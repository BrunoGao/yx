<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºèƒ½å¥åº·æ•°æ®åˆ†æå¹³å°</title>

    <script src="{{ url_for('static', filename='js/map-optimizer.js') }}"></script>

<style>
  /* å‘Šè­¦åŠ¨ç”»æ•ˆæœ */
@keyframes alertPulse {
  0%, 100% { box-shadow: 0 20px 60px rgba(255,68,68,0.3), 0 0 30px rgba(255,68,68,0.2); }
  50% { box-shadow: 0 25px 80px rgba(255,68,68,0.5), 0 0 50px rgba(255,68,68,0.4); }
}

@keyframes alertBlink {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.2); }
}

@keyframes levelGlow {
  0% { opacity: 0.8; }
  100% { opacity: 1; box-shadow: 0 0 20px currentColor; }
}

@keyframes scanLine {
  0% { left: -100%; }
  100% { left: 100%; }
}

@keyframes avatarGlow {
  0% { box-shadow: 0 0 20px rgba(255,68,68,0.6); }
  100% { box-shadow: 0 0 30px rgba(255,68,68,0.9), 0 0 60px rgba(255,68,68,0.3); }
}

@keyframes iconPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* å¥åº·ç‚¹åŠ¨ç”»æ•ˆæœ */
@keyframes healthGlow {
  0%, 100% { box-shadow: 0 25px 80px rgba(0,228,255,0.3), 0 0 40px rgba(0,228,255,0.2); }
  50% { box-shadow: 0 30px 100px rgba(0,228,255,0.5), 0 0 60px rgba(0,228,255,0.4); }
}

@keyframes healthPulse {
  0% { opacity: 0.8; }
  100% { opacity: 1; box-shadow: 0 0 25px currentColor; }
}

@keyframes healthBeat {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes healthAvatarGlow {
  0%, 100% { box-shadow: 0 0 25px rgba(0,228,255,0.6); }
  50% { box-shadow: 0 0 35px rgba(0,228,255,0.9), 0 0 70px rgba(0,228,255,0.3); }
}

@keyframes healthIconFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

@keyframes heartbeatLine {
  0%, 100% { transform: translateX(-10px); opacity: 0; }
  50% { transform: translateX(46px); opacity: 1; }
}

@keyframes bgShift {
  0%, 100% { transform: translateX(0) translateY(0); }
  50% { transform: translateX(10px) translateY(-10px); }
}

/* é€šç”¨åŠ¨ç”» */
@keyframes slideIn {
  from { transform: translateY(30px) scale(0.9); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #001529;
        color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        overflow: hidden;
      }

      .container {
        display: grid;
        grid-template-columns: 22% 1fr 22%; /* è°ƒæ•´ä¸ºæ¯”ä¾‹åˆ†é…ï¼šå·¦22% ä¸­é—´è‡ªé€‚åº” å³22% */
        grid-gap: 16px; /* å‡å°‘é—´è·ï¼šä»20pxå‡å°‘åˆ°16px */
        padding: 0 16px 16px 16px; /* å‡å°‘å†…è¾¹è·ï¼šä»20pxå‡å°‘åˆ°16px */
        height: calc(100vh - 76px); /* ä¼˜åŒ–é«˜åº¦è®¡ç®—ï¼š60pxæ ‡é¢˜+16pxåº•è¾¹è· */
        max-height: calc(100vh - 76px); /* é™åˆ¶æœ€å¤§é«˜åº¦ */
        overflow: hidden;
      }

      .panel {
        background: rgba(0, 21, 41, 0.7);
        border: 1px solid rgba(0, 228, 255, 0.2);
        border-radius: 4px;
        padding: 10px; /* å‡å°‘å†…è¾¹è·ï¼šä»12pxå‡å°‘åˆ°10px */
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      .side-container {
        display: flex;
        flex-direction: column;
        gap: 12px; /* å‡å°‘é—´è·ï¼šä»15pxå‡å°‘åˆ°12px */
        height: 100%;
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      }

      .panel:nth-child(1) {
        height: 30%; /* ç»Ÿè®¡ä¿¡æ¯é¢æ¿ï¼šä»20%å¢åŠ åˆ°30% */
        min-height: 150px; /* å¢åŠ æœ€å°é«˜åº¦ */
        max-height: 250px; /* å¢åŠ æœ€å¤§é«˜åº¦ */
      }

      .panel:nth-child(2) {
        height: 30%; /* äººå‘˜ç®¡ç†é¢æ¿ï¼šä»35%å‡å°‘åˆ°30% */
        min-height: 220px; /* è°ƒæ•´æœ€å°é«˜åº¦ */
        max-height: none; /* è°ƒæ•´æœ€å¤§é«˜åº¦ */
      }

      .panel:nth-child(3) {
        flex: 1; /* ä½¿ç”¨flex: 1å¡«å……å‰©ä½™ç©ºé—´è€Œä¸æ˜¯å›ºå®šé«˜åº¦ */
        min-height: 220px; /* è°ƒæ•´æœ€å°é«˜åº¦ */
        max-height: none; /* å…è®¸è‡ªé€‚åº”ä½†ä¸è¶…è¿‡å®¹å™¨ */
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      }

      /* å³ä¾§é¢æ¿é«˜åº¦åˆ†é… */
      .side-container:last-child .panel:nth-child(1) {
        height: 26%; /* æ‰‹è¡¨ç®¡ç†é¢æ¿ï¼šä»30%å‡å°‘åˆ°26% */
        min-height: 200px; /* å‡å°‘æœ€å°é«˜åº¦ï¼šä»220pxåˆ°200px */
        max-height: 250px; /* å‡å°‘æœ€å¤§é«˜åº¦ï¼šä»280pxåˆ°250px */
      }

      .side-container:last-child .panel:nth-child(2) {
        height: 36%; /* å¥åº·æ•°æ®åˆ†æé¢æ¿ï¼šä»34%å¢åŠ åˆ°36% */
        min-height: 220px; /* å¢åŠ æœ€å°é«˜åº¦ï¼šä»200pxåˆ°220px */
        max-height: 340px; /* å¢åŠ æœ€å¤§é«˜åº¦ï¼šä»320pxåˆ°340px */
      }

      .side-container:last-child .panel:nth-child(3) {
        flex: 1; /* ä½¿ç”¨flex: 1å¡«å……å‰©ä½™ç©ºé—´ç¡®ä¿åº•éƒ¨å¯¹é½ */
        min-height: 200px; /* è°ƒæ•´æœ€å°é«˜åº¦ */
        max-height: none; /* ä¿æŒæ— æœ€å¤§é«˜åº¦é™åˆ¶ */
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      }

      .panel-header {
        color: #00e4ff;
        font-size: 16px;
        margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
      }

      .panel-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .map-container {
        flex: 1; /* ä½¿ç”¨flex: 1è‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ */
        background: rgba(0, 21, 41, 0.7);
        border: 1px solid rgba(0, 228, 255, 0.2);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        min-height: 300px; /* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿åœ°å›¾æœ‰è¶³å¤Ÿæ˜¾ç¤ºç©ºé—´ */
      }

      /* æ•°æ®å¡ç‰‡æ ·å¼ */
      .data-card {
        background: rgba(0, 228, 255, 0.1);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
      }

      .data-card-value {
        font-size: 24px;
        color: #00e4ff;
        margin: 5px 0;
      }

      /* æ»šåŠ¨æ¡ç¾åŒ– */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 228, 255, 0.1);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(0, 228, 255, 0.3);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 228, 255, 0.5);
      }

      /* å›¾è¡¨å®¹å™¨æ ·å¼ */
      .chart-container {
        position: relative;
        flex: 1;
        width: 100%;
        height: calc(100% - 40px); /* å‡å°‘é«˜åº¦åç§»ï¼Œç»™å›¾è¡¨æ›´å¤šç©ºé—´ */
        min-height: 120px; /* å¢åŠ æœ€å°é«˜åº¦ç¡®ä¿å†…å®¹æ˜¾ç¤º */
      }

      /* ç»Ÿè®¡ä¿¡æ¯é¢æ¿çš„å›¾è¡¨å®¹å™¨ç‰¹æ®Šæ ·å¼ */
      .panel:nth-child(1) .chart-container {
        min-height: 100px; /* ç»Ÿè®¡ä¿¡æ¯é¢æ¿çš„å›¾è¡¨æœ€å°é«˜åº¦ï¼šä»80pxå¢åŠ åˆ°100px */
        height: calc(100% - 60px); /* ä¸ºç»Ÿè®¡æ•°æ®ç•™å‡ºæ›´å¤šç©ºé—´ */
      }

      /* å‘Šè­¦é¢æ¿çš„å›¾è¡¨å®¹å™¨ç‰¹æ®Šæ ·å¼ */
      .panel:nth-child(3) .chart-container {
        min-height: 160px; /* å¢åŠ å‘Šè­¦é¢æ¿çš„å›¾è¡¨æœ€å°é«˜åº¦ï¼šä¸ºå‘Šè­¦ç±»å‹å¡ç‰‡æä¾›æ›´å¤šç©ºé—´ */
        height: calc(100% - 20px);
      }

      /* å³ä¾§é¢æ¿å›¾è¡¨å®¹å™¨ä¼˜åŒ– */
      .side-container:last-child .panel:nth-child(1) .chart-container {
        min-height: 120px; /* æ‰‹è¡¨ç®¡ç†é¢æ¿å›¾è¡¨æœ€å°é«˜åº¦ */
        height: calc(100% - 40px);
      }

      .side-container:last-child .panel:nth-child(2) .chart-container {
        min-height: 140px; /* å¥åº·æ•°æ®åˆ†æé¢æ¿å›¾è¡¨æœ€å°é«˜åº¦ */
        height: calc(100% - 40px);
      }

      .side-container:last-child .panel:nth-child(3) .chart-container {
        min-height: 150px; /* å¥åº·è¯„åˆ†é¢æ¿æœ€å°é«˜åº¦ï¼šä»120pxå¢åŠ åˆ°150px */
        height: calc(100% - 40px);
        max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
      }

      /* å‘Šè­¦å›¾è¡¨ä¸“ç”¨æ ·å¼ */
      #alertTypeChart, #alertLevelChart, #alertStatusChart, #alertTrendChart {
        width: 100% !important;
        height: 100% !important;
        min-height: 90px !important; /* å¢åŠ æœ€å°é«˜åº¦ï¼šä»80pxåˆ°90px */
        max-height: 180px !important; /* å¢åŠ å•ä¸ªå›¾è¡¨æœ€å¤§é«˜åº¦ï¼šä»150pxå¢åŠ åˆ°180pxï¼Œç»™å‘Šè­¦ç±»å‹æ›´å¤šæ˜¾ç¤ºç©ºé—´ */
        overflow: hidden !important;
      }

      /* ç‰¹åˆ«é™åˆ¶å‘Šè­¦ç±»å‹å›¾è¡¨é«˜åº¦ */
      #alertTypeChart {
        max-height: 160px !important; /* å¢åŠ å‘Šè­¦ç±»å‹å›¾è¡¨é«˜åº¦ï¼šä»120pxå¢åŠ åˆ°160pxï¼Œå½“ç±»å‹å¢å¤šæ—¶æœ‰æ›´å¥½çš„æ˜¾ç¤ºæ•ˆæœ */
      }

      /* å‘Šè­¦é¢æ¿ç½‘æ ¼å¸ƒå±€ä¼˜åŒ– */
      .alert-charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 8px; /* å‡å°‘é—´è·é€‚åº”æ›´çª„çš„å®½åº¦ */
        height: calc(100% - 55px); /* ä¸ºé¡¶éƒ¨ç»Ÿè®¡ç•™å‡ºç©ºé—´ï¼Œç»™å›¾è¡¨åŒºåŸŸæ›´å¤šç©ºé—´ */
        min-height: 250px; /* å¢åŠ æœ€å°é«˜åº¦ï¼šä¿è¯å‘Šè­¦ç±»å‹å¡ç‰‡æœ‰è¶³å¤Ÿæ˜¾ç¤ºç©ºé—´ */
        max-height: none; /* é™åˆ¶æœ€å¤§é«˜åº¦é˜²æ­¢å˜å½¢ */
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media screen and (min-width: 1920px) {
        .container {
          grid-template-columns: 20% 1fr 20%; /* è¶…å®½å±ï¼šå‡å°‘ä¾§è¾¹æ å®½åº¦ï¼Œç»™ä¸­é—´æ›´å¤šç©ºé—´ */
        }
      }

      @media screen and (max-width: 1600px) {
        .container {
          grid-template-columns: 24% 1fr 24%; /* ä¸­ç­‰å±å¹•ï¼šç¨å¾®å¢åŠ ä¾§è¾¹æ å®½åº¦ */
        }
      }

      @media screen and (max-width: 1200px) {
        .container {
          grid-template-columns: 26% 1fr 26%; /* å°å±å¹•ï¼šè¿›ä¸€æ­¥å¢åŠ ä¾§è¾¹æ å®½åº¦ç¡®ä¿å†…å®¹æ˜¾ç¤º */
        }
      }

      @media screen and (max-width: 1024px) {
        .container {
          grid-template-columns: 28% 1fr 28%; /* æ›´å°å±å¹•ï¼šæœ€å¤§åŒ–ä¾§è¾¹æ å®½åº¦ */
          grid-gap: 12px; /* å‡å°‘é—´è· */
        }
        
        /* ä¼˜åŒ–å°å±å¹•ä¸‹çš„é¢æ¿å†…å®¹ */
        .panel-header {
          font-size: 14px;
          margin-bottom: 8px;
        }
        
        .alert-charts-grid {
          gap: 4px; /* è¿›ä¸€æ­¥å‡å°‘é—´è· */
          min-height: 250px; /* ä¿æŒä¸ä¸»å±å¹•ä¸€è‡´çš„æœ€å°é«˜åº¦ */
        }
        
        .chart-container {
          min-height: 100px;
        }
        
        .side-container:last-child .panel:nth-child(3) .chart-container {
          min-height: 100px;
        }
      }

      /* åœ¨å·²æœ‰çš„ style æ ‡ç­¾ä¸­æ·»åŠ  */
      .header-title {
    position: relative;
    width: 100%;
        height: 60px;
        background: linear-gradient(90deg, rgba(0,21,41,0.8) 0%, rgba(0,91,171,0.8) 50%, rgba(0,21,41,0.8) 100%);
    display: flex;
        justify-content: center;
    align-items: center;
        border-bottom: 1px solid rgba(0,228,255,0.3);
    margin-bottom: 20px;
}

      .header-title h1 {
        color: #00e4ff;
        font-size: 28px;
        font-weight: normal;
        text-shadow: 0 0 10px rgba(0,228,255,0.5);
        letter-spacing: 2px;
      }

      .header-title::before,
      .header-title::after {
        content: '';
        position: absolute;
        width: 200px;
        height: 1px;
        background: linear-gradient(90deg, transparent, #00e4ff, transparent);
        bottom: -1px;
      }

      .header-title::before {
        left: 0;
      }

      .header-title::after {
        right: 0;
      }

      /* æ·»åŠ è£…é¥°å…ƒç´  */
      .header-decoration {
    position: absolute;
        width: 120px;
        height: 30px;
    top: 50%;
        transform: translateY(-50%);
      }

      .header-decoration.left {
        left: 50px;
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMzAiPjxwYXRoIGQ9Ik0wIDE1aDEyME0zMCAwdjMwTTYwIDB2MzBNOTAgMHYzMCIgc3Ryb2tlPSIjMDBlNGZmIiBzdHJva2Utd2lkdGg9IjEiIG9wYWNpdHk9IjAuMyIvPjwvc3ZnPg==');
      }

      .header-decoration.right {
        right: 50px;
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMzAiPjxwYXRoIGQ9Ik0wIDE1aDEyME0zMCAwdjMwTTYwIDB2MzBNOTAgMHYzMCIgc3Ryb2tlPSIjMDBlNGZmIiBzdHJva2Utd2lkdGg9IjEiIG9wYWNpdHk9IjAuMyIvPjwvc3ZnPg==');
        transform: translateY(-50%) scaleX(-1);
      }

      /* æ·»åŠ äººå‘˜ç®¡ç†é¢æ¿ç‰¹æ®Šè°ƒæ•´ */
      .personnel-management {
        background: rgba(1, 19, 38, 0.8);
        border: 1px solid rgba(0, 228, 255, 0.2);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
      }

      .personnel-management:hover {
        border-color: rgba(0, 228, 255, 0.4);
        box-shadow: 0 0 15px rgba(0, 228, 255, 0.2);
      }

      .personnel-management .panel-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .personnel-management .data-overview {
        display: flex;
        justify-content: space-between;
        padding: 8px 20px;
        margin-bottom: 5px;
        border-bottom: 1px solid rgba(0, 228, 255, 0.1);
      }

      .personnel-management .overview-item {
        text-align: center;
    display: flex;
    align-items: center;
        gap: 8px;
      }

      .personnel-management .overview-item .label {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 0;
      }

      .personnel-management .overview-item .number {
        font-size: 18px;
        color: #00e4ff;
        font-weight: 600;
      }

      .personnel-management .department-chart {
    flex: 1;
        height: calc(100% - 50px); /* ç»™å›¾è¡¨æ›´å¤šç©ºé—´ */
        min-height: 0;
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media screen and (max-height: 800px) {
        .personnel-management .overview-item .number {
          font-size: 18px;
        }
        
        .personnel-management .overview-item .label {
          font-size: 11px;
        }
}

/* åœ¨å·²æœ‰çš„styleæ ‡ç­¾ä¸­æ·»åŠ  */
.message-count {
    font-size: 14px;
    color: #00e4ff;
    background: rgba(0, 228, 255, 0.1);
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 10px;
}

.message-list {
    height: calc(100% - 30px);
    overflow-y: auto;
    padding: 5px;
}

.message-item {
    background: rgba(0,228,255,0.1);
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 6px;
    border-left: 3px solid #00e4ff;
    font-size: 12px;
    line-height: 1.4;
}

.message-time {
    color: rgba(255,255,255,0.6);
    font-size: 10px;
    float: right;
}

.message-content {
    color: #fff;
    margin-top: 2px;
}

.device-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px; /* å‡å°‘é—´è· */
    margin-bottom: 8px; /* å‡å°‘åº•éƒ¨è¾¹è· */
    height: 50px; /* å‡å°‘å›ºå®šé«˜åº¦ */
}

.device-stat-item {
    background: rgba(0, 228, 255, 0.1);
    border-radius: 4px;
    padding: 4px; /* å‡å°‘å†…è¾¹è· */
    text-align: center;
    border-left: 3px solid #00e4ff;
    transition: all 0.3s ease;
    position: relative;
}

.device-stat-item:hover {
    background: rgba(0, 228, 255, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 228, 255, 0.2);
}

.stat-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 9px; /* å‡å°‘å­—ä½“å¤§å° */
    display: block;
    margin-bottom: 1px; /* å‡å°‘è¾¹è· */
}

.stat-value {
    color: #00e4ff;
    font-size: 14px; /* å‡å°‘å­—ä½“å¤§å° */
    font-weight: bold;
    display: inline-block;
}

.stat-unit {
    color: rgba(255, 255, 255, 0.6);
    font-size: 8px;
    margin-left: 2px;
}

.stats-date {
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
    font-weight: normal;
}

.total-score {
    font-size: 16px;
    color: #00e4ff;
    background: rgba(0, 228, 255, 0.1);
    padding: 4px 12px;
    border-radius: 12px;
}

/* åœ¨ <style> æ ‡ç­¾ä¸­æ·»åŠ ä»¥ä¸‹æ ·å¼ */
.modal-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal-content {
    position: relative;
    width: 90%;
    height: 90%;
    background: rgba(0, 21, 41, 0.95);
    border: 1px solid rgba(0, 228, 255, 0.3);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0, 228, 255, 0.2);
}

.modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: transparent;
    border: none;
    color: #00e4ff;
    font-size: 18px;
    cursor: pointer;
    z-index: 9999;
    padding: 5px 10px;
    transition: all 0.3s ease;
}

.modal-close:hover {
    transform: scale(1.1);
    color: #ff4444;
}

.user-view-iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 4px;
    background: rgba(1, 19, 38, 0.8);
}

/* æ·»åŠ åŠ¨ç”»æ•ˆæœ */
.modal-container {
    animation: fadeIn 0.3s ease;
}

.modal-content {
    animation: slideIn 0.3s ease;
}

@keyframes fadeIn {
    from {
    opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.filter-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: rgba(0, 21, 41, 0.9);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(0, 228, 255, 0.2);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    overflow: hidden;
    border-radius: 50%; /* æ”¶ç¼©æ—¶åœ†å½¢ */
    width: 36px; height: 36px; /* æè‡´æ”¶ç¼© */
}

.filter-panel.expanded {
    border-radius: 8px; /* å±•å¼€æ—¶æ–¹å½¢åœ†è§’ */
    width: 320px; height: auto;
    padding: 15px;
}

.filter-toggle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: transparent;
    border: none;
    width: 32px;
    height: 32px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #00e4ff;
    font-size: 16px;
    transition: all 0.3s ease;
    z-index: 10;
}

.filter-panel.expanded .filter-toggle {
    position: absolute;
    top: 15px;
    right: 15px;
    transform: none;
    background: rgba(0, 228, 255, 0.2);
    border: 1px solid rgba(0, 228, 255, 0.4);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 14px;
}

.filter-toggle:hover {
    color: #fff;
    transform: translate(-50%, -50%) scale(1.1);
}

.filter-panel.expanded .filter-toggle:hover {
    background: rgba(0, 228, 255, 0.3);
    border-color: rgba(0, 228, 255, 0.6);
    transform: scale(1.1);
}

.filter-content {
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    pointer-events: none;
}

.filter-panel.expanded .filter-content {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

.filter-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 40px; /* ä¸ºtoggleæŒ‰é’®ç•™ç©ºé—´ */
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(0, 228, 255, 0.2);
}

.filter-header span {
    color: #00e4ff;
    font-size: 14px;
    font-weight: bold;
}

.filter-search {
    width: 100%;
    padding: 8px 12px;
    margin-bottom: 10px;
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    transition: all 0.3s ease;
    font-size: 12px;
}

.filter-search:hover {
    border-color: rgba(0, 228, 255, 0.4);
}

.filter-search:focus {
    border-color: rgba(0, 228, 255, 0.6);
    outline: none;
    box-shadow: 0 0 5px rgba(0, 228, 255, 0.2);
}

.filter-search::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.filter-select {
    font-family: monospace;
    white-space: pre;
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    transition: all 0.3s ease;
}

.filter-select:hover {
    border-color: rgba(0, 228, 255, 0.4);
}

.filter-select:focus {
    border-color: rgba(0, 228, 255, 0.6);
    outline: none;
    box-shadow: 0 0 5px rgba(0, 228, 255, 0.2);
}

.filter-select option {
    font-family: monospace;
    white-space: pre;
    background: #1a1a1a;
    color: #fff;
    padding: 8px;
}

/* æ·»åŠ ç¾åŒ–çš„å¼¹å‡ºæ¡†æ ·å¼ */
.custom-alert {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 21, 41, 0.95);
    border: 1px solid rgba(0, 228, 255, 0.3);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    z-index: 10000;
    min-width: 300px;
    text-align: center;
    animation: alertFadeIn 0.3s ease;
}

.custom-alert-content {
    color: #fff;
    font-size: 16px;
    margin-bottom: 20px;
}

.custom-alert-button {
    background: rgba(0, 228, 255, 0.2);
    border: 1px solid rgba(0, 228, 255, 0.4);
    color: #00e4ff;
    padding: 8px 20px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.custom-alert-button:hover {
    background: rgba(0, 228, 255, 0.3);
    border-color: rgba(0, 228, 255, 0.6);
}

@keyframes alertFadeIn {
    from {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

/* æ·»åŠ é®ç½©å±‚æ ·å¼ */
.custom-alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
    z-index: 9999;
    animation: overlayFadeIn 0.3s ease;
}

@keyframes overlayFadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* ç°ä»£ç§‘æŠ€é£æ ¼ä¿¡æ¯é¢æ¿ */
.info-panel {
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  width: 360px;
  background: rgba(13, 17, 38, 0.95);
  border: 1px solid rgba(0, 234, 255, 0.3);
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0, 234, 255, 0.2);
  backdrop-filter: blur(10px);
  z-index: 1000;
  transition: all 0.3s ease;
  overflow: hidden;
}

.info-panel-header {
  padding: 15px 20px;
  background: linear-gradient(90deg, rgba(0, 234, 255, 0.1), rgba(0, 234, 255, 0.05));
  border-bottom: 1px solid rgba(0, 234, 255, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.info-panel-title {
  color: #00eaff;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.info-panel-close {
  background: none;
  border: none;
  color: #00eaff;
  font-size: 18px;
  cursor: pointer;
  padding: 5px;
  transition: all 0.2s ease;
}

.info-panel-close:hover {
  color: #fff;
  transform: rotate(90deg);
}

.info-panel-content {
  padding: 20px;
  max-height: 70vh;
  overflow-y: auto;
}

.info-item {
  background: rgba(0, 234, 255, 0.05);
  border: 1px solid rgba(0, 234, 255, 0.1);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 12px;
  transition: all 0.2s ease;
}

.info-item:hover {
  background: rgba(0, 234, 255, 0.1);
  transform: translateX(-5px);
}

.info-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.info-item-title {
  color: #00eaff;
  font-size: 16px;
  font-weight: 500;
}

.info-item-time {
  color: rgba(255, 255, 255, 0.6);
  font-size: 14px;
}

.info-item-content {
  color: #fff;
  font-size: 14px;
  line-height: 1.6;
}

.info-item-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(0, 234, 255, 0.1);
}

.info-item-location {
  color: rgba(255, 255, 255, 0.6);
  font-size: 13px;
}

.info-item-action {
  background: #00eaff;
  color: #0d1126;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.info-item-action:hover {
  background: #38f9d7;
}

/* å¥åº·ä¿¡æ¯æ ·å¼ */
.health-info {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.health-item {
  background: rgba(0, 234, 255, 0.05);
  padding: 8px;
  border-radius: 6px;
  text-align: center;
}

.health-label {
  color: rgba(255, 255, 255, 0.6);
  font-size: 12px;
  margin-bottom: 4px;
}

.health-value {
  color: #00eaff;
  font-size: 16px;
  font-weight: 500;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
.info-panel-content::-webkit-scrollbar {
  width: 6px;
}

.info-panel-content::-webkit-scrollbar-track {
  background: rgba(0, 234, 255, 0.05);
}

.info-panel-content::-webkit-scrollbar-thumb {
  background: rgba(0, 234, 255, 0.3);
  border-radius: 3px;
}

.info-panel-content::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 234, 255, 0.5);
}

.info-item-highlight { border:2px solid #ffbb00; box-shadow:0 0 12px #ffbb0088; }

      /* äººå‘˜ç®¡ç†é¢æ¿ä¸“ç”¨æ ·å¼ */
      .personnel-management .panel-header h3 {
        color: #00e4ff;
        font-size: 16px;
        margin: 0;
        font-weight: 600;
      }

      /* ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡æ ·å¼ */
      .personnel-management .panel-content > div:first-child {
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .personnel-management .panel-content > div:first-child:hover {
        background: rgba(0, 228, 255, 0.15) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 228, 255, 0.2);
      }

      /* å›¾è¡¨å®¹å™¨ä¼˜åŒ– */
      #departmentDistribution, #userStatusChart {
        transition: all 0.3s ease;
      }

      #departmentDistribution:hover, #userStatusChart:hover {
        border-color: rgba(0, 228, 255, 0.6) !important;
        box-shadow: 0 4px 15px rgba(0, 228, 255, 0.2) !important;
      }


      /* ç»Ÿè®¡ä¿¡æ¯é¢æ¿æ ·å¼ä¼˜åŒ– */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 10px;
        height: auto;
      }

      .stat-card {
        background: linear-gradient(135deg, rgba(0, 228, 255, 0.1), rgba(0, 228, 255, 0.05));
        border-radius: 6px;
        padding: 8px;
        border-left: 3px solid #00e4ff;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }

      .stat-card:hover::before {
        transform: translateX(100%);
      }

      .stat-card:hover {
        background: linear-gradient(135deg, rgba(0, 228, 255, 0.15), rgba(0, 228, 255, 0.08));
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 228, 255, 0.3);
        border-left-color: #38f9d7;
      }

      .stat-card.health-data { border-left-color: #00e4ff; }
      .stat-card.alert-data { border-left-color: #ff6b6b; }
      .stat-card.device-data { border-left-color: #00ff9d; }
      .stat-card.message-data { border-left-color: #ffbb00; }

      .stat-icon {
        font-size: 16px;
        position: absolute;
        top: 6px;
        right: 8px;
        opacity: 0.7;
      }

      .stat-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .stat-label {
        color: rgba(255, 255, 255, 0.8);
        font-size: 9px;
        font-weight: 500;
      }

      .stat-value-container {
        display: flex;
        align-items: baseline;
        gap: 2px;
      }

      .stat-value {
        color: #00e4ff;
        font-size: 16px;
        font-weight: bold;
        font-family: 'Courier New', monospace;
      }

      .stat-unit {
        color: rgba(255, 255, 255, 0.6);
        font-size: 8px;
        margin-left: 2px;
      }

      .stat-trend {
        color: #00ff9d;
        font-size: 8px;
        font-weight: 500;
      }

      .stat-trend.negative {
        color: #ff6b6b;
      }

      .system-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        background: rgba(0, 21, 41, 0.6);
        border-radius: 4px;
        border: 1px solid rgba(0, 228, 255, 0.2);
        margin-top: 8px;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status-indicator.normal { background: #00ff9d; }
      .status-indicator.warning { background: #ffbb00; }
      .status-indicator.critical { background: #ff6b6b; }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }

      .status-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 10px;
        flex: 1;
      }

      .health-score {
        color: #00e4ff;
        font-size: 12px;
        font-weight: bold;
      }

      .stats-date {
        color: rgba(255, 255, 255, 0.6);
        font-size: 10px;
        font-weight: normal;
      }

      /* å‘Šè­¦ç±»å‹å›¾è¡¨ç‰¹æ®Šä¼˜åŒ– - é˜²æ­¢ç±»å‹è¿‡å¤šæ—¶å˜å½¢ */
      .alert-type-container {
        max-height: 120px;
        overflow-y: auto;
        overflow-x: hidden;
      }

      /* å½“å‘Šè­¦ç±»å‹è¶…è¿‡5ä¸ªæ—¶çš„ç‰¹æ®Šå¤„ç† */
      .alert-type-scroll {
        max-height: 100px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 228, 255, 0.3) transparent;
      }

      .alert-type-scroll::-webkit-scrollbar {
        width: 4px;
      }

      .alert-type-scroll::-webkit-scrollbar-track {
        background: rgba(0, 228, 255, 0.1);
      }

      .alert-type-scroll::-webkit-scrollbar-thumb {
        background: rgba(0, 228, 255, 0.3);
        border-radius: 2px;
      }

      /* æ¶ˆæ¯é¢æ¿ä¼˜åŒ–æ ·å¼ - ç»Ÿä¸€å®šä¹‰ */
      .message-panel {
          height: 240px; /* ä½¿ç”¨å›ºå®šé«˜åº¦240pxç¡®ä¿åº•éƒ¨å¯¹é½ */
          background: rgba(0, 21, 41, 0.7);
          border: 1px solid rgba(0, 228, 255, 0.2);
          border-radius: 4px;
          padding: 8px; /* å‡å°‘å†…è¾¹è·ï¼šä»10pxå‡å°‘åˆ°8px */
          margin-bottom: 0; /* ç§»é™¤åº•éƒ¨é—´è·ç¡®ä¿å¯¹é½ */
          min-height: 220px; /* ä¿æŒæœ€å°é«˜åº¦ */
          max-height: 280px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
          overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
          display: flex;
          flex-direction: column;
          flex-shrink: 0; /* é˜²æ­¢ç¼©æ”¾ */
      }

      /* æ¶ˆæ¯é¢æ¿æ ‡é¢˜ */
      .message-panel .panel-header {
          flex-shrink: 0; /* æ ‡é¢˜ä¸ç¼©æ”¾ */
          margin-bottom: 8px;
          height: 24px; /* å›ºå®šæ ‡é¢˜é«˜åº¦ */
      }

      /* æ¶ˆæ¯é¢æ¿å†…å®¹åŒºåŸŸ */
      .message-panel-content {
          flex: 1; /* å ç”¨å‰©ä½™ç©ºé—´ */
          display: flex;
          gap: 10px;
          min-height: 0; /* å…è®¸å†…å®¹ç¼©æ”¾ */
          width: 100%;
          box-sizing: border-box;
      }

      /* æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ */
      .message-list-container {
          flex: 0 0 60%; /* å›ºå®š60%å®½åº¦ */
          display: flex;
          flex-direction: column;
          min-height: 0;
      }

      /* æ¶ˆæ¯ç»Ÿè®¡åŒºåŸŸ */
      .message-stats-container {
          flex: 0 0 38%; /* å›ºå®š38%å®½åº¦ï¼Œç•™2%é—´è· */
          display: flex;
          flex-direction: column;
          min-height: 0;
      }

      /* æ¶ˆæ¯åˆ—è¡¨æ ·å¼ */
      .message-list {
          flex: 1;
          overflow-y: auto;
          padding: 5px;
          background: rgba(0,21,41,0.3);
          border-radius: 4px;
          border: 1px solid rgba(0,228,255,0.1);
          min-height: 60px; /* ç¡®ä¿æœ€å°æ˜¾ç¤ºé«˜åº¦ */
      }

      /* æ¶ˆæ¯é¡¹æ ·å¼ */
      .message-item {
          padding: 4px 6px;
          margin-bottom: 3px;
          background: rgba(0,228,255,0.05);
          border-radius: 3px;
          border-left: 2px solid #00e4ff;
          font-size: 10px;
          line-height: 1.3;
          color: rgba(255,255,255,0.9);
          cursor: pointer;
          transition: all 0.2s ease;
      }

      .message-item:hover {
          background: rgba(0,228,255,0.1);
          border-left-color: #38f9d7;
      }

      /* æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨å®¹å™¨ */
      .message-stats-chart {
          flex: 1;
          background: rgba(0,21,41,0.3);
          border-radius: 4px;
          border: 1px solid rgba(0,228,255,0.1);
          position: relative;
          min-height: 60px;
      }


      /* æ¶ˆæ¯é¢æ¿é¢å¤–ä¼˜åŒ– - é˜²æ­¢å˜å½¢ */
      .message-panel-content {
          width: 100%;
          box-sizing: border-box;
      }

      .message-list-container,
      .message-stats-container {
          box-sizing: border-box;
          overflow: hidden;
      }

      /* æ¶ˆæ¯ç»Ÿè®¡æ¦‚è§ˆæ ·å¼ä¼˜åŒ– */
      .message-stats-overview {
          display: flex;
          justify-content: space-around;
          padding: 6px 3px;
          border-bottom: 1px solid rgba(0,228,255,0.1);
          flex-shrink: 0;
          height: 36px;
          box-sizing: border-box;
      }

      .message-stats-overview > div {
          text-align: center;
          flex: 1;
      }

      /* æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨åŒºåŸŸ */
      #messageStatsChart {
          height: calc(100% - 36px) !important;
          width: 100% !important;
          min-height: 40px !important;
      }

      /* æ‰‹è¡¨ç®¡ç†é¢æ¿æ ·å¼ */
      .watch-management {
          background: linear-gradient(135deg, rgba(0, 21, 41, 0.9), rgba(0, 91, 171, 0.1));
      }

      .watch-stats {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
          margin-bottom: 12px;
      }

      .watch-stat-card {
          background: rgba(0, 228, 255, 0.1);
          border-radius: 4px;
          padding: 8px;
          text-align: center;
          border-left: 3px solid #00e4ff;
          transition: all 0.3s ease;
          cursor: pointer;
      }

      .watch-stat-card:hover {
          background: rgba(0, 228, 255, 0.2);
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(0, 228, 255, 0.3);
      }

      .watch-stat-value {
          color: #00e4ff;
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 2px;
      }

      .watch-stat-label {
          color: rgba(255, 255, 255, 0.8);
          font-size: 10px;
      }

      /* å¥åº·æ•°æ®åˆ†æé¢æ¿æ ·å¼ */
      .health-analysis {
          background: linear-gradient(135deg, rgba(0, 21, 41, 0.9), rgba(0, 255, 157, 0.05));
      }

      .health-overview-card {
          background: linear-gradient(135deg, rgba(0, 228, 255, 0.15), rgba(0, 255, 157, 0.1));
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 12px;
          border: 1px solid rgba(0, 228, 255, 0.3);
          position: relative;
          overflow: hidden;
      }

      .health-overview-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
          transform: translateX(-100%);
          transition: transform 0.6s;
      }

      .health-overview-card:hover::before {
          transform: translateX(100%);
      }

      .health-metrics {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .health-metric {
          text-align: center;
          flex: 1;
      }

      .health-metric-value {
          color: #00e4ff;
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 4px;
      }

      .health-metric-label {
          color: rgba(255, 255, 255, 0.9);
          font-size: 11px;
      }

      /* å¥åº·è¯„åˆ†é¢æ¿æ ·å¼ */
      .health-score-panel {
          background: linear-gradient(135deg, rgba(0, 21, 41, 0.9), rgba(255, 187, 0, 0.05));
      }

      .score-display {
          display: flex;
          align-items: center;
          justify-content: space-between;
          background: rgba(0, 228, 255, 0.1);
          border-radius: 6px;
          padding: 10px;
          margin-bottom: 10px;
          border-left: 4px solid #ffbb00;
      }

      .score-main {
          display: flex;
          align-items: center;
          gap: 12px;
      }

      .score-circle {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: conic-gradient(#00e4ff 0deg, #00e4ff 320deg, rgba(255,255,255,0.2) 320deg);
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
      }

      .score-circle::before {
          content: '';
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: rgba(0, 21, 41, 0.9);
          position: absolute;
      }

      .score-number {
          color: #00e4ff;
          font-size: 16px;
          font-weight: bold;
          z-index: 1;
      }

      .score-info {
          flex: 1;
      }

      .score-title {
          color: #fff;
          font-size: 14px;
          margin-bottom: 4px;
      }

      .score-status {
          color: #00ff9d;
          font-size: 12px;
      }

      /* æ¶ˆæ¯é¢æ¿é¢å¤–ä¼˜åŒ– - é˜²æ­¢å˜å½¢ */
  </style>
  </head>
  <body>
    <!-- æ·»åŠ æ ‡é¢˜æ  -->
    <div class="header-title">
        <div class="header-decoration left"></div>
        <h1>{{ BIGSCREEN_TITLE }}</h1>
      
        <div class="header-decoration right"></div>
          </div>

    <div class="container">
      <!-- å·¦ä¾§é¢æ¿ -->
      <div class="side-container">
        <div class="panel">
          <div class="panel-header">
            <span>å®æ—¶ç»Ÿè®¡</span>
            <span class="stats-date" id="statsDate"></span>
          </div>
          <div class="panel-content">
            <div class="stats-grid">
              <div class="stat-card health-data">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-info">
                  <span class="stat-label">å¥åº·æ•°æ®</span>
                  <div class="stat-value-container">
                    <span class="stat-value" id="healthDataCount">0</span>
                    <span class="stat-unit">æ¡</span>
                  </div>
                  <div class="stat-trend" id="healthTrend">+0%</div>
                </div>
              </div>
              
              <div class="stat-card alert-data">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-info">
                  <span class="stat-label">å¾…å¤„ç†å‘Šè­¦</span>
                  <div class="stat-value-container">
                    <span class="stat-value" id="pendingAlerts">0</span>
                    <span class="stat-unit">æ¡</span>
                  </div>
                  <div class="stat-trend" id="alertTrend">+0%</div>
                </div>
              </div>
              
              <div class="stat-card device-data">
                <div class="stat-icon">ğŸ“±</div>
                <div class="stat-info">
                  <span class="stat-label">æ´»è·ƒè®¾å¤‡</span>
                  <div class="stat-value-container">
                    <span class="stat-value" id="activeDevices">0</span>
                    <span class="stat-unit">å°</span>
                  </div>
                  <div class="stat-trend" id="deviceTrend">+0%</div>
                </div>
              </div>
              
              <div class="stat-card message-data">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-info">
                  <span class="stat-label">æœªè¯»æ¶ˆæ¯</span>
                  <div class="stat-value-container">
                    <span class="stat-value" id="unreadMessages">0</span>
                    <span class="stat-unit">æ¡</span>
                  </div>
                  <div class="stat-trend" id="messageTrend">+0%</div>
                </div>
              </div>
            </div>
            
            <div class="system-status" id="systemStatus">
              <div class="status-indicator normal" id="statusIndicator"></div>
              <span class="status-text" id="statusText">ç³»ç»Ÿæ­£å¸¸</span>
              <span class="health-score" id="systemHealthScore">100</span>
            </div>
          </div>
        </div>
        
        <div class="panel personnel-management">
          <div class="panel-header">
              <h3>äººå‘˜ç®¡ç†</h3>
              </div>
          <div class="panel-content">
              <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 12px; background: rgba(0,228,255,0.1); border-radius: 6px; border-left: 4px solid #00e4ff;">
                  <div style="display: flex; align-items: center; gap: 20px;">
                      <div style="text-align: center;">
                          <div style="color: #00e4ff; font-size: 18px; font-weight: bold;" id="totalUsers">0</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 11px;">æ€»äººæ•°</div>
                      </div>
                      <div style="text-align: center;">
                          <div style="color: #00ff9d; font-size: 18px; font-weight: bold;" id="totalBindDevices">0</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 11px;">å·²ç»‘å®šè®¾å¤‡</div>
                      </div>
                      <div style="text-align: center;">
                          <div style="color: #ffbb00; font-size: 18px; font-weight: bold;" id="onlineRate">0%</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 11px;">ç»‘å®šç‡</div>
                      </div>
                  </div>
                  <div style="color: rgba(255,255,255,0.6); font-size: 12px; cursor: pointer;" onclick="showPersonnelDetails()">
                      è¯¦æƒ… â†’
                  </div>
              </div>
              
              <!-- å¿«é€Ÿç»Ÿè®¡å¡ç‰‡ -->
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; height: 45px;">
                  <div style="background: rgba(0,228,255,0.1); border-radius: 4px; padding: 4px; text-align: center; border-left: 3px solid #00e4ff; cursor: pointer; transition: all 0.3s ease;" onclick="filterByDepartment()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,228,255,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <div style="color: #00e4ff; font-size: 14px; font-weight: bold;" id="activeDeptCount">0</div>
                      <div style="color: #fff; font-size: 9px;">æ´»è·ƒéƒ¨é—¨</div>
                  </div>
                  <div style="background: rgba(0,255,157,0.1); border-radius: 4px; padding: 4px; text-align: center; border-left: 3px solid #00ff9d; cursor: pointer; transition: all 0.3s ease;" onclick="filterByOnlineStatus()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,255,157,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <div style="color: #00ff9d; font-size: 14px; font-weight: bold;" id="onlineUsers">0</div>
                      <div style="color: #fff; font-size: 9px;">åœ¨çº¿äººå‘˜</div>
                  </div>
                  <div style="background: rgba(255,187,0,0.1); border-radius: 4px; padding: 4px; text-align: center; border-left: 3px solid #ffbb00; cursor: pointer; transition: all 0.3s ease;" onclick="filterByDeviceStatus()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255,187,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <div style="color: #ffbb00; font-size: 14px; font-weight: bold;" id="boundDevices">0</div>
                      <div style="color: #fff; font-size: 9px;">ç»‘å®šè®¾å¤‡</div>
                  </div>
                  <div style="background: rgba(255,68,68,0.1); border-radius: 4px; padding: 4px; text-align: center; border-left: 3px solid #ff4444; cursor: pointer; transition: all 0.3s ease;" onclick="filterByAlertStatus()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255,68,68,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <div style="color: #ff4444; font-size: 14px; font-weight: bold;" id="alertUsers">0</div>
                      <div style="color: #fff; font-size: 9px;">å‘Šè­¦äººå‘˜</div>
                  </div>
              </div>
              
              <!-- å›¾è¡¨åŒºåŸŸ -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: calc(100% - 120px);">
                  <div id="departmentDistribution" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='rgba(0,228,255,0.6)'; this.style.boxShadow='0 4px 15px rgba(0,228,255,0.2)'" onmouseout="this.style.borderColor='rgba(0,228,255,0.3)'; this.style.boxShadow='none'">
                      <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">éƒ¨é—¨åˆ†å¸ƒ</div>
              </div>
                  <div id="userStatusChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='rgba(0,228,255,0.6)'; this.style.boxShadow='0 4px 15px rgba(0,228,255,0.2)'" onmouseout="this.style.borderColor='rgba(0,228,255,0.3)'; this.style.boxShadow='none'">
                      <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">åœ¨çº¿çŠ¶æ€</div>
                  </div>
              </div>
            </div>
          </div>
        <div class="panel">
          <div class="panel-header">
            <span>å‘Šè­¦ä¿¡æ¯</span>
              </div>
          <div class="panel-content">
            <div id="alertList" class="chart-container"></div>
            </div>
              </div>
            </div>

      <!-- ä¸­é—´åœ°å›¾åŒºåŸŸ -->
      <div style="display: flex; flex-direction: column; height: 100%; width: 100%;">
        <!-- åœ°å›¾å®¹å™¨ -->
        <div class="map-container" id="map-container">
            <!-- ç­›é€‰é¢æ¿ -->
            <div class="filter-panel" id="filterPanel">
                <div class="filter-toggle" id="filterToggle">ğŸ”</div>
                <div class="filter-content">
                    <div class="filter-header">
                        <span>äººå‘˜ç­›é€‰</span>
                    </div>
                    <div class="filter-container">
                        <input type="text" id="searchInput" class="filter-search" placeholder="ğŸ” æ¨¡ç³Šæœç´¢ç”¨æˆ·...">
                        <select id="deptSelect" class="filter-select">
                            <option value="">é€‰æ‹©éƒ¨é—¨</option>
                        </select>
                        <select id="userSelect" class="filter-select">
                            <option value="">é€‰æ‹©ç”¨æˆ·</option>
                        </select>
                    </div>
                </div>
            </div>
        <!-- ä¿ç•™åŸæœ‰åœ°å›¾ä»£ç  -->
        </div>
        
        <!-- æ¶ˆæ¯é¢æ¿ -->
        <div class="message-panel">
          <div class="panel-header">
            <span>æ¶ˆæ¯ä¿¡æ¯</span>
            <span class="message-count" id="messageCount">0</span>
          </div>
          <!-- æ¶ˆæ¯é¢æ¿å†…å®¹ -->
          <div class="message-panel-content">
            <!-- å·¦ä¾§æ¶ˆæ¯åˆ—è¡¨ -->
            <div class="message-list-container">
              <div style="color: rgba(255,255,255,0.8); font-size: 11px; margin-bottom: 5px; padding-left: 5px;">æœ€æ–°æ¶ˆæ¯</div>
              <div class="message-list" id="messageList"></div>
            </div>
            
            <!-- å³ä¾§ç»Ÿè®¡å›¾è¡¨ -->
            <div class="message-stats-container">
              <div style="color: rgba(255,255,255,0.8); font-size: 11px; margin-bottom: 5px; padding-left: 5px;">æ¶ˆæ¯ç»Ÿè®¡</div>
              <div class="message-stats-chart">
                <!-- æ¶ˆæ¯ç»Ÿè®¡æ¦‚è§ˆ -->
                <div class="message-stats-overview">
                  <div>
                    <div style="color: #00e4ff; font-size: 12px; font-weight: bold;" id="todayMessages">0</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 8px;">ä»Šæ—¥</div>
                  </div>
                  <div>
                    <div style="color: #ffbb00; font-size: 12px; font-weight: bold;" id="unreadMessages">0</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 8px;">æœªè¯»</div>
                  </div>
                  <div>
                    <div style="color: #00ff9d; font-size: 12px; font-weight: bold;" id="urgentMessages">0</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 8px;">ç´§æ€¥</div>
                  </div>
                </div>
                <!-- æ¶ˆæ¯ç±»å‹åˆ†å¸ƒå›¾ -->
                <div id="messageStatsChart"></div>
              </div>
            </div>
          </div>
        </div>
        </div>

      <!-- å³ä¾§é¢æ¿ -->
      <div class="side-container">
        <div class="panel watch-management">
          <div class="panel-header">
            <span>ğŸ“± æ‰‹è¡¨ç®¡ç†</span>
            <span class="label">æ€»æ•°: <span class="number" id="totalWatchDevices">0</span></span>
          </div>
          <div class="panel-content">
            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div id="statsChart" class="chart-container"></div>
          </div>
        </div>
        
        <div class="panel health-analysis">
          <div class="panel-header">
            <span>ğŸ’— å¥åº·æ•°æ®åˆ†æ</span>
            <span style="color: rgba(255,255,255,0.6); font-size: 12px;">æœ€è¿‘7å¤©</span>
          </div>
          <div class="panel-content">
            <!-- å¥åº·è¶‹åŠ¿å›¾ -->
            <div id="trendChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative; height: 100%; transition: all 0.3s ease;" onmouseover="this.style.borderColor='rgba(0,228,255,0.6)'; this.style.boxShadow='0 4px 15px rgba(0,228,255,0.2)'" onmouseout="this.style.borderColor='rgba(0,228,255,0.3)'; this.style.boxShadow='none'">
              <div style="position: absolute; top: 8px; left: 12px; color: #00e4ff; font-size: 13px; font-weight: bold; z-index: 10;">ğŸ“Š å¥åº·è¶‹åŠ¿åˆ†æ</div>
            </div>
          </div>
        </div>
        
        <div class="panel health-score-panel">
          <div class="panel-header">
            <span>ğŸ† å¥åº·è¯„åˆ†</span>
            <span class="total-score">æ€»åˆ†ï¼š88.9</span>
          </div>
          <div class="panel-content">
            <!-- è¯„åˆ†æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="score-display">
              <div class="score-main">
                <div class="score-circle">
                  <div class="score-number">89</div>
                </div>
                <div class="score-info">
                  <div class="score-title">ç»¼åˆå¥åº·è¯„åˆ†</div>
                  <div class="score-status">è‰¯å¥½çŠ¶æ€</div>
                </div>
              </div>
              <div style="color: rgba(255,255,255,0.6); font-size: 12px; cursor: pointer;" onclick="showScoreDetails()">
                è¯¦æƒ… â†’
              </div>
            </div>
            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div id="healthScoreChart" class="chart-container"></div>
          </div>
        </div>
      </div>
</div>

    <script src="{{ url_for('static', filename='libs/echarts.min.js') }}"></script>

    <script>

      // åœ¨å…¨å±€ä½œç”¨åŸŸå£°æ˜å›¾è¡¨å˜é‡
      let globalCharts = null;
      let currentDept = '', currentUser = '';
      const ALERT_TYPE_MAP = {
        heart_rate: 'å¿ƒç‡',
        blood_pressure: 'è¡€å‹',
        stress: 'å‹åŠ›',
        blood_oxygen: 'è¡€æ°§',
        temperature: 'ä½“æ¸©',
        one_key_alarm: 'ä¸€é”®æŠ¥è­¦',
        fall_down: 'è·Œå€’',
        sleep: 'ç¡çœ '
      };
      const ALERT_SEVERITY_MAP = {
        critical: 'ä¸¥é‡',
        high: 'é«˜',
        medium: 'ä¸­',
        low: 'ä½'
      };
      const ALERT_STATUS_MAP = {
        pending: 'å¾…å¤„ç†',
        responded: 'å·²å“åº”',
        resolved: 'å·²è§£å†³'
      };
      function translateAlertType(type) {
        return ALERT_TYPE_MAP[type] || type;
      }
      function translateAlertSeverity(severity) {
        return ALERT_SEVERITY_MAP[severity] || severity;
      }
      function translateAlertStatus(status) {
        return ALERT_STATUS_MAP[status] || status;
      }
      const ALERT_TYPE_COLOR = {
        heart_rate: '#ff6b6b',
        blood_pressure: '#ffb347',
        stress: '#f7b731',
        blood_oxygen: '#00e4ff',
        temperature: '#ffd700',
        one_key_alarm: '#ffe066',
        fall_down: '#00cfff',
        sleep: '#7ecfff'
      };
      const ALERT_SEVERITY_COLOR = {    
        critical: '#ff6b6b',
        high: '#ffb347',
        medium: '#f7b731',
        low: '#00e4ff'
      };
      const ALERT_STATUS_COLOR = {
        pending: '#ff6b6b',
        responded: '#ffb347',
        resolved: '#00e4ff'
      };
      function getAlertTypeColor(type) {
        return ALERT_TYPE_COLOR[type] || '#7ecfff';
      }
      function getAlertSeverityColor(severity) {
        return ALERT_SEVERITY_COLOR[severity] || '#7ecfff';
      }
      function getAlertStatusColor(status) {
        return ALERT_STATUS_COLOR[status] || '#7ecfff';
      }

      // æ·»åŠ æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
      function formatDate(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }

      // ä¿®æ”¹initChartså‡½æ•°
      function initCharts() {
        // æ³¨æ„ï¼šå‘Šè­¦ä¿¡æ¯panelå’Œè®¾å¤‡ä¿¡æ¯panelä¸åœ¨æ­¤å¤„åˆå§‹åŒ–å›¾è¡¨
        // è€Œæ˜¯åœ¨refreshDataæ—¶é€šè¿‡initAlertChartå’ŒinitDeviceChartæ¥åˆå§‹åŒ–
        // è¿™æ ·ç¡®ä¿åˆå§‹åŒ–æ—¶å’Œæ•°æ®æ›´æ–°æ—¶ä½¿ç”¨ç›¸åŒçš„å›¾è¡¨é…ç½®ï¼Œé¿å…æ˜¾ç¤ºä¸ä¸€è‡´
        try {
            let charts = {
                healthScore: null,
                stats: null,
                trend: null,
                alert: null,
                messageStats: null // æ·»åŠ æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨
            };

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–å¥åº·è¯„åˆ†å›¾è¡¨
            const healthScoreContainer = document.getElementById('healthScoreChart');
            if (healthScoreContainer) {
                charts.healthScore = echarts.init(healthScoreContainer);
                
                // ä»URLè·å–customerIdå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                
                // è·å–æ—¥æœŸèŒƒå›´
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 7);
                
                const startDate = formatDate(yesterday);
                const endDate = formatDate(today);
                
                // è°ƒç”¨æ¥å£è·å–å¥åº·è¯„åˆ†æ•°æ®
                fetch(`/health_data/score?orgId=${customerId}&startDate=${startDate}&endDate=${endDate}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success && result.data && result.data.healthScores) {
                            const factors = result.data.healthScores.factors;
                            
                            // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
                            const totalScoreElement = document.querySelector('.total-score');
                            if (totalScoreElement) {
                                totalScoreElement.textContent = `æ€»åˆ†ï¼š${result.data.summary.overallScore}`;
                            }
                            const scoreNumberElement = document.querySelector('.score-number');
                            if (scoreNumberElement) {
                                scoreNumberElement.textContent = `${result.data.summary.overallScore}`;
                            }
                           
                            
                            // å…¼å®¹é©¼å³°å’Œä¸‹åˆ’çº¿å‘½åçš„è¾…åŠ©å‡½æ•°
                            function getFactorScore(factors, camelCase, snakeCase) {
                                return factors[camelCase]?.score || factors[snakeCase]?.score || 0;
                            }
                            
                            const healthScoreOption = {
                                tooltip: {
                                    trigger: 'axis',
                                    formatter: function(params) {
                                        return params[0].name + '<br/>' +
                                               params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                    }
                                },
                                radar: {
                                    radius: '65%',
                                    center: ['50%', '55%'],
                                    indicator: [
                                        { name: `å¿ƒç‡ ${getFactorScore(factors, 'heartRate', 'heart_rate')}åˆ†`, max: 100 },
                                        { name: `è¡€æ°§ ${getFactorScore(factors, 'bloodOxygen', 'blood_oxygen')}åˆ†`, max: 100 },
                                        { name: `ä½“æ¸© ${getFactorScore(factors, 'temperature', 'temperature')}åˆ†`, max: 100 },
                                        { name: `æ­¥æ•° ${getFactorScore(factors, 'step', 'step')}åˆ†`, max: 100 },
                                        { name: `å¡è·¯é‡Œ ${getFactorScore(factors, 'calorie', 'calorie')}åˆ†`, max: 100 },
                                        { name: `æ”¶ç¼©å‹ ${getFactorScore(factors, 'pressureHigh', 'pressure_high')}åˆ†`, max: 100 },
                                        { name: `èˆ’å¼ å‹ ${getFactorScore(factors, 'pressureLow', 'pressure_low')}åˆ†`, max: 100 },
                                        { name: `å‹åŠ› ${getFactorScore(factors, 'stress', 'stress')}åˆ†`, max: 100 }
                                    ],
                                    name: {
                                        textStyle: {
                                            color: '#00e4ff',
                                            fontSize: 12,
                                            padding: [3, 5]
                                        },
                                        rich: {
                                            value: {
                                                color: '#00e4ff',
                                                fontSize: 12,
                                                fontWeight: 'normal'
                                            }
                                        }
                                    },
                                    splitArea: {
                                        show: true,
                                        areaStyle: {
                                            color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                        }
                                    },
                                    axisLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.5)'
                                        }
                                    },
                                    splitLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.3)'
                                        }
                                    }
                                },
                                series: [{
                                    name: 'å¥åº·æŒ‡æ ‡',
                                    type: 'radar',
                                    data: [{
                                        value: [
                                            getFactorScore(factors, 'heartRate', 'heart_rate'),
                                            getFactorScore(factors, 'bloodOxygen', 'blood_oxygen'),
                                            getFactorScore(factors, 'temperature', 'temperature'),
                                            getFactorScore(factors, 'step', 'step'),
                                            getFactorScore(factors, 'calorie', 'calorie'),
                                            getFactorScore(factors, 'pressureHigh', 'pressure_high'),
                                            getFactorScore(factors, 'pressureLow', 'pressure_low'),
                                            getFactorScore(factors, 'stress', 'stress')
                                        ],
                                        name: 'å½“å‰çŠ¶æ€',
                                        itemStyle: {
                                            color: '#00e4ff'
                                        },
                                        areaStyle: {
                                            color: 'rgba(0,228,255,0.4)'
                                        }
                                    }]
                                }]
                            };
                            charts.healthScore.setOption(healthScoreOption);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º0åˆ†
                            const totalScoreElement = document.querySelector('.total-score');
                            if (totalScoreElement) {
                                totalScoreElement.textContent = 'æ€»åˆ†ï¼š0';
                            }
                            const scoreNumberElement = document.querySelector('.score-number');
                            if (scoreNumberElement) {
                                scoreNumberElement.textContent = `0`;
                            }
                            const scoreStatusElement = document.querySelector('.score-status');
                            if (scoreStatusElement) {
                                scoreStatusElement.textContent = `æš‚æ— æ•°æ®`;
                            }
                            
                            const healthScoreOption = {
                                tooltip: {
                                    trigger: 'axis',
                                    formatter: function(params) {
                                        return params[0].name + '<br/>' +
                                               params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                    }
                                },
                                radar: {
                                    radius: '65%',
                                    center: ['50%', '55%'],
                                    indicator: [
                                        { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                        { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                        { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                        { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                        { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                        { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                        { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                        { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                    ],
                                    name: {
                                        textStyle: {
                                            color: '#00e4ff',
                                            fontSize: 12,
                                            padding: [3, 5]
                                        },
                                        rich: {
                                            value: {
                                                color: '#00e4ff',
                                                fontSize: 12,
                                                fontWeight: 'normal'
                                            }
                                        }
                                    },
                                    splitArea: {
                                        show: true,
                                        areaStyle: {
                                            color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                        }
                                    },
                                    axisLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.5)'
                                        }
                                    },
                                    splitLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.3)'
                                        }
                                    }
                                },
                                series: [{
                                    name: 'å¥åº·æŒ‡æ ‡',
                                    type: 'radar',
                                    data: [{
                                        value: [0, 0, 0, 0, 0, 0, 0, 0],
                                        name: 'å½“å‰çŠ¶æ€',
                                        itemStyle: {
                                            color: '#00e4ff'
                                        },
                                        areaStyle: {
                                            color: 'rgba(0,228,255,0.4)'
                                        }
                                    }]
                                }]
                            };
                            charts.healthScore.setOption(healthScoreOption);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching health data:', error);
                        // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ˜¾ç¤º0åˆ†
                        const totalScoreElement = document.querySelector('.total-score');
                        if (totalScoreElement) {
                            totalScoreElement.textContent = 'æ€»åˆ†ï¼š0';
                        }
                        // è®¾ç½®é»˜è®¤çš„0åˆ†å›¾è¡¨
                        const healthScoreOption = {
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    return params[0].name + '<br/>' +
                                           params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                }
                            },
                            radar: {
                                radius: '65%',
                                center: ['50%', '55%'],
                                indicator: [
                                    { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                    { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                    { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                    { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                    { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                    { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                    { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                    { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                ],
                                name: {
                                    textStyle: {
                                        color: '#00e4ff',
                                        fontSize: 12,
                                        padding: [3, 5]
                                    },
                                    rich: {
                                        value: {
                                            color: '#00e4ff',
                                            fontSize: 12,
                                            fontWeight: 'normal'
                                        }
                                    }
                                },
                                splitArea: {
                                    show: true,
                                    areaStyle: {
                                        color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                    }
                                },
                                axisLine: {
                                    lineStyle: {
                                        color: 'rgba(0,228,255,0.5)'
                                    }
                                },
                                splitLine: {
                                    lineStyle: {
                                        color: 'rgba(0,228,255,0.3)'
                                    }
                                }
                            },
                            series: [{
                                name: 'å¥åº·æŒ‡æ ‡',
                                type: 'radar',
                                data: [{
                                    value: [0, 0, 0, 0, 0, 0, 0, 0],
                                    name: 'å½“å‰çŠ¶æ€',
                                    itemStyle: {
                                        color: '#00e4ff'
                                    },
                                    areaStyle: {
                                        color: 'rgba(0,228,255,0.4)'
                                    }
                                }]
                            }]
                        };
                        charts.healthScore.setOption(healthScoreOption);
                    });
            }

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡å›¾è¡¨
            // æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡å›¾è¡¨
            const statsContainer = document.getElementById('statsChart');
            if (statsContainer) {
                // åˆ›å»ºé»˜è®¤çš„è®¾å¤‡ç»Ÿè®¡ç»“æ„ï¼Œä¸initDeviceChartç›¸åŒé£æ ¼ä½†æ˜¾ç¤ºé»˜è®¤æ•°æ®
                statsContainer.innerHTML = `
                    <div style="position: relative; height: 100%; padding: 8px;">
                        <!-- è®¾å¤‡çŠ¶æ€æ€»è§ˆ -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 10px; background: rgba(0,228,255,0.1); border-radius: 6px; border-left: 4px solid #00e4ff;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="device-stat-item">
                                    <span style="color: #00ff9d; font-size: 18px; font-weight: bold;" id="onlineDevices">0</span>
                                    <span style="color: #fff; font-size: 12px; margin-left: 4px;">åœ¨çº¿</span>
                                </div>
                                <div class="device-stat-item">
                                    <span style="color: #ffbb00; font-size: 16px; font-weight: bold;" id="offlineDevices">0</span>
                                    <span style="color: #fff; font-size: 12px; margin-left: 4px;">ç¦»çº¿</span>
                                </div>
                                <div class="device-stat-item">
                                    <span style="color: #ff6666; font-size: 14px; font-weight: bold;" id="errorDevices">0</span>
                                    <span style="color: #fff; font-size: 12px; margin-left: 4px;">æ•…éšœ</span>
                                </div>
                            </div>
                            <div style="background: rgba(0,255,157,0.3); padding: 4px 8px; border-radius: 12px;" id="deviceStatusBadge">
                                <span style="color: #00ff9d; font-size: 11px; font-weight: bold;">âœ… æ­£å¸¸</span>
                            </div>
                        </div>
                        
                        <!-- å›¾è¡¨åŒºåŸŸ -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; height: calc(100% - 45px);">
                            <div id="deviceStatusChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                                <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ</div>
                            </div>
                            <div id="deviceTypeChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                                <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">è®¾å¤‡ç±»å‹åˆ†å¸ƒ</div>
                            </div>
                            <div id="deviceDeptChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                                <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">éƒ¨é—¨åˆ†å¸ƒ</div>
                            </div>
                            <div id="deviceTrendChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                                <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">ä½¿ç”¨è¶‹åŠ¿</div>
                            </div>
                        </div>
                    </div>
                `;

                // å»¶æ—¶åˆå§‹åŒ–é»˜è®¤å›¾è¡¨
                setTimeout(() => {
                    if (document.getElementById('deviceStatusChart')) {
                        // è®¾å¤‡çŠ¶æ€åˆ†å¸ƒå›¾
                        const statusChart = echarts.init(document.getElementById('deviceStatusChart'));
                        statusChart.setOption({
                            tooltip: { trigger: 'item', backgroundColor: 'rgba(0,21,41,0.95)', borderColor: '#00e4ff', textStyle: { color: '#fff', fontSize: 11 } },
                            series: [{ type: 'pie', radius: ['35%', '65%'], center: ['50%', '55%'], data: [
                                { name: 'æš‚æ— æ•°æ®', value: 1, itemStyle: { color: '#666' } }
                            ], label: { show: false } }]
                        });

                        // è®¾å¤‡ç±»å‹åˆ†å¸ƒå›¾
                        const typeChart = echarts.init(document.getElementById('deviceTypeChart'));
                        typeChart.setOption({
                            tooltip: { trigger: 'item', backgroundColor: 'rgba(0,21,41,0.95)', borderColor: '#00e4ff', textStyle: { color: '#fff', fontSize: 11 } },
                            series: [{ type: 'pie', radius: ['35%', '65%'], center: ['50%', '55%'], data: [
                                { name: 'æš‚æ— æ•°æ®', value: 1, itemStyle: { color: '#666' } }
                            ], label: { show: false } }]
                        });

                        // éƒ¨é—¨åˆ†å¸ƒå›¾
                        const deptChart = echarts.init(document.getElementById('deviceDeptChart'));
                        deptChart.setOption({
                            tooltip: { trigger: 'axis', backgroundColor: 'rgba(0,21,41,0.95)', borderColor: '#00e4ff', textStyle: { color: '#fff', fontSize: 11 } },
                            grid: { top: 25, left: 50, right: 15, bottom: 15 },
                            xAxis: { type: 'value', axisLabel: { color: '#7ecfff', fontSize: 9 }, splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)' } }, axisLine: { show: false }, max: 1 },
                            yAxis: { type: 'category', data: ['æš‚æ— æ•°æ®'], axisLabel: { color: '#fff', fontSize: 9 }, axisLine: { show: false }, axisTick: { show: false } },
                            series: [{ type: 'bar', data: [0], barWidth: '65%', itemStyle: { color: '#00e4ff88' } }]
                        });

                        // ä½¿ç”¨è¶‹åŠ¿å›¾
                        const trendChart = echarts.init(document.getElementById('deviceTrendChart'));
                        const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                        trendChart.setOption({
                            tooltip: { trigger: 'axis', backgroundColor: 'rgba(0,21,41,0.95)', borderColor: '#00e4ff', textStyle: { color: '#fff', fontSize: 11 } },
                            grid: { top: 25, left: 30, right: 15, bottom: 25 },
                            xAxis: { type: 'category', data: days, axisLabel: { color: '#7ecfff', fontSize: 8 }, axisLine: { show: false }, axisTick: { show: false } },
                            yAxis: { type: 'value', axisLabel: { color: '#7ecfff', fontSize: 8 }, splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)' } }, axisLine: { show: false } },
                            series: [{ type: 'line', data: [0, 0, 0, 0, 0, 0, 0], smooth: true, lineStyle: { color: '#00e4ff', width: 2 }, itemStyle: { color: '#00e4ff' }, symbol: 'circle', symbolSize: 4 }]
                        });
                    }
                }, 200);

                charts.stats = null; // å°†åœ¨initDeviceChartä¸­é‡æ–°è®¾ç½®
            }

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–é¢„è­¦ä¿¡æ¯å›¾è¡¨
            const alertContainer = document.getElementById('alertList');
            if (alertContainer) {
                // åˆ›å»ºé»˜è®¤çš„å‘Šè­¦ä¿¡æ¯ç»“æ„ï¼Œä¸initAlertChartç›¸åŒé£æ ¼ä½†æ˜¾ç¤ºé»˜è®¤æ•°æ®
                alertContainer.innerHTML = `
                    <div style="position: relative; height: 100%; padding: 8px;">
                        <!-- å‘Šè­¦çŠ¶æ€æ€»è§ˆ -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 10px; background: rgba(0,228,255,0.1); border-radius: 6px; border-left: 4px solid #00e4ff;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="alert-stat-item">
                                    <span style="color: #ff4444; font-size: 18px; font-weight: bold;" id="criticalCount">0</span>
                                    <span style="color: #fff; font-size: 12px; margin-left: 4px;">ä¸¥é‡</span>
                                </div>
                                <div class="alert-stat-item">
                                    <span style="color: #ffbb00; font-size: 16px; font-weight: bold;" id="mediumCount">0</span>
                                    <span style="color: #fff; font-size: 12px; margin-left: 4px;">ä¸­ç­‰</span>
                                </div>
                                <div class="alert-stat-item">
                                    <span style="color: #ff6666; font-size: 14px; font-weight: bold;" id="pendingCount">0</span>
                                    <span style="color: #fff; font-size: 12px; margin-left: 4px;">å¾…å¤„ç†</span>
                                </div>
                            </div>
                            <div style="background: rgba(0,255,157,0.3); padding: 4px 8px; border-radius: 12px;" id="alertBadge">
                                <span style="color: #00ff9d; font-size: 11px; font-weight: bold;">âœ… æ­£å¸¸</span>
                            </div>
                        </div>
                        
                        <!-- å›¾è¡¨åŒºåŸŸ -->
                        <div class="alert-charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; height: calc(100% - 45px);">
                            <div id="alertTypeChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                                <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">å‘Šè­¦ç±»å‹åˆ†å¸ƒ</div>
                            </div>
                            <div id="alertLevelChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                                <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">ä¸¥é‡ç¨‹åº¦åˆ†æ</div>
                            </div>
                            <div id="alertStatusChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                                <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">å¤„ç†çŠ¶æ€</div>
                            </div>
                            <div id="alertTrendChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                                <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">24å°æ—¶è¶‹åŠ¿</div>
                            </div>
                        </div>
                    </div>
                `;

                // å»¶æ—¶åˆå§‹åŒ–é»˜è®¤å›¾è¡¨
                setTimeout(() => {
                    if (document.getElementById('alertTypeChart')) {
                        // å‘Šè­¦ç±»å‹åˆ†å¸ƒå›¾ 
                        const typeChart = echarts.init(document.getElementById('alertTypeChart'));
                        typeChart.setOption({
                            tooltip: { trigger: 'axis', backgroundColor: 'rgba(0,21,41,0.95)', borderColor: '#00e4ff', textStyle: { color: '#fff', fontSize: 11 } },
                            grid: { top: 25, left: 50, right: 15, bottom: 15 },
                            xAxis: { type: 'value', axisLabel: { color: '#7ecfff', fontSize: 9 }, splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)' } }, axisLine: { show: false }, max: 1 },
                            yAxis: { type: 'category', data: ['æš‚æ— æ•°æ®'], axisLabel: { color: '#fff', fontSize: 9 }, axisLine: { show: false }, axisTick: { show: false } },
                            series: [{ type: 'bar', data: [0], barWidth: '65%', itemStyle: { color: '#00e4ff88' } }]
                        });

                        // å‘Šè­¦çº§åˆ«åˆ†å¸ƒå›¾
                        const levelChart = echarts.init(document.getElementById('alertLevelChart'));
                        levelChart.setOption({
                            tooltip: { trigger: 'item', backgroundColor: 'rgba(0,21,41,0.95)', borderColor: '#00e4ff', textStyle: { color: '#fff', fontSize: 11 } },
                            series: [{ type: 'pie', radius: ['35%', '65%'], center: ['50%', '55%'], data: [
                                { name: 'æš‚æ— æ•°æ®', value: 1, itemStyle: { color: '#666' } }
                            ], label: { show: false } }]
                        });

                        // å¤„ç†çŠ¶æ€å›¾
                        const statusChart = echarts.init(document.getElementById('alertStatusChart'));
                        statusChart.setOption({
                            tooltip: { trigger: 'item', backgroundColor: 'rgba(0,21,41,0.95)', borderColor: '#00e4ff', textStyle: { color: '#fff', fontSize: 11 } },
                            series: [{ type: 'pie', radius: ['35%', '65%'], center: ['50%', '55%'], data: [
                                { name: 'æš‚æ— æ•°æ®', value: 1, itemStyle: { color: '#666' } }
                            ], label: { show: false } }]
                        });

                        // 24å°æ—¶è¶‹åŠ¿å›¾
                        const trendChart = echarts.init(document.getElementById('alertTrendChart'));
                        const hours = ['00', '04', '08', '12', '16', '20'];
                        trendChart.setOption({
                            tooltip: { trigger: 'axis', backgroundColor: 'rgba(0,21,41,0.95)', borderColor: '#00e4ff', textStyle: { color: '#fff', fontSize: 11 } },
                            grid: { top: 25, left: 30, right: 15, bottom: 25 },
                            xAxis: { type: 'category', data: hours, axisLabel: { color: '#7ecfff', fontSize: 8 }, axisLine: { show: false }, axisTick: { show: false } },
                            yAxis: { type: 'value', axisLabel: { color: '#7ecfff', fontSize: 8 }, splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)' } }, axisLine: { show: false } },
                            series: [{ type: 'line', data: [0, 0, 0, 0, 0, 0], smooth: true, lineStyle: { color: '#00e4ff', width: 2 }, itemStyle: { color: '#00e4ff' }, symbol: 'circle', symbolSize: 4 }]
                        });
                    }
                }, 200);

                charts.alert = null; // å°†åœ¨initAlertChartä¸­é‡æ–°è®¾ç½®
            }

           // æ·»åŠ çª—å£resizeäº‹ä»¶ç›‘å¬
            window.addEventListener('resize', () => {
              Object.values(charts).forEach(chart => {
                  // æ£€æŸ¥æ˜¯å¦ä¸ºEChartså®ä¾‹å¹¶ä¸”æœ‰resizeæ–¹æ³•
                  if (chart && 
                      chart.resize && 
                      typeof chart.resize === 'function' && 
                      chart.getOption) { // EChartså®ä¾‹é€šå¸¸æœ‰getOptionæ–¹æ³•
                      try {
                          chart.resize();
                      } catch (error) {
                          console.warn('å›¾è¡¨resizeå¤±è´¥:', error);
                      }
                  }
              });
            });

            // åˆå§‹åŒ–æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨
            const messageStatsContainer = document.getElementById('messageStatsChart');
            if (messageStatsContainer) {
                charts.messageStats = echarts.init(messageStatsContainer);
                
                // æ¶ˆæ¯ç±»å‹é¢œè‰²å®šä¹‰ï¼ˆä¸message_view.htmlä¿æŒä¸€è‡´ï¼‰
                const messageTypeColors = {
                    'announcement': '#1890ff',  // è“è‰² - å…¬å‘Š
                    'notification': '#52c41a',  // ç»¿è‰² - é€šçŸ¥
                    'job': '#722ed1',          // ç´«è‰² - ä½œä¸šæŒ‡å¯¼
                    'task': '#fa8c16',         // æ©™è‰² - ä»»åŠ¡ç®¡ç†
                    'warning': '#f5222d'       // çº¢è‰² - å‘Šè­¦
                };
                
                // åˆå§‹åŒ–æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨
                const messageStatsOption = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        show: false
                    },
                    series: [{
                        name: 'æ¶ˆæ¯ç±»å‹',
                        type: 'pie',
                        radius: ['30%', '70%'],
                        center: ['50%', '60%'],
                        avoidLabelOverlap: false,
                        label: {
                            show: false
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '10',
                                fontWeight: 'bold',
                                color: '#fff'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: [
                            {value: 0, name: 'å…¬å‘Š', itemStyle: {color: messageTypeColors.announcement}},
                            {value: 0, name: 'å·¥ä½œæŒ‡å¼•', itemStyle: {color: messageTypeColors.job}},
                            {value: 0, name: 'é€šçŸ¥', itemStyle: {color: messageTypeColors.notification}},
                            {value: 0, name: 'ä»»åŠ¡ç®¡ç†', itemStyle: {color: messageTypeColors.task}},
                            {value: 0, name: 'å‘Šè­¦', itemStyle: {color: messageTypeColors.warning}}
                        ]
                    }]
                };
                charts.messageStats.setOption(messageStatsOption);
            }

            // è¿”å›å›¾è¡¨å®ä¾‹å¯¹è±¡ï¼Œä»¥ä¾¿å…¶ä»–åœ°æ–¹å¯èƒ½éœ€è¦ä½¿ç”¨
            return charts;

        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    // ä¿®æ”¹åˆå§‹åŒ–è°ƒç”¨
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            globalCharts = initCharts(); // å­˜å‚¨å›¾è¡¨å®ä¾‹
             // ğŸ—ºï¸ åœ°å›¾åˆå§‹åŒ– - ä¿®å¤åœ°å›¾æœªåˆå§‹åŒ–é—®é¢˜
        console.log('ğŸ—ºï¸ å¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
        try {
            initializeMap('{{ customerId }}', '-1');
            console.log('âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
        }
             // ç­‰å¾…åœ°å›¾åˆå§‹åŒ–å®Œæˆåå†åˆ·æ–°æ•°æ®
        setTimeout(() => {
            refreshData(); // åˆå§‹åŠ è½½æ•°æ®
        }, 500); // ç»™åœ°å›¾åˆå§‹åŒ–ç•™500msæ—¶é—´

            // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ•°æ®


            setInterval(refreshData, 60000);
        }, 100);
    });

    // ä¿®æ”¹æ¶ˆæ¯åˆ—è¡¨åˆå§‹åŒ–
    function initMessageList(data) {
        const messageList = document.getElementById('messageList');
        const messageCount = document.getElementById('messageCount');
        
        if (!messageList || !messageCount) return;
    
        // æ¶ˆæ¯ç±»å‹é¢œè‰²å®šä¹‰ï¼ˆå‚è€ƒmessage_view.htmlï¼‰
        const messageTypeColors = {
            'announcement': '#1890ff',  // è“è‰² - å…¬å‘Š
            'notification': '#52c41a',  // ç»¿è‰² - é€šçŸ¥
            'job': '#722ed1',          // ç´«è‰² - ä½œä¸šæŒ‡å¯¼
            'task': '#fa8c16',         // æ©™è‰² - ä»»åŠ¡ç®¡ç†
            'warning': '#f5222d'       // çº¢è‰² - å‘Šè­¦
        };

        const typeMap = {
            'announcement': 'å…¬å‘Š',
            'job': 'å·¥ä½œæŒ‡å¼•',
            'notification': 'é€šçŸ¥',
            'task': 'ä»»åŠ¡ç®¡ç†',
            'warning': 'å‘Šè­¦'
        };
    
        // ä»message_infoä¸­è·å–æ•°æ®
        //console.log('initMessageList.data', data);
        const messages = data.message_info.messages || [];
        // è¿‡æ»¤å‡ºçŠ¶æ€ä¸ºpendingçš„æ¶ˆæ¯
        const pendingMessages = messages.filter(msg => msg.message_status === 'pending' || msg.message_status === '1');
        
        // æ›´æ–°æ¶ˆæ¯è®¡æ•°
        messageCount.textContent = pendingMessages.length;

        // ç»Ÿè®¡æ¶ˆæ¯æ•°æ®
        const today = new Date().toDateString();
        const todayMessages = messages.filter(msg => new Date(msg.received_time).toDateString() === today).length;
        const unreadMessages = messages.filter(msg => msg.message_status === 'pending' || msg.message_status === '1').length;
        const urgentMessages = messages.filter(msg => msg.priority === 'high' || msg.priority === 'urgent').length;

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        document.getElementById('todayMessages').textContent = todayMessages;
        document.getElementById('unreadMessages').textContent = unreadMessages;
        document.getElementById('urgentMessages').textContent = urgentMessages;

        // ç»Ÿè®¡æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ - ä½¿ç”¨æ­£ç¡®çš„ç±»å‹æ˜ å°„
        const messageTypes = {
            'å…¬å‘Š': 0,
            'å·¥ä½œæŒ‡å¼•': 0,
            'é€šçŸ¥': 0,
            'ä»»åŠ¡ç®¡ç†': 0,
            'å‘Šè­¦': 0
        };

        messages.forEach(msg => {
            const type = msg.message_type || 'notification';
            const typeName = typeMap[type] || 'é€šçŸ¥';
            if (messageTypes.hasOwnProperty(typeName)) {
                messageTypes[typeName]++;
            }
        });

        // æ›´æ–°æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨
        if (globalCharts && globalCharts.messageStats) {
            const chartData = [
                {value: messageTypes['å…¬å‘Š'], name: 'å…¬å‘Š', itemStyle: {color: messageTypeColors.announcement}},
                {value: messageTypes['å·¥ä½œæŒ‡å¼•'], name: 'å·¥ä½œæŒ‡å¼•', itemStyle: {color: messageTypeColors.job}},
                {value: messageTypes['é€šçŸ¥'], name: 'é€šçŸ¥', itemStyle: {color: messageTypeColors.notification}},
                {value: messageTypes['ä»»åŠ¡ç®¡ç†'], name: 'ä»»åŠ¡ç®¡ç†', itemStyle: {color: messageTypeColors.task}},
                {value: messageTypes['å‘Šè­¦'], name: 'å‘Šè­¦', itemStyle: {color: messageTypeColors.warning}}
            ];
            
            globalCharts.messageStats.setOption({
                series: [{
                    data: chartData
                }]
            });
        }
    
        // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
        messageList.innerHTML = '';
    
        // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
    
        // æ·»åŠ æ‰€æœ‰æ¶ˆæ¯
        pendingMessages.forEach(message => {
            const msgType = message.message_type || 'notification';
            const msgColor = messageTypeColors[msgType] || messageTypeColors.notification;
            const msgTypeName = typeMap[msgType] || 'é€šçŸ¥';
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';
            messageElement.innerHTML = `
                <div class="message-header">
                    <span style="color: ${msgColor}; font-weight: bold;">[${msgTypeName}] ${message.department_name || 'æœªçŸ¥éƒ¨é—¨'}-${message.user_name || 'ç³»ç»Ÿ'}</span>
                    <span class="message-time">${message.received_time || new Date().toLocaleString()}</span>
                </div>
                <div class="message-content" style="border-left: 3px solid ${msgColor}; padding-left: 6px;">${message.message || 'æ— æ¶ˆæ¯å†…å®¹'}</div>
            `;
            messageContainer.appendChild(messageElement);
        });
    
        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
        if (pendingMessages.length === 0) {
            messageList.innerHTML = '<div class="no-messages">æš‚æ— å¾…å¤„ç†æ¶ˆæ¯</div>';
            return;
        }
    
        // å°†æ¶ˆæ¯å®¹å™¨æ·»åŠ åˆ°åˆ—è¡¨ä¸­
        messageList.appendChild(messageContainer);
    
        // æ·»åŠ æ ·å¼ - ç§»é™¤é‡å¤æ ·å¼é˜²æ­¢å†²çª
        const existingStyle = document.getElementById('message-scroll-styles');
        if (existingStyle) {
            existingStyle.remove();
        }
        
        const style = document.createElement('style');
        style.id = 'message-scroll-styles';
        style.textContent = `
            #messageList {
                height: calc(100% - 5px);
                overflow: hidden;
                position: relative;
                background: linear-gradient(135deg, rgba(0, 42, 74, 0.8), rgba(0, 74, 114, 0.6));
                border-radius: 8px;
                border: 1px solid rgba(0, 228, 255, 0.25);
                box-shadow: inset 0 1px 3px rgba(0, 228, 255, 0.1);
            }
    
            .message-container {
                display: flex;
                flex-direction: column;
                width: 100%;
                padding: 8px;
            }
    
            .message-item {
                background: linear-gradient(135deg, rgba(0, 62, 94, 0.8), rgba(0, 94, 134, 0.6));
                border: 1px solid rgba(0, 228, 255, 0.2);
                border-radius: 6px;
                padding: 8px 12px;
                margin-bottom: 6px;
                position: relative;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 15px rgba(0, 228, 255, 0.05);
            }
    
            .message-item::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                border-radius: 2px 0 0 2px;
                transition: all 0.3s ease;
            }
    
            .message-item.type-announcement::before { background: linear-gradient(135deg, #4A90E2, #357ABD); }
            .message-item.type-notification::before { background: linear-gradient(135deg, #7ED321, #5BA317); }
            .message-item.type-job::before { background: linear-gradient(135deg, #9013FE, #6A1B9A); }
            .message-item.type-task::before { background: linear-gradient(135deg, #FF9500, #E6830F); }
            .message-item.type-warning::before { background: linear-gradient(135deg, #F5A623, #E8940F); }
    
            .message-item:hover {
                transform: translateX(2px);
                border-color: rgba(64, 169, 255, 0.4);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 20px rgba(64, 169, 255, 0.1);
            }
    
            .message-item:last-child {
                margin-bottom: 0;
            }
    
            .message-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 4px;
            }
    
            .message-type-badge {
                display: inline-flex;
                align-items: center;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 10px;
                font-weight: 600;
                letter-spacing: 0.5px;
                text-transform: uppercase;
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
    
            .message-type-badge.announcement {
                background: linear-gradient(135deg, rgba(74, 144, 226, 0.2), rgba(53, 122, 189, 0.3));
                color: #87CEEB;
                border-color: rgba(74, 144, 226, 0.3);
            }
    
            .message-type-badge.notification {
                background: linear-gradient(135deg, rgba(126, 211, 33, 0.2), rgba(91, 163, 23, 0.3));
                color: #98FB98;
                border-color: rgba(126, 211, 33, 0.3);
            }
    
            .message-type-badge.job {
                background: linear-gradient(135deg, rgba(144, 19, 254, 0.2), rgba(106, 27, 154, 0.3));
                color: #DDA0DD;
                border-color: rgba(144, 19, 254, 0.3);
            }
    
            .message-type-badge.task {
                background: linear-gradient(135deg, rgba(255, 149, 0, 0.2), rgba(230, 131, 15, 0.3));
                color: #FFB84D;
                border-color: rgba(255, 149, 0, 0.3);
            }
    
            .message-type-badge.warning {
                background: linear-gradient(135deg, rgba(245, 166, 35, 0.2), rgba(232, 148, 15, 0.3));
                color: #FFC04D;
                border-color: rgba(245, 166, 35, 0.3);
            }
    
            .message-sender {
                color: rgba(255, 255, 255, 0.9);
                font-size: 11px;
                font-weight: 500;
                margin-left: 8px;
            }
    
            .message-time {
                color: rgba(64, 169, 255, 0.8);
                font-size: 9px;
                font-weight: 400;
                font-family: 'Consolas', 'Monaco', monospace;
                background: rgba(64, 169, 255, 0.1);
                padding: 2px 6px;
                border-radius: 4px;
                border: 1px solid rgba(64, 169, 255, 0.2);
            }
    
            .message-content {
                color: rgba(255, 255, 255, 0.95);
                font-size: 12px;
                line-height: 1.4;
                font-weight: 400;
                margin-top: 2px;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                max-height: 32px;
            }
    
            .no-messages {
                text-align: center;
                padding: 30px 20px;
                color: rgba(255, 255, 255, 0.4);
                font-size: 14px;
                background: linear-gradient(135deg, rgba(20, 45, 85, 0.3), rgba(30, 55, 95, 0.2));
                border-radius: 8px;
                border: 1px dashed rgba(64, 169, 255, 0.3);
                margin: 20px;
            }
    
            /* æ»šåŠ¨åŠ¨ç”» */
            .message-container.scrolling {
                animation: verticalScroll linear infinite;
            }
    
            @keyframes verticalScroll {
                0% {
                    transform: translateY(0);
                }
                100% {
                    transform: translateY(-50%);
                }
            }
    
            /* æ·»åŠ å‘¼å¸å…‰æ•ˆ */
            .message-item::after {
                content: '';
                position: absolute;
                top: -1px;
                left: -1px;
                right: -1px;
                bottom: -1px;
                background: linear-gradient(45deg, transparent, rgba(64, 169, 255, 0.1), transparent);
                border-radius: 6px;
                opacity: 0;
                animation: breathe 3s ease-in-out infinite;
                pointer-events: none;
                z-index: -1;
            }
    
            @keyframes breathe {
                0%, 100% { opacity: 0; }
                50% { opacity: 0.3; }
            }
        `;
        document.head.appendChild(style);
    
        // å®ç°æ»šåŠ¨é€»è¾‘
        setTimeout(() => {
            const containerHeight = messageList.clientHeight;
            const contentHeight = messageContainer.scrollHeight;
            
            console.log('Container height:', containerHeight, 'Content height:', contentHeight);
            
            if (contentHeight > containerHeight && pendingMessages.length > 3) {
                // å¤åˆ¶å†…å®¹å®ç°æ— ç¼æ»šåŠ¨
                messageContainer.innerHTML += messageContainer.innerHTML;
                
                // è®¡ç®—æ»šåŠ¨æ—¶é—´ï¼šæ¯ä¸ªæ¶ˆæ¯æ˜¾ç¤º3ç§’
                const scrollDuration = pendingMessages.length * 3;
                
                // æ·»åŠ æ»šåŠ¨ç±»å’Œè®¾ç½®åŠ¨ç”»æ—¶é—´
                messageContainer.classList.add('scrolling');
                messageContainer.style.animationDuration = `${scrollDuration}s`;
                
                console.log('å¯åŠ¨æ»šåŠ¨åŠ¨ç”»ï¼ŒæŒç»­æ—¶é—´:', scrollDuration + 's');
                
                // é¼ æ ‡æ‚¬åœæ§åˆ¶
                messageList.addEventListener('mouseenter', () => {
                    messageContainer.style.animationPlayState = 'paused';
                });
                
                messageList.addEventListener('mouseleave', () => {
                    messageContainer.style.animationPlayState = 'running';
                });
            } else {
                console.log('æ¶ˆæ¯æ•°é‡å°‘ï¼Œä¸å¯åŠ¨æ»šåŠ¨');
            }
            
            // æ·»åŠ æ¶ˆæ¯ç‚¹å‡»äº‹ä»¶
            addMessageClickEvents();
        }, 500); // å»¶è¿Ÿ500msç¡®ä¿DOMæ¸²æŸ“å®Œæˆ
    }

    // æ·»åŠ æ¶ˆæ¯é¢æ¿ç‚¹å‡»å¤„ç†å‡½æ•°
    function openMessagePanel() {
        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('customerId') || '1';
        createModalWindow('/message_view?customerId=' + customerId, 'æ¶ˆæ¯ç®¡ç†', '90%', '90%');
    }

    // æ·»åŠ æ¶ˆæ¯é¡¹ç‚¹å‡»äº‹ä»¶
    function addMessageClickEvents() {
        const messageItems = document.querySelectorAll('.message-item');
        messageItems.forEach(item => {
            item.addEventListener('click', openMessagePanel);
            item.style.cursor = 'pointer';
        });
    }
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=7de0c6b90cb13571ce931ca75a66c6e7"></script> 
    <script src="https://webapi.amap.com/loca?v=2.0.0&key=7de0c6b90cb13571ce931ca75a66c6e7"></script>
  
  
    <script>
      // Declare infoWindow globally
      // let infoWindow; // ç§»é™¤
      let geoLevelF,geoLevelE,geo,map,loca,breathGreen,breathRed,breathYellow;//å˜é‡åˆå¹¶

      

      // åœ°å›¾åˆå§‹åŒ–é‡è¯•è®¡æ•°å™¨å’ŒçŠ¶æ€é”
      let mapInitRetryCount = 0;
      const MAX_RETRY_COUNT = 3;
      let isMapInitializing = false;
      
      function initializeMap(deptId, userId, retryCount = 0) {
        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åˆå§‹åŒ–
        if (isMapInitializing && retryCount === 0) {
          console.warn('âš ï¸ åœ°å›¾æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
          return;
        }
        
        // æ£€æŸ¥é‡è¯•æ¬¡æ•°
        if (retryCount >= MAX_RETRY_COUNT) {
          console.error('ğŸš« åœ°å›¾åˆå§‹åŒ–é‡è¯•æ¬¡æ•°è¶…é™ï¼Œåœæ­¢é‡è¯•');
          isMapInitializing = false;
          return;
        }
        
        isMapInitializing = true;
        
        // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦å·²åŠ è½½
        if (typeof AMap === 'undefined') {
          console.error('AMap åº“æœªåŠ è½½ï¼Œå»¶è¿Ÿé‡è¯•...', `é‡è¯•æ¬¡æ•°: ${retryCount + 1}`);
          isMapInitializing = false; // é‡ç½®çŠ¶æ€é”
          setTimeout(() => initializeMap(deptId, userId, retryCount + 1), 1000);
          return;
        }
        if (typeof Loca === 'undefined') {
          console.error('Loca åº“æœªåŠ è½½ï¼Œå»¶è¿Ÿé‡è¯•...', `é‡è¯•æ¬¡æ•°: ${retryCount + 1}`);
          isMapInitializing = false; // é‡ç½®çŠ¶æ€é”
          setTimeout(() => initializeMap(deptId, userId, retryCount + 1), 1000);
          return;
        }
        
        console.log('AMapå’ŒLocaåº“åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾');
        
        // æ¸…ç†ä¹‹å‰çš„å®ä¾‹ï¼Œé¿å…å†²çª
        if (window.loca) {
          try {
            window.loca.destroy();
            console.log('ğŸ§¹ æ¸…ç†æ—§çš„Locaå®ä¾‹');
          } catch (e) {
            console.warn('æ¸…ç†æ—§Locaå®ä¾‹æ—¶å‡ºé”™:', e);
          }
        }
        if (window.map) {
          try {
            window.map.destroy();
            console.log('ğŸ§¹ æ¸…ç†æ—§çš„åœ°å›¾å®ä¾‹');
          } catch (e) {
            console.warn('æ¸…ç†æ—§åœ°å›¾å®ä¾‹æ—¶å‡ºé”™:', e);
          }
        }
        
        //console.log('initializeMap.deptId',deptId);
        //console.log('initializeMap.userId',userId);
        //console.log('initializeMap.severityLevel',`./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=critical`);

        // v1.0.32 - æ·»åŠ mediumçº§åˆ«å‘Šè­¦ç‚¹æ”¯æŒ
        const dataUrls = {
          critical: `./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=critical`,
          high: `./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=high`,
          medium: `./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=medium`, // æ–°å¢mediumçº§åˆ«
          health: `./generateHealthJson?customerId=${deptId}&userId=${userId}`
        };
        
        console.log('ğŸ”— æ•°æ®URLå‡†å¤‡å®Œæˆï¼Œç­‰å¾…åœ°å›¾åŠ è½½');
      
        let current_coordinates = {
          'longitude': 114.01508952,
          'latitude': 22.58036796,
          'altitude': 0
        }
    
        //console.log('current_coordinates',current_coordinates);
        
        console.log('ğŸ—ºï¸ å¼€å§‹åˆ›å»ºåœ°å›¾å®ä¾‹');
        map = window.map = new AMap.Map('map-container', {
            zoom: 17,
            center: [current_coordinates['longitude'],current_coordinates['latitude']],
            pitch: 45,
            showLabel: false,
            mapStyle: 'amap://styles/blue',
            viewMode: '3D',
        });

        // ç­‰å¾…åœ°å›¾å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–Locaå›¾å±‚  
        map.on('complete', function() {
          console.log('ğŸ‰ åœ°å›¾åŠ è½½å®Œæˆï¼Œå¼€å§‹å®Œæ•´çš„Locaåˆå§‹åŒ–æµç¨‹');
          
          // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿åœ°å›¾å†…éƒ¨çŠ¶æ€å®Œå…¨ç¨³å®š
          setTimeout(() => {
            // å†æ¬¡ç¡®ä¿åœ°å›¾å¯¹è±¡å­˜åœ¨ä¸”æœ‰æ•ˆ
            if (!map || !window.map || map !== window.map) {
              console.error('âŒ åœ°å›¾å¯¹è±¡ä¸å­˜åœ¨æˆ–æ— æ•ˆï¼Œæ— æ³•åˆ›å»ºLocaå®¹å™¨');
              isMapInitializing = false;
              return;
            }
            
            // æ£€æŸ¥åœ°å›¾å®¹å™¨DOMæ˜¯å¦å­˜åœ¨
            const mapContainer = document.getElementById('map-container');
            if (!mapContainer) {
              console.error('âŒ åœ°å›¾å®¹å™¨DOMä¸å­˜åœ¨');
              isMapInitializing = false;
              return;
            }

            try {
              console.log('ğŸ”§ æ­¥éª¤1: åˆ›å»ºLocaæ•°æ®æº');
              
              // v1.0.32 - åˆ›å»ºæ‰€æœ‰çº§åˆ«çš„æ•°æ®æºåŒ…æ‹¬medium
              geoLevelF = new Loca.GeoJSONSource({
                url: dataUrls.critical
              });
              
              geoLevelE = new Loca.GeoJSONSource({
                url: dataUrls.high
              });
              
              geoLevelM = new Loca.GeoJSONSource({
                url: dataUrls.medium
              });
              
              geo = new Loca.GeoJSONSource({
                url: dataUrls.health
              });
              
              console.log('âœ… Locaæ•°æ®æºåˆ›å»ºæˆåŠŸ');
              
              console.log('ğŸ”§ æ­¥éª¤2: åˆ›å»ºLocaå®¹å™¨');
              
              loca = new Loca.Container({
                map: window.map, // ä½¿ç”¨window.mapç¡®ä¿å¼•ç”¨æ­£ç¡®
              });
              
              // ç¡®ä¿Locaå®¹å™¨åˆ›å»ºæˆåŠŸä¸”æœ‰æ•ˆ
              if (!loca || !loca.map) {
                console.error('âŒ Locaå®¹å™¨åˆ›å»ºå¤±è´¥æˆ–mapå¼•ç”¨æ— æ•ˆ');
                isMapInitializing = false;
                return;
              }
              
              console.log('âœ… Locaå®¹å™¨åˆ›å»ºæˆåŠŸï¼Œå¼€å§‹åˆ›å»ºå›¾å±‚');
              
            } catch (error) {
              console.error('âŒ åˆ›å»ºLocaå®¹å™¨æˆ–æ•°æ®æºæ—¶å‡ºé”™:', error);
              isMapInitializing = false;
              return;
            }
                  
            try {
              console.log('ğŸ”§ æ­¥éª¤3: å¼€å§‹åˆ›å»ºå›¾å±‚');
              
              // éªŒè¯Locaå®¹å™¨å’Œåœ°å›¾çš„æœ‰æ•ˆæ€§
              if (!loca || !loca.map || !window.map) {
                console.error('âŒ å›¾å±‚åˆ›å»ºå‰æ£€æŸ¥å¤±è´¥ï¼šLocaå®¹å™¨æˆ–åœ°å›¾æ— æ•ˆ');
                isMapInitializing = false;
                return;
              }
              
              console.log('ğŸŸ¢ åˆ›å»ºç»¿è‰²å¥åº·ç‚¹å›¾å±‚');
              breathGreen = new Loca.ScatterLayer({
                loca,
                zIndex: 113,
                opacity: 1,
                visible: true,
                zooms: [2, 22],
              });
    
              // å®‰å…¨è®¾ç½®æ•°æ®æº
              if (geo) {
                breathGreen.setSource(geo);
              } else {
                console.warn('ç»¿è‰²ç‚¹æ•°æ®æºä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®');
              }
              
              breathGreen.setStyle({
                  unit: 'meter',
                  color: 'rgb(39, 207, 14)',
                  size: [10, 10],
                  borderWidth: 0,
                  exture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_green.png',
                  duration: 500,
                  animate: true,
              });
              
              // å®‰å…¨æ·»åŠ åˆ°åœ°å›¾ä¸­
              loca.add(breathGreen);
              console.log('âœ… ç»¿è‰²å¥åº·ç‚¹å›¾å±‚åˆ›å»ºæˆåŠŸ');
              
              console.log('ğŸ”´ åˆ›å»ºçº¢è‰²å‘Šè­¦ç‚¹å›¾å±‚');
              breathRed = new Loca.ScatterLayer({
                  loca,
                  zIndex: 113,
                  opacity: 1,
                  visible: true,
                  zooms: [2, 22],
              });
              
              // å®‰å…¨è®¾ç½®æ•°æ®æº
              if (geoLevelF) {
                breathRed.setSource(geoLevelF);
              } else {
                console.warn('çº¢è‰²ç‚¹æ•°æ®æºä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®');
              }
              
              breathRed.setStyle({
                  unit: 'meter',
                  size: [60, 60],
                  borderWidth: 0,
                  texture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_red.png',
                  duration: 500,
                  animate: true,
              });
              
              // å®‰å…¨æ·»åŠ åˆ°åœ°å›¾ä¸­
              loca.add(breathRed);
              console.log('âœ… çº¢è‰²å‘Šè­¦ç‚¹å›¾å±‚åˆ›å»ºæˆåŠŸ');
              
              console.log('ğŸŸ¡ åˆ›å»ºé»„è‰²å‘Šè­¦ç‚¹å›¾å±‚');
              breathYellow = new Loca.ScatterLayer({
                  loca,
                  zIndex: 112,
                  opacity: 1,
                  visible: true,
                  zooms: [2, 22],
              });
              
              // å®‰å…¨è®¾ç½®æ•°æ®æº
              if (geoLevelE) {
                breathYellow.setSource(geoLevelE);
              } else {
                console.warn('é»„è‰²ç‚¹æ•°æ®æºä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®');
              }
              
              breathYellow.setStyle({
                  unit: 'meter',
                  size: [50, 50],
                  borderWidth: 0,
                  texture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_yellow.png',
                  duration: 1000,
                  animate: true,
              });
              
              // å®‰å…¨æ·»åŠ åˆ°åœ°å›¾ä¸­
              loca.add(breathYellow);
              console.log('âœ… é»„è‰²å‘Šè­¦ç‚¹å›¾å±‚åˆ›å»ºæˆåŠŸ');
              
              console.log('ğŸŸ  åˆ›å»ºæ©™è‰²mediumå‘Šè­¦ç‚¹å›¾å±‚');
              breathOrange = new Loca.ScatterLayer({
                  loca,
                  zIndex: 111,
                  opacity: 1,
                  visible: true,
                  zooms: [2, 22],
              });
              
              // å®‰å…¨è®¾ç½®æ•°æ®æº
              if (geoLevelM) {
                breathOrange.setSource(geoLevelM);
              } else {
                console.warn('æ©™è‰²ç‚¹æ•°æ®æºä¸å­˜åœ¨ï¼Œè·³è¿‡è®¾ç½®');
              }
              
              breathOrange.setStyle({
                  unit: 'meter',
                  size: [40, 40],
                  borderWidth: 0,
                  texture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_orange.png',
                  duration: 800,
                  animate: true,
              });
              
              // å®‰å…¨æ·»åŠ åˆ°åœ°å›¾ä¸­
              loca.add(breathOrange);
              console.log('âœ… æ©™è‰²mediumå‘Šè­¦ç‚¹å›¾å±‚åˆ›å»ºæˆåŠŸ');
              
              console.log('ğŸ”§ æ­¥éª¤4: ç»‘å®šäº¤äº’äº‹ä»¶å’Œå¯åŠ¨åŠ¨ç”»');
              
              // v1.0.32 - æ·»åŠ ç‚¹å‡»äº‹ä»¶åŒ…å«æ‰€æœ‰å›¾å±‚
              if (window.map && breathRed && breathYellow && breathOrange && breathGreen) {
                window.map.on('click',e=>{
                  const p=e.pixel.toArray();
                  let f=breathRed.queryFeature(p)||breathYellow.queryFeature(p)||breathOrange.queryFeature(p)||breathGreen.queryFeature(p);
                  if(f&&f.coordinates){showCustomMapInfo(f)}else{removeCustomMapInfo()}
                });//ä¼˜å…ˆçº§ä¿®æ­£ï¼šçº¢>é»„>æ©™>ç»¿
                console.log('âœ… åœ°å›¾ç‚¹å‡»äº‹ä»¶ç»‘å®šæˆåŠŸ(åŒ…å«4ä¸ªå›¾å±‚)');
              } else {
                console.warn('âš ï¸ å›¾å±‚ä¸å®Œæ•´ï¼Œè·³è¿‡ç‚¹å‡»äº‹ä»¶ç»‘å®š');
              }
              
              // æœ€ç»ˆéªŒè¯åå¯åŠ¨æ¸²æŸ“åŠ¨ç”»
              if (loca && loca.animate) {
                loca.animate.start();
                console.log('âœ… Locaæ¸²æŸ“åŠ¨ç”»å¯åŠ¨æˆåŠŸ');
              } else {
                console.error('âŒ LocaåŠ¨ç”»å¯åŠ¨å¤±è´¥');
                isMapInitializing = false;
                return;
              }
              
              console.log('ğŸ‰ åœ°å›¾åˆå§‹åŒ–æµç¨‹å®Œå…¨æˆåŠŸï¼');
              isMapInitializing = false; // é‡ç½®çŠ¶æ€é”
              
            } catch (error) {
              console.error('âŒ åˆ›å»ºLocaå›¾å±‚æ—¶å‡ºé”™:', error);
              // å¦‚æœå›¾å±‚åˆ›å»ºå¤±è´¥ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–
              if (retryCount < MAX_RETRY_COUNT) {
                console.log(`ğŸ”„ å›¾å±‚åˆ›å»ºå¤±è´¥ï¼Œ3ç§’åé‡è¯•... (é‡è¯•æ¬¡æ•°: ${retryCount + 1})`);
                isMapInitializing = false; // é‡ç½®çŠ¶æ€é”ä»¥å…è®¸é‡è¯•
                setTimeout(() => initializeMap(deptId, userId, retryCount + 1), 3000);
              } else {
                console.error('ğŸš« å›¾å±‚åˆ›å»ºé‡è¯•æ¬¡æ•°è¶…é™ï¼Œåœæ­¢é‡è¯•');
                isMapInitializing = false; // é‡ç½®çŠ¶æ€é”
              }
            }
            
          }, 1000); // å»¶è¿Ÿ1000msç¡®ä¿åœ°å›¾å†…éƒ¨çŠ¶æ€å®Œå…¨ç¨³å®š
        });
    
  
  }
  
  //initializeMap('{{ customerId }}','-1');

      
  
  async function reverseGeocode(lng, lat) {
    try {
        const response = await fetch(`https://restapi.amap.com/v3/geocode/regeo?key=d45f28e481665db5b1145a5aa989e68a&location=${lng},${lat}`);
        const data = await response.json();
        
        if (data.status === '1') {
            const address = data.regeocode.formatted_address;
            console.log('Address:', address);
            return address;
        } else {
            console.error('Failed to reverse geocode:', data.info);
            return null;
        }
    } catch (error) {
        console.error('Error during reverse geocoding:', error);
        return null;
    }
  }


  function handleAlert(alertId) {
    fetch(`./dealAlert?alertId=${alertId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Alert processed:', data);
                showCustomAlert(data.message, () => {
                    location.reload();
                });
            } else {
                console.error('Failed to process alert:', data.message);
                showCustomAlert('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', null);
            }
        })
        .catch(error => {
            console.error('Error processing alert:', error);
            showCustomAlert('å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•', null);
        });
}

// æ·»åŠ è‡ªå®šä¹‰å¼¹å‡ºæ¡†å‡½æ•°
function showCustomAlert(message, callback) {
    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.className = 'custom-alert-overlay';
    document.body.appendChild(overlay);

    // åˆ›å»ºå¼¹å‡ºæ¡†
    const alertBox = document.createElement('div');
    alertBox.className = 'custom-alert';
    alertBox.innerHTML = `
        <div class="custom-alert-content">${message}</div>
        <button class="custom-alert-button">ç¡®å®š</button>
    `;
    document.body.appendChild(alertBox);

    // æ·»åŠ ç¡®å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const confirmButton = alertBox.querySelector('.custom-alert-button');
    confirmButton.onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(alertBox);
        if (callback) callback();
    };
}

  
  function mapAlertStatus(alertStatus) {
    switch (alertStatus) {
        case 'responded':
            return 'å·²å¤„ç†';
        case 'pending':
            return 'æœªå¤„ç†';
        case 'closed':
            return 'å·²å…³é—­';
        default:
            return 'æœªçŸ¥';
    }
}

// ç­›é€‰é¢æ¿ä¼¸ç¼©åŠŸèƒ½
function toggleFilter() {
    const p=document.getElementById('filterPanel'),t=document.getElementById('filterToggle');
    if(p.classList.contains('expanded')){p.classList.remove('expanded');t.textContent='ğŸ”';}
    else{p.classList.add('expanded');t.textContent='âœ•';}
}

// æ¨¡ç³Šæœç´¢åŠŸèƒ½
let allUsers=[],filteredUsers=[];
function initSearchFilter() {
    const searchInput=document.getElementById('searchInput'),userSelect=document.getElementById('userSelect'),deptSelect=document.getElementById('deptSelect');
    
    searchInput.addEventListener('input',e=>{
        const q=e.target.value.toLowerCase().trim();
        if(!q){filteredUsers=allUsers;updateUserSelect();}
        else{
            filteredUsers=allUsers.filter(u=>u.user_name?.toLowerCase().includes(q)||u.dept_name?.toLowerCase().includes(q)||u.device_sn?.toLowerCase().includes(q));
            updateUserSelect();
        }
    });
    
    deptSelect.addEventListener('change',e=>{
        const dept=e.target.value;
        filteredUsers=dept?allUsers.filter(u=>u.dept_name===dept):allUsers;
        updateUserSelect();
        searchInput.value='';
    });
}

function updateUserSelect() {
    const s=document.getElementById('userSelect');
    s.innerHTML='<option value="">é€‰æ‹©ç”¨æˆ·</option>';
    filteredUsers.forEach(u=>s.innerHTML+=`<option value="${u.user_id}">${u.user_name}${u.position?' - '+u.position:''}</option>`);
}

function setUsersData(users) {
    allUsers=users||[];filteredUsers=allUsers;updateUserSelect();
}

// æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­ç­›é€‰é¢æ¿çš„åŠŸèƒ½
document.addEventListener('click', function(event) {
    const filterPanel = document.querySelector('.filter-panel');
    const filterToggle = document.querySelector('.filter-toggle');
    
    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ç­›é€‰é¢æ¿å†…çš„å…ƒç´ ä¸”é¢æ¿æ˜¯å±•å¼€çš„
    if (!filterPanel.contains(event.target) && 
        !filterToggle.contains(event.target) && 
        !filterPanel.classList.contains('collapsed')) {
        toggleFilter();
    }
});

// é˜»æ­¢ç­›é€‰é¢æ¿å†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
document.querySelector('.filter-panel').addEventListener('click', function(event) {
    event.stopPropagation();
});

// åˆå§‹åŒ–äººå‘˜ç®¡ç†é¢æ¿
function initPersonnelManagementPanel(data) {
    // æ›´æ–°æ€»è§ˆæ•°æ®
    document.getElementById('totalUsers').innerText = data.user_info.totalUsers;
    document.getElementById('totalBindDevices').innerText = data.user_info.totalDevices;

    // åˆå§‹åŒ–éƒ¨é—¨åˆ†å¸ƒå›¾è¡¨
    initDepartmentDistribution(data);
}

// ä¿®æ”¹åˆå§‹åŒ–éƒ¨é—¨åˆ†å¸ƒå›¾è¡¨å‡½æ•° - ä¸“ä¸šç‰ˆ
function initDepartmentDistribution(data) {
    console.log('initDepartmentDistribution å¼€å§‹æ‰§è¡Œï¼Œæ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
    
    const userInfo = data.user_info || {};
    
    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡æ•°æ®
    const totalUsers = userInfo.totalUsers || 0;
    const totalDevices = userInfo.totalDevices || 0;
    const departmentCount = userInfo.departmentCount || {};
    const activeDeptCount = Object.keys(departmentCount).length;
    
    // æ¨¡æ‹Ÿåœ¨çº¿ç”¨æˆ·æ•°æ®ï¼ˆå®é™…åº”ä»åç«¯è·å–ï¼‰
    const onlineUsers = Math.floor(totalUsers * 0.75); // å‡è®¾75%åœ¨çº¿
    const onlineRate = totalUsers > 0 ? ((totalDevices / totalUsers) * 100).toFixed(1) : 0;
    const alertUsers = Math.floor(totalUsers * 0.1); // å‡è®¾10%æœ‰å‘Šè­¦
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('totalBindDevices').textContent = totalDevices;
    document.getElementById('onlineRate').textContent = onlineRate + '%';
    document.getElementById('activeDeptCount').textContent = activeDeptCount;
    document.getElementById('onlineUsers').textContent = onlineUsers;
    document.getElementById('boundDevices').textContent = totalDevices;
    document.getElementById('alertUsers').textContent = alertUsers;

    // 1. éƒ¨é—¨åˆ†å¸ƒå›¾è¡¨ - ç¯å½¢å›¾
    const departmentChart = echarts.init(document.getElementById('departmentDistribution'));
    
    // å¤„ç†éƒ¨é—¨æ•°æ®
    const departmentData = Object.entries(departmentCount)
        .map(([name, value]) => ({ name, value }))
        .sort((a, b) => b.value - a.value);

    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤çŠ¶æ€
    const hasDeptData = departmentData.length > 0 && departmentData.some(d => d.value > 0);
    const displayDeptData = hasDeptData ? departmentData : [
        { name: 'æš‚æ— éƒ¨é—¨', value: 1 }
    ];

    const deptColors = ['#00e4ff', '#00a8ff', '#0080ff', '#48cae4', '#90e0ef', '#a8dadc', '#457b9d'];

    const departmentOption = {
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            borderWidth: 1,
            textStyle: { color: '#fff', fontSize: 11 },
            formatter: function(params) {
                if (!hasDeptData) return 'æš‚æ— æ•°æ®';
                return `${params.name}<br/>äººæ•°: ${params.value}äºº<br/>å æ¯”: ${params.percent}%`;
            }
        },
        series: [{
            type: 'pie',
            radius: ['40%', '75%'],
            center: ['50%', '60%'],
            avoidLabelOverlap: true,
            itemStyle: {
                borderColor: 'rgba(0,21,41,0.8)',
                borderWidth: 2,
                shadowBlur: 8,
                shadowColor: 'rgba(0,228,255,0.3)'
            },
            label: {
                show: true,
                position: 'outside',
                color: '#fff',
                fontSize: 9,
                formatter: function(params) {
                    if (!hasDeptData) return '';
                    return params.value > 0 ? `${params.name}\n${params.value}äºº` : '';
                },
                lineHeight: 10
            },
            labelLine: {
                show: true,
                length: 6,
                length2: 4,
                lineStyle: { color: 'rgba(255,255,255,0.5)', width: 1 }
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 15,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0,228,255,0.6)',
                    scale: 1.05
                }
            },
            data: displayDeptData.map((item, index) => ({
                ...item,
                itemStyle: { color: deptColors[index % deptColors.length] }
            }))
        }]
    };
    departmentChart.setOption(departmentOption);
    
    // 2. ç”¨æˆ·çŠ¶æ€å›¾è¡¨ - æŸ±çŠ¶å›¾
    const statusChart = echarts.init(document.getElementById('userStatusChart'));

    // æ¨¡æ‹ŸçŠ¶æ€æ•°æ®
    const statusData = {
        online: onlineUsers,
        offline: totalUsers - onlineUsers,
        bound: totalDevices,
        unbound: totalUsers - totalDevices,
        alert: alertUsers,
        normal: totalUsers - alertUsers
    };

    const statusOption = {
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            textStyle: { color: '#fff', fontSize: 11 },
            formatter: function(params) {
                if (!params || !params[0]) return '';
                const data = params[0];
                return `${data.name}: ${data.value}äºº`;
            }
        },
        grid: {
            top: 25,
            left: 25,
            right: 15,
            bottom: 20,
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: ['åœ¨çº¿', 'ç¦»çº¿', 'ç»‘å®š', 'æœªç»‘å®š', 'å‘Šè­¦', 'æ­£å¸¸'],
            axisLabel: { 
                color: '#7ecfff', 
                fontSize: 9,
                interval: 0,
                rotate: 0
            },
            axisLine: { lineStyle: { color: 'rgba(126,207,255,0.3)' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            axisLabel: { color: '#7ecfff', fontSize: 9 },
            splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)', type: 'dashed' } },
            axisLine: { show: false }
        },
        series: [{
            type: 'bar',
            data: [
                { value: statusData.online, itemStyle: { color: '#00ff9d' } },
                { value: statusData.offline, itemStyle: { color: '#666' } },
                { value: statusData.bound, itemStyle: { color: '#ffbb00' } },
                { value: statusData.unbound, itemStyle: { color: '#ff8800' } },
                { value: statusData.alert, itemStyle: { color: '#ff4444' } },
                { value: statusData.normal, itemStyle: { color: '#00e4ff' } }
            ],
            barWidth: '60%',
            label: {
                show: true,
                position: 'top',
                color: '#fff',
                fontSize: 9,
                formatter: '{c}'
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowColor: 'rgba(0,228,255,0.5)'
                }
            }
        }]
    };
    statusChart.setOption(statusOption);

    // è‡ªé€‚åº”å¤§å°
    const resizeCharts = () => {
        try {
            departmentChart && departmentChart.resize();
            statusChart && statusChart.resize();
        } catch (e) {
            console.warn('äººå‘˜ç®¡ç†å›¾è¡¨resizeå¤±è´¥:', e);
        }
    };
    
    window.addEventListener('resize', resizeCharts);

    // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
    setTimeout(() => {
        resizeCharts();
        console.log('äººå‘˜ç®¡ç†å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
    }, 200);

    // å›¾è¡¨ç‚¹å‡»äº¤äº’
    departmentChart.on('click', function(params) {
        if (hasDeptData && params.data && params.data.value > 0) {
            showDepartmentDetails(params.data.name, params.data.value);
        }
    });

    statusChart.on('click', function(params) {
        const statusName = params.name;
        const statusValue = params.value;
        showStatusDetails(statusName, statusValue);
        });

    return { departmentChart, statusChart };
}

function getPastDateStr(daysAgo) {
    const d = new Date();
    d.setDate(d.getDate() - daysAgo);
    return d.toISOString().slice(0,10);
  }
  function loadHealthScoreChart(customerId) {
    console.log('loadHealthScoreChart å¼€å§‹æ‰§è¡Œï¼ŒcustomerId:', customerId);
    
    const endDate = getPastDateStr(0), startDate = getPastDateStr(6);
    
    if (globalCharts.healthScore) {
      // è·å–æ—¥æœŸèŒƒå›´
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 7);
      
      const startDate = formatDate(yesterday);
      const endDate = formatDate(today);
      
      fetch(`/health_data/score?orgId=${customerId}&startDate=${startDate}&endDate=${endDate}`)
          .then(response => response.json())
          .then(result => {
              if (result.success && result.data && result.data.healthScores) {
                  const factors = result.data.healthScores.factors;
                  console.log('factors',factors);
                  
                  // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
                  const totalScoreElement = document.querySelector('.total-score');
                  if (totalScoreElement) {
                      totalScoreElement.textContent = `æ€»åˆ†ï¼š${result.data.summary.overallScore}`;
                  }
                  
                  // å…¼å®¹é©¼å³°å’Œä¸‹åˆ’çº¿å‘½åçš„è¾…åŠ©å‡½æ•°
                  function getFactorScore(factors, camelCase, snakeCase) {
                      return factors[camelCase]?.score || factors[snakeCase]?.score || 0;
                  }
                  
                  const healthScoreOption = {
                      tooltip: {
                          trigger: 'axis',
                          formatter: function(params) {
                              return params[0].name + '<br/>' +
                                     params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                          }
                      },
                      radar: {
                          radius: '65%',
                          center: ['50%', '55%'],
                          indicator: [
                              { name: `å¿ƒç‡ ${getFactorScore(factors, 'heartRate', 'heart_rate')}åˆ†`, max: 100 },
                              { name: `è¡€æ°§ ${getFactorScore(factors, 'bloodOxygen', 'blood_oxygen')}åˆ†`, max: 100 },
                              { name: `ä½“æ¸© ${getFactorScore(factors, 'temperature', 'temperature')}åˆ†`, max: 100 },
                              { name: `æ­¥æ•° ${getFactorScore(factors, 'step', 'step')}åˆ†`, max: 100 },
                              { name: `å¡è·¯é‡Œ ${getFactorScore(factors, 'calorie', 'calorie')}åˆ†`, max: 100 },
                              { name: `æ”¶ç¼©å‹ ${getFactorScore(factors, 'pressureHigh', 'pressure_high')}åˆ†`, max: 100 },
                              { name: `èˆ’å¼ å‹ ${getFactorScore(factors, 'pressureLow', 'pressure_low')}åˆ†`, max: 100 },
                              { name: `å‹åŠ› ${getFactorScore(factors, 'stress', 'stress')}åˆ†`, max: 100 }
                          ],
                          name: {
                              textStyle: {
                                  color: '#00e4ff',
                                  fontSize: 12,
                                  padding: [3, 5]
                              },
                              rich: {
                                  value: {
                                      color: '#00e4ff',
                                      fontSize: 12,
                                      fontWeight: 'normal'
                                  }
                              }
                          },
                          splitArea: {
                              show: true,
                              areaStyle: {
                                  color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                              }
                          },
                          axisLine: {
                              lineStyle: {
                                  color: 'rgba(0,228,255,0.5)'
                              }
                          },
                          splitLine: {
                              lineStyle: {
                                  color: 'rgba(0,228,255,0.3)'
                              }
                          }
                      },
                      series: [{
                          name: 'å¥åº·æŒ‡æ ‡',
                          type: 'radar',
                          data: [{
                              value: [
                                  getFactorScore(factors, 'heartRate', 'heart_rate'),
                                  getFactorScore(factors, 'bloodOxygen', 'blood_oxygen'),
                                  getFactorScore(factors, 'temperature', 'temperature'),
                                  getFactorScore(factors, 'step', 'step'),
                                  getFactorScore(factors, 'calorie', 'calorie'),
                                  getFactorScore(factors, 'pressureHigh', 'pressure_high'),
                                  getFactorScore(factors, 'pressureLow', 'pressure_low'),
                                  getFactorScore(factors, 'stress', 'stress')
                              ],
                              name: 'å½“å‰çŠ¶æ€',
                              itemStyle: {
                                  color: '#00e4ff'
                              },
                              areaStyle: {
                                  color: 'rgba(0,228,255,0.4)'
                              }
                          }]
                      }]
                  };
                  globalCharts.healthScore.setOption(healthScoreOption);
              } else {
                  // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º0åˆ†
                  const totalScoreElement = document.querySelector('.total-score');
                  if (totalScoreElement) {
                      totalScoreElement.textContent = 'æ€»åˆ†ï¼š0';
                  }
                  
                  const healthScoreOption = {
                      tooltip: {
                          trigger: 'axis',
                          formatter: function(params) {
                              return params[0].name + '<br/>' +
                                     params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                          }
                      },
                      radar: {
                          radius: '65%',
                          center: ['50%', '55%'],
                          indicator: [
                              { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                              { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                              { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                              { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                              { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                              { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                              { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                              { name: 'å‹åŠ› 0åˆ†', max: 100 }
                          ],
                          name: {
                              textStyle: {
                                  color: '#00e4ff',
                                  fontSize: 12,
                                  padding: [3, 5]
                              },
                              rich: {
                                  value: {
                                      color: '#00e4ff',
                                      fontSize: 12,
                                      fontWeight: 'normal'
                                  }
                              }
                          },
                          splitArea: {
                              show: true,
                              areaStyle: {
                                  color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                              }
                          },
                          axisLine: {
                              lineStyle: {
                                  color: 'rgba(0,228,255,0.5)'
                              }
                          },
                          splitLine: {
                              lineStyle: {
                                  color: 'rgba(0,228,255,0.3)'
                              }
                          }
                      },
                      series: [{
                          name: 'å¥åº·æŒ‡æ ‡',
                          type: 'radar',
                          data: [{
                              value: [0, 0, 0, 0, 0, 0, 0, 0],
                              name: 'å½“å‰çŠ¶æ€',
                              itemStyle: {
                                  color: '#00e4ff'
                              },
                              areaStyle: {
                                  color: 'rgba(0,228,255,0.4)'
                              }
                          }]
                      }]
                  };
                  globalCharts.healthScore.setOption(healthScoreOption);
              }
          })
          .catch(error => {
              console.error('Error fetching health data:', error);
              // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ˜¾ç¤º0åˆ†
              const totalScoreElement = document.querySelector('.total-score');
              if (totalScoreElement) {
                  totalScoreElement.textContent = 'æ€»åˆ†ï¼š0';
              }
              // è®¾ç½®é»˜è®¤çš„0åˆ†å›¾è¡¨
              const healthScoreOption = {
                  tooltip: {
                      trigger: 'axis',
                      formatter: function(params) {
                          return params[0].name + '<br/>' +
                                 params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                      }
                  },
                  radar: {
                      radius: '65%',
                      center: ['50%', '55%'],
                      indicator: [
                          { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                          { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                          { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                          { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                          { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                          { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                          { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                          { name: 'å‹åŠ› 0åˆ†', max: 100 }
                      ],
                      name: {
                          textStyle: {
                              color: '#00e4ff',
                              fontSize: 12,
                              padding: [3, 5]
                          },
                          rich: {
                              value: {
                                  color: '#00e4ff',
                                  fontSize: 12,
                                  fontWeight: 'normal'
                              }
                          }
                      },
                      splitArea: {
                          show: true,
                          areaStyle: {
                              color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                          }
                      },
                      axisLine: {
                          lineStyle: {
                              color: 'rgba(0,228,255,0.5)'
                          }
                      },
                      splitLine: {
                          lineStyle: {
                              color: 'rgba(0,228,255,0.3)'
                          }
                      }
                  },
                  series: [{
                      name: 'å¥åº·æŒ‡æ ‡',
                      type: 'radar',
                      data: [{
                          value: [0, 0, 0, 0, 0, 0, 0, 0],
                          name: 'å½“å‰çŠ¶æ€',
                          itemStyle: {
                              color: '#00e4ff'
                          },
                          areaStyle: {
                              color: 'rgba(0,228,255,0.4)'
                          }
                      }]
                  }]
              };
              globalCharts.healthScore.setOption(healthScoreOption);
          });
  }
  }
  
  function loadBaselineTrendChart(orgId) {
    console.log('loadBaselineTrendChart å¼€å§‹æ‰§è¡Œï¼ŒorgId:', orgId);
    
    const endDate = getPastDateStr(0), startDate = getPastDateStr(6);
    
    fetch(`/health_data/chart/baseline?orgId=${orgId}&startDate=${startDate}&endDate=${endDate}`)
      .then(r=>r.json())
      .then(result=>{
        console.log('å¥åº·æ•°æ®æ¥å£è¿”å›:', result);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™ç”Ÿæˆbaseline
        if (!result || !result.dates || result.dates.length === 0) {
          console.warn('baselineæ•°æ®ç¼ºå¤±ï¼Œå¼€å§‹ç”Ÿæˆbaseline');
          return generateBaselineAndRetry(orgId, startDate, endDate);
        }
        
        renderHealthChart(result);
      })
      .catch(error => {
        console.error('å¥åº·æ•°æ®åŠ è½½å¤±è´¥:', error);
        // å°è¯•ç”Ÿæˆbaselineåé‡è¯•
        generateBaselineAndRetry(orgId, startDate, endDate);
      });
  }

  // ç”Ÿæˆbaselineå¹¶é‡è¯•è·å–æ•°æ®
  function generateBaselineAndRetry(orgId, startDate, endDate) {
    console.log('æ­£åœ¨ç”Ÿæˆbaselineæ•°æ®...');
    
    fetch('/api/baseline/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ target_date: endDate })
    })
    .then(r => r.json())
    .then(generateResult => {
      console.log('baselineç”Ÿæˆç»“æœ:', generateResult);
      
      if (generateResult.success) {
        // ç”ŸæˆæˆåŠŸåé‡æ–°è·å–æ•°æ®
        return fetch(`/health_data/chart/baseline?orgId=${orgId}&startDate=${startDate}&endDate=${endDate}`);
      } else {
        throw new Error('baselineç”Ÿæˆå¤±è´¥: ' + generateResult.error);
      }
    })
    .then(r => r.json())
    .then(result => {
      console.log('é‡æ–°è·å–çš„å¥åº·æ•°æ®:', result);
      renderHealthChart(result);
    })
    .catch(error => {
      console.error('ç”Ÿæˆbaselineæˆ–é‡æ–°è·å–æ•°æ®å¤±è´¥:', error);
      //showDefaultHealthData();
    });
  }

  // æ¸²æŸ“å¥åº·å›¾è¡¨ - ä¸“ä¸šäº®çœ¼ç‰ˆæœ¬ v1.0.34
  function renderHealthChart(result) {
    const {dates, metrics, health_summary} = result;
    console.log('ğŸ¯ renderHealthChart æ¥æ”¶æ•°æ®:', {dates, metrics: metrics?.map(m=>({name:m.name,count:m.values?.length}))});

    const trendChart = echarts.init(document.getElementById('trendChart'));
    
    // å¤§å±ç§‘æŠ€é£æ ¼å¥åº·æŒ‡æ ‡é…ç½® - åè°ƒç‰ˆ v1.0.34
    const healthMetrics = {
      'å¿ƒç‡': { color: '#ff6b9d', icon: 'ğŸ’—', gradient: ['#ff6b9d', '#ff8fb3'], range: [60, 100] },
      'è¡€æ°§': { color: '#00e4ff', icon: 'ğŸ«', gradient: ['#00e4ff', '#5beeff'], range: [95, 100] },
      'ä½“æ¸©': { color: '#ffaa00', icon: 'ğŸŒ¡ï¸', gradient: ['#ffaa00', '#ffcc55'], range: [36, 38] },
      'å‹åŠ›': { color: '#ff7700', icon: 'ğŸ˜°', gradient: ['#ff7700', '#ff9944'], range: [0, 100] },
      'ç¡çœ ': { color: '#7ecfff', icon: 'ğŸ˜´', gradient: ['#7ecfff', '#a8d8ff'], range: [6, 10] }
    };
    
    const series = [];
    
    // å¤„ç†ç°æœ‰æ•°æ®
    if (metrics?.length > 0) {
      Object.keys(healthMetrics).forEach(metricName => {
        const metric = metrics.find(m => m.name === metricName);
        if (metric?.values?.length > 0) {
          const config = healthMetrics[metricName];
          series.push({
            name: metricName,
            type: 'line',
            data: metric.values,
            smooth: true,
            symbol: 'circle',
            symbolSize: 6,
            lineStyle: { 
              width: 3, 
              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                { offset: 0, color: config.gradient[0] },
                { offset: 1, color: config.gradient[1] }
              ]),
              shadowColor: config.color + '40',
              shadowBlur: 8
            },
            itemStyle: { 
              color: config.color,
              borderColor: '#001529',
              borderWidth: 1,
              shadowColor: config.color,
              shadowBlur: 6
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: config.color + '30' },
                { offset: 1, color: config.color + '05' }
              ])
            },
            emphasis: {
              focus: 'series',
              scale: 1.1
            }
          });
        }
      });
    }
    
    // å¦‚æœæ²¡æœ‰ç¡çœ æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
    const hasSleep = series.some(s => s.name === 'ç¡çœ ');
    if (!hasSleep && dates?.length > 0) {
      console.log('âš ï¸ æœªæ‰¾åˆ°ç¡çœ æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®');
      const sleepData = dates.map(() => (7 + Math.random() * 2).toFixed(1));
      const sleepConfig = healthMetrics['ç¡çœ '];
      series.push({
        name: 'ç¡çœ ',
        type: 'line',
        data: sleepData,
        smooth: true,
        symbol: 'circle',
        symbolSize: 6,
        lineStyle: { 
          width: 3, 
          color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
            { offset: 0, color: sleepConfig.gradient[0] },
            { offset: 1, color: sleepConfig.gradient[1] }
          ]),
          shadowColor: sleepConfig.color + '40',
          shadowBlur: 8
        },
        itemStyle: { 
          color: sleepConfig.color,
          borderColor: '#001529',
          borderWidth: 1,
          shadowColor: sleepConfig.color,
          shadowBlur: 6
        },
        areaStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 0, color: sleepConfig.color + '30' },
            { offset: 1, color: sleepConfig.color + '05' }
          ])
        }
      });
    }
    
    console.log('ğŸ“Š å›¾è¡¨ç³»åˆ—æ•°æ®:', series.map(s=>({name:s.name,dataCount:s.data?.length})));
    
    const trendOption = {
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(10,24,48,0.95)',
        borderColor: '#00e4ff',
        borderWidth: 1,
        textStyle: { color: '#fff', fontSize: 10 },
        formatter: function(params) {
          let result = params[0].axisValue + '<br/>';
          params.forEach(param => {
            const unit = getMetricUnit(param.seriesName);
            result += `${param.seriesName}: ${param.value}${unit}<br/>`;
          });
          return result;
        }
      },
      legend: {
        show: true,
        top: 5,
        right: 15,
        textStyle: { color: '#7ecfff', fontSize: 10 },
        itemGap: 12,
        formatter: function(name) {
          return name;
        }
      },
      grid: { 
        top: 35, 
        left: 35, 
        right: 20, 
        bottom: 25, 
        containLabel: true,
        backgroundColor: 'transparent'
      },
      xAxis: {
        type: 'category',
        data: dates || [],
        axisLabel: { 
          color: '#7ecfff', 
          fontSize: 10,
          fontWeight: 'bold',
          interval: 0,
          rotate: dates?.length > 5 ? 45 : 0
        },
        axisLine: { 
          lineStyle: { color: 'rgba(0,228,255,0.4)', width: 2 }
        },
        axisTick: {
          lineStyle: { color: 'rgba(0,228,255,0.3)' }
        }
      },
      yAxis: {
        type: 'value',
        axisLabel: { 
          color: '#7ecfff', 
          fontSize: 10,
          fontWeight: 'bold'
        },
        splitLine: { 
          lineStyle: { 
            color: 'rgba(0,228,255,0.15)', 
            type: 'dashed',
            width: 1
          } 
        },
        axisLine: {
          lineStyle: { color: 'rgba(0,228,255,0.4)', width: 2 }
        }
      },
      series,
      animation: true,
      animationDuration: 1500,
      animationEasing: 'cubicOut'
    };
    
    trendChart.setOption(trendOption, true);
    
    // ä¸“ä¸šäº¤äº’äº‹ä»¶
    trendChart.on('click', function(params) {
      console.log('ğŸ” å¥åº·æ•°æ®ç‚¹å‡»:', params);
      const metric = params.seriesName;
      const value = params.value;
      const date = params.name;
      showHealthDetailModal(metric, value, date);
    });
    
    // æ‚¬åœé«˜äº®æ•ˆæœ
    trendChart.on('mouseover', function(params) {
      if (params.componentType === 'series') {
        trendChart.dispatchAction({
          type: 'highlight',
          seriesIndex: params.seriesIndex
        });
      }
    });
    
    // å“åº”å¼è°ƒæ•´
    const resizeChart = () => {
      if (trendChart && !trendChart.isDisposed()) {
        trendChart.resize();
      }
    };
    window.removeEventListener('resize', resizeChart);
    window.addEventListener('resize', resizeChart);
  }
  
  // æ˜¾ç¤ºå¥åº·æ•°æ®è¯¦æƒ…å¼¹çª—
  function showHealthDetailModal(metric, value, date) {
    const healthMetrics = {
      'å¿ƒç‡': { color: '#ff6b9d', icon: 'ğŸ’—' },
      'è¡€æ°§': { color: '#00e4ff', icon: 'ğŸ«' },
      'ä½“æ¸©': { color: '#ffaa00', icon: 'ğŸŒ¡ï¸' },
      'å‹åŠ›': { color: '#ff7700', icon: 'ğŸ˜°' },
      'ç¡çœ ': { color: '#7ecfff', icon: 'ğŸ˜´' }
    };
    const icon = healthMetrics[metric]?.icon || 'ğŸ“Š';
    const color = healthMetrics[metric]?.color || '#00e4ff';
    const unit = getMetricUnit(metric);
    console.log(`${icon} ${metric}: ${value}${unit} (${date})`);
  }

  // è·å–æŒ‡æ ‡å•ä½
  function getMetricUnit(metricName) {
    const units = {
      'å¿ƒç‡': 'bpm',
      'è¡€æ°§': '%',
      'ä½“æ¸©': 'Â°C',
      'å‹åŠ›': '',
      'ç¡çœ ': 'h'
    };
    return units[metricName] || '';
  }


// ä¿®æ”¹æ•°æ®åˆ·æ–°å‡½æ•°
function refreshData() {
    // ä» URL è·å– customerId å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    console.log('urlParams', urlParams.get('customerId'));
    const customerId = urlParams.get('customerId') || '1';
    loadBaselineTrendChart(customerId);
    loadHealthScoreChart(customerId);
    loadStatisticsData();
    //loadMessages(); // åŠ è½½æ¶ˆæ¯æ•°æ®

    fetch(`/get_total_info?customer_id=${customerId}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                console.log('Refreshing data:', data);

                lastTotalInfo = data;
               
                updateMapData(data);
               

                // æ›´æ–°äººå‘˜ç®¡ç†é¢æ¿
                initPersonnelManagementPanel(data);

                // æ›´æ–°å‘Šè­¦ä¿¡æ¯å›¾è¡¨
                initAlertChart(data);

                // æ›´æ–°è®¾å¤‡ç®¡ç†å›¾è¡¨
                initDeviceChart(data);

                // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                initMessageList(data);

                // ä¸ºå„ä¸ªé¢æ¿æ·»åŠ ç‚¹å‡»äº‹ä»¶
                setupPanelClickEvents(customerId, data);
            }
        })
        .catch(error => console.error('Error fetching data:', error));
}

// å°†é¢æ¿ç‚¹å‡»äº‹ä»¶è®¾ç½®æŠ½å–ä¸ºå•ç‹¬çš„å‡½æ•°
function setupPanelClickEvents(customerId, data) {
    // 1. å‘Šè­¦ä¿¡æ¯é¢æ¿
    const alertPanel = document.querySelector('.panel:has(#alertList)');
    if (alertPanel) {
        alertPanel.style.cursor = 'pointer';
        alertPanel.onclick = function() {
            createModalWindow(`/alert_view.html?customerId=${customerId}`, data.alert_info || null, 'alertInfo');
        };
    }

    // 2. è®¾å¤‡ç®¡ç†é¢æ¿
    const devicePanel = document.querySelector('.panel:has(#statsChart)');
    if (devicePanel) {
        devicePanel.style.cursor = 'pointer';
        devicePanel.onclick = function() {
            console.log('ğŸ”§ ç‚¹å‡»è®¾å¤‡ç®¡ç†é¢æ¿ï¼Œè·³è½¬åˆ°è®¾å¤‡è§†å›¾ (ç®€åŒ–æ¨¡å¼)');
            
            // åˆ›å»ºç®€åŒ–çš„æ¨¡æ€çª—å£ï¼Œä¸ä¼ é€’å¤æ‚æ•°æ®ï¼Œç±»ä¼¼personal.htmlçš„æ–¹å¼
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal-container';
            modalContainer.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close">âœ–</button>
                    <iframe src="/device_view.html?customerId=${customerId}" class="user-view-iframe"></iframe>
                </div>
            `;
            
            document.body.appendChild(modalContainer);
            
            // æ·»åŠ ç®€åŒ–æ ·å¼
            if (!document.getElementById('simpleModalStyles')) {
                const style = document.createElement('style');
                style.id = 'simpleModalStyles';
                style.textContent = `
                    .modal-container {
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
                        display: flex; justify-content: center; align-items: center; z-index: 9999; animation: fadeIn 0.3s ease;
                    }
                    .modal-content {
                        position: relative; width: 90%; height: 90%; background: rgba(0,21,41,0.95);
                        border: 1px solid rgba(0,228,255,0.3); border-radius: 8px; padding: 20px;
                        box-shadow: 0 0 20px rgba(0,228,255,0.2); animation: slideIn 0.3s ease;
                    }
                    .modal-close {
                        position: absolute; top: 10px; right: 10px; background: transparent; border: none;
                        color: #00e4ff; font-size: 18px; cursor: pointer; z-index: 1; padding: 5px 10px; transition: all 0.3s ease;
                    }
                    .modal-close:hover { transform: scale(1.1); color: #ff4444; }
                    .user-view-iframe { width: 100%; height: 100%; border: none; border-radius: 4px; background: rgba(1,19,38,0.8); }
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                `;
                document.head.appendChild(style);
            }
            
            // å…³é—­äº‹ä»¶
            modalContainer.querySelector('.modal-close').onclick = () => modalContainer.remove();
            modalContainer.onclick = (e) => { if (e.target === modalContainer) modalContainer.remove(); };
            
            console.log('âœ… ç®€åŒ–è®¾å¤‡è§†å›¾æ¨¡æ€çª—å£åˆ›å»ºå®Œæˆ');
        };
    }

    // 3. æ¶ˆæ¯ä¿¡æ¯é¢æ¿
    const messagePanel = document.querySelector('.panel:has(#messageList)');
    if (messagePanel) {
        messagePanel.style.cursor = 'pointer';
        messagePanel.onclick = function() {
            createModalWindow(`/message_view.html?customerId=${customerId}`, data.message_info || null, 'messageInfo');
        };
    }

    // 4. è¶‹åŠ¿åˆ†æé¢æ¿
    const trendPanel = document.querySelector('.panel:has(#trendChart)');
    if (trendPanel) {
        trendPanel.style.cursor = 'pointer';
        trendPanel.onclick = function() {
            createModalWindow(`/health_main?customerId=${customerId}`, data.health_data || null, 'healthInfo');
        };
    }

    // 5. äººå‘˜ç®¡ç†é¢æ¿
    const personnelPanel = document.querySelector('.panel:has(#departmentDistribution)');
    if (personnelPanel) {
        personnelPanel.style.cursor = 'pointer';
        personnelPanel.onclick = function() {
            createModalWindow(`/user_view.html?customerId=${customerId}`, data.user_info || null, 'userInfo');
        };
    }

    // 6. å¥åº·è¯„åˆ†é¢æ¿
    const scorePanel = document.querySelector('.panel:has(#healthScoreChart)');
    if (scorePanel) {
        scorePanel.style.cursor = 'pointer';
        scorePanel.onclick = function() {
            createModalWindow(`/user_health_data_analysis.html?customerId=${customerId}`, data.health_data || null, 'healthInfo');
        };
    }
}

// ä¿®æ”¹åˆå§‹åŒ–è°ƒç”¨
document.addEventListener('DOMContentLoaded', () => {
    // åˆå§‹åŒ–ç­›é€‰é¢æ¿åŠŸèƒ½
    document.getElementById('filterToggle').addEventListener('click',toggleFilter);
    initSearchFilter();
    
    setTimeout(() => {
        globalCharts = initCharts(); // å­˜å‚¨å›¾è¡¨å®ä¾‹

        
        // ğŸ—ºï¸ åœ°å›¾åˆå§‹åŒ– - ä¿®å¤åœ°å›¾æœªåˆå§‹åŒ–é—®é¢˜
        console.log('ğŸ—ºï¸ å¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
        try {
            initializeMap('{{ customerId }}', '-1');
            console.log('âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
        }
        
        // ç­‰å¾…åœ°å›¾åˆå§‹åŒ–å®Œæˆåå†åˆ·æ–°æ•°æ®
        setTimeout(() => {
            refreshData(); // åˆå§‹åŠ è½½æ•°æ®
        }, 500); // ç»™åœ°å›¾åˆå§‹åŒ–ç•™500msæ—¶é—´
        
        // ä¿®æ”¹å®šæ—¶å™¨
        // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ•°æ®

        setInterval(refreshData, 60000);
    }, 100);
});

// æ·»åŠ é€šç”¨çš„åˆ›å»ºæ¨¡æ€çª—å£å‡½æ•°
function createModalWindow(url, data, dataType) {
    const modalContainer = document.createElement('div');
    modalContainer.className = 'modal-container';
    modalContainer.innerHTML = `
        <div class="modal-content">
            <button class="modal-close">âœ–</button>
            <div class="modal-header">
                <div class="filter-controls">
                    <div class="select-group">
                        <select id="modalDeptSelect" class="modal-select">
                            <option value="">é€‰æ‹©éƒ¨é—¨</option>
                        </select>
                        <select id="modalUserSelect" class="modal-select">
                            <option value="">é€‰æ‹©ç”¨æˆ·</option>
                        </select>
                    </div>
                    <div class="date-picker" style="display: none;">
                        <!-- é¢„ç•™æ—¶é—´é€‰æ‹©å™¨ä½ç½® -->
                    </div>
                </div>
            </div>
            <iframe src="${url}" class="user-view-iframe"></iframe>
        </div>
    `;
    
    document.body.appendChild(modalContainer);
    
    // è·å–iframeå¼•ç”¨
    const iframe = modalContainer.querySelector('iframe');
    
    // å½“iframeåŠ è½½å®Œæˆåä¼ é€’æ•°æ®
    iframe.onload = function() {
        console.log('ğŸ”„ iframeåŠ è½½å®Œæˆï¼Œå‡†å¤‡ä¼ é€’æ•°æ®:', { dataType, hasData: !!data });
        if (data) {
            try {
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿iframeå®Œå…¨å‡†å¤‡å¥½
                setTimeout(() => {
                    console.log('ğŸ“¤ æ­£åœ¨ä¼ é€’æ•°æ®åˆ°iframe:', { type: dataType, data: data });
                    iframe.contentWindow.postMessage({
                        type: dataType,
                        data: data
                    }, '*');
                    console.log('âœ… æ•°æ®ä¼ é€’å®Œæˆ');
                }, 100);
            } catch (e) {
                console.error('âŒ æ— æ³•ä¼ é€’æ•°æ®åˆ°iframe:', e);
            }
        } else {
            console.warn('âš ï¸ æ²¡æœ‰æ•°æ®éœ€è¦ä¼ é€’');
        }
    };
    
    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .modal-header {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .filter-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .select-group {
            display: flex;
            gap: 10px;
        }
        
        .modal-select {
            background: rgba(0, 21, 41, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            padding: 5px 10px;
            font-size: 14px;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-select:hover {
            border-color: rgba(0, 228, 255, 0.6);
        }
        
        .modal-select option {
            background: rgba(0, 21, 41, 0.9);
            color: #fff;
        }
        
        .user-view-iframe {
            margin-top: 10px;
        }
    `;
    document.head.appendChild(style);
    
    // å­˜å‚¨éƒ¨é—¨æ•°æ®çš„æ˜ å°„å…³ç³»
    const departmentMap = new Map();
    
    // è·å–éƒ¨é—¨æ•°æ®å¹¶å¡«å……é€‰æ‹©æ¡†
    fetch(`/get_departments?orgId={{ customerId }}`)
        .then(response => response.json())
        .then(response => {
            if (response.success && response.data) {
                const deptSelect = document.getElementById('modalDeptSelect');
                
                // é€’å½’æ·»åŠ éƒ¨é—¨é€‰é¡¹å¹¶ä¿å­˜æ˜ å°„å…³ç³»
                function addDepartmentOptions(departments, level = 0) {
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        const indent = 'ã€€'.repeat(level);
                        option.textContent = indent + dept.name;
                        deptSelect.appendChild(option);
                        
                        // ä¿å­˜éƒ¨é—¨IDå’Œåç§°çš„æ˜ å°„
                        departmentMap.set(dept.id.toString(), dept.name); // ç¡®ä¿keyä¸ºå­—ç¬¦ä¸²ç±»å‹
                        
                        if (dept.children && dept.children.length > 0) {
                            addDepartmentOptions(dept.children, level + 1);
                        }
                    });
                }
                
                addDepartmentOptions(response.data);
            }
        })
        .catch(error => console.error('Error fetching departments:', error));
    
    // éƒ¨é—¨é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    const deptSelect = document.getElementById('modalDeptSelect');
    const userSelect = document.getElementById('modalUserSelect');
    
    deptSelect.addEventListener('change', function() {
        const selectedDeptId = this.value;
        const selectedDeptName = selectedDeptId ? departmentMap.get(selectedDeptId.toString()) : ''; // ç¡®ä¿IDä¸ºå­—ç¬¦ä¸²ç±»å‹è¿›è¡ŒæŸ¥æ‰¾
        userSelect.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>';
        
        if (selectedDeptId) {
            fetch(`/fetch_users?orgId=${selectedDeptId}`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.user_name;
                            // å°†ç”¨æˆ·åå­˜å‚¨åœ¨dataå±æ€§ä¸­
                            option.dataset.userName = user.user_name;
                            userSelect.appendChild(option);
                        });
                        // æ·»åŠ "å…¨éƒ¨ç”¨æˆ·"é€‰é¡¹
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'å…¨éƒ¨ç”¨æˆ·';
                        userSelect.appendChild(allOption);
                    }
                })
                .catch(error => console.error('Error fetching users:', error));
        }
        
        // æ›´æ–° iframe URLï¼ŒåŒ…å«éƒ¨é—¨ä¿¡æ¯
        updateIframeUrl(selectedDeptId, selectedDeptName);
    });
    
    // ç”¨æˆ·é€‰æ‹©å˜åŒ–æ—¶è§¦å‘äº‹ä»¶
    userSelect.addEventListener('change', function() {
        const selectedDeptId = deptSelect.value;
        const selectedDeptName = selectedDeptId ? departmentMap.get(selectedDeptId.toString()) : ''; // ç¡®ä¿IDä¸ºå­—ç¬¦ä¸²ç±»å‹è¿›è¡ŒæŸ¥æ‰¾
        const selectedUserId = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const selectedUserName = selectedOption.dataset.userName || '';
        
        // æ›´æ–° iframe URLï¼ŒåŒ…å«éƒ¨é—¨å’Œç”¨æˆ·ä¿¡æ¯
        updateIframeUrl(selectedDeptId, selectedDeptName, selectedUserId, selectedUserName);
    });
    
    // æ›´æ–° iframe URL çš„è¾…åŠ©å‡½æ•°
    function updateIframeUrl(deptId, deptName, userId, userName) {
        const iframe = modalContainer.querySelector('iframe');
        let newUrl = new URL(iframe.src);
        
        // ä¿æŒåŸæœ‰çš„ customerId å‚æ•°
        const customerId = newUrl.searchParams.get('customerId');
        
        // é‡ç½® URL å‚æ•°
        newUrl.search = '';
        
        // é‡æ–°æ·»åŠ æ‰€æœ‰å¿…è¦çš„å‚æ•°
        if (customerId) {
            newUrl.searchParams.set('customerId', customerId);
        }
        if (deptId) {
            newUrl.searchParams.set('deptId', deptId);
            newUrl.searchParams.set('deptName', encodeURIComponent(deptName || ''));
        }
        if (userId && userId !== 'all') {
            newUrl.searchParams.set('userId', userId);
            newUrl.searchParams.set('userName', encodeURIComponent(userName || ''));
        }
        
        // æ›´æ–° iframe çš„ src
        iframe.src = newUrl.toString();
        
        // å¦‚æœé¡µé¢æœ‰åˆ·æ–°æ•°æ®çš„å‡½æ•°ï¼Œå°è¯•è°ƒç”¨å®ƒ
        try {
            iframe.contentWindow.fetchData && iframe.contentWindow.fetchData();
        } catch (e) {
            console.log('No fetchData function found in iframe or cross-origin restrictions apply');
        }
    }
    
    // æ·»åŠ å…³é—­äº‹ä»¶
    const closeBtn = modalContainer.querySelector('.modal-close');
    closeBtn.onclick = () => {
        modalContainer.remove();
        style.remove();
    };
    
    // ç‚¹å‡»é®ç½©å±‚å…³é—­
    modalContainer.onclick = (e) => {
        if (e.target === modalContainer) {
            modalContainer.remove();
            style.remove();
        }
    };
}

// æ·»åŠ é¢æ¿æ ·å¼
const panelStyle = document.createElement('style');
panelStyle.textContent = `
    .panel {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .panel:hover {
        border-color: rgba(0, 228, 255, 0.4);
        box-shadow: 0 0 15px rgba(0, 228, 255, 0.2);
    }

    .modal-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        position: relative;
        width: 90%;
        height: 90%;
        background: rgba(0, 21, 41, 0.95);
        border: 1px solid rgba(0, 228, 255, 0.3);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0, 228, 255, 0.2);
        animation: slideIn 0.3s ease;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        color: #00e4ff;
        font-size: 18px;
        cursor: pointer;
        z-index: 1;
        padding: 5px 10px;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        transform: scale(1.1);
        color: #ff4444;
    }

    .user-view-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 4px;
        background: rgba(1, 19, 38, 0.8);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(panelStyle);

// åˆå§‹åŒ–å‘Šè­¦ä¿¡æ¯å›¾è¡¨ - ä¸“ä¸šç‰ˆ
function initAlertChart(data) {
    console.log('initAlertChart å¼€å§‹æ‰§è¡Œï¼Œæ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
    
    const alertContainer = document.getElementById('alertList');
    if (!alertContainer) {
        console.warn('å‘Šè­¦å®¹å™¨ #alertList æœªæ‰¾åˆ°');
        return;
    }

    // æ¸…ç©ºå®¹å™¨å¹¶åˆ›å»ºä¸“ä¸šå¸ƒå±€
    alertContainer.innerHTML = `
        <div style="position: relative; height: 100%; padding: 8px;">
            <!-- å‘Šè­¦çŠ¶æ€æ€»è§ˆ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 10px; background: rgba(0,228,255,0.1); border-radius: 6px; border-left: 4px solid #00e4ff;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="alert-stat-item">
                        <span style="color: #ff4444; font-size: 18px; font-weight: bold;" id="criticalCount">0</span>
                        <span style="color: #fff; font-size: 12px; margin-left: 4px;">ä¸¥é‡</span>
                    </div>
                    <div class="alert-stat-item">
                        <span style="color: #ffbb00; font-size: 16px; font-weight: bold;" id="mediumCount">0</span>
                        <span style="color: #fff; font-size: 12px; margin-left: 4px;">ä¸­ç­‰</span>
                    </div>
                    <div class="alert-stat-item">
                        <span style="color: #ff6666; font-size: 14px; font-weight: bold;" id="pendingCount">0</span>
                        <span style="color: #fff; font-size: 12px; margin-left: 4px;">å¾…å¤„ç†</span>
                    </div>
                </div>
                <div style="background: rgba(255,68,68,0.2); padding: 4px 8px; border-radius: 12px; animation: pulse 2s infinite;" id="alertBadge">
                    <span style="color: #ff4444; font-size: 11px; font-weight: bold;">ğŸš¨ å®æ—¶ç›‘æ§</span>
                </div>
            </div>
            
            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="alert-charts-grid">
                <div id="alertTypeChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                    <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">å‘Šè­¦ç±»å‹åˆ†å¸ƒ</div>
                </div>
                <div id="alertLevelChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                    <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">ä¸¥é‡ç¨‹åº¦åˆ†æ</div>
                </div>
                <div id="alertStatusChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                    <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">å¤„ç†çŠ¶æ€</div>
                </div>
                <div id="alertTrendChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                    <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">24å°æ—¶è¶‹åŠ¿</div>
                </div>
            </div>
        </div>
    `;

    const alertInfo = data.alert_info || {};
    const alerts = alertInfo.alerts || [];
    
    console.log('å‘Šè­¦ä¿¡æ¯:', alertInfo); // è°ƒè¯•ä¿¡æ¯
    console.log('å‘Šè­¦åˆ—è¡¨:', alerts); // è°ƒè¯•ä¿¡æ¯
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    const criticalCount = alertInfo.alertLevelCount?.critical || 0;
    const mediumCount = alertInfo.alertLevelCount?.medium || 0;
    const pendingCount = alertInfo.alertStatusCount?.pending || 0;
    
    document.getElementById('criticalCount').textContent = criticalCount;
    document.getElementById('mediumCount').textContent = mediumCount;
    document.getElementById('pendingCount').textContent = pendingCount;
    
    // æ›´æ–°å‘Šè­¦å¾½ç« 
    const badge = document.getElementById('alertBadge');
    if (criticalCount > 0) {
        badge.innerHTML = '<span style="color: #ff4444; font-size: 11px; font-weight: bold;">ğŸ”´ ä¸¥é‡å‘Šè­¦</span>';
        badge.style.background = 'rgba(255,68,68,0.3)';
    } else if (pendingCount > 0) {
        badge.innerHTML = '<span style="color: #ffbb00; font-size: 11px; font-weight: bold;">âš ï¸ å¾…å¤„ç†</span>';
        badge.style.background = 'rgba(255,187,0,0.3)';
    } else {
        badge.innerHTML = '<span style="color: #00ff9d; font-size: 11px; font-weight: bold;">âœ… æ­£å¸¸</span>';
        badge.style.background = 'rgba(0,255,157,0.3)';
    }

    // 1. å‘Šè­¦ç±»å‹åˆ†å¸ƒå›¾ - æ°´å¹³æ¡å½¢å›¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    const typeChart = echarts.init(document.getElementById('alertTypeChart'));
    const alertTypes = Object.keys(alertInfo.alertTypeCount || {});
    const alertValues = Object.values(alertInfo.alertTypeCount || {});

    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤æ•°æ®
    const hasTypeData = alertTypes.length > 0 && alertValues.some(v => v > 0);
    let displayTypes = hasTypeData ? alertTypes : ['heart_rate', 'blood_pressure', 'temperature'];
    let displayValues = hasTypeData ? alertValues : [0, 0, 0];

    // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé˜²æ­¢å›¾è¡¨å˜å½¢ï¼Œç”±äºé«˜åº¦å¢åŠ å¯ä»¥æ˜¾ç¤ºæ›´å¤šç±»å‹
    const MAX_DISPLAY_TYPES = 8; // ä»6å¢åŠ åˆ°8ç§ç±»å‹ï¼Œå……åˆ†åˆ©ç”¨å¢åŠ çš„é«˜åº¦ç©ºé—´
    if (displayTypes.length > MAX_DISPLAY_TYPES) {
        // æŒ‰æ•°å€¼æ’åºï¼Œå–å‰8ä¸ª
        const sortedData = displayTypes.map((type, index) => ({
            type: type,
            value: displayValues[index]
        })).sort((a, b) => b.value - a.value);
        
        displayTypes = sortedData.slice(0, MAX_DISPLAY_TYPES).map(item => item.type);
        displayValues = sortedData.slice(0, MAX_DISPLAY_TYPES).map(item => item.value);
        
        // å¦‚æœæœ‰æ›´å¤šç±»å‹ï¼Œå°†å‰©ä½™çš„åˆå¹¶ä¸º"å…¶ä»–"
        if (sortedData.length > MAX_DISPLAY_TYPES) {
            const otherValue = sortedData.slice(MAX_DISPLAY_TYPES).reduce((sum, item) => sum + item.value, 0);
            displayTypes.push('others');
            displayValues.push(otherValue);
        }
    }

    const typeColors = {
        'temperature': '#ffd700',
        'stress': '#ff8800', 
        'heart_rate': '#00e4ff',
        'blood_pressure': '#ffbb00',
        'blood_oxygen': '#ff6666',
        'others': '#888888'
    };

    const typeOption = {
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            borderWidth: 1,
            textStyle: { color: '#fff', fontSize: 11 },
            formatter: function(params) {
                if (!params || !params[0]) return '';
                const data = params[0];
                const total = displayValues.reduce((a, b) => a + b, 0);
                const percent = total > 0 ? (data.value / total * 100).toFixed(1) : 0;
                const typeName = data.name === 'others' ? 'å…¶ä»–ç±»å‹' : translateAlertType(data.name);
                return `${typeName}<br/>å‘Šè­¦: ${data.value}æ¬¡ (${percent}%)`;
            }
        },
        grid: { 
            top: 25, 
            left: 50, 
            right: 15, 
            bottom: 15,
            containLabel: true
        },
        xAxis: {
            type: 'value',
            axisLabel: { color: '#7ecfff', fontSize: 9 },
            splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)' } },
            axisLine: { show: false },
            max: Math.max(...displayValues, 1)
        },
        yAxis: {
            type: 'category',
            data: displayTypes.map(t => t === 'others' ? 'å…¶ä»–' : translateAlertType(t)),
            axisLabel: { 
                color: '#fff', 
                fontSize: 9,
                interval: 0, // å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
                formatter: function(value) {
                    return value.length > 5 ? value.substring(0, 5) + '...' : value; /* ä»4å¢åŠ åˆ°5ï¼Œå…è®¸æ˜¾ç¤ºæ›´å¤šå­—ç¬¦ */
                }
            },
            axisLine: { show: false },
            axisTick: { show: false }
        },
        series: [{
            type: 'bar',
            data: displayTypes.map((type, index) => ({
                value: displayValues[index],
                itemStyle: { 
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: typeColors[type] || '#00e4ff' },
                        { offset: 1, color: (typeColors[type] || '#00e4ff') + '88' }
                    ])
                }
            })),
            barWidth: displayTypes.length > 6 ? '40%' : displayTypes.length > 4 ? '50%' : '65%', // åŠ¨æ€è°ƒæ•´æ¡å½¢å®½åº¦ï¼Œé€‚åº”æ›´å¤šç±»å‹
            label: { 
                show: true, 
                position: 'right', 
                color: '#fff', 
                fontSize: 9,
                formatter: '{c}'
            }
        }]
    };
    typeChart.setOption(typeOption);

    // 2. å‘Šè­¦çº§åˆ«åˆ†å¸ƒå›¾ - ç¯å½¢å›¾
    const levelChart = echarts.init(document.getElementById('alertLevelChart'));
    const levelEntries = Object.entries(alertInfo.alertLevelCount || {});
    const hasLevelData = levelEntries.length > 0 && levelEntries.some(([_, count]) => count > 0);
    
    const levelData = hasLevelData ? 
        levelEntries.map(([level, count]) => ({
            name: level === 'critical' ? 'ä¸¥é‡' : level === 'medium' ? 'ä¸­ç­‰' : 'è½»å¾®',
            value: count,
            itemStyle: { 
                color: level === 'critical' ? '#ff4444' : level === 'medium' ? '#ffbb00' : '#00e4ff'
            }
        })) :
        [
            { name: 'ä¸¥é‡', value: 0, itemStyle: { color: '#ff4444' } },
            { name: 'ä¸­ç­‰', value: 0, itemStyle: { color: '#ffbb00' } },
            { name: 'æ­£å¸¸', value: 1, itemStyle: { color: '#00e4ff' } }
        ];

    const levelOption = {
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            textStyle: { color: '#fff', fontSize: 11 },
            formatter: function(params) {
                return `${params.name}<br/>æ•°é‡: ${params.value}æ¬¡<br/>å æ¯”: ${params.percent}%`;
            }
        },
        series: [{
            type: 'pie',
            radius: ['35%', '65%'],
            center: ['50%', '55%'],
            data: levelData,
            label: {
                show: true,
                position: 'outside',
                color: '#fff',
                fontSize: 10,
                formatter: function(params) {
                    return hasLevelData ? `${params.name}\n${params.value}æ¬¡` : `${params.name}`;
                },
                lineHeight: 12
            },
            labelLine: {
                show: true,
                length: 8,
                length2: 5,
                lineStyle: { color: 'rgba(255,255,255,0.5)' }
            },
            emphasis: {
                itemStyle: { 
                    shadowBlur: 15, 
                    shadowOffsetX: 0, 
                    shadowColor: 'rgba(0, 0, 0, 0.8)',
                    scale: 1.05
                }
            }
        }]
    };
    levelChart.setOption(levelOption);

    // 3. å‘Šè­¦çŠ¶æ€åˆ†å¸ƒå›¾ - ä»ªè¡¨ç›˜æ ·å¼
    const statusChart = echarts.init(document.getElementById('alertStatusChart'));
    const totalAlerts = (alertInfo.alertStatusCount?.pending || 0) + (alertInfo.alertStatusCount?.responded || 0);
    const pendingPercent = totalAlerts > 0 ? ((alertInfo.alertStatusCount?.pending || 0) / totalAlerts * 100).toFixed(1) : 0;

    const statusOption = {
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            textStyle: { color: '#fff', fontSize: 11 }
        },
        series: [{
            type: 'gauge',
            radius: '75%',
            center: ['50%', '55%'],
            startAngle: 180,
            endAngle: 0,
            min: 0,
            max: 100,
            splitNumber: 4,
            axisLine: {
                lineStyle: {
                    width: 8,
                    color: [
                        [0.3, '#00e4ff'],
                        [0.7, '#ffbb00'],
                        [1, '#ff4444']
                    ]
                }
            },
            pointer: {
                icon: 'circle',
                length: '60%',
                width: 4,
                offsetCenter: [0, '5%'],
                itemStyle: { color: '#fff' }
            },
            axisTick: { show: false },
            splitLine: { show: false },
            axisLabel: {
                show: true,
                distance: -25,
                color: '#7ecfff',
                fontSize: 9,
                formatter: function(value) {
                    if (value === 0) return 'æ­£å¸¸';
                    if (value === 50) return 'ä¸­ç­‰';
                    if (value === 100) return 'ä¸¥é‡';
                    return '';
                }
            },
            detail: {
                valueAnimation: true,
                formatter: function(value) {
                    return `{value|${value}%}\n{name|å¾…å¤„ç†ç‡}`;
                },
                rich: {
                    value: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: pendingPercent > 70 ? '#ff4444' : pendingPercent > 30 ? '#ffbb00' : '#00e4ff'
                    },
                    name: {
                        fontSize: 10,
                        color: '#7ecfff',
                        padding: [5, 0, 0, 0]
                    }
                },
                offsetCenter: [0, '20%']
            },
            data: [{ value: pendingPercent }]
        }]
    };
    statusChart.setOption(statusOption);

    // 4. 24å°æ—¶å‘Šè­¦è¶‹åŠ¿å›¾ - ä¿®å¤æ•°æ®å¤„ç†
    const alertTrendChart = echarts.init(document.getElementById('alertTrendChart'));
    
    // å¤„ç†æ—¶é—´æ•°æ®ï¼ŒæŒ‰å°æ—¶ç»Ÿè®¡
    const hourlyData = {};
    const now = new Date();
    
    // åˆå§‹åŒ–24å°æ—¶æ•°æ®
    for (let i = 0; i < 24; i++) {
        hourlyData[i] = 0;
    }
    
    // ç»Ÿè®¡å‘Šè­¦æ•°æ®
    if (alerts && alerts.length > 0) {
        alerts.forEach(alert => {
            try {
                let alertTime;
                if (alert.alert_timestamp) {
                    // å°è¯•è§£ææ—¶é—´æˆ³
                    alertTime = new Date(alert.alert_timestamp);
                    if (isNaN(alertTime.getTime())) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                        alertTime = new Date(alert.alert_timestamp.replace(/-/g, '/'));
                    }
                } else if (alert.timestamp) {
                    alertTime = new Date(alert.timestamp);
                } else {
                    alertTime = now; // é»˜è®¤å½“å‰æ—¶é—´
                }
                
                if (!isNaN(alertTime.getTime())) {
                    const hour = alertTime.getHours();
                    hourlyData[hour] = (hourlyData[hour] || 0) + 1;
                }
            } catch (e) {
                console.warn('è§£æå‘Šè­¦æ—¶é—´å¤±è´¥:', alert, e);
            }
        });
    }
    
    const hours = Array.from({length: 24}, (_, i) => i);
    const hourlyValues = hours.map(h => hourlyData[h] || 0);
    const maxValue = Math.max(...hourlyValues, 1);

    const trendOption = {
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            textStyle: { color: '#fff', fontSize: 11 },
                formatter: function(params) {
                if (!params || !params[0]) return '';
                const data = params[0];
                return `${data.name}:00<br/>å‘Šè­¦æ•°é‡: ${data.value}æ¬¡`;
            }
        },
        grid: { top: 25, left: 25, right: 15, bottom: 20 },
        xAxis: {
            type: 'category',
            data: hours.map(h => h.toString().padStart(2, '0')),
            axisLabel: { 
                color: '#7ecfff', 
                fontSize: 9,
                interval: 3
            },
            axisLine: { lineStyle: { color: 'rgba(126,207,255,0.3)' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            max: Math.max(maxValue + 1, 3),
            axisLabel: { color: '#7ecfff', fontSize: 9 },
            splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)', type: 'dashed' } },
            axisLine: { show: false }
        },
        series: [{
            type: 'line',
            data: hourlyValues,
            smooth: true,
            lineStyle: { 
                color: '#00e4ff', 
                width: 2,
                shadowColor: 'rgba(0,228,255,0.3)',
                shadowBlur: 5
            },
            itemStyle: { 
                color: '#00e4ff',
                borderColor: '#fff',
                borderWidth: 1
            },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(0,228,255,0.4)' },
                    { offset: 1, color: 'rgba(0,228,255,0.05)' }
                ])
            },
            symbol: 'circle',
            symbolSize: function(value) {
                return value > 0 ? 4 : 2;
            },
            emphasis: {
                itemStyle: {
                    color: '#fff', 
                    borderColor: '#00e4ff', 
                    borderWidth: 2,
                    shadowColor: 'rgba(0,228,255,0.6)',
                    shadowBlur: 8
                },
                scale: 1.2
            }
        }]
    };
    alertTrendChart.setOption(trendOption);

    // æ·»åŠ åŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .alert-stat-item {
            display: flex;
            align-items: baseline;
            transition: all 0.3s ease;
        }
        
        .alert-stat-item:hover {
            transform: translateY(-2px);
        }
        
        #alertBadge {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #alertBadge:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0,228,255,0.5);
        }
    `;
    document.head.appendChild(style);

    // è‡ªé€‚åº”å¤§å° - å»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMå·²æ¸²æŸ“
    setTimeout(() => {
        const resizeCharts = () => {
            try {
                typeChart && typeChart.resize();
                levelChart && levelChart.resize();
                statusChart && statusChart.resize();
                alertTrendChart && alertTrendChart.resize();
            } catch (e) {
                console.warn('å›¾è¡¨resizeå¤±è´¥:', e);
            }
        };
        
        resizeCharts(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        window.addEventListener('resize', resizeCharts);
    }, 100);

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºè¯¦ç»†å‘Šè­¦åˆ—è¡¨
    badge.onclick = () => showAlertDetails(alerts);
    
    // å›¾è¡¨ç‚¹å‡»äº¤äº’
    typeChart.on('click', function(params) {
        if (hasTypeData && params.dataIndex < alertTypes.length) {
            const alertType = alertTypes[params.dataIndex];
            const filteredAlerts = alerts.filter(alert => alert.alert_type === alertType);
            showAlertDetails(filteredAlerts, `${translateAlertType(alertType)}å‘Šè­¦è¯¦æƒ…`);
        }
    });

    // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“ - å»¶è¿Ÿæ‰§è¡Œ
    setTimeout(() => {
        try {
            typeChart.resize();
            levelChart.resize();
            statusChart.resize();
            alertTrendChart.resize();
            console.log('å‘Šè­¦å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
        } catch (e) {
            console.warn('å‘Šè­¦å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', e);
        }
    }, 200);

    return { typeChart, levelChart, statusChart, alertTrendChart };
}

// æ˜¾ç¤ºè¯¦ç»†å‘Šè­¦åˆ—è¡¨
function showAlertDetails(alerts, title = 'ğŸ“‹ è¯¦ç»†å‘Šè­¦åˆ—è¡¨') {
    const modal = document.createElement('div');
    modal.className = 'modal-container';
    modal.innerHTML = `
        <div class="modal-content" style="width: 85%; height: 85%;">
            <button class="modal-close">âœ•</button>
            <h3 style="color: #00e4ff; margin-bottom: 20px; text-align: center; font-size: 18px;">${title}</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,228,255,0.1); border-radius: 6px;">
                <div style="color: #fff; font-size: 14px;">
                    å…± <span style="color: #00e4ff; font-weight: bold;">${alerts.length}</span> æ¡å‘Šè­¦è®°å½•
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="exportAlerts()" style="background: rgba(0,228,255,0.2); border: 1px solid #00e4ff; color: #00e4ff; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ“Š å¯¼å‡º</button>
                    <button onclick="refreshAlerts()" style="background: rgba(0,228,255,0.2); border: 1px solid #00e4ff; color: #00e4ff; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>
            <div style="height: calc(100% - 100px); overflow-y: auto; border: 1px solid rgba(0,228,255,0.2); border-radius: 6px;">
                <table style="width: 100%; border-collapse: collapse; color: #fff; font-size: 13px;">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr style="background: rgba(0,228,255,0.3); border-bottom: 2px solid #00e4ff;">
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">æ—¶é—´</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">ç±»å‹</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">çº§åˆ«</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">çŠ¶æ€</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">ç”¨æˆ·</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">éƒ¨é—¨</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">è®¾å¤‡</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold;">æè¿°</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${alerts.map((alert, index) => `
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); transition: all 0.2s ease; ${alert.severity_level === 'critical' ? 'background: rgba(255,68,68,0.15);' : index % 2 === 0 ? 'background: rgba(0,21,41,0.3);' : 'background: rgba(0,21,41,0.1);'}" 
                                onmouseover="this.style.background='rgba(0,228,255,0.1)'" 
                                onmouseout="this.style.background='${alert.severity_level === 'critical' ? 'rgba(255,68,68,0.15)' : index % 2 === 0 ? 'rgba(0,21,41,0.3)' : 'rgba(0,21,41,0.1)'}'">
                                <td style="padding: 10px 8px; font-size: 11px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <div style="color: #7ecfff;">${alert.alert_timestamp.split(' ')[0]}</div>
                                    <div style="color: #fff; font-size: 10px;">${alert.alert_timestamp.split(' ')[1]}</div>
                                </td>
                                <td style="padding: 10px 8px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <span style="background: ${getAlertTypeColor(alert.alert_type)}; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; color: #000;">
                                        ${translateAlertType(alert.alert_type)}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <span style="background: ${alert.severity_level === 'critical' ? '#ff4444' : '#ffbb00'}; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; color: #000;">
                                        ${alert.severity_level === 'critical' ? 'ğŸ”´ ä¸¥é‡' : 'ğŸŸ¡ ä¸­ç­‰'}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <span style="background: ${alert.alert_status === 'pending' ? '#ff4444' : '#00e4ff'}; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; color: ${alert.alert_status === 'pending' ? '#fff' : '#000'};">
                                        ${alert.alert_status === 'pending' ? 'â³ å¾…å¤„ç†' : 'âœ… å·²å¤„ç†'}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; font-size: 12px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <div style="color: #00e4ff; font-weight: bold;">${alert.user_name}</div>
                                    <div style="color: #7ecfff; font-size: 10px;">ID: ${alert.user_id}</div>
                                </td>
                                <td style="padding: 10px 8px; font-size: 12px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <div style="color: #fff;">${alert.dept_name}</div>
                                    <div style="color: #7ecfff; font-size: 10px;">éƒ¨é—¨ID: ${alert.dept_id}</div>
                                </td>
                                <td style="padding: 10px 8px; font-size: 11px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <div style="color: #ffbb00; font-family: monospace;">${alert.device_sn}</div>
                                    ${alert.health_id ? `<div style="color: #7ecfff; font-size: 10px;">å¥åº·ID: ${alert.health_id}</div>` : ''}
                                </td>
                                <td style="padding: 10px 8px; font-size: 11px; max-width: 200px; word-wrap: break-word; line-height: 1.4;">
                                    <div style="color: #fff;">${alert.alert_desc || 'æ— è¯¦ç»†æè¿°'}</div>
                                    ${alert.alert_status === 'pending' ? `
                                        <button onclick="handleAlert('${alert.alert_id}')" 
                                                style="margin-top: 5px; background: #ff4444; color: #fff; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; transition: all 0.2s ease;"
                                                onmouseover="this.style.background='#ff6666'" 
                                                onmouseout="this.style.background='#ff4444'">
                                            ğŸš¨ ç«‹å³å¤„ç†
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${alerts.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: #7ecfff;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
                        <div style="font-size: 16px;">æš‚æ— å‘Šè­¦è®°å½•</div>
                        <div style="font-size: 12px; margin-top: 5px; color: rgba(255,255,255,0.5);">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // å…³é—­äº‹ä»¶
    modal.querySelector('.modal-close').onclick = () => modal.remove();
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
    
    // æ·»åŠ é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escHandler);
        }
    });
}

// å¯¼å‡ºå‘Šè­¦æ•°æ®
function exportAlerts() {
    // è¿™é‡Œå¯ä»¥å®ç°å¯¼å‡ºåŠŸèƒ½
    showCustomAlert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', null);
}

// åˆ·æ–°å‘Šè­¦æ•°æ®
function refreshAlerts() {
    refreshData();
    showCustomAlert('å‘Šè­¦æ•°æ®å·²åˆ·æ–°', null);
}

// è·å–å‘Šè­¦ç±»å‹é¢œè‰²
function getAlertTypeColor(type) {
    const colors = {
        'temperature': '#ff4444',
        'stress': '#ff8800',
        'heart_rate': '#00e4ff', 
        'blood_pressure': '#ffbb00',
        'blood_oxygen': '#ff6666'
    };
    return colors[type] || '#00e4ff';
}

// ä¿®æ”¹è®¾å¤‡ç®¡ç†å›¾è¡¨åˆå§‹åŒ–å‡½æ•°
function initDeviceChart(data) {
    const statsContainer = document.getElementById('statsChart');
    if (!statsContainer) return;

    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å›¾è¡¨å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨åˆ™å¤ç”¨
    let statsChart;
    if (globalCharts && globalCharts.stats) {
        statsChart = globalCharts.stats;
    } else {
        if (globalCharts) {
            globalCharts.stats = statsChart;
        }
    }
    
    const deviceInfo = data.device_info || {};
    const totalDevices = deviceInfo.totalDevices || 0;
    document.getElementById('totalWatchDevices').textContent = totalDevices;
    
    // è®¡ç®—å„é¡¹ç»Ÿè®¡æ•°æ®
    const activeDevices = deviceInfo.deviceStatusCount?.ACTIVE || 0;
    const chargingDevices = deviceInfo.deviceChargingCount?.CHARGING || 0;
    const faultDevices = deviceInfo.deviceStatusCount?.FAULT || 0;
    const offlineDevices = deviceInfo.deviceStatusCount?.INACTIVE || 0;
    
    // è®¡ç®—åœ¨çº¿ç‡
    const onlineRate = totalDevices > 0 ? ((activeDevices / totalDevices) * 100).toFixed(1) : 0;
    
    // åªåœ¨é¦–æ¬¡åˆ›å»ºæ—¶æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    if (!statsContainer.hasClickListener) {
        statsContainer.onclick = () => {
            const legendData = {
                'éƒ¨é—¨åˆ†å¸ƒ': deviceInfo.departmentDeviceCount || {},
                'å……ç”µçŠ¶æ€': deviceInfo.deviceChargingCount || {},
                'è®¾å¤‡çŠ¶æ€': deviceInfo.deviceStatusCount || {},
                'ç³»ç»Ÿç‰ˆæœ¬': deviceInfo.deviceSystemVersionCount || {},
                'ä½©æˆ´çŠ¶æ€': deviceInfo.deviceWearableCount || {}
            };
            showFullLegend(legendData);
        };
        statsContainer.hasClickListener = true;
    }

    // é‡æ–°æ„å»ºé¢æ¿å†…å®¹ï¼Œåˆ é™¤ä¸­é—´å¡ç‰‡ï¼Œåªä¿ç•™é¡¶éƒ¨æ€»è§ˆå’Œåº•éƒ¨å›¾è¡¨
    if (!statsContainer.querySelector('.device-overview-header')) {
        statsContainer.innerHTML = `
            <div style="position: relative; height: 100%; padding: 6px;">
                <!-- é¡¶éƒ¨æ•°æ®æ€»è§ˆæ¡ - æ›´ç´§å‡‘ -->
                <div class="device-overview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 12px; background: rgba(0,228,255,0.1); border-radius: 6px; border-left: 3px solid #00e4ff;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="overview-item">
                            <span style="color: #00e4ff; font-size: 20px; font-weight: bold;">${totalDevices}</span>
                            <span style="color: #fff; font-size: 12px; margin-left: 4px;">è®¾å¤‡æ€»æ•°</span>
                        </div>
                        <div class="overview-item">
                            <span style="color: #52c41a; font-size: 18px; font-weight: bold;">${activeDevices}</span>
                            <span style="color: #fff; font-size: 12px; margin-left: 4px;">åœ¨çº¿è®¾å¤‡</span>
                        </div>
                        <div class="overview-item">
                            <span style="color: #faad14; font-size: 18px; font-weight: bold;">${onlineRate}%</span>
                            <span style="color: #fff; font-size: 12px; margin-left: 4px;">åœ¨çº¿ç‡</span>
                        </div>
                    </div>
                    <div style="color: #7ecfff; font-size: 11px; cursor: pointer;">è¯¦æƒ… â†’</div>
                </div>

                <!-- åº•éƒ¨å›¾è¡¨åŒºåŸŸ - æ›´ç´§å‡‘ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; height: calc(100% - 45px);">
                    <div id="deviceDeptChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                        <div style="position: absolute; top: 6px; left: 10px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">éƒ¨é—¨è®¾å¤‡åˆ†å¸ƒ</div>
                    </div>
                    <div id="deviceStatusChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                        <div style="position: absolute; top: 6px; left: 10px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">è®¾å¤‡çŠ¶æ€ç»Ÿè®¡</div>
                    </div>
                </div>
            </div>
        `;
    }

    // å»¶æ—¶åˆå§‹åŒ–å›¾è¡¨
    setTimeout(() => {
        // éƒ¨é—¨è®¾å¤‡åˆ†å¸ƒé¥¼å›¾ï¼ˆå·¦ä¾§å¤§å›¾è¡¨ï¼‰
        const deptChart = echarts.init(document.getElementById('deviceDeptChart'));
        const deptData = Object.entries(deviceInfo.departmentDeviceCount || {}).map(([name, count]) => ({
            name: name.length > 8 ? name.substring(0, 8) + '...' : name,
            value: count,
            itemStyle: { color: `hsl(${Math.random() * 360}, 60%, 50%)` }
        }));
        
        deptChart.setOption({
            tooltip: { 
                trigger: 'item', 
                backgroundColor: 'rgba(0,21,41,0.95)', 
                borderColor: '#00e4ff', 
                textStyle: { color: '#fff', fontSize: 11 },
                formatter: '{b}: {c}å° ({d}%)'
            },
            legend: {
                orient: 'vertical',
                left: 'left',
                top: 'center',
                textStyle: { color: '#fff', fontSize: 9 },
                itemWidth: 10,
                itemHeight: 6,
                itemGap: 4
            },
            series: [{
                type: 'pie',
                radius: ['25%', '65%'],
                center: ['70%', '50%'],
                data: deptData.length > 0 ? deptData : [{ name: 'æš‚æ— æ•°æ®', value: 1, itemStyle: { color: '#666' } }],
                label: { show: false },
                labelLine: { show: false },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 228, 255, 0.6)'
                    }
                }
            }]
        });

        // è®¾å¤‡çŠ¶æ€ç»Ÿè®¡æŸ±çŠ¶å›¾ï¼ˆå³ä¾§å¤§å›¾è¡¨ï¼‰
        const statusChart = echarts.init(document.getElementById('deviceStatusChart'));
        const statusCategories = ['åœ¨çº¿', 'ç¦»çº¿', 'å……ç”µ', 'æ•…éšœ', 'æ­£å¸¸'];
        const statusValues = [
            activeDevices,
            offlineDevices, 
            chargingDevices,
            faultDevices,
            totalDevices - faultDevices - offlineDevices
        ];
        const statusColors = ['#52c41a', '#f5222d', '#1890ff', '#fa8c16', '#00e4ff'];
        
        statusChart.setOption({
            tooltip: { 
                trigger: 'axis', 
                backgroundColor: 'rgba(0,21,41,0.95)', 
                borderColor: '#00e4ff', 
                textStyle: { color: '#fff', fontSize: 11 },
                formatter: function(params) {
                    return params[0].name + ': ' + params[0].value + 'å°';
                }
            },
            grid: { top: 25, left: 30, right: 15, bottom: 25 },
            xAxis: { 
                type: 'category', 
                data: statusCategories,
                axisLabel: { color: '#7ecfff', fontSize: 9, rotate: 0 }, 
                axisLine: { lineStyle: { color: 'rgba(126,207,255,0.3)' } }, 
                axisTick: { show: false } 
            },
            yAxis: { 
                type: 'value', 
                axisLabel: { color: '#7ecfff', fontSize: 9 }, 
                splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)' } }, 
                axisLine: { show: false } 
            },
            series: [{ 
                type: 'bar', 
                data: statusValues.map((value, index) => ({
                    value: value,
                    itemStyle: { 
                        color: statusColors[index],
                        borderRadius: [3, 3, 0, 0]
                    }
                })),
                barWidth: '45%',
                label: {
                    show: true,
                    position: 'top',
                    color: '#fff',
                    fontSize: 10,
                    formatter: '{c}'
                }
            }]
        });

        if (globalCharts) {
            globalCharts.stats = { deptChart, statusChart };
        }
    }, 200);

    return statsChart;
}

// ä¿®æ”¹è¶‹åŠ¿åˆ†æå›¾è¡¨ï¼Œå¢åŠ é¢„æµ‹æ•°æ®
function updateTrendChart(data) {
    const trendContainer = document.getElementById('trendChart');
    if (!trendContainer) return;

    const trendChart = echarts.init(trendContainer);
    
    const trendOption = {
        title: {
            text: 'å¥åº·æŒ‡æ ‡è¶‹åŠ¿åŠé¢„æµ‹',
            textStyle: {
                color: '#fff',
                fontSize: 16
            }
        },
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.9)',
            borderColor: 'rgba(0,228,255,0.2)',
            textStyle: { color: '#fff' }
        },
        legend: {
            data: ['å¿ƒç‡', 'è¡€å‹', 'å‹åŠ›æŒ‡æ•°', 'è·ç¦»', 'å¡è·¯é‡Œ', 'æ­¥æ•°', 'é¢„æµ‹å€¼'],
            textStyle: { color: '#fff' },
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
            xAxis: {
                type: 'category',
            boundaryGap: false,
            data: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', 'é¢„æµ‹'],
            axisLabel: { color: '#fff' },
            axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
            },
            yAxis: {
                type: 'value',
            axisLabel: { color: '#fff' },
            splitLine: {
                lineStyle: {
                    color: 'rgba(255,255,255,0.1)',
                    type: 'dashed'
                }
            }
        },
        series: [
            {
                name: 'å¿ƒç‡',
                type: 'line',
                smooth: true,
                data: [75, 72, 78, 85, 80, 75, 77],
                itemStyle: { color: '#ff4444' }
            },
            {
                name: 'è¡€å‹',
                type: 'line',
                smooth: true,
                data: [120, 118, 122, 125, 121, 119, 120],
                itemStyle: { color: '#00e4ff' }
            },
            {
                name: 'å‹åŠ›æŒ‡æ•°',
                type: 'line',
                smooth: true,
                data: [45, 48, 52, 55, 50, 47, 49],
                itemStyle: { color: '#ffbb00' }
            },
            {
                name: 'è·ç¦»',
                type: 'line',
                smooth: true,
                data: [2.1, 2.3, 2.8, 3.2, 3.5, 3.8, 4.0],
                itemStyle: { color: '#00ff9d' }
            },
            {
                name: 'å¡è·¯é‡Œ',
                type: 'line',
                smooth: true,
                data: [150, 180, 220, 280, 320, 350, 380],
                itemStyle: { color: '#ff7777' }
            },
            {
                name: 'æ­¥æ•°',
                type: 'line',
                smooth: true,
                data: [2000, 2500, 3000, 3800, 4200, 4500, 4800],
                itemStyle: { color: '#7777ff' }
            }
        ]
    };

    // ä¸ºæ¯ä¸ªç³»åˆ—æ·»åŠ é¢„æµ‹åŒºåŸŸ
    trendOption.series.forEach(series => {
        const lastIndex = series.data.length - 1;
        series.markArea = {
                itemStyle: {
                color: 'rgba(0, 228, 255, 0.1)'
            },
            data: [[{
                xAxis: trendOption.xAxis.data[lastIndex - 1]
            }, {
                xAxis: trendOption.xAxis.data[lastIndex]
            }]]
        };
    });

    trendChart.setOption(trendOption);
    return trendChart;
}

// äººå‘˜ç®¡ç†é¢æ¿äº¤äº’å‡½æ•°
function showPersonnelDetails() {
    showCustomAlert('äººå‘˜è¯¦æƒ…åŠŸèƒ½ï¼šæ˜¾ç¤ºå®Œæ•´çš„äººå‘˜ç®¡ç†ç»Ÿè®¡ä¿¡æ¯');
}

function filterByDepartment() {
    showCustomAlert('éƒ¨é—¨ç­›é€‰åŠŸèƒ½ï¼šæŒ‰éƒ¨é—¨æŸ¥çœ‹äººå‘˜åˆ†å¸ƒè¯¦æƒ…');
}

function filterByOnlineStatus() {
    showCustomAlert('åœ¨çº¿çŠ¶æ€ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºåœ¨çº¿/ç¦»çº¿äººå‘˜åˆ—è¡¨');
}

function filterByDeviceStatus() {
    showCustomAlert('è®¾å¤‡çŠ¶æ€ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºå·²ç»‘å®š/æœªç»‘å®šè®¾å¤‡äººå‘˜');
}

function filterByAlertStatus() {
    showCustomAlert('å‘Šè­¦çŠ¶æ€ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºæœ‰å‘Šè­¦çš„äººå‘˜åˆ—è¡¨');
}

// æ˜¾ç¤ºéƒ¨é—¨è¯¦æƒ…
function showDepartmentDetails(deptName, userCount) {
    const modal = document.createElement('div');
    modal.className = 'modal-container';
    modal.innerHTML = `
        <div class="modal-content" style="width: 60%; height: 70%;">
            <button class="modal-close">âœ•</button>
            <h3 style="color: #00e4ff; margin-bottom: 20px; text-align: center; font-size: 18px;">ğŸ“Š ${deptName} éƒ¨é—¨è¯¦æƒ…</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px;">
                <div style="background: rgba(0,228,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="color: #00e4ff; font-size: 24px; font-weight: bold;">${userCount}</div>
                    <div style="color: #fff; margin-top: 5px;">æ€»äººæ•°</div>
                </div>
                <div style="background: rgba(0,255,157,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="color: #00ff9d; font-size: 24px; font-weight: bold;">${Math.floor(userCount * 0.8)}</div>
                    <div style="color: #fff; margin-top: 5px;">åœ¨çº¿äººæ•°</div>
                </div>
                <div style="background: rgba(255,187,0,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="color: #ffbb00; font-size: 24px; font-weight: bold;">${Math.floor(userCount * 0.9)}</div>
                    <div style="color: #fff; margin-top: 5px;">è®¾å¤‡ç»‘å®š</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px; color: #7ecfff;">
                ç‚¹å‡»å¯æŸ¥çœ‹è¯¥éƒ¨é—¨çš„è¯¦ç»†äººå‘˜åˆ—è¡¨å’Œè®¾å¤‡çŠ¶æ€
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // å…³é—­äº‹ä»¶
    modal.querySelector('.modal-close').onclick = () => modal.remove();
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
}

// æ˜¾ç¤ºçŠ¶æ€è¯¦æƒ…
function showStatusDetails(statusName, statusValue) {
    const statusMap = {
        'åœ¨çº¿': 'å½“å‰åœ¨çº¿çš„ç”¨æˆ·åˆ—è¡¨',
        'ç¦»çº¿': 'å½“å‰ç¦»çº¿çš„ç”¨æˆ·åˆ—è¡¨',
        'ç»‘å®š': 'å·²ç»‘å®šè®¾å¤‡çš„ç”¨æˆ·',
        'æœªç»‘å®š': 'æœªç»‘å®šè®¾å¤‡çš„ç”¨æˆ·',
        'å‘Šè­¦': 'å½“å‰æœ‰å‘Šè­¦çš„ç”¨æˆ·',
        'æ­£å¸¸': 'çŠ¶æ€æ­£å¸¸çš„ç”¨æˆ·'
    };
    
    const modal = document.createElement('div');
    modal.className = 'modal-container';
    modal.innerHTML = `
        <div class="modal-content" style="width: 70%; height: 80%;">
            <button class="modal-close">âœ•</button>
            <h3 style="color: #00e4ff; margin-bottom: 20px; text-align: center; font-size: 18px;">ğŸ“‹ ${statusName}ç”¨æˆ·è¯¦æƒ…</h3>
            <div style="background: rgba(0,228,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <div style="color: #00e4ff; font-size: 28px; font-weight: bold;">${statusValue}</div>
                <div style="color: #fff; margin-top: 5px;">${statusMap[statusName] || 'ç”¨æˆ·ç»Ÿè®¡'}</div>
            </div>
            <div style="color: #7ecfff; text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ‘¥</div>
                <div style="font-size: 16px;">è¯¦ç»†ç”¨æˆ·åˆ—è¡¨åŠŸèƒ½å¼€å‘ä¸­...</div>
                <div style="font-size: 12px; margin-top: 10px; color: rgba(255,255,255,0.5);">å°†æ˜¾ç¤ºå…·ä½“çš„ç”¨æˆ·ä¿¡æ¯ã€è®¾å¤‡çŠ¶æ€å’Œå¥åº·æ•°æ®</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // å…³é—­äº‹ä»¶
    modal.querySelector('.modal-close').onclick = () => modal.remove();
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
}

  </script>


   
  </script>
  <script src="{{ url_for('static', filename='libs/jquery.min.js') }}"></script>
<script>
  $(document).ready(function() {
    // è·å–éƒ¨é—¨æ•°æ®
    $.ajax({
        url: `/get_departments?orgId={{ customerId }}`,
        method: 'GET',
        success: function(response) {
            console.log('response', response);
            if (response.success && response.data) {
                updateDepartmentSelect(response.data);
    } else {
                console.error('Invalid response format:', response);
            }
        },
        error: function(error) {
            console.error('Failed to fetch departments:', error);
        }
    });

    // éƒ¨é—¨é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    $('#deptSelect').change(function() {
        const selectedDeptId = $(this).val();
        currentDept=selectedDeptId
        console.log('currentDept',currentDept);
        updateUsers(selectedDeptId);
    });

    // ç”¨æˆ·é€‰æ‹©å˜åŒ–æ—¶åˆ·æ–°åœ°å›¾
    $('#userSelect').change(function() {
        currentUser=$(this).val()
       //console.log('currentUser',currentUser);
        // è°ƒç”¨ initializeMap åˆ·æ–°æ•°æ®
        //initializeMap(selectedDeptId, selectedUserId);
        updateMapData(lastTotalInfo);
    });



    // æ›´æ–°éƒ¨é—¨é€‰æ‹©æ¡†
    function updateDepartmentSelect(departments) {
        const deptSelect = document.getElementById('deptSelect');
        if (!deptSelect) return;

        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        deptSelect.innerHTML = '<option value="">é€‰æ‹©éƒ¨é—¨</option>';

        // é€’å½’æ·»åŠ éƒ¨é—¨é€‰é¡¹å¹¶æ”¶é›†æ‰€æœ‰ç”¨æˆ·æ•°æ®
        const allDeptUsers = [];
        async function addDepartmentOptions(departments, level = 0) {
            for (const dept of departments) {
                const option = document.createElement('option');
                option.value = dept.id;
                const indent = 'ã€€'.repeat(level);
                option.textContent = indent + dept.name;
                deptSelect.appendChild(option);

                // è·å–è¯¥éƒ¨é—¨çš„ç”¨æˆ·æ•°æ®å¹¶æ·»åŠ åˆ°å…¨å±€æ•°ç»„
                try {
                    const response = await fetch(`/fetch_users?orgId=${dept.id}`);
                    const users = await response.json();
                    if (users) {
                        users.forEach(user => {
                            allDeptUsers.push({
                                ...user,
                                dept_name: dept.name,
                                dept_id: dept.id,
                                user_id: user.id
                            });
                        });
                    }
                } catch (e) {
                    console.error('è·å–éƒ¨é—¨ç”¨æˆ·å¤±è´¥:', e);
                }

                if (dept.children && dept.children.length > 0) {
                    await addDepartmentOptions(dept.children, level + 1);
                }
            }
        }

        // å¼‚æ­¥å¤„ç†å¹¶è®¾ç½®ç”¨æˆ·æ•°æ®
        addDepartmentOptions(departments).then(() => {
            setUsersData(allDeptUsers);
        });
        
        deptSelect.style.fontFamily = 'monospace';
    }

    // æ›´æ–°ç”¨æˆ·é€‰æ‹©æ¡†
    async function updateUsers(deptId) {
        if (deptId) {
            // å¦‚æœé€‰æ‹©äº†éƒ¨é—¨ï¼Œè¿‡æ»¤è¯¥éƒ¨é—¨çš„ç”¨æˆ·
            filteredUsers = allUsers.filter(u => u.dept_id == deptId);
        } else {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©éƒ¨é—¨ï¼Œæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·
            filteredUsers = allUsers;
        }
        updateUserSelect();
        // æ¸…ç©ºæœç´¢æ¡†
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.value = '';
    }

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .filter-select {
            font-family: monospace;
            white-space: pre;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .filter-select option {
            font-family: monospace;
            white-space: pre;
            background: #1a1a1a;
            color: #fff;
        }


    `;
    document.head.appendChild(style);
  });
</script>

<div id="infoPanel" class="info-panel" style="display: none;">
  <div class="info-panel-header">
    <div class="info-panel-title">
      <i class="fas fa-info-circle"></i>
      <span>å®æ—¶ä¿¡æ¯</span>
    </div>
    <button class="info-panel-close" onclick="toggleInfoPanel()">Ã—</button>
  </div>
  <div class="info-panel-content" id="infoPanelContent">
    <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
  </div>
</div>

<script>
  // å…¨å±€å˜é‡
  let infoPanelVisible = false;
  let lastTotalInfo = null;
  
  // åˆ‡æ¢ä¿¡æ¯é¢æ¿æ˜¾ç¤ºçŠ¶æ€
  function toggleInfoPanel() {
    const panel = document.getElementById('infoPanel');
    infoPanelVisible = !infoPanelVisible;
    panel.style.display = infoPanelVisible ? 'block' : 'none';
  }
  
  // æ·»åŠ é”®ç›˜å¿«æ·é”®åˆ‡æ¢ä¿¡æ¯é¢æ¿
  document.addEventListener('keydown', (e) => {
    if (e.key === 'i' && e.ctrlKey) {
      toggleInfoPanel();
    }
  });
  
  function openInfoPanelWithAlertId(alertId) {
    infoPanelVisible = true;
    document.getElementById('infoPanel').style.display = 'block';
    updateInfoPanel(lastTotalInfo, alertId);
  }
  
  // é¢æ¿æ˜¾ç¤ºçŠ¶æ€ç®¡ç†ï¼Œé˜²æ­¢é‡å¤é¢æ¿
  let panelDisplaying = false;
  
  function showCustomMapInfo(f){
    // é˜²æŠ–ï¼šå¦‚æœæ­£åœ¨æ˜¾ç¤ºé¢æ¿ï¼Œç›´æ¥è¿”å›
    if(panelDisplaying) {
      console.log('é¢æ¿æ­£åœ¨æ˜¾ç¤ºä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
      return;
    }
    
    panelDisplaying = true; // æ ‡è®°é¢æ¿æ­£åœ¨æ˜¾ç¤º
    
    // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„é¢æ¿ï¼Œé¿å…é‡å¤æ˜¾ç¤º
    removeCustomMapInfo(); // ç§»é™¤åœ°å›¾ä¿¡æ¯é¢æ¿
    const existingHealthModal = document.querySelector('.health-modal-overlay');
    if(existingHealthModal) {
      existingHealthModal.remove(); // ç§»é™¤å¥åº·è¯¦æƒ…é¢æ¿
    }
    
    const d=f.properties,toStr=x=>x===undefined||x===null?'':String(x);
    const get=(...k)=>k.map(x=>d[x]).find(x=>x!==undefined&&x!==null&&x!=='')||'-';
    // åˆ¤æ–­æ˜¯å¦ä¸ºå‘Šè­¦ç‚¹ï¼šæœ‰alert_id/alertIdä¸”æœ‰alert_type/alertTypeï¼Œä¸”typeä¸æ˜¯health
    const isAlert=!!(get('alert_id','alertId')&&get('alert_type','alertType')&&d.type!=='health');
    console.log('showCustomMapInfo.d',d);
    console.log('showCustomMapInfo.isAlert',isAlert);
    const level=get('severity_level','severityLevel');
    const levelColor=level==='critical'?'#ff4d4f':level==='high'?'#ffbb00':'#ffe066';
    const avatarUrl=d.avatar||'/static/images/avatar-tech.svg';
    const div=document.createElement('div');
    div.className='custom-map-info';
    div.style.cssText='position:absolute;z-index:9999;min-width:360px;max-width:420px;background:rgba(10,24,48,0.98);border:1.5px solid #00e4ff;border-radius:16px;box-shadow:0 0 24px #00e4ff44;padding:22px 28px 18px 28px;color:#fff;top:120px;left:50%;transform:translateX(-50%);font-size:15px;font-family:Roboto,Arial,sans-serif;backdrop-filter:blur(6px);';
    // è·å–ä½ç½®ä¿¡æ¯
        const longitude = get('longitude');
        const latitude = get('latitude');
        if(longitude && latitude){
          reverseGeocode(longitude, latitude)
            .then(address => {
              const locationInfo = document.getElementById('locationInfo');
              if(locationInfo){
                locationInfo.textContent = address || 'æœªçŸ¥ä½ç½®';
              }
            })
            .catch(error => {
              console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
              const locationInfo = document.getElementById('locationInfo');
              if(locationInfo){
                locationInfo.textContent = 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
              }
            });
        }
    if(isAlert){
      
      // å‘Šè­¦ç‚¹å†…å®¹
      // å‘Šè­¦ç‚¹å†…å®¹ - ä¸“ä¸šç§‘æŠ€é£æ ¼
div.innerHTML=`
<div style="
  background: linear-gradient(135deg, rgba(15,25,45,0.95) 0%, rgba(25,35,65,0.98) 50%, rgba(15,25,45,0.95) 100%);
  border-radius: 20px; 
  border: 2px solid rgba(255,68,68,0.5); 
  box-shadow: 0 20px 60px rgba(255,68,68,0.3), 0 0 30px rgba(255,68,68,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
  padding: 24px; 
  color: #fff; 
  position: relative; 
  overflow: hidden;
  animation: alertPulse 2s infinite, slideIn 0.5s ease-out;
  min-width: 380px;
">
  
  <!-- èƒŒæ™¯åŠ¨æ€æ•ˆæœ -->
  <div style="
    position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,68,68,0.1), transparent);
    animation: scanLine 3s infinite linear;
  "></div>
  
  <!-- å‘Šè­¦çº§åˆ«æŒ‡ç¤ºå™¨ -->
  <div style="
    position: absolute; top: -1px; left: -1px; right: -1px; height: 4px;
    background: linear-gradient(90deg, #ff4444, #ff6b6b, #ff4444);
    border-radius: 20px 20px 0 0;
    animation: levelGlow 1.5s infinite alternate;
  "></div>
  
  <!-- å¤´éƒ¨ä¿¡æ¯ -->
  <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;position:relative;z-index:2;">
    <div style="position:relative;">
      <img src="${avatarUrl}" style="
        width:64px;height:64px;border-radius:50%;
        border:3px solid #ff4444;
        box-shadow:0 0 20px rgba(255,68,68,0.6), inset 0 0 10px rgba(255,68,68,0.2);
        object-fit:cover;background:#001529;
        animation: avatarGlow 2s infinite alternate;
      ">
      <!-- å‘Šè­¦çŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <div style="
        position:absolute;top:-2px;right:-2px;
        width:20px;height:20px;border-radius:50%;
        background: radial-gradient(circle, #ff4444 30%, transparent 70%);
        border:2px solid #fff;
        animation: alertBlink 1s infinite;
      "></div>
    </div>
    <div style="flex:1;">
      <div style="
        font-size:20px;font-weight:700;letter-spacing:1.2px;
        color:#fff;text-shadow:0 0 10px rgba(255,255,255,0.5);
        margin-bottom:4px;
      ">${get('dept_name','deptName')}</div>
      <div style="
        font-size:18px;color:#00e4ff;font-weight:600;
        text-shadow:0 0 8px rgba(0,228,255,0.6);
      ">${get('user_name','userName')}</div>
    </div>
    <!-- å‘Šè­¦å›¾æ ‡ -->
    <div style="
      width:48px;height:48px;border-radius:12px;
      background:linear-gradient(135deg, rgba(255,68,68,0.3) 0%, rgba(220,38,38,0.5) 100%);
      display:flex;align-items:center;justify-content:center;
      font-size:24px;
      box-shadow:0 4px 15px rgba(255,68,68,0.4);
      animation: iconPulse 1.5s infinite ease-in-out;
    ">âš ï¸</div>
  </div>
  
  <!-- å‘Šè­¦è¯¦æƒ…å¡ç‰‡ç»„ -->
  <div style="
    display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:16px;margin-bottom:20px;
  ">
    <!-- å‘Šè­¦ç±»åˆ«å¡ç‰‡ -->
    <div style="
      background:rgba(0,21,41,0.6);border-radius:12px;padding:16px;
      border:1px solid rgba(255,68,68,0.3);
      transition:all 0.3s ease;
    " onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 25px rgba(255,68,68,0.4)';" 
       onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none';">
      <div style="color:#7ecfff;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">å‘Šè­¦ç±»åˆ«</div>
      <div style="
        color:${getAlertTypeColor(get('alert_type','alertType','-'))};
        font-weight:700;font-size:16px;
        text-shadow:0 0 8px currentColor;
      ">${translateAlertType(get('alert_type','alertType','-'))}</div>
    </div>
    
    <!-- å‘Šè­¦çº§åˆ«å¡ç‰‡ -->
    <div style="
      background:rgba(0,21,41,0.6);border-radius:12px;padding:16px;
      border:1px solid rgba(255,187,0,0.3);
      transition:all 0.3s ease;
    " onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 25px rgba(255,187,0,0.4)';" 
       onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none';">
      <div style="color:#7ecfff;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">å‘Šè­¦çº§åˆ«</div>
      <div style="
        color:${getAlertSeverityColor(level||'-')};
        font-weight:700;font-size:16px;
        text-shadow:0 0 8px currentColor;
      ">${translateAlertSeverity(level||'-')}</div>
    </div>
    
    <!-- å‘Šè­¦çŠ¶æ€å¡ç‰‡ -->
    <div style="
      background:rgba(0,21,41,0.6);border-radius:12px;padding:16px;
      border:1px solid rgba(0,228,255,0.3);
      transition:all 0.3s ease;
    " onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 25px rgba(0,228,255,0.4)';" 
       onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none';">
      <div style="color:#7ecfff;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">å¤„ç†çŠ¶æ€</div>
      <div style="
        color:${getAlertStatusColor(get('alert_status','status','-'))};
        font-weight:700;font-size:16px;
        text-shadow:0 0 8px currentColor;
      ">${translateAlertStatus(get('alert_status','status','-'))}</div>
    </div>
  </div>
  
  <!-- å¥åº·ä¿¡æ¯é“¾æ¥ -->
  <div style="
    background:linear-gradient(135deg, rgba(0,228,255,0.1) 0%, rgba(0,180,255,0.2) 100%);
    border-radius:12px;padding:16px;margin-bottom:16px;
    border:1px solid rgba(0,228,255,0.3);
    position:relative;overflow:hidden;
  ">
    <div style="color:#7ecfff;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">å¥åº·æ•°æ®è¯¦æƒ…</div>
    <a href="javascript:void(0)" onclick="showHealthProfile('${get('health_id','healthId')}')" style="
      color:#00e4ff;text-decoration:none;font-family:monospace;font-size:16px;font-weight:600;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 16px;border-radius:8px;
      background:rgba(0,228,255,0.1);border:1px solid rgba(0,228,255,0.3);
      transition:all 0.3s ease;
      text-shadow:0 0 10px rgba(0,228,255,0.5);
    " onmouseover="this.style.background='rgba(0,228,255,0.2)';this.style.transform='scale(1.05)';" 
       onmouseout="this.style.background='rgba(0,228,255,0.1)';this.style.transform='scale(1)';">
      <span>ğŸ“Š</span>${get('health_id','healthId')}
    </a>
  </div>
  
  <!-- ä½ç½®å’Œæ—¶é—´ä¿¡æ¯ -->
  <div style="
    display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;
  ">
    <div style="
      background:rgba(0,21,41,0.4);border-radius:10px;padding:12px;
      border:1px solid rgba(0,228,255,0.2);
    ">
      <div style="color:#7ecfff;font-size:11px;margin-bottom:6px;text-transform:uppercase;">ä½ç½®ä¿¡æ¯</div>
      <div style="color:#fff;font-size:13px;" id="locationInfo">ğŸŒ æ­£åœ¨è·å–...</div>
    </div>
    <div style="
      background:rgba(0,21,41,0.4);border-radius:10px;padding:12px;
      border:1px solid rgba(0,228,255,0.2);
    ">
      <div style="color:#7ecfff;font-size:11px;margin-bottom:6px;text-transform:uppercase;">å‘Šè­¦æ—¶é—´</div>
      <div style="color:#fff;font-size:13px;">â° ${get('alert_timestamp','timestamp','-')}</div>
    </div>
  </div>
  
  <!-- æ“ä½œæŒ‰é’®åŒº -->
  <div style="display:flex;gap:16px;align-items:center;position:relative;z-index:2;">
    <button onclick="handleAlert('${get('alert_id','alertId')}')" style="
      padding:12px 24px;
      background:linear-gradient(135deg, ${levelColor} 0%, ${levelColor}dd 100%);
      color:#001529;border:none;border-radius:10px;cursor:pointer;
      font-weight:700;font-size:14px;
      box-shadow:0 4px 15px ${levelColor}66, inset 0 1px 0 rgba(255,255,255,0.2);
      transition:all 0.3s ease;
      text-transform:uppercase;letter-spacing:1px;
    " onmouseover="this.style.transform='translateY(-2px) scale(1.05)';this.style.boxShadow='0 8px 25px ${levelColor}88';" 
       onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 4px 15px ${levelColor}66';">
      ğŸš€ ä¸€é”®å¤„ç†
    </button>
    <div style="flex:1;"></div>
    <button onclick="removeCustomMapInfo()" style="
      width:44px;height:44px;border-radius:50%;
      background:rgba(0,228,255,0.1);border:2px solid rgba(0,228,255,0.3);
      color:#00e4ff;cursor:pointer;display:flex;align-items:center;justify-content:center;
      font-size:20px;font-weight:700;
      transition:all 0.3s ease;
      backdrop-filter:blur(10px);
    " onmouseover="this.style.background='rgba(0,228,255,0.2)';this.style.transform='scale(1.1) rotate(90deg)';this.style.boxShadow='0 0 20px rgba(0,228,255,0.6)';" 
       onmouseout="this.style.background='rgba(0,228,255,0.1)';this.style.transform='scale(1) rotate(0deg)';this.style.boxShadow='none';">
      âœ•
    </button>
  </div>
</div>
`;
      document.body.appendChild(div);
      
  
    } else {
      // å¥åº·ç‚¹å†…å®¹
      // å¥åº·ç‚¹å†…å®¹ - ç§‘æŠ€å¥åº·é£æ ¼
// å¥åº·ç‚¹å†…å®¹ - ç§‘æŠ€å¥åº·é£æ ¼
div.innerHTML=`
  <div style="
    background: linear-gradient(135deg, rgba(10,24,48,0.95) 0%, rgba(15,35,65,0.98) 50%, rgba(10,24,48,0.95) 100%);
    border-radius: 24px; 
    border: 2px solid rgba(0,228,255,0.4); 
    box-shadow: 0 25px 80px rgba(0,228,255,0.3), 0 0 40px rgba(0,228,255,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
    padding: 28px; 
    color: #fff; 
    position: relative; 
    overflow: hidden;
    animation: healthGlow 3s infinite ease-in-out, slideIn 0.6s ease-out;
    min-width: 420px;
  ">
    
    <!-- èƒŒæ™¯ç§‘æŠ€çº¹ç† -->
    <div style="
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 20% 20%, rgba(0,228,255,0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(0,180,255,0.1) 0%, transparent 50%);
      animation: bgShift 6s infinite ease-in-out;
    "></div>
    
    <!-- å¥åº·çŠ¶æ€é¡¶éƒ¨æŒ‡ç¤ºæ¡ -->
    <div style="
      position: absolute; top: -1px; left: -1px; right: -1px; height: 4px;
      background: linear-gradient(90deg, #00ff88, #00e4ff, #00ff88);
      border-radius: 24px 24px 0 0;
      animation: healthPulse 2s infinite alternate;
    "></div>
    
    <!-- å¤´éƒ¨ç”¨æˆ·ä¿¡æ¯ -->
    <div style="display:flex;align-items:center;gap:20px;margin-bottom:24px;position:relative;z-index:2;">
      <div style="position:relative;">
        <img src="${avatarUrl}" style="
          width:72px;height:72px;border-radius:50%;
          border:3px solid #00e4ff;
          box-shadow:0 0 25px rgba(0,228,255,0.6), inset 0 0 15px rgba(0,228,255,0.2);
          object-fit:cover;background:#001529;
          animation: healthAvatarGlow 3s infinite ease-in-out;
        ">
        <!-- å¥åº·çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div style="
          position:absolute;bottom:-2px;right:-2px;
          width:24px;height:24px;border-radius:50%;
          background: radial-gradient(circle, #00ff88 40%, transparent 70%);
          border:3px solid #fff;
          animation: healthBeat 1.5s infinite ease-in-out;
        ">ğŸ’š</div>
      </div>
      <div style="flex:1;">
        <div style="
          font-size:22px;font-weight:700;letter-spacing:1.2px;
          color:#fff;text-shadow:0 0 15px rgba(255,255,255,0.5);
          margin-bottom:6px;
        ">${get('dept_name','deptName')}</div>
        <div style="
          font-size:18px;color:#00e4ff;font-weight:600;
          text-shadow:0 0 12px rgba(0,228,255,0.6);
        ">${get('user_name','userName')}</div>
      </div>
      <!-- å¥åº·å›¾æ ‡ -->

      <!-- ä¸ªäººå¤§å±æŒ‰é’® -->
      <div>
        <button onclick="window.open('personal?deviceSn=${get('deviceSn')}', '_blank')" style="
          padding:12px 20px;
          background:linear-gradient(135deg, rgba(0,228,255,0.3) 0%, rgba(0,180,255,0.5) 100%);
          border:2px solid rgba(0,228,255,0.4);
          border-radius:12px;
          color:#00e4ff;
          font-size:14px;
          font-weight:700;
          cursor:pointer;
          display:flex;
          align-items:center;
          gap:8px;
          transition:all 0.3s ease;
          text-shadow:0 0 8px rgba(0,228,255,0.5);
          box-shadow:0 4px 15px rgba(0,228,255,0.2);
          backdrop-filter:blur(10px);
        " onmouseover="this.style.background='linear-gradient(135deg, rgba(0,228,255,0.5) 0%, rgba(0,180,255,0.7) 100%)';this.style.transform='translateY(-3px) scale(1.05)';this.style.boxShadow='0 8px 25px rgba(0,228,255,0.4)';" 
           onmouseout="this.style.background='linear-gradient(135deg, rgba(0,228,255,0.3) 0%, rgba(0,180,255,0.5) 100%)';this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 4px 15px rgba(0,228,255,0.2)';">
          <span>ğŸ“Š</span>
          <span>ä¸ªäººå¤§å±</span>
        </button>
      </div>
    </div>
    
    <!-- å¥åº·æŒ‡æ ‡ç½‘æ ¼ -->
    <div style="
      display:grid;grid-template-columns:repeat(2,1fr);
      gap:16px;margin-bottom:20px;
    ">
      <!-- å¿ƒç‡è¡€å‹å¡ç‰‡ -->
      <div style="
        background:rgba(0,21,41,0.6);border-radius:16px;padding:18px;
        border:1px solid rgba(255,107,107,0.3);
        transition:all 0.4s ease;position:relative;overflow:hidden;
      " onmouseover="this.style.transform='translateY(-6px)';this.style.boxShadow='0 12px 35px rgba(255,107,107,0.4)';" 
         onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none';">
        <div style="
          display:flex;align-items:center;gap:12px;margin-bottom:12px;
        ">
          <div style="
            width:40px;height:40px;border-radius:10px;
            background:linear-gradient(135deg, rgba(255,107,107,0.3) 0%, rgba(238,90,36,0.5) 100%);
            display:flex;align-items:center;justify-content:center;font-size:20px;
          ">â¤ï¸</div>
          <div>
            <div style="color:#7ecfff;font-size:11px;text-transform:uppercase;letter-spacing:1px;">ç”Ÿå‘½ä½“å¾</div>
            <div style="color:#fff;font-size:14px;font-weight:600;">å¿ƒç‡ & è¡€å‹</div>
          </div>
        </div>
        <div style="
          display:flex;justify-content:space-between;align-items:center;
        ">
          <div>
            <div style="color:#ff6b6b;font-size:18px;font-weight:700;">${get('heartRate','heart_rate')} <span style="font-size:12px;color:#888;">bpm</span></div>
            <div style="color:#7ecfff;font-size:14px;">${get('pressureHigh','pressure_high')}/${get('pressureLow','pressure_low')} mmHg</div>
          </div>
          <!-- å¿ƒç‡å¯è§†åŒ– -->
          <div style="
            width:50px;height:30px;
            background:linear-gradient(90deg, transparent, rgba(255,107,107,0.3), transparent);
            border-radius:4px;position:relative;overflow:hidden;
          ">
            <div style="
              width:4px;height:100%;background:#ff6b6b;
              animation: heartbeatLine 1.5s infinite ease-in-out;
              box-shadow:0 0 10px #ff6b6b;
            "></div>
          </div>
        </div>
      </div>
      
      <!-- è¡€æ°§ä½“æ¸©å¡ç‰‡ -->
      <div style="
        background:rgba(0,21,41,0.6);border-radius:16px;padding:18px;
        border:1px solid rgba(0,255,136,0.3);
        transition:all 0.4s ease;position:relative;overflow:hidden;
      " onmouseover="this.style.transform='translateY(-6px)';this.style.boxShadow='0 12px 35px rgba(0,255,136,0.4)';" 
         onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none';">
        <div style="
          display:flex;align-items:center;gap:12px;margin-bottom:12px;
        ">
          <div style="
            width:40px;height:40px;border-radius:10px;
            background:linear-gradient(135deg, rgba(0,255,136,0.3) 0%, rgba(0,204,102,0.5) 100%);
            display:flex;align-items:center;justify-content:center;font-size:20px;
          ">ğŸ«</div>
          <div>
            <div style="color:#7ecfff;font-size:11px;text-transform:uppercase;letter-spacing:1px;">å‘¼å¸ä½“æ¸©</div>
            <div style="color:#fff;font-size:14px;font-weight:600;">è¡€æ°§ & ä½“æ¸©</div>
          </div>
        </div>
        <div style="
          display:flex;justify-content:space-between;align-items:center;
        ">
          <div>
            <div style="color:#00ff88;font-size:18px;font-weight:700;">${get('bloodOxygen','blood_oxygen')} <span style="font-size:12px;color:#888;">%</span></div>
            <div style="color:#7ecfff;font-size:14px;">${get('temperature','temp')} â„ƒ</div>
          </div>
          <!-- è¡€æ°§ç¯å½¢è¿›åº¦ -->
          <div style="position:relative;width:40px;height:40px;">
            <svg width="40" height="40" style="transform:rotate(-90deg);">
              <circle cx="20" cy="20" r="16" stroke="rgba(0,255,136,0.2)" stroke-width="3" fill="none"/>
              <circle cx="20" cy="20" r="16" stroke="#00ff88" stroke-width="3" fill="none"
                stroke-dasharray="100.48" stroke-dashoffset="${100.48 * (1 - (get('bloodOxygen','blood_oxygen')||95)/100)}"
                style="transition:stroke-dashoffset 1s ease;"/>
            </svg>
            <div style="
              position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
              font-size:10px;font-weight:700;color:#00ff88;
            ">${get('bloodOxygen','blood_oxygen')||'-'}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- è¿åŠ¨æ•°æ®æ¨ªæ¡ -->
    <div style="
      background:linear-gradient(135deg, rgba(138,43,226,0.2) 0%, rgba(75,0,130,0.3) 100%);
      border-radius:16px;padding:20px;margin-bottom:20px;
      border:1px solid rgba(138,43,226,0.4);
      position:relative;overflow:hidden;
    ">
      <div style="
        display:flex;align-items:center;gap:16px;margin-bottom:16px;
      ">
        <div style="
          width:48px;height:48px;border-radius:12px;
          background:linear-gradient(135deg, rgba(138,43,226,0.4) 0%, rgba(75,0,130,0.6) 100%);
          display:flex;align-items:center;justify-content:center;font-size:24px;
        ">ğŸƒ</div>
        <div>
          <div style="color:#9d4edd;font-size:18px;font-weight:700;">è¿åŠ¨æ•°æ®ç»Ÿè®¡</div>
          <div style="color:#7ecfff;font-size:12px;">Activity & Fitness Metrics</div>
        </div>
      </div>
      <div style="
        display:grid;grid-template-columns:repeat(4,1fr);gap:16px;
      ">
        <div style="text-align:center;padding:12px;border-radius:10px;background:rgba(0,0,0,0.3);">
          <div style="color:#9d4edd;font-size:20px;font-weight:700;">${get('step','steps')||'-'}</div>
          <div style="color:#7ecfff;font-size:10px;text-transform:uppercase;">æ­¥æ•°</div>
        </div>
        <div style="text-align:center;padding:12px;border-radius:10px;background:rgba(0,0,0,0.3);">
          <div style="color:#9d4edd;font-size:20px;font-weight:700;">${get('distance','distance')||'-'}</div>
          <div style="color:#7ecfff;font-size:10px;text-transform:uppercase;">è·ç¦»(ç±³)</div>
        </div>
        <div style="text-align:center;padding:12px;border-radius:10px;background:rgba(0,0,0,0.3);">
          <div style="color:#9d4edd;font-size:20px;font-weight:700;">${get('calorie','calories')||'-'}</div>
          <div style="color:#7ecfff;font-size:10px;text-transform:uppercase;">å¡è·¯é‡Œ</div>
        </div>
        <div style="text-align:center;padding:12px;border-radius:10px;background:rgba(0,0,0,0.3);">
          <div style="color:#9d4edd;font-size:20px;font-weight:700;">${get('stress','pressure')||'-'}</div>
          <div style="color:#7ecfff;font-size:10px;text-transform:uppercase;">å‹åŠ›å€¼</div>
        </div>
      </div>
    </div>
    
    <!-- ä½ç½®å’Œæ—¶é—´ä¿¡æ¯ -->
    <div style="
      display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;
    ">
      <div style="
        background:rgba(0,21,41,0.5);border-radius:12px;padding:16px;
        border:1px solid rgba(0,228,255,0.3);
      ">
        <div style="color:#7ecfff;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">ä½ç½®ä¿¡æ¯</div>
        <div style="color:#fff;font-size:14px;display:flex;align-items:center;gap:8px;" id="locationInfo">
          <span>ğŸŒ</span><span>æ­£åœ¨è·å–ä½ç½®...</span>
        </div>
      </div>
      <div style="
        background:rgba(0,21,41,0.5);border-radius:12px;padding:16px;
        border:1px solid rgba(0,228,255,0.3);
      ">
        <div style="color:#7ecfff;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">é‡‡é›†æ—¶é—´</div>
        <div style="color:#fff;font-size:14px;display:flex;align-items:center;gap:8px;">
          <span>â°</span><span>${get('timestamp')}</span>
        </div>
      </div>
    </div>
    
    <!-- å…³é—­æŒ‰é’® -->
    <div style="display:flex;justify-content:flex-end;position:relative;z-index:2;">
      <button onclick="removeCustomMapInfo()" style="
        width:48px;height:48px;border-radius:50%;
        background:rgba(0,228,255,0.1);border:2px solid rgba(0,228,255,0.3);
        color:#00e4ff;cursor:pointer;display:flex;align-items:center;justify-content:center;
        font-size:22px;font-weight:700;
        transition:all 0.3s ease;
        backdrop-filter:blur(15px);
      " onmouseover="this.style.background='rgba(0,228,255,0.2)';this.style.transform='scale(1.15) rotate(90deg)';this.style.boxShadow='0 0 25px rgba(0,228,255,0.7)';" 
         onmouseout="this.style.background='rgba(0,228,255,0.1)';this.style.transform='scale(1) rotate(0deg)';this.style.boxShadow='none';">
        âœ•
      </button>
    </div>
  </div>
`;
      document.body.appendChild(div);
      
      // å»¶è¿Ÿé‡ç½®é˜²æŠ–æ ‡å¿—ï¼Œç»™é¢æ¿æ¸²æŸ“ç•™å‡ºæ—¶é—´
      setTimeout(() => {
        panelDisplaying = false;
        console.log('åœ°å›¾é¢æ¿æ¸²æŸ“å®Œæˆï¼Œé‡ç½®æ˜¾ç¤ºçŠ¶æ€');
      }, 300);
      
      // è·å–ä½ç½®ä¿¡æ¯
      const longitude = get('longitude');
      const latitude = get('latitude');
      if(longitude && latitude){
        reverseGeocode(longitude, latitude)
          .then(address => {
            const locationInfo = document.getElementById('locationInfo');
            if(locationInfo){
              locationInfo.textContent = address || 'æœªçŸ¥ä½ç½®';
            }
          })
          .catch(error => {
            console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
            const locationInfo = document.getElementById('locationInfo');
            if(locationInfo){
              locationInfo.textContent = 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
            }
          });
      }
    }
  }
  function showHealthProfile(healthId){
    // é˜²æŠ–ï¼šå¦‚æœæ­£åœ¨æ˜¾ç¤ºé¢æ¿ï¼Œç›´æ¥è¿”å›
    if(panelDisplaying) {
      console.log('é¢æ¿æ­£åœ¨æ˜¾ç¤ºä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
      return;
    }
    
    panelDisplaying = true; // æ ‡è®°é¢æ¿æ­£åœ¨æ˜¾ç¤º
    
    // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„é¢æ¿ï¼Œé¿æ­¢é‡å¤æ˜¾ç¤º
    removeCustomMapInfo(); // ç§»é™¤åœ°å›¾ä¿¡æ¯é¢æ¿
    const existingHealthModal = document.querySelector('.health-modal-overlay');
    if(existingHealthModal) {
      existingHealthModal.remove(); // ç§»é™¤å·²å­˜åœ¨çš„å¥åº·è¯¦æƒ…é¢æ¿
    }
    
    fetch(`/fetchHealthDataById?id=${healthId}`).then(r=>r.json()).then(j=>{
      if(!j.success||!j.data)return showCustomAlert('æ— å¥åº·æ•°æ®');
      const d=j.data,g=(...k)=>k.map(x=>d[x]).find(x=>x!==undefined&&x!==null&&x!=='')||'-';
      let sleepStr=g('sleepData','scientificSleepData'),sleep='-';
      try{
        if(typeof sleepStr==='string'&&sleepStr.startsWith('{')){
          const o=JSON.parse(sleepStr),arr=o.data||[];
          if(arr.length){
            const s=arr[0],fmt=m=>m?`${Math.floor(m/60)}h${m%60}m`:'-';
            sleep=`æ€»:${fmt(s.total)} æ·±:${fmt(s.deep)} æµ…:${fmt(s.light)} é†’:${fmt(s.awake)}`;
          }
        }
      }catch(e){sleep='-';}
      
      // å¥åº·æ•°æ®è¯„åˆ†è®¡ç®—
      const heartRate = parseInt(g('heartRate','heart_rate')) || 0;
      const bloodOxygen = parseInt(g('bloodOxygen','blood_oxygen')) || 0;
      const temperature = parseFloat(g('temperature','temp')) || 0;
      const steps = parseInt(g('step','steps')) || 0;
      
      const getHealthScore = () => {
        let score = 0;
        if(heartRate >= 60 && heartRate <= 100) score += 25;
        if(bloodOxygen >= 95) score += 25;
        if(temperature >= 36.1 && temperature <= 37.2) score += 25;
        if(steps >= 8000) score += 25;
        return Math.min(score, 100);
      };
      
      const healthScore = getHealthScore();
      const getScoreColor = (score) => {
        if(score >= 80) return '#00ff88';
        if(score >= 60) return '#ffbb00';
        return '#ff4444';
      };
      
      const html=`
        <div class="health-profile-header">
          <div class="health-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="url(#heartGradient)"/>
              <defs>
                <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#ee5a24;stop-opacity:1" />
                </linearGradient>
              </defs>
            </svg>
          </div>
          <div class="health-title">
            <div class="title-main">æ™ºèƒ½å¥åº·ç›‘æµ‹</div>
            <div class="title-sub">Health Profile Analysis</div>
          </div>
          <div class="health-score-circle">
            <svg width="60" height="60" class="score-ring">
              <circle cx="30" cy="30" r="25" stroke="rgba(0,228,255,0.2)" stroke-width="3" fill="none"/>
              <circle cx="30" cy="30" r="25" stroke="${getScoreColor(healthScore)}" stroke-width="3" fill="none"
                stroke-dasharray="${2 * Math.PI * 25}" stroke-dashoffset="${2 * Math.PI * 25 * (1 - healthScore/100)}"
                transform="rotate(-90 30 30)" class="score-progress"/>
            </svg>
            <div class="score-text">${healthScore}</div>
          </div>
        </div>
        
        <div class="health-metrics-grid">
          <div class="metric-card vital">
            <div class="metric-icon">
              <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-width="2" d="M12 8V4m0 4V2m0 6v4m0 0v6m0-6h8m-8 0H4"/>
              </svg>
            </div>
            <div class="metric-info">
              <div class="metric-label">å¿ƒç‡ç›‘æµ‹</div>
              <div class="metric-value ${heartRate>=60&&heartRate<=100?'normal':'abnormal'}">${g('heartRate','heart_rate')||'-'} <span class="unit">bpm</span></div>
              <div class="metric-bar">
                <div class="bar-fill heart-rate" style="width:${Math.min((heartRate/120)*100,100)}%"></div>
              </div>
            </div>
          </div>
          
          <div class="metric-card pressure">
            <div class="metric-icon">
              <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path stroke="currentColor" stroke-width="2" d="M12 8v8m-4-4h8"/>
              </svg>
            </div>
            <div class="metric-info">
              <div class="metric-label">è¡€å‹ç›‘æµ‹</div>
              <div class="metric-value">${(g('pressureHigh','pressure_high')||'-')+'/'+(g('pressureLow','pressure_low')||'-')} <span class="unit">mmHg</span></div>
              <div class="metric-status ${parseInt(g('pressureHigh'))<140&&parseInt(g('pressureLow'))<90?'normal':'warning'}">
                ${parseInt(g('pressureHigh'))<140&&parseInt(g('pressureLow'))<90?'æ­£å¸¸èŒƒå›´':'éœ€è¦å…³æ³¨'}
              </div>
            </div>
          </div>
          
          <div class="metric-card oxygen">
            <div class="metric-icon">
              <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-width="2" d="M12 2L2 12l10 10 10-10L12 2z"/>
                <path stroke="currentColor" stroke-width="2" d="M12 8v8"/>
              </svg>
            </div>
            <div class="metric-info">
              <div class="metric-label">è¡€æ°§é¥±å’Œåº¦</div>
              <div class="metric-value ${bloodOxygen>=95?'normal':'abnormal'}">${g('bloodOxygen','blood_oxygen')||'-'} <span class="unit">%</span></div>
              <div class="metric-bar">
                <div class="bar-fill oxygen" style="width:${bloodOxygen}%"></div>
              </div>
            </div>
          </div>
          
          <div class="metric-card temperature">
            <div class="metric-icon">
              <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-width="2" d="M14 3v7a3 3 0 1 1-6 0V3a3 3 0 1 1 6 0z"/>
                <path stroke="currentColor" stroke-width="2" d="M11 14h2"/>
              </svg>
            </div>
            <div class="metric-info">
              <div class="metric-label">ä½“æ¸©ç›‘æµ‹</div>
              <div class="metric-value ${temperature>=36.1&&temperature<=37.2?'normal':'abnormal'}">${g('temperature','temp')||'-'} <span class="unit">â„ƒ</span></div>
              <div class="temperature-indicator ${temperature>=36.1&&temperature<=37.2?'normal':'abnormal'}">
                ${temperature>=36.1&&temperature<=37.2?'ä½“æ¸©æ­£å¸¸':'å¼‚å¸¸ä½“æ¸©'}
              </div>
            </div>
          </div>
          
          <div class="metric-card activity">
            <div class="metric-icon">
              <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-width="2" d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5"/>
                <path stroke="currentColor" stroke-width="2" d="M12 5L8 21h8l-4-16z"/>
              </svg>
            </div>
            <div class="metric-info">
              <div class="metric-label">è¿åŠ¨æ•°æ®</div>
              <div class="activity-stats">
                <div class="activity-item">
                  <span class="activity-num">${g('step','steps')||'-'}</span>
                  <span class="activity-label">æ­¥æ•°</span>
                </div>
                <div class="activity-item">
                  <span class="activity-num">${g('distance','distance')||'-'}</span>
                  <span class="activity-label">ç±³</span>
                </div>
                <div class="activity-item">
                  <span class="activity-num">${g('calorie','calories')||'-'}</span>
                  <span class="activity-label">å¡è·¯é‡Œ</span>
                </div>
              </div>
              <div class="progress-ring-container">
                <div class="progress-ring">
                  <div class="ring-progress" style="--progress:${Math.min((steps/10000)*100,100)}%"></div>
                  <div class="ring-text">${Math.min(Math.round((steps/10000)*100),100)}%</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="metric-card stress">
            <div class="metric-icon">
              <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-width="2" d="M12 2v20M2 12h20"/>
                <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <div class="metric-info">
              <div class="metric-label">å‹åŠ›æŒ‡æ•°</div>
              <div class="metric-value">${g('stress','pressure')||'-'} <span class="unit">åˆ†</span></div>
              <div class="stress-level ${parseInt(g('stress','pressure'))<=50?'low':parseInt(g('stress','pressure'))<=70?'medium':'high'}">
                ${parseInt(g('stress','pressure'))<=50?'å‹åŠ›è¾ƒä½':parseInt(g('stress','pressure'))<=70?'å‹åŠ›é€‚ä¸­':'å‹åŠ›åé«˜'}
              </div>
            </div>
          </div>
        </div>
        
        <div class="sleep-analysis">
          <div class="sleep-header">
            <div class="sleep-icon">
              <svg width="20" height="20" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-width="2" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
              </svg>
            </div>
            <div class="sleep-title">ç¡çœ åˆ†æ</div>
          </div>
          <div class="sleep-content">${sleep}</div>
        </div>
        
        <div class="timestamp-info">
          <div class="time-icon">â°</div>
          <div class="time-text">æ•°æ®é‡‡é›†æ—¶é—´ï¼š${g('timestamp')||'-'}</div>
        </div>
      `;
      
      const m=document.createElement('div');
      m.className = 'health-modal-overlay';
      m.innerHTML=`
        <div class="health-modal-content">
          <div class="modal-close" onclick="removeCustomMapInfo()">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24">
              <path stroke="currentColor" stroke-width="2" d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </div>
          ${html}
        </div>
      `;
      
      // æ·»åŠ CSSæ ·å¼
      if(!document.querySelector('#health-profile-styles')){
        const style = document.createElement('style');
        style.id = 'health-profile-styles';
        style.textContent = `
          .health-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(ellipse at center, rgba(0,21,41,0.95) 0%, rgba(0,10,25,0.98) 100%);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(8px); animation: fadeIn 0.3s ease-out;
          }
          @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
          
          .health-modal-content {
            background: linear-gradient(135deg, rgba(10,24,48,0.95) 0%, rgba(15,35,65,0.98) 100%);
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,228,255,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            padding: 32px; min-width: 480px; max-width: 600px; color: #fff; position: relative;
            border: 1px solid rgba(0,228,255,0.2); animation: slideUp 0.4s ease-out;
            max-height: 90vh; overflow-y: auto;
          }
          @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
          
          .modal-close {
            position: absolute; right: 16px; top: 16px; cursor: pointer;
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: rgba(0,228,255,0.1); border: 1px solid rgba(0,228,255,0.3);
            color: #00e4ff; transition: all 0.3s ease;
          }
          .modal-close:hover { background: rgba(0,228,255,0.2); transform: scale(1.1); }
          
          .health-profile-header {
            display: flex; align-items: center; gap: 20px; margin-bottom: 32px;
            padding: 20px; background: linear-gradient(90deg, rgba(0,228,255,0.05) 0%, rgba(0,180,255,0.1) 100%);
            border-radius: 16px; border: 1px solid rgba(0,228,255,0.1);
          }
          
          .health-icon {
            width: 64px; height: 64px; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle, rgba(255,107,107,0.2) 0%, rgba(238,90,36,0.3) 100%);
            border-radius: 50%; animation: pulse 2s infinite;
          }
          @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(255,107,107,0.7); } 50% { box-shadow: 0 0 0 20px rgba(255,107,107,0); } }
          
          .health-title { flex: 1; }
          .title-main { font-size: 24px; font-weight: 700; color: #00e4ff; margin-bottom: 4px; letter-spacing: 1px; }
          .title-sub { font-size: 12px; color: #7ecfff; opacity: 0.8; text-transform: uppercase; letter-spacing: 2px; }
          
          .health-score-circle {
            position: relative; width: 60px; height: 60px;
          }
          .score-ring { width: 60px; height: 60px; }
          .score-progress { transition: stroke-dashoffset 1s ease-out; }
          .score-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 18px; font-weight: 700; color: #00ff88;
          }
          
          .health-metrics-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; margin-bottom: 24px;
          }
          
          .metric-card {
            background: linear-gradient(135deg, rgba(0,21,41,0.6) 0%, rgba(0,35,70,0.8) 100%);
            border-radius: 16px; padding: 20px; border: 1px solid rgba(0,228,255,0.1);
            transition: all 0.3s ease; position: relative; overflow: hidden;
          }
          .metric-card::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,228,255,0.1), transparent);
            transition: left 0.6s ease;
          }
          .metric-card:hover::before { left: 100%; }
          .metric-card:hover { transform: translateY(-4px); box-shadow: 0 8px 32px rgba(0,228,255,0.2); }
          
          .metric-card { display: flex; gap: 16px; align-items: flex-start; }
          .metric-icon {
            width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, rgba(0,228,255,0.2) 0%, rgba(0,180,255,0.3) 100%);
            color: #00e4ff; flex-shrink: 0;
          }
          .metric-info { flex: 1; }
          .metric-label { font-size: 12px; color: #7ecfff; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
          .metric-value { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
          .metric-value.normal { color: #00ff88; }
          .metric-value.abnormal { color: #ff4444; }
          .unit { font-size: 14px; color: #888; font-weight: 400; }
          
          .metric-bar {
            height: 4px; background: rgba(126,207,255,0.2); border-radius: 2px; overflow: hidden; margin-top: 8px;
          }
          .bar-fill {
            height: 100%; border-radius: 2px; transition: width 1s ease-out;
          }
          .bar-fill.heart-rate { background: linear-gradient(90deg, #ff6b6b, #ee5a24); }
          .bar-fill.oxygen { background: linear-gradient(90deg, #00ff88, #00cc66); }
          
          .metric-status, .temperature-indicator, .stress-level {
            font-size: 11px; padding: 4px 8px; border-radius: 12px; display: inline-block; margin-top: 4px;
          }
          .metric-status.normal, .temperature-indicator.normal, .stress-level.low {
            background: rgba(0,255,136,0.2); color: #00ff88;
          }
          .metric-status.warning, .stress-level.medium {
            background: rgba(255,187,0,0.2); color: #ffbb00;
          }
          .temperature-indicator.abnormal, .stress-level.high {
            background: rgba(255,68,68,0.2); color: #ff4444;
          }
          
          .activity-stats {
            display: flex; gap: 16px; margin-bottom: 12px;
          }
          .activity-item {
            text-align: center;
          }
          .activity-num {
            display: block; font-size: 16px; font-weight: 700; color: #00e4ff;
          }
          .activity-label {
            font-size: 10px; color: #7ecfff; text-transform: uppercase;
          }
          
          .progress-ring-container {
            display: flex; justify-content: center; margin-top: 12px;
          }
          .progress-ring {
            position: relative; width: 40px; height: 40px;
          }
          .ring-progress {
            width: 40px; height: 40px; border-radius: 50%;
            background: conic-gradient(#00ff88 calc(var(--progress) * 1%), rgba(126,207,255,0.2) 0%);
            display: flex; align-items: center; justify-content: center;
          }
          .ring-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 10px; font-weight: 700; color: #00ff88;
          }
          
          .sleep-analysis {
            background: linear-gradient(135deg, rgba(0,21,41,0.6) 0%, rgba(15,25,45,0.8) 100%);
            border-radius: 16px; padding: 20px; margin-bottom: 20px;
            border: 1px solid rgba(0,228,255,0.1);
          }
          .sleep-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
          }
          .sleep-icon {
            width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, rgba(138,43,226,0.2) 0%, rgba(75,0,130,0.3) 100%);
            color: #9d4edd;
          }
          .sleep-title {
            font-size: 16px; font-weight: 600; color: #00e4ff;
          }
          .sleep-content {
            font-size: 14px; color: #fff; font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;
          }
          
          .timestamp-info {
            display: flex; align-items: center; gap: 12px; padding: 16px;
            background: rgba(0,228,255,0.05); border-radius: 12px;
            border: 1px solid rgba(0,228,255,0.1);
          }
          .time-icon { font-size: 16px; }
          .time-text { font-size: 13px; color: #7ecfff; }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(m);
      
      // å»¶è¿Ÿé‡ç½®é˜²æŠ–æ ‡å¿—ï¼Œç»™å¥åº·é¢æ¿æ¸²æŸ“ç•™å‡ºæ—¶é—´
      setTimeout(() => {
        panelDisplaying = false;
        console.log('å¥åº·é¢æ¿æ¸²æŸ“å®Œæˆï¼Œé‡ç½®æ˜¾ç¤ºçŠ¶æ€');
      }, 300);
    }).catch(()=>{
      showCustomAlert('è·å–å¥åº·æ•°æ®å¤±è´¥');
      // è·å–æ•°æ®å¤±è´¥æ—¶ä¹Ÿè¦é‡ç½®çŠ¶æ€
      panelDisplaying = false;
    });
  }
  
  function removeCustomMapInfo(){
    // ç§»é™¤åœ°å›¾ä¿¡æ¯é¢æ¿
    const mapInfo=document.querySelector('.custom-map-info');
    if(mapInfo)mapInfo.remove();
    
    // ç§»é™¤å¥åº·è¯¦æƒ…é¢æ¿
    const healthModal=document.querySelector('.health-modal-overlay');
    if(healthModal)healthModal.remove();
    
    // é‡ç½®é¢æ¿æ˜¾ç¤ºçŠ¶æ€ï¼Œå…è®¸æ–°çš„é¢æ¿æ˜¾ç¤º
    panelDisplaying = false;
    console.log('é¢æ¿å·²å…³é—­ï¼Œé‡ç½®æ˜¾ç¤ºçŠ¶æ€');
  }
  
  function filterData(data){
      //console.log('filterData.data',currentDept,currentUser);
  
      //console.log('filterData.data.health_count || 0',data.health_count || 0);
    const toStr=x=>x===undefined||x===null?'':String(x);
    const dept=toStr(currentDept),user=toStr(currentUser);
    const alerts=(data.alert_info?.alerts||[]).filter(a=>
      (!dept||[a.dept_id,a.deptId].some(v=>toStr(v)===dept))&&
      (!user||[a.user_id,a.userId].some(v=>toStr(v)===user))&&
      (['pending','1'].includes(toStr(a.alert_status||a.status)))
    );
    const healths=(data.health_data?.healthData||[]).filter(h=>
      (!dept||[h.dept_id,h.deptId].some(v=>toStr(v)===dept))&&
      (!user||[h.user_id,h.userId].some(v=>toStr(v)===user))
    );
    //console.log('filterData.alerts',alerts);
    //console.log('filterData.healths',healths);
    return {alerts,healths};
  }
  window.updateMapData = function(data) {
    console.log('updateMapData.data', data);
    // å¢å¼ºåœ°å›¾åˆå§‹åŒ–æ£€æŸ¥
    if (!data) {
        console.warn('âŒ æ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ›´æ–°åœ°å›¾');
        return;
    }
    
    // æ£€æŸ¥åœ°å›¾å®ä¾‹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é‡æ–°åˆå§‹åŒ–
    if (!map || !loca) {
        console.warn('ğŸ—ºï¸ åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ­£åœ¨é‡æ–°åˆå§‹åŒ–...');
        try {
            // é‡æ–°åˆå§‹åŒ–åœ°å›¾
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customerId') || '{{ customerId }}' || '1';
            initializeMap(customerId, '-1');
            
            // ç­‰å¾…åœ°å›¾åˆå§‹åŒ–å®Œæˆå†æ›´æ–°æ•°æ®
            setTimeout(() => {
                window.updateMapData(data);
            }, 1000);
            return;
        } catch (error) {
            console.error('âŒ åœ°å›¾é‡æ–°åˆå§‹åŒ–å¤±è´¥:', error);
            return;
        }
    }
    
    // æ£€æŸ¥åœ°å›¾å›¾å±‚æ˜¯å¦å­˜åœ¨
    if (!breathRed || !breathYellow || !breathGreen) {
        console.warn('ğŸ”§ åœ°å›¾å›¾å±‚æœªå®Œå…¨åˆå§‹åŒ–ï¼Œç­‰å¾…å›¾å±‚åˆ›å»º...');
        setTimeout(() => {
            window.updateMapData(data);
        }, 500);
        return;
    }
    
    const {alerts, healths} = filterData(data);
    
    function isValidCoordinate(lng, lat) {
        try {
            const longitude = parseFloat(lng);
            const latitude = parseFloat(lat);
            return !isNaN(longitude) && !isNaN(latitude) && 
                   isFinite(longitude) && isFinite(latitude) &&
                   longitude >= -180 && longitude <= 180 && 
                   latitude >= -90 && latitude <= 90 &&
                   longitude !== 0 && latitude !== 0;
        } catch (e) {
            console.warn('åæ ‡éªŒè¯é”™è¯¯:', e);
            return false;
        }
    }
    
    const validHealths = healths.filter(h => {
        const isValid = isValidCoordinate(h.longitude, h.latitude);
        if (!isValid) {
            console.log('æ— æ•ˆå¥åº·ç‚¹åæ ‡è¢«è¿‡æ»¤:', h.userName, h.longitude, h.latitude);
        }
        return isValid;
    });
    
    const healthFeatures = validHealths.map(h => ({
        type: 'Feature',
        geometry: {type: 'Point', coordinates: [parseFloat(h.longitude), parseFloat(h.latitude)]},
        properties: {
            ...h,
            dept_name: h.deptName || 'æœªçŸ¥éƒ¨é—¨',
            user_name: h.userName || 'æœªçŸ¥å‘˜å·¥',
            label: `${h.deptName || 'æœªçŸ¥éƒ¨é—¨'}-${h.userName || 'æœªçŸ¥å‘˜å·¥'}`,
            type: 'health'
        }
    }));
    
    const validAlerts = alerts.filter(a => isValidCoordinate(a.longitude, a.latitude));

    console.log('updateMapData.validAlerts',alerts);
    
    const alertFeatures = validAlerts.map(a => ({
        type: 'Feature',
        geometry: {type: 'Point', coordinates: [parseFloat(a.longitude), parseFloat(a.latitude)]},
        properties: {
            ...a,
            label: `âš ï¸${a.dept_name || 'æœªçŸ¥éƒ¨é—¨'}-${a.user_name || 'æœªçŸ¥å‘˜å·¥'}`,
            type: 'alert'
        }
    }));
    
    const criticalAlerts = {type: 'FeatureCollection', features: alertFeatures.filter(f => f.properties.severity_level === 'critical')};
    const highAlerts = {type: 'FeatureCollection', features: alertFeatures.filter(f => f.properties.severity_level === 'high' || f.properties.severity_level === 'medium')};
    const healthData = {type: 'FeatureCollection', features: healthFeatures};
    
    console.log(`å¤„ç†æ•°æ®: ${healthFeatures.length}ä¸ªæœ‰æ•ˆå¥åº·ç‚¹, ${alertFeatures.length}ä¸ªæœ‰æ•ˆå‘Šè­¦ç‚¹`);
    
    try {
        // å®‰å…¨æ›´æ–°å›¾å±‚æ•°æ®æº
        if (breathRed && typeof breathRed.setSource === 'function') {
            breathRed.setSource(new Loca.GeoJSONSource({data: criticalAlerts}));
        }
        if (breathYellow && typeof breathYellow.setSource === 'function') {
            breathYellow.setSource(new Loca.GeoJSONSource({data: highAlerts}));
        }
        if (breathGreen && typeof breathGreen.setSource === 'function') {
            breathGreen.setSource(new Loca.GeoJSONSource({data: healthData}));
        }
        
        const allValidFeatures = [...alertFeatures, ...healthFeatures];
        if (allValidFeatures.length > 0) {
            const firstFeature = allValidFeatures[0];
            const [lng, lat] = firstFeature.geometry.coordinates;
            if (map && typeof map.setCenter === 'function') {
                map.setCenter([lng, lat]);
                console.log(`åœ°å›¾ä¸­å¿ƒè®¾ç½®ä¸º: [${lng}, ${lat}]`);
            }
        } else if (map && typeof map.setCenter === 'function') {
            map.setCenter([114.01508952, 22.54036796]);
        }
        
        // é‡æ–°å¯åŠ¨åŠ¨ç”»
        if (loca && loca.animate && typeof loca.animate.start === 'function') {
            loca.animate.start();
        }
        
        console.log('âœ… åœ°å›¾æ›´æ–°å®Œæˆ');
    } catch (error) {
        console.error('âŒ åœ°å›¾æ›´æ–°å¤±è´¥:', error);
    }
  };
  
  window.updateMapData1 = function(data){
      //console.log('updateMapData.data',data);
    if(!data||!map||!loca)return;
    const {alerts,healths}=filterData(data);
    console.log('updateMapData1.alerts',alerts);
    const f=[];
    // å¤„ç†å‘Šè­¦æ•°æ®
    alerts.forEach(a=>{
      if((a.longitude||a.longitude===0)&&(a.latitude||a.latitude===0)){
        f.push({
          type:'Feature',
          geometry:{type:'Point',coordinates:[+a.longitude,+a.latitude]},
          properties:{
            ...a,
            alert_id: a.alert_id,
            alert_type: a.alert_type,
            alert_status: a.alert_status,
            severity_level: a.severity_level,
            dept_name: a.dept_name,
            user_name: a.user_name,
            health_id: a.health_id,
            device_sn: a.device_sn,
            alert_timestamp: a.alert_timestamp,
            type: 'alert'
          }
        });
      }
    });
    // å¤„ç†å¥åº·æ•°æ®
    healths.forEach(h=>{
      if((h.longitude||h.longitude===0)&&(h.latitude||h.latitude===0)){
        f.push({
          type:'Feature',
          geometry:{type:'Point',coordinates:[+h.longitude,+h.latitude]},
          properties:{
            ...h,
            dept_name: h.deptName,
            user_name: h.userName,
            heart_rate: h.heartRate,
            blood_oxygen: h.bloodOxygen,
            temperature: h.temperature,
            pressure_high: h.pressureHigh,
            pressure_low: h.pressureLow,
            step: h.step,
            stress: h.stress,
            device_sn: h.deviceSn,
            timestamp: h.timestamp,
            avatar: h.avatar,
            sleepData: h.sleepData,
            timestamp: h.timestamp,
            type: 'health'
          }
        });
      }
    });
    
    
    const geoJSON={type:'FeatureCollection',features:f};
    const criticalAlerts={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.severity_level==='critical')};
    const highAlerts={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.severity_level==='high'||f.properties.severity_level==='medium')};
    const healthData={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.type==='health')};
    
    breathRed.setSource(new Loca.GeoJSONSource({data:criticalAlerts}));
    breathYellow.setSource(new Loca.GeoJSONSource({data:highAlerts}));
    breathGreen.setSource(new Loca.GeoJSONSource({data:healthData}));
    
    // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
    let center=null;
    const getCoord=f=>f&&f.geometry&&f.geometry.coordinates;
    const findFirst=(arr,cond)=>{for(let i=0;i<arr.length;i++)if(cond(arr[i]))return arr[i];return null;};
    const cAlert=findFirst(geoJSON.features,f=>f.properties.type==='alert'&&['critical','high','medium'].includes(f.properties.severity_level));
    const cHealth=findFirst(geoJSON.features,f=>f.properties.type==='health');
    if(cAlert)center=getCoord(cAlert);
    else if(cHealth)center=getCoord(cHealth);
    if(center&&center.length>=2)map.setCenter([center[0],center[1]]);
    else if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        map.setCenter([pos.coords.longitude,pos.coords.latitude]);
      });
    }
  }

// å¥åº·æ•°æ®ç»Ÿè®¡è®¡ç®—å‡½æ•°
function calculateHealthStats(metrics) {
  const stats = {
    healthScore: 0,
    normalCount: 0,
    riskCount: 0,
    avgHeartRate: 0,
    avgBloodOxygen: 0,
    avgTemperature: 0,
    avgSteps: 0
  };
  
  if (!metrics || metrics.length === 0) return stats;
  
  let totalScore = 0, validMetrics = 0;
  
  metrics.forEach(metric => {
    const values = metric.values.filter(v => v !== null && v !== undefined);
    if (values.length === 0) return;
    
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    
    switch(metric.name) {
      case 'å¿ƒç‡':
        stats.avgHeartRate = Math.round(avg);
        const heartScore = avg >= 60 && avg <= 100 ? 85 : (avg < 60 ? 70 : 60); // æ­£å¸¸èŒƒå›´è¯„åˆ†
        totalScore += heartScore;
        if (heartScore >= 80) stats.normalCount++; else stats.riskCount++;
        validMetrics++;
        break;
      case 'è¡€æ°§':
        stats.avgBloodOxygen = Math.round(avg);
        const oxygenScore = avg >= 95 ? 90 : (avg >= 90 ? 75 : 50);
        totalScore += oxygenScore;
        if (oxygenScore >= 80) stats.normalCount++; else stats.riskCount++;
        validMetrics++;
        break;
      case 'ä½“æ¸©':
        stats.avgTemperature = avg.toFixed(1);
        const tempScore = avg >= 36.1 && avg <= 37.2 ? 88 : 65;
        totalScore += tempScore;
        if (tempScore >= 80) stats.normalCount++; else stats.riskCount++;
        validMetrics++;
        break;
      case 'æ­¥æ•°':
        stats.avgSteps = Math.round(avg);
        const stepScore = avg >= 8000 ? 85 : (avg >= 5000 ? 70 : 55);
        totalScore += stepScore;
        if (stepScore >= 80) stats.normalCount++; else stats.riskCount++;
        validMetrics++;
        break;
    }
  });
  
  stats.healthScore = validMetrics > 0 ? Math.round(totalScore / validMetrics) : 0;
  return stats;
}

// æ›´æ–°å¥åº·ç»Ÿè®¡UI
function updateHealthStats(stats) {
  try {
    document.getElementById('healthScore').textContent = stats.healthScore;
    document.getElementById('normalCount').textContent = stats.normalCount;
    document.getElementById('riskCount').textContent = stats.riskCount;
    document.getElementById('avgHeartRate').textContent = stats.avgHeartRate;
    document.getElementById('avgBloodOxygen').textContent = stats.avgBloodOxygen + '%';
    document.getElementById('avgTemperature').textContent = stats.avgTemperature + 'Â°C';
    document.getElementById('avgSteps').textContent = stats.avgSteps;
  } catch (e) {
    console.warn('æ›´æ–°å¥åº·ç»Ÿè®¡UIå¤±è´¥:', e);
  }
}

// è®¡ç®—é›·è¾¾å›¾æ•°æ®
function calculateRadarData(metrics) {
  const indicators = [];
  const values = [];
  
  const metricMap = {
    'å¿ƒç‡': { max: 100, unit: 'bpm' },
    'è¡€æ°§': { max: 100, unit: '%' },
    'ä½“æ¸©': { max: 100, unit: 'Â°C' },
    'æ­¥æ•°': { max: 100, unit: 'æ­¥' },
    'å‹åŠ›': { max: 100, unit: 'çº§' },
    'ç¡çœ ': { max: 100, unit: 'å°æ—¶' },
    'å¡è·¯é‡Œ': { max: 100, unit: 'kcal' },
    'è¡€å‹': { max: 100, unit: 'mmHg' }
  };
  
  metrics.forEach(metric => {
    const config = metricMap[metric.name];
    if (!config) return;
    
    const validValues = metric.values.filter(v => v !== null && v !== undefined);
    if (validValues.length === 0) return;
    
    const avg = validValues.reduce((a, b) => a + b, 0) / validValues.length;
    
    // æ ¹æ®æŒ‡æ ‡ç±»å‹è®¡ç®—å¥åº·è¯„åˆ†
    let score = 0;
    switch(metric.name) {
      case 'å¿ƒç‡':
        score = avg >= 60 && avg <= 100 ? 85 : (avg < 60 ? 70 : 60);
        break;
      case 'è¡€æ°§':
        score = avg >= 95 ? 90 : (avg >= 90 ? 75 : 50);
        break;
      case 'ä½“æ¸©':
        score = avg >= 36.1 && avg <= 37.2 ? 88 : 65;
        break;
      case 'æ­¥æ•°':
        score = avg >= 8000 ? 85 : (avg >= 5000 ? 70 : 55);
        break;
      case 'å‹åŠ›':
        score = avg <= 3 ? 85 : (avg <= 5 ? 70 : 50);
        break;
      case 'ç¡çœ ':
        score = avg >= 7 ? 85 : (avg >= 6 ? 70 : 55);
        break;
      default:
        score = Math.min(90, Math.max(50, 100 - (avg * 0.5))); // é»˜è®¤è®¡ç®—
    }
    
    indicators.push({
      name: metric.name,
      max: 100,
      min: 0
    });
    
    values.push(Math.round(score));
  });
  
  return { indicators, values };
}


function optimizeMapDisplay() {
  // æ ¹æ®ç¼©æ”¾çº§åˆ«åŠ¨æ€è°ƒæ•´æ˜¾ç¤ºç­–ç•¥
  map.on('zoomend', () => {
      const zoom = map.getZoom();
      
      if (zoom < 12) {
          // ä½ç¼©æ”¾çº§åˆ«ï¼šéšè—æ–‡æœ¬ï¼Œæ˜¾ç¤ºèšåˆç‚¹
          textLayer.hide();
          alertTextLayer.hide();
          enableClustering();
      } else if (zoom < 15) {
          // ä¸­ç­‰ç¼©æ”¾çº§åˆ«ï¼šæ˜¾ç¤ºéƒ¨åˆ†æ–‡æœ¬
          textLayer.show();
          alertTextLayer.show();
          disableClustering();
          setTextFilter(0.3); // åªæ˜¾ç¤º30%çš„æ–‡æœ¬é¿å…é‡å 
      } else {
          // é«˜ç¼©æ”¾çº§åˆ«ï¼šæ˜¾ç¤ºæ‰€æœ‰æ ‡è¯†
          textLayer.show();
          alertTextLayer.show();
          disableClustering();
          setTextFilter(1); // æ˜¾ç¤ºæ‰€æœ‰æ–‡æœ¬
      }
  });
}

// èšåˆæ˜¾ç¤ºå®ç°
function enableClustering() {
  // ä½¿ç”¨Locaçš„èšåˆåŠŸèƒ½
  const clusterLayer = new Loca.PointLayer({
      loca,
      zIndex: 115
  });
  
  clusterLayer.setSource(geo);
  clusterLayer.setStyle({
      unit: 'meter',
      size: [20, 20],
      color: (feature) => {
          const count = feature.properties.count || 1;
          return count > 10 ? '#ff4d4f' : count > 5 ? '#faad14' : '#52c41a';
      },
      text: {
          field: 'count',
          font: 'bold 12px Arial',
          fillColor: '#fff'
      }
  });
  
  loca.add(clusterLayer);
}

// æ–‡æœ¬è¿‡æ»¤æ˜¾ç¤º
function setTextFilter(ratio) {
  textLayer.setStyle({
      filter: (feature, index) => {
          return Math.random() < ratio; // éšæœºæ˜¾ç¤ºéƒ¨åˆ†æ–‡æœ¬
      }
  });
}

// äº¤äº’åŠŸèƒ½å‡½æ•°
function showHealthDetails() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('å¥åº·è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...\n\nå½“å‰æ˜¾ç¤ºçš„æ˜¯7å¤©å¥åº·æ•°æ®æ±‡æ€»');
    return;
  }
  
  const { health_summary, risk_alerts } = data;
  let message = `å¥åº·æ•°æ®è¯¦æƒ…æŠ¥å‘Š\n\n`;
  message += `ğŸ“Š ç»¼åˆè¯„åˆ†: ${health_summary.overall_score}åˆ†\n`;
  message += `âœ… æ­£å¸¸æŒ‡æ ‡: ${health_summary.normal_indicators}é¡¹\n`;
  message += `âš ï¸ é£é™©æŒ‡æ ‡: ${health_summary.risk_indicators}é¡¹\n`;
  message += `ğŸ‘¥ æ´»è·ƒç”¨æˆ·: ${health_summary.active_users}/${health_summary.total_users}äºº\n\n`;
  
  if (risk_alerts && risk_alerts.length > 0) {
    message += `ğŸš¨ é£é™©é¢„è­¦:\n`;
    risk_alerts.slice(0, 3).forEach(alert => {
      message += `â€¢ ${alert.message}\n`;
    });
  } else {
    message += `âœ¨ æš‚æ— é£é™©é¢„è­¦ï¼Œæ•´ä½“å¥åº·çŠ¶å†µè‰¯å¥½`;
  }
  
  alert(message);
}

function filterByHeartRate() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('å¿ƒç‡ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºå¿ƒç‡å¼‚å¸¸çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const heartRateMetric = data.metrics.find(m => m.name === 'å¿ƒç‡');
  if (heartRateMetric) {
    const abnormalDays = heartRateMetric.daily_stats ? 
      heartRateMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`å¿ƒç‡åˆ†æç»“æœ\n\nå¹³å‡å¿ƒç‡: ${heartRateMetric.avg_value}bpm\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${heartRateMetric.normal_range[0]}-${heartRateMetric.normal_range[1]}bpm`);
  } else {
    alert('æš‚æ— å¿ƒç‡æ•°æ®');
  }
}

function filterByBloodOxygen() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('è¡€æ°§ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºè¡€æ°§åä½çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const oxygenMetric = data.metrics.find(m => m.name === 'è¡€æ°§');
  if (oxygenMetric) {
    const abnormalDays = oxygenMetric.daily_stats ? 
      oxygenMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`è¡€æ°§åˆ†æç»“æœ\n\nå¹³å‡è¡€æ°§: ${oxygenMetric.avg_value}%\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${oxygenMetric.normal_range[0]}-${oxygenMetric.normal_range[1]}%`);
  } else {
    alert('æš‚æ— è¡€æ°§æ•°æ®');
  }
}

function filterByTemperature() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('ä½“æ¸©ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºä½“æ¸©å¼‚å¸¸çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const tempMetric = data.metrics.find(m => m.name === 'ä½“æ¸©');
  if (tempMetric) {
    const abnormalDays = tempMetric.daily_stats ? 
      tempMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`ä½“æ¸©åˆ†æç»“æœ\n\nå¹³å‡ä½“æ¸©: ${tempMetric.avg_value}Â°C\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${tempMetric.normal_range[0]}-${tempMetric.normal_range[1]}Â°C`);
  } else {
    alert('æš‚æ— ä½“æ¸©æ•°æ®');
  }
}

function filterBySteps() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('æ­¥æ•°ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºè¿åŠ¨é‡ä¸è¶³çš„ç”¨æˆ·');
    return;
  }
  
  const stepsMetric = data.metrics.find(m => m.name === 'æ­¥æ•°');
  if (stepsMetric) {
    const lowActivityDays = stepsMetric.daily_stats ? 
      stepsMetric.daily_stats.filter(d => d.value && d.value < 5000).length : 0;
    alert(`æ­¥æ•°åˆ†æç»“æœ\n\nå¹³å‡æ­¥æ•°: ${stepsMetric.avg_value}æ­¥\nè¿åŠ¨ä¸è¶³å¤©æ•°: ${lowActivityDays}å¤©\nå»ºè®®ç›®æ ‡: ${stepsMetric.normal_range[0]}æ­¥ä»¥ä¸Š`);
  } else {
    alert('æš‚æ— æ­¥æ•°æ•°æ®');
  }
}

function showMetricDetails(metricName, value, date) {
  const data = window.healthAnalysisData;
  if (!data) {
    alert(`æŒ‡æ ‡è¯¦æƒ…\n\næŒ‡æ ‡: ${metricName}\næ•°å€¼: ${value}\næ—¥æœŸ: ${date}\n\nç‚¹å‡»å¯æŸ¥çœ‹è¯¥æŒ‡æ ‡çš„è¯¦ç»†åˆ†æå’Œå»ºè®®`);
    return;
  }
  
  const metric = data.metrics.find(m => m.name === metricName);
  if (metric) {
    const dayData = metric.daily_stats ? metric.daily_stats.find(d => d.date === date) : null;
    let message = `${metricName}è¯¦ç»†ä¿¡æ¯\n\n`;
    message += `ğŸ“… æ—¥æœŸ: ${date}\n`;
    message += `ğŸ“Š æ•°å€¼: ${value}${metric.unit}\n`;
    message += `ğŸ“ˆ 7å¤©å¹³å‡: ${metric.avg_value}${metric.unit}\n`;
    message += `ğŸ“ æ­£å¸¸èŒƒå›´: ${metric.normal_range[0]}-${metric.normal_range[1]}${metric.unit}\n`;
    
    if (dayData) {
      message += `â­ å¥åº·è¯„åˆ†: ${dayData.score}åˆ†\n`;
      message += `ğŸ” çŠ¶æ€: ${dayData.status === 'normal' ? 'æ­£å¸¸' : 'éœ€å…³æ³¨'}\n`;
    }
    
    message += `\nğŸ’¡ å»ºè®®: ä¿æŒè§„å¾‹ç›‘æµ‹ï¼Œå¦‚æœ‰å¼‚å¸¸è¯·åŠæ—¶å°±åŒ»`;
    alert(message);
  }
}


// è·å–æŒ‡æ ‡å¹³å‡å€¼çš„è¾…åŠ©å‡½æ•°
function getMetricAvg(metrics, metricName) {
  const metric = metrics.find(m => m.name === metricName);
  if (!metric || !metric.values) return 0;
  
  const validValues = metric.values.filter(v => v !== null && v !== undefined);
  return validValues.length > 0 ? Math.round(validValues.reduce((a,b) => a+b, 0) / validValues.length) : 0;
}

// ä»åç«¯metricsæ•°æ®è®¡ç®—é›·è¾¾å›¾æ•°æ®
function calculateRadarDataFromMetrics(metrics) {
  const indicators = [];
  const values = [];
  
  // é€‰æ‹©ä¸»è¦å¥åº·æŒ‡æ ‡
  const mainMetrics = ['å¿ƒç‡', 'è¡€æ°§', 'ä½“æ¸©', 'æ­¥æ•°', 'å‹åŠ›', 'æ”¶ç¼©å‹'];
  
  metrics.forEach(metric => {
    if (mainMetrics.includes(metric.name) && metric.avg_value > 0) {
      // æ ¹æ®æŒ‡æ ‡ç±»å‹è®¡ç®—å¥åº·è¯„åˆ†
      let score = 0;
      const avg = metric.avg_value;
      const [min, max] = metric.normal_range;
      
      if (avg >= min && avg <= max) {
        score = 85 + (15 * (1 - Math.abs(avg - (min + max)/2) / ((max - min)/2)));
      } else {
        if (avg < min) {
          score = Math.max(50, 85 - (min - avg) / min * 35);
        } else {
          score = Math.max(50, 85 - (avg - max) / max * 35);
        }
      }
      
      indicators.push({
        name: metric.name,
        max: 100,
        min: 0
      });
      
      values.push(Math.round(Math.min(100, Math.max(0, score))));
    }
  });
  
  // å¦‚æœæŒ‡æ ‡ä¸è¶³ï¼Œæ·»åŠ é»˜è®¤æŒ‡æ ‡
  if (indicators.length < 4) {
    const defaultIndicators = [
      { name: 'å¿ƒç‡', max: 100, min: 0 },
      { name: 'è¡€æ°§', max: 100, min: 0 },
      { name: 'ä½“æ¸©', max: 100, min: 0 },
      { name: 'æ­¥æ•°', max: 100, min: 0 }
    ];
    const defaultValues = [75, 85, 80, 65];
    
    for (let i = indicators.length; i < 4; i++) {
      indicators.push(defaultIndicators[i]);
      values.push(defaultValues[i]);
    }
  }
  
  return { indicators, values };
}

// æ›´æ–°äº¤äº’åŠŸèƒ½å‡½æ•°
function showHealthDetails() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('å¥åº·è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...\n\nå½“å‰æ˜¾ç¤ºçš„æ˜¯7å¤©å¥åº·æ•°æ®æ±‡æ€»');
    return;
  }
  
  const { health_summary, risk_alerts } = data;
  let message = `å¥åº·æ•°æ®è¯¦æƒ…æŠ¥å‘Š\n\n`;
  message += `ğŸ“Š ç»¼åˆè¯„åˆ†: ${health_summary.overall_score}åˆ†\n`;
  message += `âœ… æ­£å¸¸æŒ‡æ ‡: ${health_summary.normal_indicators}é¡¹\n`;
  message += `âš ï¸ é£é™©æŒ‡æ ‡: ${health_summary.risk_indicators}é¡¹\n`;
  message += `ğŸ‘¥ æ´»è·ƒç”¨æˆ·: ${health_summary.active_users}/${health_summary.total_users}äºº\n\n`;
  
  if (risk_alerts && risk_alerts.length > 0) {
    message += `ğŸš¨ é£é™©é¢„è­¦:\n`;
    risk_alerts.slice(0, 3).forEach(alert => {
      message += `â€¢ ${alert.message}\n`;
    });
  } else {
    message += `âœ¨ æš‚æ— é£é™©é¢„è­¦ï¼Œæ•´ä½“å¥åº·çŠ¶å†µè‰¯å¥½`;
  }
  
  alert(message);
}

function filterByHeartRate() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('å¿ƒç‡ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºå¿ƒç‡å¼‚å¸¸çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const heartRateMetric = data.metrics.find(m => m.name === 'å¿ƒç‡');
  if (heartRateMetric) {
    const abnormalDays = heartRateMetric.daily_stats ? 
      heartRateMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`å¿ƒç‡åˆ†æç»“æœ\n\nå¹³å‡å¿ƒç‡: ${heartRateMetric.avg_value}bpm\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${heartRateMetric.normal_range[0]}-${heartRateMetric.normal_range[1]}bpm`);
  } else {
    alert('æš‚æ— å¿ƒç‡æ•°æ®');
  }
}

function filterByBloodOxygen() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('è¡€æ°§ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºè¡€æ°§åä½çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const oxygenMetric = data.metrics.find(m => m.name === 'è¡€æ°§');
  if (oxygenMetric) {
    const abnormalDays = oxygenMetric.daily_stats ? 
      oxygenMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`è¡€æ°§åˆ†æç»“æœ\n\nå¹³å‡è¡€æ°§: ${oxygenMetric.avg_value}%\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${oxygenMetric.normal_range[0]}-${oxygenMetric.normal_range[1]}%`);
  } else {
    alert('æš‚æ— è¡€æ°§æ•°æ®');
  }
}

function filterByTemperature() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('ä½“æ¸©ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºä½“æ¸©å¼‚å¸¸çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const tempMetric = data.metrics.find(m => m.name === 'ä½“æ¸©');
  if (tempMetric) {
    const abnormalDays = tempMetric.daily_stats ? 
      tempMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`ä½“æ¸©åˆ†æç»“æœ\n\nå¹³å‡ä½“æ¸©: ${tempMetric.avg_value}Â°C\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${tempMetric.normal_range[0]}-${tempMetric.normal_range[1]}Â°C`);
  } else {
    alert('æš‚æ— ä½“æ¸©æ•°æ®');
  }
}

function filterBySteps() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('æ­¥æ•°ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºè¿åŠ¨é‡ä¸è¶³çš„ç”¨æˆ·');
    return;
  }
  
  const stepsMetric = data.metrics.find(m => m.name === 'æ­¥æ•°');
  if (stepsMetric) {
    const lowActivityDays = stepsMetric.daily_stats ? 
      stepsMetric.daily_stats.filter(d => d.value && d.value < 5000).length : 0;
    alert(`æ­¥æ•°åˆ†æç»“æœ\n\nå¹³å‡æ­¥æ•°: ${stepsMetric.avg_value}æ­¥\nè¿åŠ¨ä¸è¶³å¤©æ•°: ${lowActivityDays}å¤©\nå»ºè®®ç›®æ ‡: ${stepsMetric.normal_range[0]}æ­¥ä»¥ä¸Š`);
  } else {
    alert('æš‚æ— æ­¥æ•°æ•°æ®');
  }
}

function showMetricDetails(metricName, value, date) {
  const data = window.healthAnalysisData;
  if (!data) {
    alert(`æŒ‡æ ‡è¯¦æƒ…\n\næŒ‡æ ‡: ${metricName}\næ•°å€¼: ${value}\næ—¥æœŸ: ${date}\n\nç‚¹å‡»å¯æŸ¥çœ‹è¯¥æŒ‡æ ‡çš„è¯¦ç»†åˆ†æå’Œå»ºè®®`);
    return;
  }
  
  const metric = data.metrics.find(m => m.name === metricName);
  if (metric) {
    const dayData = metric.daily_stats ? metric.daily_stats.find(d => d.date === date) : null;
    let message = `${metricName}è¯¦ç»†ä¿¡æ¯\n\n`;
    message += `ğŸ“… æ—¥æœŸ: ${date}\n`;
    message += `ğŸ“Š æ•°å€¼: ${value}${metric.unit}\n`;
    message += `ğŸ“ˆ 7å¤©å¹³å‡: ${metric.avg_value}${metric.unit}\n`;
    message += `ğŸ“ æ­£å¸¸èŒƒå›´: ${metric.normal_range[0]}-${metric.normal_range[1]}${metric.unit}\n`;
    
    if (dayData) {
      message += `â­ å¥åº·è¯„åˆ†: ${dayData.score}åˆ†\n`;
      message += `ğŸ” çŠ¶æ€: ${dayData.status === 'normal' ? 'æ­£å¸¸' : 'éœ€å…³æ³¨'}\n`;
    }
    
    message += `\nğŸ’¡ å»ºè®®: ä¿æŒè§„å¾‹ç›‘æµ‹ï¼Œå¦‚æœ‰å¼‚å¸¸è¯·åŠæ—¶å°±åŒ»`;
    alert(message);
  }
}

function showHealthRadarDetails(radarData) {
  const data = window.healthAnalysisData;
  const avgScore = radarData.values.reduce((a,b)=>a+b,0) / radarData.values.length;
  
  let message = `å¥åº·é›·è¾¾è¯¦æƒ…\n\n`;
  message += `ğŸ¯ ç»¼åˆè¯„åˆ†: ${avgScore.toFixed(1)}åˆ†\n\n`;
  message += `ğŸ“‹ å„é¡¹æŒ‡æ ‡è¯„åˆ†:\n`;
  radarData.indicators.forEach((ind,i) => {
    const score = radarData.values[i];
    const status = score >= 80 ? 'âœ…' : score >= 60 ? 'âš ï¸' : 'âŒ';
    message += `${status} ${ind.name}: ${score}åˆ†\n`;
  });
  
  if (data && data.risk_alerts && data.risk_alerts.length > 0) {
    message += `\nğŸš¨ éœ€è¦å…³æ³¨:\n`;
    data.risk_alerts.slice(0, 2).forEach(alert => {
      message += `â€¢ ${alert.metric}: ${alert.current_value}\n`;
    });
  }
  
  alert(message);
}



function openMessagePanel() {
  // è·å–customerIdå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('customerId') || '1';
        
  // æ‰“å¼€æ¶ˆæ¯è¯¦æƒ…é¡µé¢
  createModalWindow(`/message_view.html?customerId=${customerId}`);
}

// è·å–ç»Ÿè®¡æ•°æ®
function loadStatisticsData() {
  const urlParams = new URLSearchParams(window.location.search);
  const customerId = urlParams.get('customerId') || '1';
  //const today = new Date().toISOString().split('T')[0];
    // è·å–åŒ—äº¬æ—¶é—´æ—¥æœŸ(UTC+8) - ä¿®å¤æ—¶åŒºé—®é¢˜




    const today = new Date().toLocaleDateString('zh-CN', {
      timeZone: 'Asia/Shanghai',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).replace(/\//g, '-');
    console.log("today", today);
  
  // è®¾ç½®å½“å‰æ—¥æœŸ
  document.getElementById('statsDate').textContent = today;
  
    // è·å–ç»Ÿè®¡æ¦‚è§ˆæ•°æ®
    fetch(`/api/statistics/overview?orgId=${customerId}&date=${today}`)
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const data = result.data;
        console.log("statistics", data);
        
        // ä¿®å¤å­—æ®µæ˜ å°„ - ä½¿ç”¨APIå®é™…è¿”å›çš„å­—æ®µåå¹¶æ·»åŠ è¿‡æ»¤é€»è¾‘
        document.getElementById('healthDataCount').textContent = formatNumber(data.health_count || 0);
        
        // è¿‡æ»¤å¹¶ç»Ÿè®¡çœŸå®æ•°æ®
        let pendingAlerts = data.alert_count || 0;
        let activeDevices = data.active_devices || 0;
        let unreadMessages = data.message_count || 0;
        
        // å¦‚æœæœ‰lastTotalInfoç¼“å­˜æ•°æ®ï¼Œä½¿ç”¨è¿‡æ»¤é€»è¾‘è¿›è¡ŒéªŒè¯
        if (typeof lastTotalInfo !== 'undefined' && lastTotalInfo) {
          console.log('ğŸ” ä½¿ç”¨lastTotalInfoè¿‡æ»¤éªŒè¯:', lastTotalInfo);
          
          // è¿‡æ»¤pendingçŠ¶æ€çš„å‘Šè­¦
          if (lastTotalInfo.alert_info && lastTotalInfo.alert_info.alerts) {
            const filteredPendingAlerts = lastTotalInfo.alert_info.alerts.filter(
              alert => alert.alert_status === 'pending' || alert.status === 'pending'
            );
            console.log(`ğŸ“Š è¿‡æ»¤pendingå‘Šè­¦: ${filteredPendingAlerts.length}/${lastTotalInfo.alert_info.alerts.length}`);
          }
          
          // è¿‡æ»¤message_status=1çš„æ¶ˆæ¯
          if (lastTotalInfo.message_info && lastTotalInfo.message_info.messages) {
            const filteredUnreadMessages = lastTotalInfo.message_info.messages.filter(
              msg => msg.message_status === 1 || msg.message_status === '1'
            );
            console.log(`ğŸ“Š è¿‡æ»¤æœªè¯»æ¶ˆæ¯: ${filteredUnreadMessages.length}/${lastTotalInfo.message_info.messages.length}`);
          }
          
          // è¿‡æ»¤status=ACTIVEçš„è®¾å¤‡
          if (lastTotalInfo.device_info && lastTotalInfo.device_info.devices) {
            const filteredActiveDevices = lastTotalInfo.device_info.devices.filter(
              device => device.status === 'ACTIVE'
            );
            console.log(`ğŸ“Š è¿‡æ»¤æ´»è·ƒè®¾å¤‡: ${filteredActiveDevices.length}/${lastTotalInfo.device_info.devices.length}`);
          }
        }
        
        // æ›´æ–°å‰ç«¯æ˜¾ç¤º
        document.getElementById('pendingAlerts').textContent = formatNumber(pendingAlerts);
        document.getElementById('activeDevices').textContent = activeDevices;
        document.getElementById('unreadMessages').textContent = formatNumber(unreadMessages);
        
        // æ¨¡æ‹Ÿç³»ç»ŸçŠ¶æ€æ•°æ®ï¼ˆå› ä¸ºAPIæœªè¿”å›æ­¤æ•°æ®ï¼‰
        const mockSummary = {
          systemStatus: data.alert_count > 20 ? 'warning' : (data.alert_count > 10 ? 'normal' : 'normal'),
          healthScore: Math.max(100 - Math.floor(data.alert_count * 2), 60) // åŸºäºå‘Šè­¦æ•°é‡è®¡ç®—å¥åº·åˆ†æ•°
        };
        updateSystemStatus(mockSummary);
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºè¶‹åŠ¿ï¼ˆåŸºäºå½“å‰æ•°æ®ç”Ÿæˆæ¨¡æ‹Ÿè¶‹åŠ¿ï¼‰
        const mockTrends = {
          changes: {
            healthDataChange: '+5%',     // å¥åº·æ•°æ®å¢é•¿
            alertsChange: data.alert_count > 15 ? '+12%' : '+3%',  // å‘Šè­¦å˜åŒ–
            activeDevicesChange: '+2%',  // æ´»è·ƒè®¾å¤‡å˜åŒ–
            messagesChange: '+8%'        // æ¶ˆæ¯å˜åŒ–
          }
        };
        updateTrends(mockTrends);
        
        // æ·»åŠ æ•°æ®æ›´æ–°åŠ¨ç”»
        animateStatCards();
        
        console.log('âœ… å®æ—¶ç»Ÿè®¡æ•°æ®å·²æ›´æ–°:', {
          health_count: data.health_count,
          alert_count: data.alert_count,
          active_devices: data.active_devices,
          message_count: data.message_count
        });
      }
    })
    .catch(error => {
      console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
      showErrorState();
    });
}

// æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
}

// æ›´æ–°ç³»ç»ŸçŠ¶æ€
function updateSystemStatus(summary) {
  const indicator = document.getElementById('statusIndicator');
  const statusText = document.getElementById('statusText');
  const healthScore = document.getElementById('systemHealthScore');
  
  // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
  indicator.className = 'status-indicator';
  
  // æ ¹æ®ç³»ç»ŸçŠ¶æ€è®¾ç½®æ ·å¼å’Œæ–‡æœ¬
  switch (summary.systemStatus) {
    case 'normal':
      indicator.classList.add('normal');
      statusText.textContent = 'ç³»ç»Ÿæ­£å¸¸';
      break;
    case 'warning':
      indicator.classList.add('warning');
      statusText.textContent = 'ç³»ç»Ÿè­¦å‘Š';
      break;
    case 'critical':
      indicator.classList.add('critical');
      statusText.textContent = 'ç³»ç»Ÿå¼‚å¸¸';
      break;
  }
  
  // æ›´æ–°å¥åº·è¯„åˆ†
  healthScore.textContent = summary.healthScore;
  
  // æ ¹æ®è¯„åˆ†è®¾ç½®é¢œè‰²
  if (summary.healthScore >= 80) {
    healthScore.style.color = '#00ff9d';
  } else if (summary.healthScore >= 60) {
    healthScore.style.color = '#ffbb00';
        } else {
    healthScore.style.color = '#ff6b6b';
  }
}

// æ›´æ–°è¶‹åŠ¿æ˜¾ç¤º
// æ›´æ–°è¶‹åŠ¿æ˜¾ç¤º
function updateTrends(data) {
  // ä½¿ç”¨æ¥å£è¿”å›çš„çœŸå®å˜åŒ–æ•°æ®
  if (data.changes) {
  const trends = {
      health: data.changes.healthDataChange || '0%',
      alert: data.changes.alertsChange || '0%', 
      device: data.changes.activeDevicesChange || '0%',
      message: data.changes.messagesChange || '0%'
  };
  
  // æ›´æ–°è¶‹åŠ¿æ˜¾ç¤º
  updateTrendElement('healthTrend', trends.health);
  updateTrendElement('alertTrend', trends.alert);
  updateTrendElement('deviceTrend', trends.device);
  updateTrendElement('messageTrend', trends.message);
    
    console.log('è¶‹åŠ¿æ•°æ®å·²æ›´æ–°:', trends);
    console.log('æ˜¨å¤©å¯¹æ¯”æ•°æ®:', data.yesterday);
  } else {
    // å…œåº•ï¼šå¦‚æœæ²¡æœ‰changesæ•°æ®ï¼Œæ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€
    updateTrendElement('healthTrend', '0%');
    updateTrendElement('alertTrend', '0%');
    updateTrendElement('deviceTrend', '0%');
    updateTrendElement('messageTrend', '0%');
    
    console.warn('æ¥å£æœªè¿”å›changesæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
  }
}

// æ›´æ–°å•ä¸ªè¶‹åŠ¿å…ƒç´ 
function updateTrendElement(elementId, trend) {
  const element = document.getElementById(elementId);
  element.textContent = trend;
  element.className = 'stat-trend';
  
  if (trend.startsWith('-')) {
    element.classList.add('negative');
  }
}

// ç»Ÿè®¡å¡ç‰‡åŠ¨ç”»
function animateStatCards() {
  const cards = document.querySelectorAll('.stat-card');
  cards.forEach((card, index) => {
    setTimeout(() => {
      card.style.transform = 'scale(1.05)';
      setTimeout(() => {
        card.style.transform = 'scale(1)';
      }, 200);
    }, index * 100);
  });
}

// æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
function showErrorState() {
  const statusText = document.getElementById('statusText');
  const indicator = document.getElementById('statusIndicator');
  
  statusText.textContent = 'æ•°æ®è·å–å¤±è´¥';
  indicator.className = 'status-indicator critical';
  
  // æ˜¾ç¤ºé»˜è®¤å€¼
  document.getElementById('healthDataCount').textContent = '--';
  document.getElementById('pendingAlerts').textContent = '--';
  document.getElementById('activeDevices').textContent = '--';
  document.getElementById('unreadMessages').textContent = '--';
}


// åˆå§‹åŒ–ç»Ÿè®¡æ¦‚è§ˆå›¾è¡¨
function initOverviewChart() {
  const overviewContainer = document.getElementById('overviewChart');
  if (overviewContainer) {
    const overviewChart = echarts.init(overviewContainer);
    
    const overviewOption = {
      tooltip: {
        trigger: 'item',
        formatter: '{a} <br/>{b}: {c} ({d}%)'
      },
      legend: {
        show: false
      },
      series: [{
        name: 'æ•°æ®æ¦‚è§ˆ',
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['50%', '50%'],
        data: [
          {value: 0, name: 'å¥åº·æ•°æ®', itemStyle: {color: '#00e4ff'}},
          {value: 0, name: 'å‘Šè­¦æ•°æ®', itemStyle: {color: '#ff6b6b'}},
          {value: 0, name: 'è®¾å¤‡æ•°æ®', itemStyle: {color: '#00ff9d'}},
          {value: 0, name: 'æ¶ˆæ¯æ•°æ®', itemStyle: {color: '#ffbb00'}}
        ],
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        },
        label: {
          show: false
        },
        labelLine: {
          show: false
        }
      }]
    };
    
    overviewChart.setOption(overviewOption);
    
    // ä¿å­˜å›¾è¡¨å®ä¾‹ä»¥ä¾¿åç»­æ›´æ–°
    window.overviewChart = overviewChart;
  }
}
</script>
  </body>
</html>



