<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>人员管理</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.4.2/tinycolor.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 顶部统计卡片 */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 228, 255, 0.1), rgba(0, 228, 255, 0.05));
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 228, 255, 0.6);
            box-shadow: 0 10px 30px rgba(0, 228, 255, 0.2);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #00e4ff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* 图表网格布局 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            min-height: 350px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            border-color: rgba(0, 228, 255, 0.5);
            box-shadow: 0 5px 20px rgba(0, 228, 255, 0.1);
        }

        .chart-title {
            font-size: 16px;
            color: #00e4ff;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }

        /* 用户卡片网格容器 */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* 控制面板样式 */
        .control-panel {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 228, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #52c41a;
            box-shadow: 0 0 6px rgba(82, 196, 26, 0.8);
            animation: pulse 2s infinite;
        }

        .status-dot.paused {
            background: #fa8c16;
            box-shadow: 0 0 6px rgba(250, 140, 22, 0.8);
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .status-text {
            color: #7ecfff;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .control-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
            min-width: 90px;
            justify-content: center;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
        }

        .control-btn.primary:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        .control-btn.secondary {
            background: linear-gradient(45deg, rgba(250, 140, 22, 0.8), rgba(255, 187, 0, 0.8));
            color: #fff;
        }

        .control-btn.secondary:hover {
            background: linear-gradient(45deg, rgba(255, 187, 0, 0.9), rgba(250, 140, 22, 0.9));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(250, 140, 22, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            font-size: 14px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 用户卡片样式 */
        .user-card {
            background: rgba(37, 39, 41, 0.95);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .user-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 228, 255, 0.5);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(0, 228, 255, 0.5);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 18px;
            margin: 0 0 5px 0;
            color: #fff;
        }

        .department {
            font-size: 14px;
            color: #00e4ff;
            margin: 0;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .info-label {
            color: rgba(0, 228, 255, 0.6);
            min-width: 70px;
        }

        .device-tag {
            background: rgba(0, 228, 255, 0.1);
            color: #00e4ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 10px;
            display: inline-block;
        }

        /* 设备链接样式 */
        .device-link {
            color: #00e4ff;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .device-link:hover {
            color: #fff;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        /* 弹出层样式 */
        .profile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .profile-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background: #011326;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .profile-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background: rgba(255, 0, 0, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .profile-close-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.4);
        }

        .profile-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
        }

            .cards-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部统计概览 -->
        <div class="stats-overview" id="statsOverview">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">总员工数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDepts">0</div>
                <div class="stat-label">部门数量</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDevices">0</div>
                <div class="stat-label">设备总数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="deviceRate">0%</div>
                <div class="stat-label">设备配备率</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineUsers">0</div>
                <div class="stat-label">在线人数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgWorkingYears">0</div>
                <div class="stat-label">平均工龄</div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="refreshStatus" class="status-text">实时监控中</span>
            </div>
            <div class="button-group">
                <button id="refreshBtn" class="control-btn primary" onclick="manualRefresh()">
                    <span class="btn-icon">🔄</span>
                    <span>手动刷新</span>
                </button>
                <button id="toggleAutoRefresh" class="control-btn secondary" onclick="toggleAutoRefresh()">
                    <span class="btn-icon" id="autoRefreshIcon">⏸️</span>
                    <span id="autoRefreshText">暂停自动</span>
                </button>
            </div>
        </div>

        <!-- 用户卡片列表 - 移到图表前面 -->
        <div class="cards-container" id="userCards"></div>

        <!-- 专业图表网格 -->
        <div class="charts-grid">
            <!-- 部门人员分布图 -->
            <div class="chart-container">
                <div class="chart-title">部门人员分布</div>
                <div id="deptUserChart" style="width: 100%; height: 300px;"></div>
            </div>

            <!-- 设备配备状态图 -->
            <div class="chart-container">
                <div class="chart-title">设备配备状态</div>
                <div id="deviceStatusChart" style="width: 100%; height: 300px;"></div>
            </div>

            <!-- 岗位分布图 -->
            <div class="chart-container">
                <div class="chart-title">岗位分布分析</div>
                <div id="positionChart" style="width: 100%; height: 300px;"></div>
        </div>

            <!-- 工龄分布图 -->
            <div class="chart-container">
                <div class="chart-title">工龄分布分析</div>
                <div id="workingYearsChart" style="width: 100%; height: 300px;"></div>
            </div>

            <!-- 部门设备配备率对比 -->
            <div class="chart-container">
                <div class="chart-title">部门设备配备率对比</div>
                <div id="deptDeviceRateChart" style="width: 100%; height: 300px;"></div>
            </div>

            <!-- 人员状态分布 -->
            <div class="chart-container">
                <div class="chart-title">人员在线状态分布</div>
                <div id="userStatusChart" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- 用户档案弹出层 -->
    <div class="profile-overlay" id="profileOverlay">
        <div class="profile-panel" id="profilePanel">
            <button class="profile-close-btn" onclick="closeUserProfile()" title="关闭">✕</button>
            <iframe id="profileFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>

    <script>
        // 图表实例缓存
        const chartInstances = new Map();
        
        // 缓存传递过来的用户数据
        let cachedUserInfo = null;
        
        // 自动刷新相关变量
        let autoRefreshTimer = null;
        let isAutoRefreshEnabled = true;
        const REFRESH_INTERVAL = 30000; // 30秒
        
        // 部门颜色方案
        const departmentColors = {
            '煤矿集团总部': '#3498db',
            '安全管理部': '#e74c3c',
            '生产技术部': '#2ecc71',
            '财务部': '#f1c40f',
            '人力资源部': '#9b59b6',
            '销售部': '#1abc9c',
            '矿区 1': '#e67e22',
            '矿区 2': '#34495e',
            '开采队': '#9b59b6',
            '通风队': '#16a085',
            '设备维修队': '#d35400',
            '安全监察队': '#c0392b'
        };

        // 获取部门颜色
        function getDepartmentColor(deptName) {
            return departmentColors[deptName] || '#00e4ff';
        }

        // 数据获取函数
        async function fetchUserInfo() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                const deptId = urlParams.get('deptId') || '';
                const userId = urlParams.get('userId') || '';

                const orgId = deptId || customerId;
                let url = `/get_users_by_orgIdAndUserId?orgId=${orgId}`;
                if (userId && userId !== 'all') url += `&userId=${userId}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const result = await response.json();
                if (result.success) {
                    return result.data;
                }
                throw new Error('Failed to fetch data');
            } catch (error) {
                console.error('Error fetching user info:', error);
                return null;
            }
        }

        // 更新统计概览
        function updateStatsOverview(data) {
            const { users, totalUsers, totalDevices, departmentCount, statusCount } = data;
            
            // 计算统计数据
            const totalDepts = Object.keys(departmentCount).length;
            const onlineUsers = statusCount['1'] || 0;
            const deviceRate = totalDevices > 0 ? Math.round((totalDevices / totalUsers) * 100) : 0;
            
            // 计算平均工龄
            const totalWorkingYears = users.reduce((sum, user) => sum + (user.working_years || 0), 0);
            const avgWorkingYears = totalUsers > 0 ? Math.round(totalWorkingYears / totalUsers * 10) / 10 : 0;

            // 更新显示
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalDepts').textContent = totalDepts;
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('deviceRate').textContent = deviceRate + '%';
            document.getElementById('onlineUsers').textContent = onlineUsers;
            document.getElementById('avgWorkingYears').textContent = avgWorkingYears + '年';
            }

        // 更新部门人员分布图
        function updateDeptChart(chart, departmentCount) {
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                grid: {
                    top: '10%',
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: Object.keys(departmentCount),
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#fff',
                        rotate: 30,
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { color: '#fff' },
                    splitLine: {
                        lineStyle: { color: 'rgba(0,228,255,0.1)', type: 'dashed' }
                    }
                },
                series: [{
                    type: 'bar',
                    data: Object.values(departmentCount),
                    barWidth: '60%',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(0,228,255,0.8)' },
                            { offset: 1, color: 'rgba(0,228,255,0.2)' }
                        ]),
                        borderRadius: [4, 4, 0, 0]
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0,228,255,1)' },
                                { offset: 1, color: 'rgba(0,228,255,0.4)' }
                            ])
                        }
                    }
                }]
            };
            chart.setOption(option, true);
        }

        // 更新设备配备状态图
        function updateDeviceChart(chart, users) {
            const hasDevice = users.filter(u => u.device_sn && u.device_sn !== '-' && u.device_sn !== '').length;
            const noDevice = users.length - hasDevice;
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#fff', fontSize: 12 }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        color: '#fff',
                        formatter: '{b}\n{c}人'
                    },
                    emphasis: {
                        label: { show: true, fontSize: 14, fontWeight: 'bold' }
                    },
                    data: [
                        {
                            name: '已配备设备',
                            value: hasDevice,
                            itemStyle: { color: '#00e4ff' }
                        },
                        {
                            name: '未配备设备',
                            value: noDevice,
                            itemStyle: { color: '#ff6b6b' }
                        }
                    ]
                }]
            };
            chart.setOption(option, true);
        }

        // 更新岗位分布图
        function updatePositionChart(chart, users) {
            const positionCount = {};
            users.forEach(user => {
                const position = user.position || '未设置';
                positionCount[position] = (positionCount[position] || 0) + 1;
            });

            const data = Object.entries(positionCount).map(([name, value]) => ({ name, value }));
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}人 ({d}%)',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    center: ['50%', '50%'],
                    data: data,
                    itemStyle: {
                        borderRadius: 6,
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    label: {
                        show: true,
                        color: '#fff',
                        formatter: '{b}\n{c}人'
                    },
                    emphasis: {
                        itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                    }
                }]
            };
            chart.setOption(option, true);
        }

        // 更新工龄分布图
        function updateWorkingYearsChart(chart, users) {
            const yearRanges = {
                '0年': 0, '1-2年': 0, '3-5年': 0, '6-10年': 0, '10年以上': 0
            };
            
            users.forEach(user => {
                const years = user.working_years || 0;
                if (years === 0) yearRanges['0年']++;
                else if (years <= 2) yearRanges['1-2年']++;
                else if (years <= 5) yearRanges['3-5年']++;
                else if (years <= 10) yearRanges['6-10年']++;
                else yearRanges['10年以上']++;
            });

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                grid: {
                    top: '10%',
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: Object.keys(yearRanges),
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } },
                    axisTick: { show: false },
                    axisLabel: { color: '#fff' }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { color: '#fff' },
                    splitLine: {
                        lineStyle: { color: 'rgba(0,228,255,0.1)', type: 'dashed' }
                    }
                },
                series: [{
                    type: 'line',
                    data: Object.values(yearRanges),
                    smooth: true,
                    lineStyle: { color: '#00e4ff', width: 3 },
                    itemStyle: { color: '#00e4ff', borderWidth: 2 },
                    areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(0,228,255,0.3)' },
                            { offset: 1, color: 'rgba(0,228,255,0.05)' }
                                ])
                        },
                        emphasis: {
                        itemStyle: { color: '#fff', borderColor: '#00e4ff', borderWidth: 3 }
                            }
                }]
            };
            chart.setOption(option, true);
        }

        // 更新部门设备配备率对比图
        function updateDeptDeviceRateChart(chart, users, departmentCount) {
            const deptDeviceStats = {};
            
            // 统计各部门设备配备情况
            users.forEach(user => {
                const dept = user.dept_name;
                if (!deptDeviceStats[dept]) {
                    deptDeviceStats[dept] = { total: 0, hasDevice: 0 };
                }
                deptDeviceStats[dept].total++;
                if (user.device_sn && user.device_sn !== '-' && user.device_sn !== '') {
                    deptDeviceStats[dept].hasDevice++;
                }
            });

            const depts = Object.keys(deptDeviceStats);
            const rates = depts.map(dept => {
                const stats = deptDeviceStats[dept];
                return Math.round((stats.hasDevice / stats.total) * 100);
            });
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const dept = params[0].name;
                        const rate = params[0].value;
                        const stats = deptDeviceStats[dept];
                        return `${dept}<br/>配备率: ${rate}%<br/>已配备: ${stats.hasDevice}人<br/>总人数: ${stats.total}人`;
                    },
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                grid: {
                    top: '10%',
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: depts,
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#fff',
                        rotate: 30,
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    max: 100,
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#fff',
                        formatter: '{value}%'
                    },
                    splitLine: {
                        lineStyle: { color: 'rgba(0,228,255,0.1)', type: 'dashed' }
                    }
                },
                series: [{
                        type: 'bar',
                    data: rates,
                    barWidth: '60%',
                        itemStyle: {
                        color: function(params) {
                            const rate = params.value;
                            if (rate >= 80) return '#2ecc71';
                            if (rate >= 60) return '#f1c40f';
                            if (rate >= 40) return '#e67e22';
                            return '#e74c3c';
                        },
                        borderRadius: [4, 4, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        color: '#fff',
                        formatter: '{c}%'
                    }
                }]
            };
            chart.setOption(option, true);
        }

        // 更新人员状态分布图
        function updateUserStatusChart(chart, users) {
            const onlineCount = users.filter(u => u.status === '1').length;
            const offlineCount = users.length - onlineCount;
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}人 ({d}%)',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 10,
                    textStyle: { color: '#fff', fontSize: 12 }
                },
                series: [{
                        type: 'pie',
                    radius: ['30%', '60%'],
                    center: ['50%', '45%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                        borderRadius: 8,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                        show: true,
                        color: '#fff',
                        formatter: '{b}\n{c}人\n{d}%'
                        },
                        emphasis: {
                        label: { show: true, fontSize: 14, fontWeight: 'bold' }
                        },
                    data: [
                        {
                            name: '在线',
                            value: onlineCount,
                            itemStyle: { color: '#2ecc71' }
                        },
                        {
                            name: '离线',
                            value: offlineCount,
                            itemStyle: { color: '#95a5a6' }
                    }
                ]
                }]
            };
            chart.setOption(option, true);
        }

        // 更新用户卡片显示
        function displayUsers(users) {
            const container = document.getElementById('userCards');
            container.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="card-header">
                        <img class="avatar" src="${user.avatar || 'https://i.pravatar.cc/100'}" alt="${user.user_name}" onerror="this.src='https://i.pravatar.cc/100'">
                        <div class="user-info">
                            <h3 class="user-name">${user.user_name}</h3>
                            <p class="department">${user.dept_name}</p>
                        </div>
                        <span class="status-badge">${user.status === '1' ? '在线' : '离线'}</span>
                    </div>
                    <div class="card-content">
                        <div class="info-item">
                            <span class="info-label">工号：</span>
                            <span>${user.user_card_number || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">岗位：</span>
                            <span>${user.position || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">工龄：</span>
                            <span>${user.working_years || 0}年</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">手机：</span>
                            <span>${user.phone_number || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">设备号：</span>
                            <span class="info-value">
                                ${user.device_sn && user.device_sn !== '-' && user.device_sn !== '' ? 
                                    `<a class="device-link" onclick="showUserProfile('${user.device_sn}')">${user.device_sn}</a>` : 
                                    '<span style="color: #ff6b6b;">未配备</span>'
                                }
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 显示用户档案
        function showUserProfile(deviceSn) {
            const overlay = document.getElementById('profileOverlay');
            const frame = document.getElementById('profileFrame');
            frame.src = `/personal?deviceSn=${deviceSn}`;
            overlay.style.display = 'block';
        }

        // 关闭用户档案
        function closeUserProfile() {
            const overlay = document.getElementById('profileOverlay');
            const frame = document.getElementById('profileFrame');
            overlay.style.display = 'none';
            frame.src = '';
        }

        // 初始化图表
        function initCharts() {
            chartInstances.set('deptUserChart', echarts.init(document.getElementById('deptUserChart')));
            chartInstances.set('deviceStatusChart', echarts.init(document.getElementById('deviceStatusChart')));
            chartInstances.set('positionChart', echarts.init(document.getElementById('positionChart')));
            chartInstances.set('workingYearsChart', echarts.init(document.getElementById('workingYearsChart')));
            chartInstances.set('deptDeviceRateChart', echarts.init(document.getElementById('deptDeviceRateChart')));
            chartInstances.set('userStatusChart', echarts.init(document.getElementById('userStatusChart')));
        }

        // 监听来自父窗口的数据
        window.addEventListener('message', function(event) {
            if (event.data.type === 'userInfo') {
                cachedUserInfo = event.data.data;
                console.log('接收到传递的用户数据:', cachedUserInfo);
                // 如果图表已初始化，直接更新数据
                if (chartInstances.size > 0) {
                    updateDashboardWithCachedData();
                }
            }
            // 其他消息处理
            if (event.data.type === 'closeProfile') {
                closeUserProfile();
            }
        });
        
        // 使用缓存数据更新仪表板
        function updateDashboardWithCachedData() {
            if (!cachedUserInfo) return;
            
            // 将缓存的user_info转换为与API返回格式一致的数据结构
            const data = {
                users: cachedUserInfo.users || [],
                totalUsers: cachedUserInfo.totalUsers || 0,
                totalDevices: cachedUserInfo.totalDevices || 0,
                departmentCount: cachedUserInfo.departmentCount || generateDepartmentCount(cachedUserInfo.users || []), // 前端生成部门统计
                statusCount: { '1': Math.floor((cachedUserInfo.totalUsers || 0) * 0.75) } // 模拟在线用户
            };
            
            // 更新统计概览
            updateStatsOverview(data);

            // 更新用户卡片
            displayUsers(data.users);

            // 更新所有图表
            updateDeptChart(chartInstances.get('deptUserChart'), data.departmentCount);
            updateDeviceChart(chartInstances.get('deviceStatusChart'), data.users);
            updatePositionChart(chartInstances.get('positionChart'), data.users);
            updateWorkingYearsChart(chartInstances.get('workingYearsChart'), data.users);
            updateDeptDeviceRateChart(chartInstances.get('deptDeviceRateChart'), data.users, data.departmentCount);
            updateUserStatusChart(chartInstances.get('userStatusChart'), data.users);
        }

        // 前端生成部门统计函数
        function generateDepartmentCount(users) {
            const deptCount = {};
            users.forEach(user => {
                const deptName = user.dept_name || user.department_name || '未分配部门';
                deptCount[deptName] = (deptCount[deptName] || 0) + 1;
            });
            return deptCount;
        }

        // 主要更新函数 - 支持强制刷新
        async function updateDashboard(forceRefresh = false) {
            // 如果强制刷新或没有缓存数据，调用接口获取
            if (forceRefresh || !cachedUserInfo) {
                console.log('🔄 调用接口获取最新用户数据...');
                const data = await fetchUserInfo();
                if (!data) return;

                // 前端补充部门统计数据
                if (!data.departmentCount && data.users) {
                    data.departmentCount = generateDepartmentCount(data.users);
                }

                // 更新统计概览
                updateStatsOverview(data);

                // 更新用户卡片
                displayUsers(data.users);

                // 更新所有图表
                updateDeptChart(chartInstances.get('deptUserChart'), data.departmentCount);
                updateDeviceChart(chartInstances.get('deviceStatusChart'), data.users);
                updatePositionChart(chartInstances.get('positionChart'), data.users);
                updateWorkingYearsChart(chartInstances.get('workingYearsChart'), data.users);
                updateDeptDeviceRateChart(chartInstances.get('deptDeviceRateChart'), data.users, data.departmentCount);
                updateUserStatusChart(chartInstances.get('userStatusChart'), data.users);
                return;
            }
            
            // 只有首次加载且有缓存数据时才使用缓存
            console.log('✅ 使用传递的缓存数据，避免重复接口调用');
            updateDashboardWithCachedData();
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 手动刷新功能
        function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            const btnIcon = btn.querySelector('.btn-icon');
            const btnText = btn.querySelector('span:last-child');
            
            btnText.textContent = '刷新中...';
            btnIcon.style.animation = 'spin 1s linear infinite';
            btn.disabled = true;
            
            console.log('🔄 手动刷新用户数据...');
            updateDashboard(true).then(() => {
                btnText.textContent = '手动刷新';
                btnIcon.style.animation = '';
                btn.disabled = false;
                console.log('✅ 手动刷新完成');
            }).catch(error => {
                console.error('❌ 手动刷新失败:', error);
                btnText.textContent = '刷新失败';
                btnIcon.textContent = '❌';
                setTimeout(() => {
                    btnText.textContent = '手动刷新';
                    btnIcon.textContent = '🔄';
                    btnIcon.style.animation = '';
                    btn.disabled = false;
                }, 2000);
            });
        }
        
        // 切换自动刷新状态
        function toggleAutoRefresh() {
            const btn = document.getElementById('toggleAutoRefresh');
            const status = document.getElementById('refreshStatus');
            const statusDot = document.getElementById('statusDot');
            const btnIcon = document.getElementById('autoRefreshIcon');
            const btnText = document.getElementById('autoRefreshText');
            
            if (isAutoRefreshEnabled) {
                // 关闭自动刷新
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                isAutoRefreshEnabled = false;
                btnIcon.textContent = '▶️';
                btnText.textContent = '启动监控';
                status.textContent = '监控已暂停';
                statusDot.classList.add('paused');
                console.log('❌ 自动刷新已关闭');
            } else {
                // 开启自动刷新
                startAutoRefresh();
                isAutoRefreshEnabled = true;
                btnIcon.textContent = '⏸️';
                btnText.textContent = '暂停自动';
                status.textContent = '实时监控中';
                statusDot.classList.remove('paused');
                console.log('✅ 自动刷新已开启');
            }
        }
        
        // 启动自动刷新
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            autoRefreshTimer = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    console.log('🔄 自动刷新用户数据...');
                    updateDashboard(true).catch(error => {
                        console.error('❌ 自动刷新失败:', error);
                    });
                }
            }, REFRESH_INTERVAL);
        }
        
        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }
        
        // 全局暴露刷新相关函数
        window.manualRefresh = manualRefresh;
        window.toggleAutoRefresh = toggleAutoRefresh;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 初始化图表实例
            initCharts();
            
            // 等待一小段时间，看是否有缓存数据传递过来
            setTimeout(async () => {
                if (cachedUserInfo) {
                    console.log('✅ 使用传递的缓存数据，避免重复接口调用');
                } else {
                    console.log('❌ 未接收到缓存数据，将调用接口获取');
                }
                
                // 首次加载数据
                await updateDashboard();

                // 启动自动刷新
                if (isAutoRefreshEnabled) {
                    startAutoRefresh();
                }
            }, 1000); // 等待1秒让postMessage有时间传递数据

            // 添加窗口大小变化监听
            window.addEventListener('resize', debounce(() => {
                    chartInstances.forEach(chart => chart.resize());
            }, 250));
            });

        // 点击遮罩层关闭
        document.getElementById('profileOverlay').addEventListener('click', function(event) {
            if (event.target === this) {
                closeUserProfile();
            }
            });

        // ESC键关闭
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeUserProfile();
                }
        });
    </script>
</body>
</html> 