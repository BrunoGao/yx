<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>äººå‘˜ç®¡ç†</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.4.2/tinycolor.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 228, 255, 0.1), rgba(0, 228, 255, 0.05));
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 228, 255, 0.6);
            box-shadow: 0 10px 30px rgba(0, 228, 255, 0.2);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #00e4ff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* å›¾è¡¨ç½‘æ ¼å¸ƒå±€ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            min-height: 350px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            border-color: rgba(0, 228, 255, 0.5);
            box-shadow: 0 5px 20px rgba(0, 228, 255, 0.1);
        }

        .chart-title {
            font-size: 16px;
            color: #00e4ff;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }

        /* ç”¨æˆ·å¡ç‰‡ç½‘æ ¼å®¹å™¨ */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 228, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #52c41a;
            box-shadow: 0 0 6px rgba(82, 196, 26, 0.8);
            animation: pulse 2s infinite;
        }

        .status-dot.paused {
            background: #fa8c16;
            box-shadow: 0 0 6px rgba(250, 140, 22, 0.8);
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .status-text {
            color: #7ecfff;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .control-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
            min-width: 90px;
            justify-content: center;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
        }

        .control-btn.primary:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        .control-btn.secondary {
            background: linear-gradient(45deg, rgba(250, 140, 22, 0.8), rgba(255, 187, 0, 0.8));
            color: #fff;
        }

        .control-btn.secondary:hover {
            background: linear-gradient(45deg, rgba(255, 187, 0, 0.9), rgba(250, 140, 22, 0.9));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(250, 140, 22, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            font-size: 14px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ç”¨æˆ·å¡ç‰‡æ ·å¼ */
        .user-card {
            background: rgba(37, 39, 41, 0.95);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .user-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 228, 255, 0.5);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(0, 228, 255, 0.5);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 18px;
            margin: 0 0 5px 0;
            color: #fff;
        }

        .department {
            font-size: 14px;
            color: #00e4ff;
            margin: 0;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .info-label {
            color: rgba(0, 228, 255, 0.6);
            min-width: 70px;
        }

        .device-tag {
            background: rgba(0, 228, 255, 0.1);
            color: #00e4ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 10px;
            display: inline-block;
        }

        /* è®¾å¤‡é“¾æ¥æ ·å¼ */
        .device-link {
            color: #00e4ff;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .device-link:hover {
            color: #fff;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        /* å¼¹å‡ºå±‚æ ·å¼ */
        .profile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .profile-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background: #011326;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .profile-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background: rgba(255, 0, 0, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .profile-close-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.4);
        }

        .profile-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
        }

            .cards-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="stats-overview" id="statsOverview">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">æ€»å‘˜å·¥æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDepts">0</div>
                <div class="stat-label">éƒ¨é—¨æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDevices">0</div>
                <div class="stat-label">è®¾å¤‡æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="deviceRate">0%</div>
                <div class="stat-label">è®¾å¤‡é…å¤‡ç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineUsers">0</div>
                <div class="stat-label">åœ¨çº¿äººæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgWorkingYears">0</div>
                <div class="stat-label">å¹³å‡å·¥é¾„</div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="refreshStatus" class="status-text">å®æ—¶ç›‘æ§ä¸­</span>
            </div>
            <div class="button-group">
                <button id="refreshBtn" class="control-btn primary" onclick="manualRefresh()">
                    <span class="btn-icon">ğŸ”„</span>
                    <span>æ‰‹åŠ¨åˆ·æ–°</span>
                </button>
                <button id="toggleAutoRefresh" class="control-btn secondary" onclick="toggleAutoRefresh()">
                    <span class="btn-icon" id="autoRefreshIcon">â¸ï¸</span>
                    <span id="autoRefreshText">æš‚åœè‡ªåŠ¨</span>
                </button>
            </div>
        </div>

        <!-- ç”¨æˆ·å¡ç‰‡åˆ—è¡¨ - ç§»åˆ°å›¾è¡¨å‰é¢ -->
        <div class="cards-container" id="userCards"></div>

        <!-- ä¸“ä¸šå›¾è¡¨ç½‘æ ¼ -->
        <div class="charts-grid">
            <!-- éƒ¨é—¨äººå‘˜åˆ†å¸ƒå›¾ -->
            <div class="chart-container">
                <div class="chart-title">éƒ¨é—¨äººå‘˜åˆ†å¸ƒ</div>
                <div id="deptUserChart" style="width: 100%; height: 300px;"></div>
            </div>

            <!-- è®¾å¤‡é…å¤‡çŠ¶æ€å›¾ -->
            <div class="chart-container">
                <div class="chart-title">è®¾å¤‡é…å¤‡çŠ¶æ€</div>
                <div id="deviceStatusChart" style="width: 100%; height: 300px;"></div>
            </div>

            <!-- å²—ä½åˆ†å¸ƒå›¾ -->
            <div class="chart-container">
                <div class="chart-title">å²—ä½åˆ†å¸ƒåˆ†æ</div>
                <div id="positionChart" style="width: 100%; height: 300px;"></div>
        </div>

            <!-- å·¥é¾„åˆ†å¸ƒå›¾ -->
            <div class="chart-container">
                <div class="chart-title">å·¥é¾„åˆ†å¸ƒåˆ†æ</div>
                <div id="workingYearsChart" style="width: 100%; height: 300px;"></div>
            </div>

            <!-- éƒ¨é—¨è®¾å¤‡é…å¤‡ç‡å¯¹æ¯” -->
            <div class="chart-container">
                <div class="chart-title">éƒ¨é—¨è®¾å¤‡é…å¤‡ç‡å¯¹æ¯”</div>
                <div id="deptDeviceRateChart" style="width: 100%; height: 300px;"></div>
            </div>

            <!-- äººå‘˜çŠ¶æ€åˆ†å¸ƒ -->
            <div class="chart-container">
                <div class="chart-title">äººå‘˜åœ¨çº¿çŠ¶æ€åˆ†å¸ƒ</div>
                <div id="userStatusChart" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·æ¡£æ¡ˆå¼¹å‡ºå±‚ -->
    <div class="profile-overlay" id="profileOverlay">
        <div class="profile-panel" id="profilePanel">
            <button class="profile-close-btn" onclick="closeUserProfile()" title="å…³é—­">âœ•</button>
            <iframe id="profileFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>

    <script>
        // å›¾è¡¨å®ä¾‹ç¼“å­˜
        const chartInstances = new Map();
        
        // ç¼“å­˜ä¼ é€’è¿‡æ¥çš„ç”¨æˆ·æ•°æ®
        let cachedUserInfo = null;
        
        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshTimer = null;
        let isAutoRefreshEnabled = true;
        const REFRESH_INTERVAL = 30000; // 30ç§’
        
        // éƒ¨é—¨é¢œè‰²æ–¹æ¡ˆ
        const departmentColors = {
            'ç…¤çŸ¿é›†å›¢æ€»éƒ¨': '#3498db',
            'å®‰å…¨ç®¡ç†éƒ¨': '#e74c3c',
            'ç”Ÿäº§æŠ€æœ¯éƒ¨': '#2ecc71',
            'è´¢åŠ¡éƒ¨': '#f1c40f',
            'äººåŠ›èµ„æºéƒ¨': '#9b59b6',
            'é”€å”®éƒ¨': '#1abc9c',
            'çŸ¿åŒº 1': '#e67e22',
            'çŸ¿åŒº 2': '#34495e',
            'å¼€é‡‡é˜Ÿ': '#9b59b6',
            'é€šé£é˜Ÿ': '#16a085',
            'è®¾å¤‡ç»´ä¿®é˜Ÿ': '#d35400',
            'å®‰å…¨ç›‘å¯Ÿé˜Ÿ': '#c0392b'
        };

        // è·å–éƒ¨é—¨é¢œè‰²
        function getDepartmentColor(deptName) {
            return departmentColors[deptName] || '#00e4ff';
        }

        // æ•°æ®è·å–å‡½æ•°
        async function fetchUserInfo() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                const deptId = urlParams.get('deptId') || '';
                const userId = urlParams.get('userId') || '';

                const orgId = deptId || customerId;
                let url = `/get_users_by_orgIdAndUserId?orgId=${orgId}`;
                if (userId && userId !== 'all') url += `&userId=${userId}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const result = await response.json();
                if (result.success) {
                    return result.data;
                }
                throw new Error('Failed to fetch data');
            } catch (error) {
                console.error('Error fetching user info:', error);
                return null;
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
        function updateStatsOverview(data) {
            const { users, totalUsers, totalDevices, departmentCount, statusCount } = data;
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const totalDepts = Object.keys(departmentCount).length;
            const onlineUsers = statusCount['1'] || 0;
            const deviceRate = totalDevices > 0 ? Math.round((totalDevices / totalUsers) * 100) : 0;
            
            // è®¡ç®—å¹³å‡å·¥é¾„
            const totalWorkingYears = users.reduce((sum, user) => sum + (user.working_years || 0), 0);
            const avgWorkingYears = totalUsers > 0 ? Math.round(totalWorkingYears / totalUsers * 10) / 10 : 0;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalDepts').textContent = totalDepts;
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('deviceRate').textContent = deviceRate + '%';
            document.getElementById('onlineUsers').textContent = onlineUsers;
            document.getElementById('avgWorkingYears').textContent = avgWorkingYears + 'å¹´';
            }

        // æ›´æ–°éƒ¨é—¨äººå‘˜åˆ†å¸ƒå›¾
        function updateDeptChart(chart, departmentCount) {
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                grid: {
                    top: '10%',
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: Object.keys(departmentCount),
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#fff',
                        rotate: 30,
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { color: '#fff' },
                    splitLine: {
                        lineStyle: { color: 'rgba(0,228,255,0.1)', type: 'dashed' }
                    }
                },
                series: [{
                    type: 'bar',
                    data: Object.values(departmentCount),
                    barWidth: '60%',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(0,228,255,0.8)' },
                            { offset: 1, color: 'rgba(0,228,255,0.2)' }
                        ]),
                        borderRadius: [4, 4, 0, 0]
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0,228,255,1)' },
                                { offset: 1, color: 'rgba(0,228,255,0.4)' }
                            ])
                        }
                    }
                }]
            };
            chart.setOption(option, true);
        }

        // æ›´æ–°è®¾å¤‡é…å¤‡çŠ¶æ€å›¾
        function updateDeviceChart(chart, users) {
            const hasDevice = users.filter(u => u.device_sn && u.device_sn !== '-' && u.device_sn !== '').length;
            const noDevice = users.length - hasDevice;
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#fff', fontSize: 12 }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        color: '#fff',
                        formatter: '{b}\n{c}äºº'
                    },
                    emphasis: {
                        label: { show: true, fontSize: 14, fontWeight: 'bold' }
                    },
                    data: [
                        {
                            name: 'å·²é…å¤‡è®¾å¤‡',
                            value: hasDevice,
                            itemStyle: { color: '#00e4ff' }
                        },
                        {
                            name: 'æœªé…å¤‡è®¾å¤‡',
                            value: noDevice,
                            itemStyle: { color: '#ff6b6b' }
                        }
                    ]
                }]
            };
            chart.setOption(option, true);
        }

        // æ›´æ–°å²—ä½åˆ†å¸ƒå›¾
        function updatePositionChart(chart, users) {
            const positionCount = {};
            users.forEach(user => {
                const position = user.position || 'æœªè®¾ç½®';
                positionCount[position] = (positionCount[position] || 0) + 1;
            });

            const data = Object.entries(positionCount).map(([name, value]) => ({ name, value }));
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}äºº ({d}%)',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    center: ['50%', '50%'],
                    data: data,
                    itemStyle: {
                        borderRadius: 6,
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    label: {
                        show: true,
                        color: '#fff',
                        formatter: '{b}\n{c}äºº'
                    },
                    emphasis: {
                        itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                    }
                }]
            };
            chart.setOption(option, true);
        }

        // æ›´æ–°å·¥é¾„åˆ†å¸ƒå›¾
        function updateWorkingYearsChart(chart, users) {
            const yearRanges = {
                '0å¹´': 0, '1-2å¹´': 0, '3-5å¹´': 0, '6-10å¹´': 0, '10å¹´ä»¥ä¸Š': 0
            };
            
            users.forEach(user => {
                const years = user.working_years || 0;
                if (years === 0) yearRanges['0å¹´']++;
                else if (years <= 2) yearRanges['1-2å¹´']++;
                else if (years <= 5) yearRanges['3-5å¹´']++;
                else if (years <= 10) yearRanges['6-10å¹´']++;
                else yearRanges['10å¹´ä»¥ä¸Š']++;
            });

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                grid: {
                    top: '10%',
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: Object.keys(yearRanges),
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } },
                    axisTick: { show: false },
                    axisLabel: { color: '#fff' }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { color: '#fff' },
                    splitLine: {
                        lineStyle: { color: 'rgba(0,228,255,0.1)', type: 'dashed' }
                    }
                },
                series: [{
                    type: 'line',
                    data: Object.values(yearRanges),
                    smooth: true,
                    lineStyle: { color: '#00e4ff', width: 3 },
                    itemStyle: { color: '#00e4ff', borderWidth: 2 },
                    areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(0,228,255,0.3)' },
                            { offset: 1, color: 'rgba(0,228,255,0.05)' }
                                ])
                        },
                        emphasis: {
                        itemStyle: { color: '#fff', borderColor: '#00e4ff', borderWidth: 3 }
                            }
                }]
            };
            chart.setOption(option, true);
        }

        // æ›´æ–°éƒ¨é—¨è®¾å¤‡é…å¤‡ç‡å¯¹æ¯”å›¾
        function updateDeptDeviceRateChart(chart, users, departmentCount) {
            const deptDeviceStats = {};
            
            // ç»Ÿè®¡å„éƒ¨é—¨è®¾å¤‡é…å¤‡æƒ…å†µ
            users.forEach(user => {
                const dept = user.dept_name;
                if (!deptDeviceStats[dept]) {
                    deptDeviceStats[dept] = { total: 0, hasDevice: 0 };
                }
                deptDeviceStats[dept].total++;
                if (user.device_sn && user.device_sn !== '-' && user.device_sn !== '') {
                    deptDeviceStats[dept].hasDevice++;
                }
            });

            const depts = Object.keys(deptDeviceStats);
            const rates = depts.map(dept => {
                const stats = deptDeviceStats[dept];
                return Math.round((stats.hasDevice / stats.total) * 100);
            });
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const dept = params[0].name;
                        const rate = params[0].value;
                        const stats = deptDeviceStats[dept];
                        return `${dept}<br/>é…å¤‡ç‡: ${rate}%<br/>å·²é…å¤‡: ${stats.hasDevice}äºº<br/>æ€»äººæ•°: ${stats.total}äºº`;
                    },
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                grid: {
                    top: '10%',
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: depts,
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#fff',
                        rotate: 30,
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    max: 100,
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#fff',
                        formatter: '{value}%'
                    },
                    splitLine: {
                        lineStyle: { color: 'rgba(0,228,255,0.1)', type: 'dashed' }
                    }
                },
                series: [{
                        type: 'bar',
                    data: rates,
                    barWidth: '60%',
                        itemStyle: {
                        color: function(params) {
                            const rate = params.value;
                            if (rate >= 80) return '#2ecc71';
                            if (rate >= 60) return '#f1c40f';
                            if (rate >= 40) return '#e67e22';
                            return '#e74c3c';
                        },
                        borderRadius: [4, 4, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        color: '#fff',
                        formatter: '{c}%'
                    }
                }]
            };
            chart.setOption(option, true);
        }

        // æ›´æ–°äººå‘˜çŠ¶æ€åˆ†å¸ƒå›¾
        function updateUserStatusChart(chart, users) {
            const onlineCount = users.filter(u => u.status === '1').length;
            const offlineCount = users.length - onlineCount;
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}äºº ({d}%)',
                    backgroundColor: 'rgba(0,15,52,0.9)',
                    borderColor: '#00e4ff',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 10,
                    textStyle: { color: '#fff', fontSize: 12 }
                },
                series: [{
                        type: 'pie',
                    radius: ['30%', '60%'],
                    center: ['50%', '45%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                        borderRadius: 8,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                        show: true,
                        color: '#fff',
                        formatter: '{b}\n{c}äºº\n{d}%'
                        },
                        emphasis: {
                        label: { show: true, fontSize: 14, fontWeight: 'bold' }
                        },
                    data: [
                        {
                            name: 'åœ¨çº¿',
                            value: onlineCount,
                            itemStyle: { color: '#2ecc71' }
                        },
                        {
                            name: 'ç¦»çº¿',
                            value: offlineCount,
                            itemStyle: { color: '#95a5a6' }
                    }
                ]
                }]
            };
            chart.setOption(option, true);
        }

        // æ›´æ–°ç”¨æˆ·å¡ç‰‡æ˜¾ç¤º
        function displayUsers(users) {
            const container = document.getElementById('userCards');
            container.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="card-header">
                        <img class="avatar" src="${user.avatar || 'https://i.pravatar.cc/100'}" alt="${user.user_name}" onerror="this.src='https://i.pravatar.cc/100'">
                        <div class="user-info">
                            <h3 class="user-name">${user.user_name}</h3>
                            <p class="department">${user.dept_name}</p>
                        </div>
                        <span class="status-badge">${user.status === '1' ? 'åœ¨çº¿' : 'ç¦»çº¿'}</span>
                    </div>
                    <div class="card-content">
                        <div class="info-item">
                            <span class="info-label">å·¥å·ï¼š</span>
                            <span>${user.user_card_number || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å²—ä½ï¼š</span>
                            <span>${user.position || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å·¥é¾„ï¼š</span>
                            <span>${user.working_years || 0}å¹´</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ‰‹æœºï¼š</span>
                            <span>${user.phone_number || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è®¾å¤‡å·ï¼š</span>
                            <span class="info-value">
                                ${user.device_sn && user.device_sn !== '-' && user.device_sn !== '' ? 
                                    `<a class="device-link" onclick="showUserProfile('${user.device_sn}')">${user.device_sn}</a>` : 
                                    '<span style="color: #ff6b6b;">æœªé…å¤‡</span>'
                                }
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºç”¨æˆ·æ¡£æ¡ˆ
        function showUserProfile(deviceSn) {
            const overlay = document.getElementById('profileOverlay');
            const frame = document.getElementById('profileFrame');
            frame.src = `/personal?deviceSn=${deviceSn}`;
            overlay.style.display = 'block';
        }

        // å…³é—­ç”¨æˆ·æ¡£æ¡ˆ
        function closeUserProfile() {
            const overlay = document.getElementById('profileOverlay');
            const frame = document.getElementById('profileFrame');
            overlay.style.display = 'none';
            frame.src = '';
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            chartInstances.set('deptUserChart', echarts.init(document.getElementById('deptUserChart')));
            chartInstances.set('deviceStatusChart', echarts.init(document.getElementById('deviceStatusChart')));
            chartInstances.set('positionChart', echarts.init(document.getElementById('positionChart')));
            chartInstances.set('workingYearsChart', echarts.init(document.getElementById('workingYearsChart')));
            chartInstances.set('deptDeviceRateChart', echarts.init(document.getElementById('deptDeviceRateChart')));
            chartInstances.set('userStatusChart', echarts.init(document.getElementById('userStatusChart')));
        }

        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ•°æ®
        window.addEventListener('message', function(event) {
            if (event.data.type === 'userInfo') {
                cachedUserInfo = event.data.data;
                console.log('æ¥æ”¶åˆ°ä¼ é€’çš„ç”¨æˆ·æ•°æ®:', cachedUserInfo);
                // å¦‚æœå›¾è¡¨å·²åˆå§‹åŒ–ï¼Œç›´æ¥æ›´æ–°æ•°æ®
                if (chartInstances.size > 0) {
                    updateDashboardWithCachedData();
                }
            }
            // å…¶ä»–æ¶ˆæ¯å¤„ç†
            if (event.data.type === 'closeProfile') {
                closeUserProfile();
            }
        });
        
        // ä½¿ç”¨ç¼“å­˜æ•°æ®æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboardWithCachedData() {
            if (!cachedUserInfo) return;
            
            // å°†ç¼“å­˜çš„user_infoè½¬æ¢ä¸ºä¸APIè¿”å›æ ¼å¼ä¸€è‡´çš„æ•°æ®ç»“æ„
            const data = {
                users: cachedUserInfo.users || [],
                totalUsers: cachedUserInfo.totalUsers || 0,
                totalDevices: cachedUserInfo.totalDevices || 0,
                departmentCount: cachedUserInfo.departmentCount || generateDepartmentCount(cachedUserInfo.users || []), // å‰ç«¯ç”Ÿæˆéƒ¨é—¨ç»Ÿè®¡
                statusCount: { '1': Math.floor((cachedUserInfo.totalUsers || 0) * 0.75) } // æ¨¡æ‹Ÿåœ¨çº¿ç”¨æˆ·
            };
            
            // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
            updateStatsOverview(data);

            // æ›´æ–°ç”¨æˆ·å¡ç‰‡
            displayUsers(data.users);

            // æ›´æ–°æ‰€æœ‰å›¾è¡¨
            updateDeptChart(chartInstances.get('deptUserChart'), data.departmentCount);
            updateDeviceChart(chartInstances.get('deviceStatusChart'), data.users);
            updatePositionChart(chartInstances.get('positionChart'), data.users);
            updateWorkingYearsChart(chartInstances.get('workingYearsChart'), data.users);
            updateDeptDeviceRateChart(chartInstances.get('deptDeviceRateChart'), data.users, data.departmentCount);
            updateUserStatusChart(chartInstances.get('userStatusChart'), data.users);
        }

        // å‰ç«¯ç”Ÿæˆéƒ¨é—¨ç»Ÿè®¡å‡½æ•°
        function generateDepartmentCount(users) {
            const deptCount = {};
            users.forEach(user => {
                const deptName = user.dept_name || user.department_name || 'æœªåˆ†é…éƒ¨é—¨';
                deptCount[deptName] = (deptCount[deptName] || 0) + 1;
            });
            return deptCount;
        }

        // ä¸»è¦æ›´æ–°å‡½æ•° - æ”¯æŒå¼ºåˆ¶åˆ·æ–°
        async function updateDashboard(forceRefresh = false) {
            // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œè°ƒç”¨æ¥å£è·å–
            if (forceRefresh || !cachedUserInfo) {
                console.log('ğŸ”„ è°ƒç”¨æ¥å£è·å–æœ€æ–°ç”¨æˆ·æ•°æ®...');
                const data = await fetchUserInfo();
                if (!data) return;

                // å‰ç«¯è¡¥å……éƒ¨é—¨ç»Ÿè®¡æ•°æ®
                if (!data.departmentCount && data.users) {
                    data.departmentCount = generateDepartmentCount(data.users);
                }

                // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
                updateStatsOverview(data);

                // æ›´æ–°ç”¨æˆ·å¡ç‰‡
                displayUsers(data.users);

                // æ›´æ–°æ‰€æœ‰å›¾è¡¨
                updateDeptChart(chartInstances.get('deptUserChart'), data.departmentCount);
                updateDeviceChart(chartInstances.get('deviceStatusChart'), data.users);
                updatePositionChart(chartInstances.get('positionChart'), data.users);
                updateWorkingYearsChart(chartInstances.get('workingYearsChart'), data.users);
                updateDeptDeviceRateChart(chartInstances.get('deptDeviceRateChart'), data.users, data.departmentCount);
                updateUserStatusChart(chartInstances.get('userStatusChart'), data.users);
                return;
            }
            
            // åªæœ‰é¦–æ¬¡åŠ è½½ä¸”æœ‰ç¼“å­˜æ•°æ®æ—¶æ‰ä½¿ç”¨ç¼“å­˜
            console.log('âœ… ä½¿ç”¨ä¼ é€’çš„ç¼“å­˜æ•°æ®ï¼Œé¿å…é‡å¤æ¥å£è°ƒç”¨');
            updateDashboardWithCachedData();
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
        function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            const btnIcon = btn.querySelector('.btn-icon');
            const btnText = btn.querySelector('span:last-child');
            
            btnText.textContent = 'åˆ·æ–°ä¸­...';
            btnIcon.style.animation = 'spin 1s linear infinite';
            btn.disabled = true;
            
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°ç”¨æˆ·æ•°æ®...');
            updateDashboard(true).then(() => {
                btnText.textContent = 'æ‰‹åŠ¨åˆ·æ–°';
                btnIcon.style.animation = '';
                btn.disabled = false;
                console.log('âœ… æ‰‹åŠ¨åˆ·æ–°å®Œæˆ');
            }).catch(error => {
                console.error('âŒ æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error);
                btnText.textContent = 'åˆ·æ–°å¤±è´¥';
                btnIcon.textContent = 'âŒ';
                setTimeout(() => {
                    btnText.textContent = 'æ‰‹åŠ¨åˆ·æ–°';
                    btnIcon.textContent = 'ğŸ”„';
                    btnIcon.style.animation = '';
                    btn.disabled = false;
                }, 2000);
            });
        }
        
        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        function toggleAutoRefresh() {
            const btn = document.getElementById('toggleAutoRefresh');
            const status = document.getElementById('refreshStatus');
            const statusDot = document.getElementById('statusDot');
            const btnIcon = document.getElementById('autoRefreshIcon');
            const btnText = document.getElementById('autoRefreshText');
            
            if (isAutoRefreshEnabled) {
                // å…³é—­è‡ªåŠ¨åˆ·æ–°
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                isAutoRefreshEnabled = false;
                btnIcon.textContent = 'â–¶ï¸';
                btnText.textContent = 'å¯åŠ¨ç›‘æ§';
                status.textContent = 'ç›‘æ§å·²æš‚åœ';
                statusDot.classList.add('paused');
                console.log('âŒ è‡ªåŠ¨åˆ·æ–°å·²å…³é—­');
            } else {
                // å¼€å¯è‡ªåŠ¨åˆ·æ–°
                startAutoRefresh();
                isAutoRefreshEnabled = true;
                btnIcon.textContent = 'â¸ï¸';
                btnText.textContent = 'æš‚åœè‡ªåŠ¨';
                status.textContent = 'å®æ—¶ç›‘æ§ä¸­';
                statusDot.classList.remove('paused');
                console.log('âœ… è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯');
            }
        }
        
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            autoRefreshTimer = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°ç”¨æˆ·æ•°æ®...');
                    updateDashboard(true).catch(error => {
                        console.error('âŒ è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', error);
                    });
                }
            }, REFRESH_INTERVAL);
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }
        
        // å…¨å±€æš´éœ²åˆ·æ–°ç›¸å…³å‡½æ•°
        window.manualRefresh = manualRefresh;
        window.toggleAutoRefresh = toggleAutoRefresh;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
            initCharts();
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œçœ‹æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®ä¼ é€’è¿‡æ¥
            setTimeout(async () => {
                if (cachedUserInfo) {
                    console.log('âœ… ä½¿ç”¨ä¼ é€’çš„ç¼“å­˜æ•°æ®ï¼Œé¿å…é‡å¤æ¥å£è°ƒç”¨');
                } else {
                    console.log('âŒ æœªæ¥æ”¶åˆ°ç¼“å­˜æ•°æ®ï¼Œå°†è°ƒç”¨æ¥å£è·å–');
                }
                
                // é¦–æ¬¡åŠ è½½æ•°æ®
                await updateDashboard();

                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                if (isAutoRefreshEnabled) {
                    startAutoRefresh();
                }
            }, 1000); // ç­‰å¾…1ç§’è®©postMessageæœ‰æ—¶é—´ä¼ é€’æ•°æ®

            // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬
            window.addEventListener('resize', debounce(() => {
                    chartInstances.forEach(chart => chart.resize());
            }, 250));
            });

        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        document.getElementById('profileOverlay').addEventListener('click', function(event) {
            if (event.target === this) {
                closeUserProfile();
            }
            });

        // ESCé”®å…³é—­
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeUserProfile();
                }
        });
    </script>
</body>
</html> 