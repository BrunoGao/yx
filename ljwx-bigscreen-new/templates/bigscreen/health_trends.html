<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¥åº·è¶‹åŠ¿å›¾</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <style>
    body { margin:0; background: #181c2f; color:#eee; font-family: 'Segoe UI',sans-serif; }
    .legend-bar {padding:10px 20px;}
    .chart-container { display: grid; grid-template-columns: repeat(3,1fr); gap:10px; padding:10px; }
    .chart { width:100%; height:300px; background:#232946; border-radius:8px; box-shadow:0 2px 12px #0008; transition:height .3s;}
    .selector-bar {padding:16px 20px;display:flex;align-items:center;gap:12px;}
    .selector-bar label {font-size:18px;}
    .metric-dropdown{position:relative;}
    .metric-btn{min-width:180px;height:2.4em;border-radius:6px;border:1px solid #444;background:#232946;color:#fff;font-size:16px;padding:4px 8px;cursor:pointer;}
    .metric-list{display:none;position:absolute;top:110%;left:0;z-index:10;background:#232946;border:1px solid #444;border-radius:6px;box-shadow:0 2px 8px #0006;padding:8px 0;}
    .metric-list label{display:block;padding:6px 18px;cursor:pointer;font-size:16px;}
    .metric-list label:hover{background:#2a2f4a;}
    .metric-list input[type=checkbox]{margin-right:8px;}
    .metric-list input[type=radio]{margin-right:8px;}
    .metric-list .all{font-weight:bold;}
    
    /* å‘˜å·¥é€‰æ‹©å™¨ç‰¹å®šæ ·å¼ */
    #userList {max-height:300px; overflow-y:auto; min-width:220px;}
    #userList label {white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    #userList input[type=radio] {accent-color:#00eaff;}
    #userTip {animation:pulse 2s infinite;}
    @keyframes pulse {0%{opacity:1;} 50%{opacity:0.7;} 100%{opacity:1;}}
    
    /* æœç´¢æ¡†æ ·å¼ */
    .user-search {
      width:200px; margin:8px; padding:4px 8px; border-radius:4px;
      border:1px solid #444; background:#232946; color:#fff; font-size:14px;
    }
    .user-search:focus {border-color:#00eaff; outline:none;}

    .date-picker-container {
        padding: 16px 20px 0 20px;
        display: flex; align-items: center; gap: 8px;
        font-size: 16px; font-weight: 500;
      }
      .date-picker-container input[type="date"] {
        border: 1.5px solid #3a6ea5; border-radius: 6px;
        background: #232946; color: #fff; font-size: 16px; padding: 4px 8px;
        margin-right: 4px; outline: none; transition: .2s;
      }
      .date-picker-container input[type="date"]:focus { border-color: #00eaff; }
      #dateSearchBtn {
        border: none; border-radius: 6px; background: #00eaff; color: #181c2f;
        font-size: 16px; font-weight: 700; padding: 6px 18px; cursor: pointer;
        box-shadow: 0 2px 8px #00eaff44; transition: .2s;
      }
      #dateSearchBtn:hover { background: #38f9d7; color: #232946; }

  </style>
</head>
<body>
  <div class="selector-bar">
    <label>é€‰æ‹©ä½“å¾ï¼š</label>
    <div class="metric-dropdown">
      <button id="metricBtn" class="metric-btn">å…¨éƒ¨ä½“å¾</button>
      <div id="metricList" class="metric-list"></div>
    </div>
  </div>
  <div class="date-picker-container">
    <label>èµ·å§‹æ—¥æœŸï¼š</label>
    <input type="date" id="startDate" />
    <label style="margin-left:12px;">ç»“æŸæ—¥æœŸï¼š</label>
    <input type="date" id="endDate" />
    <button id="dateSearchBtn" style="margin-left:16px;">æŸ¥è¯¢</button>
  </div>
  <!-- å‘˜å·¥é€‰æ‹©å™¨ -->
  <div id="userSelector" class="selector-bar" style="display:flex;">
    <label>é€‰æ‹©å‘˜å·¥ï¼š</label>
    <div class="metric-dropdown">
      <button id="userBtn" class="metric-btn">è¯·é€‰æ‹©å‘˜å·¥</button>
      <div id="userList" class="metric-list"></div>
    </div>
    <div id="userTip" style="margin-left:12px;color:#ff6b6b;font-size:14px;">æ­£åœ¨åŠ è½½å‘˜å·¥åˆ—è¡¨...</div>
  </div>
  <div class="legend-bar" id="legendBar"></div>
  <div id="loading" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:99;background:#181c2fcc;display:flex;align-items:center;justify-content:center;font-size:32px;color:#00eaff;font-weight:bold;">åŠ è½½ä¸­...</div>
  <div id="nodata" style="display:none;text-align:center;font-size:28px;color:#b0c4de;margin-top:80px;">æš‚æ— æ•°æ®</div>
  <div class="chart-container"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const customerId = params.get('customerId') || '1';
    const deptId = params.get('deptId') || customerId;
    const userId = params.get('userId') || '';
    const deptName = params.get('deptName') || '';
    const userName = params.get('userName') || '';
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    let departmentUsers = []; // å­˜å‚¨éƒ¨é—¨å‘˜å·¥åˆ—è¡¨
    let selectedUserId = userId; // å½“å‰é€‰æ‹©çš„å‘˜å·¥ID

    window.onload = ()=>{
      // è®¾ç½®é»˜è®¤æ—¥æœŸ
      const today = new Date();
      const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0'), d = String(today.getDate()).padStart(2,'0');
      document.getElementById('startDate').value = `${y}-${m}-01`;
      document.getElementById('endDate').value = `${y}-${m}-${d}`;
      
      // æ˜¾ç¤ºåˆå§‹æç¤ºé¡µé¢ï¼Œä¸è‡ªåŠ¨åŠ è½½æ•°æ®
      showInitialState();
      
      // é¦–å…ˆè·å–éƒ¨é—¨å‘˜å·¥åˆ—è¡¨ï¼ˆä»…è·å–åˆ—è¡¨ï¼Œä¸åŠ è½½æ•°æ®ï¼‰
      loadDepartmentUsers();
      
      document.getElementById('dateSearchBtn').onclick = loadTrendData;
    };

    // æ˜¾ç¤ºåˆå§‹çŠ¶æ€é¡µé¢
    function showInitialState() {
      const container = document.querySelector('.chart-container');
      container.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #232946; border-radius: 8px; margin: 20px;">
          <div style="font-size: 48px; color: #00eaff; margin-bottom: 20px;">ğŸ“Š</div>
          <h2 style="color: #fff; margin-bottom: 16px; font-size: 24px;">å¥åº·è¶‹åŠ¿åˆ†æ</h2>
          <p style="color: #b0c4de; font-size: 18px; margin-bottom: 30px; line-height: 1.6;">
            é€‰æ‹©å‘˜å·¥å’Œæ—¶é—´èŒƒå›´ï¼ŒæŸ¥çœ‹è¯¦ç»†çš„å¥åº·æ•°æ®è¶‹åŠ¿å¯¹æ¯”åˆ†æ
          </p>
          <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
            <div style="background: #1a1e35; padding: 20px; border-radius: 8px; border-left: 4px solid #00eaff;">
              <div style="color: #00eaff; font-weight: bold; margin-bottom: 8px;">ğŸ“ˆ å¤šæŒ‡æ ‡å¯¹æ¯”</div>
              <div style="color: #b0c4de; font-size: 14px;">å¿ƒç‡ã€è¡€æ°§ã€è¡€å‹ç­‰9é¡¹æŒ‡æ ‡</div>
            </div>
            <div style="background: #1a1e35; padding: 20px; border-radius: 8px; border-left: 4px solid #ff6b6b;">
              <div style="color: #ff6b6b; font-weight: bold; margin-bottom: 8px;">ğŸ‘¥ ä¸ªäººvséƒ¨é—¨</div>
              <div style="color: #b0c4de; font-size: 14px;">ä¸ªäººæ•°æ®ä¸éƒ¨é—¨å¹³å‡å¯¹æ¯”</div>
            </div>
            <div style="background: #1a1e35; padding: 20px; border-radius: 8px; border-left: 4px solid #38f9d7;">
              <div style="color: #38f9d7; font-weight: bold; margin-bottom: 8px;">ğŸ“… æ—¶é—´èŒƒå›´</div>
              <div style="color: #b0c4de; font-size: 14px;">æ”¯æŒè‡ªå®šä¹‰æ—¶é—´æŸ¥è¯¢</div>
            </div>
          </div>
          <div style="margin-top: 40px; padding: 20px; background: #1a1e35; border-radius: 8px; border: 1px dashed #444;">
            <div style="color: #ffd700; font-weight: bold; font-size: 16px; margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨æç¤º</div>
            <div style="color: #b0c4de; font-size: 14px; text-align: left; max-width: 600px; margin: 0 auto;">
              <div style="margin-bottom: 8px;">1. ğŸ§‘â€ğŸ’¼ <strong>é€‰æ‹©å‘˜å·¥</strong>ï¼šç‚¹å‡»ä¸Šæ–¹"è¯·é€‰æ‹©å‘˜å·¥"è¿›è¡Œé€‰æ‹©</div>
              <div style="margin-bottom: 8px;">2. ğŸ“… <strong>è®¾ç½®æ—¶é—´</strong>ï¼šè°ƒæ•´èµ·å§‹å’Œç»“æŸæ—¥æœŸèŒƒå›´</div>
              <div style="margin-bottom: 8px;">3. ğŸ” <strong>ç‚¹å‡»æŸ¥è¯¢</strong>ï¼šç‚¹å‡»"æŸ¥è¯¢"æŒ‰é’®å¼€å§‹åˆ†æ</div>
              <div>4. ğŸ“Š <strong>é€‰æ‹©æŒ‡æ ‡</strong>ï¼šåœ¨å›¾è¡¨æ˜¾ç¤ºåå¯é€‰æ‹©éœ€è¦å¯¹æ¯”çš„å¥åº·æŒ‡æ ‡</div>
            </div>
          </div>
        </div>
      `;
      
      // éšè—åŠ è½½å’Œæ— æ•°æ®æç¤º
      document.getElementById('loading').style.display = 'none';
      document.getElementById('nodata').style.display = 'none';
    }

    // è·å–éƒ¨é—¨å‘˜å·¥åˆ—è¡¨
    async function loadDepartmentUsers() {
      const userTip = document.getElementById('userTip');
      const userBtn = document.getElementById('userBtn');
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      if (userTip) {
        userTip.innerText = 'æ­£åœ¨åŠ è½½å‘˜å·¥åˆ—è¡¨...';
        userTip.style.color = '#00eaff';
      }
      if (userBtn) {
        userBtn.innerText = 'åŠ è½½ä¸­...';
        userBtn.disabled = true;
      }
      
      try {
        const response = await fetch(`/fetch_users?orgId=${deptId}`);
        const data = await response.json();
        
        // é€‚åº”ç›´æ¥æ•°ç»„æ ¼å¼çš„å“åº”
        if (Array.isArray(data)) {
          departmentUsers = data.filter(user => user.device_sn && user.device_sn !== '-' && user.device_sn !== '');
          console.log(`ğŸ“Š éƒ¨é—¨å‘˜å·¥æ•°é‡: ${departmentUsers.length}`);
          
          // é‡æ–°å¯ç”¨æŒ‰é’®
          if (userBtn) {
            userBtn.disabled = false;
            userBtn.innerText = 'è¯·é€‰æ‹©å‘˜å·¥';
          }
          
          // è®¾ç½®å‘˜å·¥é€‰æ‹©å™¨
          setupUserSelector();
          
          // æ›´æ–°åˆå§‹é¡µé¢çš„å‘˜å·¥æ•°é‡æç¤º
          updateInitialStateUserCount();
          
          console.log(`âœ… å‘˜å·¥åˆ—è¡¨åŠ è½½å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©åæŸ¥è¯¢æ•°æ®`);
        } else if (data.success && data.data) {
          // å…¼å®¹åŒ…è£…æ ¼å¼
          departmentUsers = data.data.filter(user => user.device_sn && user.device_sn !== '-' && user.device_sn !== '');
          console.log(`ğŸ“Š éƒ¨é—¨å‘˜å·¥æ•°é‡: ${departmentUsers.length}`);
          
          // é‡æ–°å¯ç”¨æŒ‰é’®
          if (userBtn) {
            userBtn.disabled = false;
            userBtn.innerText = 'è¯·é€‰æ‹©å‘˜å·¥';
          }
          
          // è®¾ç½®å‘˜å·¥é€‰æ‹©å™¨
          setupUserSelector();
          
          // æ›´æ–°åˆå§‹é¡µé¢çš„å‘˜å·¥æ•°é‡æç¤º
          updateInitialStateUserCount();
          
          console.log(`âœ… å‘˜å·¥åˆ—è¡¨åŠ è½½å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©åæŸ¥è¯¢æ•°æ®`);
        } else {
          throw new Error('å‘˜å·¥åˆ—è¡¨æ ¼å¼é”™è¯¯æˆ–ä¸ºç©º');
        }
      } catch (error) {
        console.error('è·å–éƒ¨é—¨å‘˜å·¥å¤±è´¥:', error);
        // åœ¨å‘˜å·¥é€‰æ‹©å™¨ä¸­æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        const userTip = document.getElementById('userTip');
        const userBtn = document.getElementById('userBtn');
        if (userTip && userBtn) {
          userTip.innerText = 'å‘˜å·¥åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
          userTip.style.color = '#ff6b6b';
          userBtn.innerText = 'åŠ è½½å¤±è´¥';
          userBtn.disabled = true;
          userBtn.style.opacity = '0.6';
        }
        
        // åŒæ—¶åœ¨ä¸»åŒºåŸŸæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        const container = document.querySelector('.chart-container');
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #232946; border-radius: 8px; margin: 20px;">
            <div style="font-size: 48px; color: #ff6b6b; margin-bottom: 20px;">âš ï¸</div>
            <h2 style="color: #fff; margin-bottom: 16px;">åŠ è½½å¤±è´¥</h2>
            <p style="color: #b0c4de; font-size: 16px;">è·å–éƒ¨é—¨å‘˜å·¥åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #00eaff; color: #232946; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">åˆ·æ–°é¡µé¢</button>
          </div>
        `;
      }
    }

    // æ›´æ–°åˆå§‹çŠ¶æ€çš„å‘˜å·¥æ•°é‡æ˜¾ç¤º
    function updateInitialStateUserCount() {
      const container = document.querySelector('.chart-container');
      if (container && departmentUsers.length > 0) {
        // åœ¨ä½¿ç”¨æç¤ºä¸­æ·»åŠ å‘˜å·¥æ•°é‡ä¿¡æ¯
        const tipSection = container.querySelector('div[style*="border: 1px dashed"]');
        if (tipSection) {
          const userCountInfo = document.createElement('div');
          userCountInfo.style = 'margin-top: 15px; padding: 12px; background: #2a2f4a; border-radius: 6px; border-left: 3px solid #00eaff;';
          userCountInfo.innerHTML = `
            <div style="color: #00eaff; font-weight: bold; font-size: 14px;">ğŸ‘¥ å½“å‰éƒ¨é—¨å…±æœ‰ ${departmentUsers.length} åå‘˜å·¥</div>
            <div style="color: #b0c4de; font-size: 12px; margin-top: 4px;">é€‰æ‹©ç‰¹å®šå‘˜å·¥å¯æŸ¥çœ‹ä¸ªäººä¸éƒ¨é—¨å¯¹æ¯”æ•°æ®</div>
          `;
          tipSection.appendChild(userCountInfo);
        }
      }
    }

    // è®¾ç½®å‘˜å·¥é€‰æ‹©å™¨
    function setupUserSelector() {
      const userSelector = document.getElementById('userSelector');
      const userBtn = document.getElementById('userBtn');
      const userList = document.getElementById('userList');
      const userTip = document.getElementById('userTip');

      // å‘˜å·¥é€‰æ‹©å™¨å·²ç»åœ¨HTMLä¸­è®¾ä¸ºæ˜¾ç¤ºï¼Œæ— éœ€é‡å¤è®¾ç½®
      
      // æ ¹æ®å‘˜å·¥æ•°é‡è°ƒæ•´æç¤ºä¿¡æ¯
      if (departmentUsers.length <= 3) {
        userTip.innerText = `éƒ¨é—¨å…±${departmentUsers.length}äººï¼Œè¯·é€‰æ‹©å‘˜å·¥è¿›è¡Œåˆ†æ`;
        userTip.style.color = '#00eaff';
      } else {
        userTip.innerText = `éƒ¨é—¨å…±${departmentUsers.length}äººï¼Œè¯·é€‰æ‹©ç‰¹å®šå‘˜å·¥è¿›è¡Œå¯¹æ¯”åˆ†æ`;
        userTip.style.color = '#ff6b6b';
      }
      
      // æ·»åŠ æœç´¢æ¡†
      const searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.className = 'user-search';
      searchInput.placeholder = 'æœç´¢å‘˜å·¥å§“åæˆ–è®¾å¤‡å·...';
      
      // ç”Ÿæˆå‘˜å·¥åˆ—è¡¨
      function renderUserList(filterText = '') {
        let html = '';
        const filteredUsers = departmentUsers.filter(user => 
          !filterText || 
          user.user_name.toLowerCase().includes(filterText.toLowerCase()) ||
          user.real_name?.toLowerCase().includes(filterText.toLowerCase()) ||
          user.device_sn.toLowerCase().includes(filterText.toLowerCase())
        );
        
        html += '<div style="padding:8px; border-bottom:1px solid #444; background:#1a1e35;">';
        html += '<input type="text" class="user-search" placeholder="ğŸ” æœç´¢å‘˜å·¥å§“åæˆ–è®¾å¤‡å·..." />';
        html += '</div>';
        
        if (filteredUsers.length === 0) {
          html += '<div style="padding:12px; text-align:center; color:#888;">æš‚æ— åŒ¹é…çš„å‘˜å·¥</div>';
        } else {
          filteredUsers.forEach(user => {
            const isSelected = user.id == selectedUserId ? 'checked' : '';
            const displayName = user.real_name || user.user_name;
            html += `<label title="${displayName} (${user.device_sn})">
              <input type="radio" name="userSelect" value="${user.id}" data-name="${displayName}" ${isSelected}/>
              <span style="font-weight:bold;">${displayName}</span>
              <span style="color:#888; font-size:12px; margin-left:4px;">(${user.device_sn})</span>
            </label>`;
          });
        }
        
        userList.innerHTML = html;
        
        // é‡æ–°ç»‘å®šæœç´¢æ¡†äº‹ä»¶
        const newSearchInput = userList.querySelector('.user-search');
        if (newSearchInput) {
          newSearchInput.value = filterText;
          newSearchInput.oninput = (e) => {
            renderUserList(e.target.value.trim());
          };
          newSearchInput.onclick = (e) => e.stopPropagation();
        }
      }
      
      renderUserList();

      // è®¾ç½®æŒ‰é’®æ–‡æœ¬
      const currentUser = departmentUsers.find(u => u.id == selectedUserId);
      if (currentUser) {
        const displayName = currentUser.real_name || currentUser.user_name;
        userBtn.innerText = displayName;
      } else {
        userBtn.innerText = 'è¯·é€‰æ‹©å‘˜å·¥';
      }

      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      userBtn.onclick = () => {
        const isVisible = userList.style.display === 'block';
        userList.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
          // èšç„¦æœç´¢æ¡†
          setTimeout(() => {
            const searchInput = userList.querySelector('.user-search');
            if (searchInput) searchInput.focus();
          }, 100);
        }
      };

      // ç‚¹å‡»å‘˜å·¥é€‰é¡¹äº‹ä»¶
      userList.onclick = (e) => {
        if (e.target.tagName === 'INPUT' && e.target.type === 'radio') {
          selectedUserId = e.target.value;
          const userName = e.target.getAttribute('data-name');
          userBtn.innerText = userName;
          userList.style.display = 'none';
          
          console.log(`ğŸ‘¤ é€‰æ‹©å‘˜å·¥: ${userName} (ID: ${selectedUserId})`);
          
          // æ˜¾ç¤ºæŸ¥è¯¢æç¤ºè€Œä¸æ˜¯è‡ªåŠ¨åŠ è½½æ•°æ®
          showQueryPrompt(userName);
        }
      };

      // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å‘˜å·¥é€‰æ‹©å™¨
      document.body.addEventListener('click', (e) => {
        if (!e.target.closest('#userSelector .metric-dropdown')) {
          userList.style.display = 'none';
        }
      });
    }

    // æ˜¾ç¤ºæŸ¥è¯¢æç¤º
    function showQueryPrompt(userName) {
      const container = document.querySelector('.chart-container');
      container.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #232946; border-radius: 8px; margin: 20px;">
          <div style="font-size: 48px; color: #00eaff; margin-bottom: 20px;">ğŸ‘¤</div>
          <h2 style="color: #fff; margin-bottom: 16px; font-size: 24px;">å·²é€‰æ‹©å‘˜å·¥ï¼š${userName}</h2>
          <p style="color: #b0c4de; font-size: 18px; margin-bottom: 30px; line-height: 1.6;">
            ç‚¹å‡»ä¸Šæ–¹"æŸ¥è¯¢"æŒ‰é’®å¼€å§‹åˆ†æå¥åº·è¶‹åŠ¿æ•°æ®
          </p>
          <div style="background: #1a1e35; padding: 30px; border-radius: 8px; border: 2px solid #00eaff; max-width: 600px; margin: 0 auto;">
            <div style="color: #00eaff; font-weight: bold; font-size: 20px; margin-bottom: 20px;">ğŸ¯ å‡†å¤‡å°±ç»ª</div>
            <div style="color: #b0c4de; font-size: 16px; text-align: left; line-height: 1.8;">
              <div style="margin-bottom: 12px;">âœ… <strong>å‘˜å·¥å·²é€‰æ‹©</strong>ï¼š${userName}</div>
              <div style="margin-bottom: 12px;">âœ… <strong>æ—¶é—´èŒƒå›´</strong>ï¼š${document.getElementById('startDate').value} è‡³ ${document.getElementById('endDate').value}</div>
              <div style="margin-bottom: 12px;">âœ… <strong>åˆ†ææ¨¡å¼</strong>ï¼šä¸ªäººæ•°æ® vs éƒ¨é—¨å¹³å‡å¯¹æ¯”</div>
              <div style="color: #ffd700;">ğŸ” <strong>ä¸‹ä¸€æ­¥</strong>ï¼šç‚¹å‡»ä¸Šæ–¹è“è‰²"æŸ¥è¯¢"æŒ‰é’®å¼€å§‹åˆ†æ</div>
            </div>
          </div>
          <div style="margin-top: 30px;">
            <button onclick="loadTrendData()" style="
              padding: 12px 30px; font-size: 18px; font-weight: bold;
              background: linear-gradient(45deg, #00eaff, #38f9d7);
              color: #232946; border: none; border-radius: 8px; cursor: pointer;
              box-shadow: 0 4px 15px rgba(0, 234, 255, 0.3);
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 234, 255, 0.4)';" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 234, 255, 0.3)';">
              ğŸš€ å¼€å§‹åˆ†æå¥åº·è¶‹åŠ¿
            </button>
          </div>
          <div style="margin-top: 20px; color: #888; font-size: 14px;">
            ğŸ’¡ æ‚¨ä¹Ÿå¯ä»¥å…ˆè°ƒæ•´ä¸Šæ–¹çš„æ—¶é—´èŒƒå›´ï¼Œç„¶åå†ç‚¹å‡»æŸ¥è¯¢
          </div>
        </div>
      `;
    }

    function loadTrendData() {
      loading.style.display='flex';nodata.style.display='none';
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      // ä½¿ç”¨é€‰æ‹©çš„å‘˜å·¥IDï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©åˆ™ä¼ ç©º
      const currentUserId = selectedUserId || '';
      
      console.log(`ğŸ”„ åŠ è½½å¥åº·è¶‹åŠ¿æ•°æ®: userId=${currentUserId}, deptId=${deptId}`);
      
      let url = `/health_data/trends?orgId=${deptId||''}&userId=${currentUserId}&startDate=${startDate}&endDate=${endDate}`;
      fetch(url).then(r=>r.json()).then(initCharts).catch(e=>{loading.style.display='none';console.error('æ•°æ®åŠ è½½å¤±è´¥',e)});
    }

    function initCharts(resp) {
      loading.style.display='none';
      if(!resp||!resp.timestamps||!resp.timestamps.length){
        nodata.style.display='block';
        document.querySelector('.chart-container').innerHTML='';
        return;
      }else{nodata.style.display='none';}
      const ts = resp.timestamps, dept = resp.dept, users = resp.users;
      const metrics = [
        { code:'heart_rate',    name:'å¿ƒç‡(bpm)', color:'#3a6ea5' },
        { code:'blood_oxygen',  name:'è¡€æ°§(%)', color:'#6c757d' },
        { code:'pressure_high', name:'æ”¶ç¼©å‹(mmHg)', color:'#bfa180' },
        { code:'pressure_low',  name:'èˆ’å¼ å‹(mmHg)', color:'#5c8374' },
        { code:'temperature',   name:'ä½“æ¸©(â„ƒ)', color:'#bdbdbd' },
        { code:'stress',        name:'å‹åŠ›æŒ‡æ•°', color:'#e0a96d' },
        { code:'step',          name:'æ­¥æ•°(steps)', color:'#7b8fa1' },
        { code:'distance',      name:'è·ç¦»(m)', color:'#a3a3a3' },
        { code:'calorie',       name:'å¡è·¯é‡Œ(kcal)', color:'#c9b29b' }
      ];
      const userColors = [
        '#3a6ea5','#6c757d','#bfa180','#5c8374','#bdbdbd','#e0a96d','#7b8fa1','#a3a3a3','#c9b29b','#8d6748','#4e5d6c','#b0a990','#7c8c8d'
      ];
      
      const allUsers = Object.keys(users);
      
      // æ£€æŸ¥å‘˜å·¥æ•°é‡å¹¶å†³å®šæ˜¾ç¤ºç­–ç•¥
      let shownUsers;
      let legendHtml = `<span style='color:#00eaff;font-weight:bold;text-shadow:0 2px 8px #0008;'>â–  éƒ¨é—¨å¹³å‡</span>`;
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©çš„å‘˜å·¥
      const currentUser = departmentUsers.find(u => u.id == selectedUserId);
      if (currentUser && (allUsers.includes(currentUser.user_name) || allUsers.includes(currentUser.real_name))) {
        const userName = allUsers.find(name => name === currentUser.user_name || name === currentUser.real_name);
        shownUsers = [userName];
        legendHtml += ` <span style='color:${userColors[0]};font-weight:bold;text-shadow:0 2px 8px #0008;'>â—</span> ${userName}`;
      } else {
        shownUsers = [];
        legendHtml += ` <span style='color:#888;font-style:italic;'>è¯·é€‰æ‹©å‘˜å·¥æŸ¥çœ‹ä¸ªäººæ•°æ®</span>`;
      }
      
      document.getElementById('legendBar').innerHTML = legendHtml;

      const metricBtn = document.getElementById('metricBtn');
      const metricList = document.getElementById('metricList');
      let selectedMetrics = ['heart_rate']; // é»˜è®¤åªæ˜¾ç¤ºå¿ƒç‡

      function renderMetricList() {
        let html = `<label class="all"><input type="checkbox" id="allMetric" ${selectedMetrics.length===metrics.length?'checked':''}/>å…¨é€‰</label>`;
        metrics.forEach(m=>{
          html += `<label><input type="checkbox" value="${m.code}" ${selectedMetrics.includes(m.code)?'checked':''}/> ${m.name}</label>`;
        });
        metricList.innerHTML = html;
      }
      renderMetricList();

      metricBtn.onclick = ()=>{metricList.style.display=metricList.style.display==='block'?'none':'block';};
      document.body.onclick = e=>{
        if(!e.target.closest('.metric-dropdown')) metricList.style.display='none';
      };
      metricList.onclick = e=>{
        if(e.target.tagName==='INPUT'){
          if(e.target.id==='allMetric'){
            selectedMetrics = e.target.checked ? metrics.map(m=>m.code) : [];
            renderMetricList();
          }else{
            const v = e.target.value;
            if(e.target.checked) selectedMetrics.push(v);
            else selectedMetrics = selectedMetrics.filter(x=>x!==v);
            document.getElementById('allMetric').checked = selectedMetrics.length===metrics.length;
          }
          metricBtn.innerText = selectedMetrics.length===metrics.length?'å…¨éƒ¨ä½“å¾':selectedMetrics.length===1?metrics.find(m=>m.code===selectedMetrics[0]).name:metrics.filter(m=>selectedMetrics.includes(m.code)).map(m=>m.name).join('ã€')||'è¯·é€‰æ‹©';
          renderCharts();
          setTimeout(() => { metricList.style.display = 'none'; }, 200);
        }
      };
      // ç¡®ä¿é¦–æ¬¡åŠ è½½è‡ªåŠ¨æ¸²æŸ“
      renderCharts();

      // ä½“å¾é€‰æ‹©å™¨ç¾åŒ–ï¼Œæ”¯æŒæœç´¢
      let searchInput=document.createElement('input');
      searchInput.type='text';searchInput.placeholder='æœç´¢ä½“å¾...';searchInput.style='width:120px;margin:0 8px 8px 8px;padding:2px 8px;border-radius:4px;border:1px solid #444;background:#232946;color:#fff;';
      metricList.prepend(searchInput);
      searchInput.oninput=()=>{
        let v=searchInput.value.trim();
        Array.from(metricList.querySelectorAll('label')).forEach(l=>{
          if(l.className==='all')return;
          l.style.display=l.innerText.includes(v)?'block':'none';
        });
      };

      function renderCharts() {
        const container = document.querySelector('.chart-container');
        container.innerHTML = '';
        let n = selectedMetrics.length, cols = n==1?1:n<=3?2:n<=6?3:3;
        container.style.gridTemplateColumns = `repeat(${cols},1fr)`;
        selectedMetrics.forEach(code=>{
          const m = metrics.find(x=>x.code===code);
          const div = document.createElement('div');
          div.className = 'chart';
          div.id = 'chart-'+code;
          div.style.height = n==1 ? '500px' : '300px';
          // å¯¼å‡º/å…¨å±æŒ‰é’®
          let btnBar=document.createElement('div');
          btnBar.style='position:absolute;right:12px;top:8px;z-index:2;';
          let btnExport=document.createElement('button');
          btnExport.innerText='å¯¼å‡º';btnExport.style='margin-right:8px;padding:2px 10px;border-radius:4px;border:none;background:#00eaff;color:#232946;cursor:pointer;font-weight:bold;';
          let btnFull=document.createElement('button');
          btnFull.innerText='å…¨å±';btnFull.style='padding:2px 10px;border-radius:4px;border:none;background:#00eaff;color:#232946;cursor:pointer;font-weight:bold;';
          btnExport.onclick=()=>{
            let chart=echarts.getInstanceByDom(div)||echarts.init(div);
            let url=chart.getDataURL({type:'png',backgroundColor:'#232946'});
            let a=document.createElement('a');a.href=url;a.download=m.name+'.png';a.click();
          };
          btnFull.onclick=()=>{
            if(div.requestFullscreen)div.requestFullscreen();
            setTimeout(()=>{let chart=echarts.getInstanceByDom(div)||echarts.init(div);chart.resize();},300);
          };
          btnBar.appendChild(btnExport);btnBar.appendChild(btnFull);
          div.style.position='relative';div.appendChild(btnBar);
          container.appendChild(div);
        });
        drawCharts(selectedMetrics);
      }

      function drawCharts(selectedMetrics) {
        selectedMetrics.forEach(code=>{
          const m = metrics.find(x=>x.code===code);
          const dom = document.getElementById('chart-'+code);
          const chart = echarts.init(dom);
          const series = [{
            name:'éƒ¨é—¨å¹³å‡',type:'line',smooth:true,data:dept[m.code],
            lineStyle:{width:4,color:m.color,shadowColor:m.color,shadowBlur:16},
            itemStyle:{opacity:1},sampling:'lttb',z:10
          }];
          allUsers.forEach((u,i)=>{
            const data = ts.map(t=>users[u][t]&&users[u][t][m.code]!=null?users[u][t][m.code]:null);
            series.push({
              name:u,type:'line',smooth:true,data,
              showSymbol:false,
              lineStyle:{
                width:2,
                color:userColors[i%userColors.length],
                opacity:shownUsers.includes(u)?0.85:0.18,
                shadowColor:userColors[i%userColors.length],
                shadowBlur:shownUsers.includes(u)?8:0
              },
              itemStyle:{opacity:shownUsers.includes(u)?0.85:0.18},
              sampling:'lttb',emphasis:{focus:'series'}
            });
          });
          const legendSelected = { 'éƒ¨é—¨å¹³å‡': true };
          allUsers.forEach((u,i)=>{ legendSelected[u] = shownUsers.includes(u); });
          chart.setOption({
            color: [m.color,...userColors],
            backgroundColor:'#232946',
            title:{
              text:m.name,
              textStyle:{
                color:'#fff',
                fontWeight:'bold',
                fontSize:22,
                textShadowColor:'#000a',
                textShadowBlur:8,
                textShadowOffsetY:2
              },
              left:'center'
            },
            tooltip:{trigger:'axis',axisPointer:{type:'cross'},backgroundColor:'#232946cc',borderColor:'#00eaff',textStyle:{color:'#fff'}},
            legend:{
              show:false,
              textStyle:{
                color:'#b0c4de',
                fontWeight:'bold',
                fontSize:18,
                textShadowColor:'#000a',
                textShadowBlur:6
              }
            },
            grid:{left:40,right:20,bottom:40,top:60},
            xAxis:{type:'category',data:ts,axisLabel:{color:'#b0c4de',rotate:45,fontSize:11}},
            yAxis:{type:'value',name:m.name,nameTextStyle:{color:'#b0c4de'},axisLabel:{color:'#b0c4de'}},
            dataZoom:[{
              type:'slider',
              start:80,
              end:100,
              backgroundColor:'#1a1e35',
              fillerColor:'#00eaff66',
              borderColor:'#00eaff',
              dataBackground: {
                lineStyle: { color: '#00eaff88', width: 2 },
                areaStyle: { color: '#00eaff22' }
              },
              selectedDataBackground: {
                lineStyle: { color: '#ffffff', width: 2 },
                areaStyle: { color: '#00eaff44' }
              },
              handleStyle: {
                color: '#00eaff',
                borderColor: '#ffffff',
                borderWidth: 2
              },
              textStyle: { color: '#ffffff' }
            }],
            series
          });
        });
      }
    }
  </script>
</body>
</html>