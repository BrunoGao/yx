<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ¶ˆæ¯ä¸­å¿ƒ</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.4.2/tinycolor.min.js"></script>
    <!-- æ·»åŠ  Element UI çš„ä¾èµ– -->
    <link rel="stylesheet" href="{{ url_for('static', filename='element-ui/theme-chalk/index.css') }}">
    <script src="{{ url_for('static', filename='js/vue.min.js') }}"></script>
    <script src="{{ url_for('static', filename='element-ui/index.js') }}"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* æ¶ˆæ¯è¡¨æ ¼å®¹å™¨æ ·å¼ */
        .message-table-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            max-height: 400px;
            overflow: hidden; /* æ”¹ä¸ºhiddenï¼Œè®©å†…éƒ¨è¡¨æ ¼å®¹å™¨å¤„ç†æ»šåŠ¨ */
            margin-bottom: 20px;
            position: relative;
        }

        .message-table-container h2 {
            color: #00e4ff;
            font-size: 20px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        /* æ·»åŠ å†…éƒ¨æ»šåŠ¨å®¹å™¨ */
        #messageTable {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 8px;
        }

        /* è¡¨æ ¼åŸºç¡€æ ·å¼ */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            position: relative;
        }

        /* è¡¨å¤´æ ·å¼ */
        th {
            background: linear-gradient(180deg, rgba(0, 228, 255, 0.15) 0%, rgba(0, 228, 255, 0.05) 100%);
            color: #00e4ff;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(0, 228, 255, 0.2);
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        th:first-child { border-top-left-radius: 8px; }
        th:last-child { border-top-right-radius: 8px; }

        /* è¡¨æ ¼å†…å®¹æ ·å¼ */
        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.1);
            transition: all 0.3s ease;
            max-width: 300px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* æ¶ˆæ¯å†…å®¹å•å…ƒæ ¼ç‰¹æ®Šå¤„ç† */
        td:nth-child(4) {
            max-width: 400px;
            white-space: normal;
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* æ¡å¸¦æ•ˆæœ */
        tr:nth-child(even) {
            background: rgba(0, 228, 255, 0.03);
        }

        /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
        tr:hover td {
            background: rgba(0, 228, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 228, 255, 0.1);
        }

        /* æ¶ˆæ¯ç±»å‹å’ŒçŠ¶æ€æ ‡ç­¾ */
        .message-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .message-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .type-announcement {
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.2) 0%, rgba(33, 150, 243, 0.4) 100%);
            color: #2196f3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .type-job {
            background: linear-gradient(45deg, rgba(156, 39, 176, 0.2) 0%, rgba(156, 39, 176, 0.4) 100%);
            color: #9c27b0;
            border: 1px solid rgba(156, 39, 176, 0.3);
        }

        .type-notification {
            background: linear-gradient(45deg, rgba(250, 140, 22, 0.2) 0%, rgba(250, 140, 22, 0.4) 100%);
            color: #fa8c16;
            border: 1px solid rgba(250, 140, 22, 0.3);
        }

        .type-task {
            background: linear-gradient(45deg, rgba(255, 140, 0, 0.2) 0%, rgba(255, 140, 0, 0.4) 100%);
            color: #ff8c00;
            border: 1px solid rgba(255, 140, 0, 0.3);
        }

        .type-warning {
            background: linear-gradient(45deg, rgba(245, 34, 45, 0.2) 0%, rgba(245, 34, 45, 0.4) 100%);
            color: #f5222d;
            border: 1px solid rgba(245, 34, 45, 0.3);
        }

        /* æ¶ˆæ¯çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-unread {
            background: linear-gradient(45deg, rgba(245, 34, 45, 0.2) 0%, rgba(245, 34, 45, 0.4) 100%);
            color: #f5222d;
            border: 1px solid rgba(245, 34, 45, 0.3);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-read {
            background: linear-gradient(45deg, rgba(82, 196, 26, 0.2) 0%, rgba(82, 196, 26, 0.4) 100%);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.3);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        /* å›¾è¡¨ç½‘æ ¼å®¹å™¨ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            height: 300px;
        }

        /* æ—¶é—´åˆ†å¸ƒå›¾æ¨ªè·¨ä¸¤åˆ—çš„å®¹å™¨æ ·å¼ */
        .chart-container[style*="grid-column: span 2"] {
            margin-top: 20px;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        #messageTable::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #messageTable::-webkit-scrollbar-track {
            background: rgba(0, 228, 255, 0.1);
            border-radius: 4px;
        }

        #messageTable::-webkit-scrollbar-thumb {
            background: rgba(0, 228, 255, 0.2);
            border-radius: 4px;
        }

        #messageTable::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 228, 255, 0.3);
        }

        /* ç§»é™¤åŸæ¥çš„æ»šåŠ¨æ¡æ ·å¼ */
        .message-table-container::-webkit-scrollbar {
            display: none;
        }

        /* å‘é€æ¶ˆæ¯é¢æ¿æ ·å¼ */
        .send-message-panel {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .send-message-panel h3 {
            color: #00e4ff;
            font-size: 20px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        /* å¯æŠ˜å é¢æ¿æ ·å¼ */
        .collapsible-panel {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .panel-header {
            padding: 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 228, 255, 0.05);
            transition: background 0.3s ease;
        }

        .panel-header:hover {
            background: rgba(0, 228, 255, 0.1);
        }

        .panel-header h3 {
            color: #00e4ff;
            font-size: 20px;
            margin: 0;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        .panel-toggle {
            color: #00e4ff;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .panel-toggle.expanded {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .panel-content.expanded {
            max-height: 1000px; /* è¶³å¤Ÿå¤§çš„å€¼ä»¥å®¹çº³å†…å®¹ */
            padding: 20px;
        }

        /* Element UI æ ·å¼è¦†ç›– */
        .el-tree {
            background: transparent;
            color: #fff;
        }

        .el-tree-node__content {
            background: transparent !important;
        }

        .el-tree-node__content:hover {
            background-color: rgba(0, 228, 255, 0.1) !important;
        }

        .el-tree-node.is-current > .el-tree-node__content {
            background-color: rgba(0, 228, 255, 0.2) !important;
        }

        .el-select {
            width: 100%;
        }

        .el-select-dropdown {
            background: rgba(1, 19, 38, 0.9);
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .el-select-dropdown__item {
            color: #fff;
        }

        .el-select-dropdown__item.hover {
            background: rgba(0, 228, 255, 0.1);
        }

        .el-input__inner {
            background: rgba(0, 228, 255, 0.1);
            border: 1px solid rgba(0, 228, 255, 0.3);
            color: #fff;
        }

        .el-textarea__inner {
            background: rgba(0, 228, 255, 0.1);
            border: 1px solid rgba(0, 228, 255, 0.3);
            color: #fff;
        }

        /* ä¿®æ”¹è¡¨å•ç»„ä»¶çš„åŸºç¡€æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .form-group label {
            display: block;
            color: #00e4ff;
            margin-bottom: 8px;
            font-size: 14px;
        }

        /* ä¿®æ”¹ä¸‹æ‹‰é€‰æ‹©æ¡†æ ·å¼ */
        .filter-select {
            width: 100%;
            padding: 10px;
            background: rgba(1, 19, 38, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }

        .filter-select option {
            padding: 8px;
            background: rgba(1, 19, 38, 0.9);
            color: #fff;
        }

        .filter-select[multiple] {
            height: 150px;
            overflow-y: auto;
        }

        /* ä¿®æ”¹æ–‡æœ¬æ¡†æ ·å¼ */
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            background: rgba(1, 19, 38, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            resize: vertical;
            font-family: Arial, sans-serif;
        }

        textarea:focus {
            outline: none;
            border-color: #00e4ff;
            box-shadow: 0 0 5px rgba(0, 228, 255, 0.5);
        }

        /* å‘é€æ¶ˆæ¯é¢æ¿æ ·å¼ä¼˜åŒ– */
        .send-message-panel {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        /* ç”¨æˆ·é€‰æ‹©æ¡†ç‰¹å®šæ ·å¼ */
        #userSelectGroup {
            margin-top: 15px;
        }

        #userSelect {
            width: 100%;
            min-height: 150px;
            background: rgba(1, 19, 38, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            padding: 5px;
        }

        #userSelect option {
            padding: 8px;
            margin: 2px 0;
            border-radius: 4px;
        }

        #userSelect option:hover,
        #userSelect option:checked {
            background: rgba(0, 228, 255, 0.2);
            color: #00e4ff;
        }

        /* æç¤ºæ–‡æœ¬æ ·å¼ */
        .select-hint {
            font-size: 12px;
            color: rgba(0, 228, 255, 0.7);
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .dept-color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }

        .send-btn {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        /* æ·»åŠ æ–°çš„æ ·å¼ */
        .dept-select-container,
        .user-select-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            padding: 10px;
            background: rgba(0, 228, 255, 0.1);
        }

        .dept-option,
        .user-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .dept-option:hover,
        .user-option:hover {
            background: rgba(0, 228, 255, 0.2);
        }

        .dept-option input[type="checkbox"],
        .user-option input[type="checkbox"] {
            margin-right: 8px;
        }

        .dept-option label,
        .user-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #fff;
        }

        .dept-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 228, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #52c41a;
            box-shadow: 0 0 6px rgba(82, 196, 26, 0.8);
            animation: pulse 2s infinite;
        }

        .status-dot.paused {
            background: #fa8c16;
            box-shadow: 0 0 6px rgba(250, 140, 22, 0.8);
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .status-text {
            color: #7ecfff;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .control-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
            min-width: 90px;
            justify-content: center;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
        }

        .control-btn.primary:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        .control-btn.secondary {
            background: linear-gradient(45deg, rgba(250, 140, 22, 0.8), rgba(255, 187, 0, 0.8));
            color: #fff;
        }

        .control-btn.secondary:hover {
            background: linear-gradient(45deg, rgba(255, 187, 0, 0.9), rgba(250, 140, 22, 0.9));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(250, 140, 22, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            font-size: 14px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- è¿‡æ»¤å™¨é¢æ¿ -->
        <div class="collapsible-panel">
            <div class="panel-header" onclick="togglePanel('filterPanel')">
                <h3>ğŸ“‹ æ¶ˆæ¯ç­›é€‰</h3>
                <span class="panel-toggle" id="filterPanelToggle">â–¼</span>
            </div>
            <div class="panel-content" id="filterPanelContent">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>æ¶ˆæ¯ç±»å‹ï¼š</label>
                        <select id="messageTypeFilter" class="filter-select">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option value="announcement">å…¬å‘Š</option>
                            <option value="notification">é€šçŸ¥</option>
                            <option value="job">ä½œä¸šæŒ‡å¯¼</option>
                            <option value="task">ä»»åŠ¡ç®¡ç†</option>
                            <option value="warning">å‘Šè­¦</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>æ¶ˆæ¯çŠ¶æ€ï¼š</label>
                        <select id="messageStatusFilter" class="filter-select">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="1">æœªè¯»</option>
                            <option value="2">å·²è¯»</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>éƒ¨é—¨ç­›é€‰ï¼š</label>
                        <select id="departmentFilter" class="filter-select">
                            <option value="">å…¨éƒ¨éƒ¨é—¨</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 0; min-width: 120px; display: flex; align-items: end;">
                        <button id="resetFilter" class="send-btn" style="width: 100%; margin: 0;">é‡ç½®ç­›é€‰</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‘é€æ¶ˆæ¯é¢æ¿ -->
        <div class="collapsible-panel">
            <div class="panel-header" onclick="togglePanel('sendMessagePanel')">
                <h3>ğŸ“¨ å‘é€æ¶ˆæ¯</h3>
                <span class="panel-toggle" id="sendMessagePanelToggle">â–¼</span>
            </div>
            <div class="panel-content" id="sendMessagePanelContent">
                <form id="sendMessageForm">
                    <div class="form-group">
                        <label>é€‰æ‹©éƒ¨é—¨ï¼š</label>
                        <select id="deptSelect" class="filter-select">
                            <option value="">é€‰æ‹©éƒ¨é—¨</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="userSelectGroup" style="display: none;">
                        <label>é€‰æ‹©å‘˜å·¥ï¼š</label>
                        <select id="userSelect" class="filter-select" multiple>
                        </select>
                        <div class="select-hint">æŒ‰ä½ Ctrl/Command é”®å¯å¤šé€‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ¶ˆæ¯ç±»å‹</label>
                        <select id="messageType" class="filter-select">
                            <option value="announcement">å…¬å‘Š</option>
                            <option value="notification">é€šçŸ¥</option>
                            <option value="job">å·¥ä½œæŒ‡å¼•</option>
                            <option value="task">ä»»åŠ¡ç®¡ç†</option>
                            <option value="warning">å‘Šè­¦</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>æ¶ˆæ¯å†…å®¹ï¼š</label>
                        <textarea id="messageContent" required placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹..."></textarea>
                    </div>
                    
                    <button type="submit" class="send-btn">å‘é€æ¶ˆæ¯</button>
                </form>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="refreshStatus" class="status-text">å®æ—¶ç›‘æ§ä¸­</span>
            </div>
            <div class="button-group">
                <button id="refreshBtn" class="control-btn primary" onclick="manualRefresh()">
                    <span class="btn-icon">ğŸ”„</span>
                    <span>æ‰‹åŠ¨åˆ·æ–°</span>
                </button>
                <button id="toggleAutoRefresh" class="control-btn secondary" onclick="toggleAutoRefresh()">
                    <span class="btn-icon" id="autoRefreshIcon">â¸ï¸</span>
                    <span id="autoRefreshText">æš‚åœè‡ªåŠ¨</span>
                </button>
            </div>
        </div>

        <!-- æ¶ˆæ¯è¡¨æ ¼ -->
        <div class="message-table-container">
            <h2>æ¶ˆæ¯åˆ—è¡¨ <span id="filterStatus" style="font-size: 14px; color: #00e4ff; opacity: 0.8;"></span></h2>
            <div id="messageTable"></div>
        </div>

        <!-- ç»Ÿè®¡å›¾è¡¨ -->
        <div class="charts-grid">
            <!-- ç¬¬ä¸€è¡Œ -->
            <div class="chart-container">
                <div id="messageTypeChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="departmentMessageChart" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- ç¬¬äºŒè¡Œ -->
            <div class="chart-container">
                <div id="messageDistributionChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="messageStatusChart" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- æ—¶é—´åˆ†å¸ƒå›¾ï¼ˆè·¨è¶Šæ‰€æœ‰åˆ—ï¼‰ -->
            <div class="chart-container" style="grid-column: span 2;">
                <div id="messageTimeChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <script>
        const messageTypeColors = {
            'announcement': '#1890ff',  // è“è‰² - å…¬å‘Š
            'notification': '#52c41a',  // ç»¿è‰² - é€šçŸ¥
            'job': '#722ed1',          // ç´«è‰² - ä½œä¸šæŒ‡å¯¼
            'task': '#fa8c16',         // æ©™è‰² - ä»»åŠ¡ç®¡ç†
            'warning': '#f5222d'       // çº¢è‰² - å‘Šè­¦
        };

        const typeMap = {
            'announcement': 'å…¬å‘Š',
            'job': 'å·¥ä½œæŒ‡å¼•',
            'notification': 'é€šçŸ¥',
            'task': 'ä»»åŠ¡ç®¡ç†',
            'warning': 'å‘Šè­¦'
        };
        const statusMap = {
            '1': 'æœªè¯»',
            '2': 'å·²è¯»'
        };
        

        const chartInstances = new Map();

        // å…¨å±€å˜é‡å­˜å‚¨åŸå§‹æ•°æ®
        let originalMessageData = null;
        let currentFilteredData = null;
        
        // ç¼“å­˜ä¼ é€’è¿‡æ¥çš„æ¶ˆæ¯æ•°æ®
        let cachedMessageInfo = null;
        
        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshTimer = null;
        let isAutoRefreshEnabled = true;
        const REFRESH_INTERVAL = 15000; // 15ç§’
        
        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ•°æ®
        window.addEventListener('message', function(event) {
            if (event.data.type === 'messageInfo') {
                cachedMessageInfo = event.data.data;
                console.log('æ¥æ”¶åˆ°ä¼ é€’çš„æ¶ˆæ¯æ•°æ®:', cachedMessageInfo);
                // å¦‚æœå›¾è¡¨å·²åˆå§‹åŒ–ï¼Œç›´æ¥æ›´æ–°æ•°æ®
                if (chartInstances.size > 0) {
                    updateDashboardWithCachedData();
                }
            }
        });
        
        // ä½¿ç”¨ç¼“å­˜æ•°æ®æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboardWithCachedData() {
            if (!cachedMessageInfo) return;
            
            // å°†ç¼“å­˜çš„æ•°æ®è½¬æ¢ä¸ºæ¶ˆæ¯æ•°æ®æ ¼å¼
            const data = {
                messages: cachedMessageInfo.messages || [],
                totalMessages: cachedMessageInfo.totalMessages || 0,
                publicMessagesCount: cachedMessageInfo.publicMessagesCount || 0,
                personalMessagesCount: cachedMessageInfo.personalMessagesCount || 0,
                messageTypeCount: cachedMessageInfo.messageTypeCount || {},
                messageStatusCount: cachedMessageInfo.messageStatusCount || {},
                departmentMessageCount: cachedMessageInfo.departmentMessageCount || {}
            };
            
            // ä¿å­˜åŸå§‹æ•°æ®
            originalMessageData = data;
            currentFilteredData = data;
            
            // åˆå§‹åŒ–éƒ¨é—¨è¿‡æ»¤å™¨
            const departments = data.messages.map(msg => msg.department_name);
            initDepartmentFilter(departments);
            
            // åˆå§‹åŒ–è¿‡æ»¤çŠ¶æ€æ˜¾ç¤º
            updateFilterStatus('', '', '', data.messages.length, data.messages.length);
            
            // æ˜¾ç¤ºæ•°æ®
            displayMessageTable(data.messages);
            updateMessageTypeChart(data.messageTypeCount);
            updateDepartmentMessageChart(data.departmentMessageCount);
            updateMessageDistributionChart(data);
            updateMessageStatusChart(data.messageStatusCount);
            updateMessageTimeChart(data.messages);
        }

        // é¢æ¿åˆ‡æ¢åŠŸèƒ½
        function togglePanel(panelId) {
            const content = document.getElementById(panelId + 'Content');
            const toggle = document.getElementById(panelId + 'Toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = 'â–¼';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = 'â–²';
            }
        }

        // å…¨å±€æš´éœ²å‡½æ•°ä¾›HTMLè°ƒç”¨
        window.togglePanel = togglePanel;

        // è¿‡æ»¤å‡½æ•°
        function filterMessages(messages, typeFilter, statusFilter, deptFilter) {
            return messages.filter(msg => {
                const typeMatch = !typeFilter || msg.message_type === typeFilter;
                const statusMatch = !statusFilter || msg.message_status === statusFilter;
                const deptMatch = !deptFilter || msg.department_name.includes(deptFilter);
                return typeMatch && statusMatch && deptMatch;
            });
        }

        // åº”ç”¨è¿‡æ»¤å™¨
        function applyFilters() {
            if (!originalMessageData) return;

            const typeFilter = document.getElementById('messageTypeFilter').value;
            const statusFilter = document.getElementById('messageStatusFilter').value;
            const deptFilter = document.getElementById('departmentFilter').value;

            const filteredMessages = filterMessages(originalMessageData.messages, typeFilter, statusFilter, deptFilter);
            
            // æ›´æ–°è¿‡æ»¤çŠ¶æ€æ˜¾ç¤º
            updateFilterStatus(typeFilter, statusFilter, deptFilter, filteredMessages.length, originalMessageData.messages.length);
            
            // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
            const filteredData = {
                ...originalMessageData,
                messages: filteredMessages,
                totalMessages: filteredMessages.length,
                publicMessagesCount: filteredMessages.filter(msg => msg.is_public).length,
                personalMessagesCount: filteredMessages.filter(msg => !msg.is_public).length
            };

            // é‡æ–°è®¡ç®—å„ç§ç»Ÿè®¡
            const messageTypeCount = {};
            const messageStatusCount = {};
            const departmentMessageCount = {};
            
            filteredMessages.forEach(msg => {
                messageTypeCount[msg.message_type] = (messageTypeCount[msg.message_type] || 0) + 1;
                messageStatusCount[msg.message_status] = (messageStatusCount[msg.message_status] || 0) + 1;
                departmentMessageCount[msg.department_name] = (departmentMessageCount[msg.department_name] || 0) + 1;
            });

            filteredData.messageTypeCount = messageTypeCount;
            filteredData.messageStatusCount = messageStatusCount;
            filteredData.departmentMessageCount = departmentMessageCount;

            currentFilteredData = filteredData;
            updateDisplayWithFilteredData(filteredData);
        }

        // æ›´æ–°è¿‡æ»¤çŠ¶æ€æ˜¾ç¤º
        function updateFilterStatus(typeFilter, statusFilter, deptFilter, filteredCount, totalCount) {
            const statusElement = document.getElementById('filterStatus');
            let statusText = '';
            
            if (typeFilter || statusFilter || deptFilter) {
                const filters = [];
                if (typeFilter) filters.push(`ç±»å‹:${typeMap[typeFilter]}`);
                if (statusFilter) filters.push(`çŠ¶æ€:${statusMap[statusFilter]}`);
                if (deptFilter) filters.push(`éƒ¨é—¨:${deptFilter}`);
                
                statusText = `(å·²ç­›é€‰: ${filters.join(', ')} | æ˜¾ç¤º ${filteredCount}/${totalCount} æ¡)`;
            } else {
                statusText = `(å…± ${totalCount} æ¡æ¶ˆæ¯)`;
            }
            
            statusElement.textContent = statusText;
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplayWithFilteredData(data) {
            displayMessageTable(data.messages);
            updateMessageTypeChart(data.messageTypeCount);
            updateDepartmentMessageChart(data.departmentMessageCount);
            updateMessageDistributionChart(data);
            updateMessageStatusChart(data.messageStatusCount);
            updateMessageTimeChart(data.messages);
        }

        // é‡ç½®è¿‡æ»¤å™¨
        function resetFilters() {
            document.getElementById('messageTypeFilter').value = '';
            document.getElementById('messageStatusFilter').value = '';
            document.getElementById('departmentFilter').value = '';
            
            if (originalMessageData) {
                currentFilteredData = originalMessageData;
                updateFilterStatus('', '', '', originalMessageData.messages.length, originalMessageData.messages.length);
                updateDisplayWithFilteredData(originalMessageData);
            }
        }

        // åˆå§‹åŒ–éƒ¨é—¨è¿‡æ»¤å™¨é€‰é¡¹
        function initDepartmentFilter(departments) {
            const deptFilter = document.getElementById('departmentFilter');
            deptFilter.innerHTML = '<option value="">å…¨éƒ¨éƒ¨é—¨</option>';
            
            const uniqueDepts = [...new Set(departments)];
            uniqueDepts.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });
        }

        async function fetchMessageInfo() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                const deptId = urlParams.get('deptId') || '';
                const userId = urlParams.get('userId') || '';
                
                console.log('fetchMessageInfo - URLå‚æ•°:', { customerId, deptId, userId });
                console.log('fetchMessageInfo - å®Œæ•´URL:', window.location.href);

                // æ„å»ºURLï¼Œä½¿ç”¨ deptId ä½œä¸º orgIdï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ customerId
                const orgId = deptId || customerId;
                let url = `/get_messages_by_orgIdAndUserId?orgId=${orgId}`;
                if (userId && userId !== 'all') url += `&userId=${userId}`;
                
                console.log('fetchMessageInfo - è¯·æ±‚URL:', url);

                const response = await fetch(url);
                console.log('fetchMessageInfo - å“åº”çŠ¶æ€:', response.status);
                
                const result = await response.json();
                console.log('fetchMessageInfo - å“åº”æ•°æ®:', result);
                
                if (result.success) {
                    console.log('fetchMessageInfo - è·å–åˆ°æ¶ˆæ¯æ•°é‡:', result.data ? result.data.length : 0);
                    return result.data;
                }
                throw new Error(`Failed to fetch message data: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
            } catch (error) {
                console.error('Error fetching message data:', error);
                return null;
            }
        }

        function displayMessageTable(messages) {
            const container = document.getElementById('messageTable');
            
            // æŒ‰å‘é€æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°æ¶ˆæ¯åœ¨å‰ï¼‰
            const sortedMessages = [...messages].sort((a, b) => {
                const timeA = new Date(a.sent_time || 0);
                const timeB = new Date(b.sent_time || 0);
                return timeB - timeA; // å€’åºæ’åˆ—
            });
            
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>æ¶ˆæ¯ID</th>
                            <th>æ¶ˆæ¯ç±»å‹</th>
                            <th>éƒ¨é—¨</th>
                            <th>å†…å®¹</th>
                            <th>å‘é€æ—¶é—´</th>
                            <th>æ¥æ”¶æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedMessages.map(msg => `
                            <tr>
                                <td>${msg.message_id}</td>
                                <td>
                                    <span class="message-badge type-${msg.message_type}">
                                        ${typeMap[msg.message_type]}
                                    </span>
                                </td>
                                <td>${msg.department_name}</td>
                                <td>${msg.message}</td>
                                <td>${msg.sent_time}</td>
                                <td>${msg.received_time || '-'}</td>
                                <td>
                                    <span class="status-${msg.message_status === '1' ? 'unread' : 'read'}">
                                        ${statusMap[msg.message_status]}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHTML;
        }

        function updateMessageTypeChart(data) {
            const chart = chartInstances.get('messageTypeChart');
           
            
            chart.setOption({
                title: {
                    text: 'æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}æ¡ ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {c}æ¡'
                    },
                    data: Object.entries(data).map(([key, value]) => ({
                        name: typeMap[key],
                        value: value,
                        itemStyle: {
                            color: messageTypeColors[key] || '#9c27b0'
                        }
                    }))
                }]
            });
        }

        function updateDepartmentMessageChart(data) {
            const chart = chartInstances.get('departmentMessageChart');
            const departments = Object.entries(data);

            chart.setOption({
                title: {
                    text: 'éƒ¨é—¨æ¶ˆæ¯åˆ†å¸ƒ',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: departments.map(d => d[0]),
                    axisLabel: {
                        color: '#fff',
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' }
                },
                series: [{
                    type: 'bar',
                    data: departments.map(d => ({
                        value: d[1],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#83bff6' },
                                { offset: 0.5, color: '#188df0' },
                                { offset: 1, color: '#188df0' }
                            ])
                        }
                    })),
                    label: {
                        show: true,
                        position: 'top',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateMessageDistributionChart(data) {
            const chart = chartInstances.get('messageDistributionChart');
            
            chart.setOption({
                title: {
                    text: 'æ¶ˆæ¯åˆ†å¸ƒç»Ÿè®¡',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}æ¡ ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {c}æ¡'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '20',
                            fontWeight: 'bold'
                        }
                    },
                    data: [
                        {
                            name: 'å…¬å¼€æ¶ˆæ¯',
                            value: data.publicMessagesCount,
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: '#2196f3' },
                                    { offset: 1, color: '#83bff6' }
                                ])
                            }
                        },
                        {
                            name: 'ä¸ªäººæ¶ˆæ¯',
                            value: data.personalMessagesCount,
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: '#9c27b0' },
                                    { offset: 1, color: '#ba68c8' }
                                ])
                            }
                        }
                    ]
                }]
            });
        }

        function updateMessageStatusChart(data) {
            const chart = chartInstances.get('messageStatusChart');
            const statusData = Object.entries(data).map(([status, count]) => ({
                name: status === '1' ? 'å·²è¯»' : 'æœªè¯»',
                value: count
            }));

            chart.setOption({
                title: {
                    text: 'æ¶ˆæ¯çŠ¶æ€ç»Ÿè®¡',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}æ¡ ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    itemStyle: {
                        borderRadius: 10
                    },
                    label: {
                        show: true,
                        color: '#fff'
                    },
                    data: statusData
                }]
            });
        }

        function updateMessageTimeChart(messages) {
            const chart = chartInstances.get('messageTimeChart');
            
            // æŒ‰å°æ—¶ç»Ÿè®¡å‘é€å’Œæ¥æ”¶æ—¶é—´
            const timeData = messages.reduce((acc, msg) => {
                const sentHour = new Date(msg.sent_time).getHours();
                const receivedHour = new Date(msg.received_time).getHours();
                
                acc.sent[sentHour] = (acc.sent[sentHour] || 0) + 1;
                acc.received[receivedHour] = (acc.received[receivedHour] || 0) + 1;
                
                return acc;
            }, { sent: {}, received: {} });

            // å‡†å¤‡24å°æ—¶çš„æ•°æ®
            const hours = Array.from({length: 24}, (_, i) => i);
            const sentData = hours.map(hour => timeData.sent[hour] || 0);
            const receivedData = hours.map(hour => timeData.received[hour] || 0);

            chart.setOption({
                title: {
                    text: 'æ¶ˆæ¯æ—¶é—´åˆ†å¸ƒ',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['å‘é€æ—¶é—´', 'æ¥æ”¶æ—¶é—´'],
                    textStyle: { color: '#fff' },
                    top: 25
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours.map(h => `${h}:00`),
                    axisLabel: {
                        color: '#fff',
                        interval: 2
                    },
                    axisLine: {
                        lineStyle: { color: 'rgba(0, 228, 255, 0.3)' }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ¶ˆæ¯æ•°é‡',
                    nameTextStyle: { color: '#fff' },
                    axisLabel: { color: '#fff' },
                    splitLine: {
                        lineStyle: { color: 'rgba(0, 228, 255, 0.1)' }
                    }
                },
                series: [
                    {
                        name: 'å‘é€æ—¶é—´',
                        type: 'line',
                        smooth: true,
                        data: sentData,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(33, 150, 243, 0.3)' },
                                { offset: 1, color: 'rgba(33, 150, 243, 0.1)' }
                            ])
                        },
                        lineStyle: {
                            color: '#2196f3',
                            width: 2
                        },
                        itemStyle: {
                            color: '#2196f3'
                        }
                    },
                    {
                        name: 'æ¥æ”¶æ—¶é—´',
                        type: 'line',
                        smooth: true,
                        data: receivedData,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(156, 39, 176, 0.3)' },
                                { offset: 1, color: 'rgba(156, 39, 176, 0.1)' }
                            ])
                        },
                        lineStyle: {
                            color: '#9c27b0',
                            width: 2
                        },
                        itemStyle: {
                            color: '#9c27b0'
                        }
                    }
                ]
            });
        }

        async function updateDashboard(forceRefresh = false) {
            // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œè°ƒç”¨æ¥å£è·å–
            if (forceRefresh || !cachedMessageInfo) {
                console.log('ğŸ”„ è°ƒç”¨æ¥å£è·å–æœ€æ–°æ¶ˆæ¯æ•°æ®...');
                const data = await fetchMessageInfo();
                if (data) {
                    // ä¿å­˜åŸå§‹æ•°æ®
                    originalMessageData = data;
                    currentFilteredData = data;
                    
                    // åˆå§‹åŒ–éƒ¨é—¨è¿‡æ»¤å™¨
                    const departments = data.messages.map(msg => msg.department_name);
                    initDepartmentFilter(departments);
                    
                    // åˆå§‹åŒ–è¿‡æ»¤çŠ¶æ€æ˜¾ç¤º
                    updateFilterStatus('', '', '', data.messages.length, data.messages.length);
                    
                    // æ˜¾ç¤ºæ•°æ®
                    displayMessageTable(data.messages);
                    updateMessageTypeChart(data.messageTypeCount);
                    updateDepartmentMessageChart(data.departmentMessageCount);
                    updateMessageDistributionChart(data);
                    updateMessageStatusChart(data.messageStatusCount);
                    updateMessageTimeChart(data.messages);
                }
                return;
            }
            
            // åªæœ‰é¦–æ¬¡åŠ è½½ä¸”æœ‰ç¼“å­˜æ•°æ®æ—¶æ‰ä½¿ç”¨ç¼“å­˜
            console.log('âœ… ä½¿ç”¨ä¼ é€’çš„ç¼“å­˜æ•°æ®ï¼Œé¿å…é‡å¤æ¥å£è°ƒç”¨');
            updateDashboardWithCachedData();
        }

        function initCharts() {
            const chartIds = [
                'messageTypeChart', 'departmentMessageChart',
                'messageDistributionChart', 'messageStatusChart',
                'messageTimeChart'
            ];
            
            chartIds.forEach(id => {
                chartInstances.set(id, echarts.init(document.getElementById(id)));
            });
        }

        async function initDashboard() {
            initCharts();
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œçœ‹æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®ä¼ é€’è¿‡æ¥
            setTimeout(async () => {
                if (cachedMessageInfo) {
                    console.log('âœ… ä½¿ç”¨ä¼ é€’çš„ç¼“å­˜æ•°æ®ï¼Œé¿å…é‡å¤æ¥å£è°ƒç”¨');
                } else {
                    console.log('âŒ æœªæ¥æ”¶åˆ°ç¼“å­˜æ•°æ®ï¼Œå°†è°ƒç”¨æ¥å£è·å–');
                }
                
                await updateDashboard();
                
                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                if (isAutoRefreshEnabled) {
                    startAutoRefresh();
                }
            }, 1000); // ç­‰å¾…1ç§’è®©postMessageæœ‰æ—¶é—´ä¼ é€’æ•°æ®

            window.addEventListener('resize', debounce(() => {
                chartInstances.forEach(chart => chart.resize());
            }, 250));
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // éƒ¨é—¨é¢œè‰²æ–¹æ¡ˆ
        const departmentColors = {
            'ç…¤çŸ¿é›†å›¢æ€»éƒ¨': '#3498db',
            'å®‰å…¨ç®¡ç†éƒ¨': '#e74c3c',
            'ç”Ÿäº§æŠ€æœ¯éƒ¨': '#2ecc71',
            'è´¢åŠ¡éƒ¨': '#f1c40f',
            'äººåŠ›èµ„æºéƒ¨': '#9b59b6',
            'é”€å”®éƒ¨': '#1abc9c'
        };

        // ä¸ºå­éƒ¨é—¨ç”Ÿæˆæ¸å˜è‰²
        function generateSubDepartmentColor(parentColor, index, total) {
            const color = tinycolor(parentColor);
            const hsl = color.toHsl();
            hsl.l = Math.min(0.9, hsl.l + (index / total) * 0.3);
            return tinycolor(hsl).toHexString();
        }

        // è·å–éšæœºé¢œè‰²
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // ä¿®æ”¹åŠ è½½éƒ¨é—¨æ•°æ®çš„å‡½æ•°
        async function loadDepartments() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                const response = await fetch(`/get_departments?orgId=${customerId}`);
                const data = await response.json();
                const deptSelect = document.getElementById('deptSelect');

                deptSelect.innerHTML = '<option value="">é€‰æ‹©éƒ¨é—¨</option>';

                function addDepartmentOptions(departments, level = 0) {
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        const indent = 'ã€€'.repeat(level);
                        option.textContent = indent + dept.name;
                        deptSelect.appendChild(option);

                        if (dept.children && dept.children.length > 0) {
                            addDepartmentOptions(dept.children, level + 1);
                        }
                    });
                }

                if (data.success && data.data) {
                    addDepartmentOptions(data.data);
                }

                // æ·»åŠ éƒ¨é—¨é€‰æ‹©äº‹ä»¶ç›‘å¬
                deptSelect.addEventListener('change', handleDepartmentSelection);
            } catch (error) {
                console.error('åŠ è½½éƒ¨é—¨å¤±è´¥:', error);
            }
        }

        // ä¿®æ”¹åŠ è½½ç”¨æˆ·æ•°æ®çš„å‡½æ•°
        async function loadUsers(deptId) {
            try {
                console.log('Loading users for department:', deptId);
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                const response = await fetch(`/fetch_users?orgId=${deptId}`);
                const data = await response.json();
                console.log('User data received:', data);
                
                const userSelect = document.getElementById('userSelect');
                const userSelectGroup = document.getElementById('userSelectGroup');

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                userSelect.innerHTML = '';
                
                // æ£€æŸ¥ç”¨æˆ·æ•°æ®æ˜¯å¦ä¸ºæ•°ç»„
                const users = Array.isArray(data) ? data : (data.data && data.data.users ? data.data.users : []);
                
                if (users && users.length > 0) {
                    // æ·»åŠ ç”¨æˆ·é€‰é¡¹
                    users.forEach(user => {
                        // æ£€æŸ¥ç”¨æˆ·å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
                        if (user && (user.id || user.user_id)) {
                            const option = document.createElement('option');
                            option.value = user.id || user.user_id;
                            let displayText = user.user_name || user.name || user.username || 'æœªçŸ¥ç”¨æˆ·';
                            // å¦‚æœæœ‰èŒä½ä¿¡æ¯ï¼Œæ·»åŠ åˆ°æ˜¾ç¤ºæ–‡æœ¬ä¸­
                            if (user.position) {
                                displayText += ` (${user.position})`;
                            }
                            option.textContent = displayText;
                            userSelect.appendChild(option);
                        }
                    });
                    
                    // æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©ç»„
                    userSelectGroup.style.display = 'block';
                    console.log('Users loaded successfully:', userSelect.options.length, 'ä¸ªç”¨æˆ·');
                } else {
                    console.log('No users found in data');
                    userSelect.innerHTML = '<option disabled>è¯¥éƒ¨é—¨æš‚æ— ç”¨æˆ·</option>';
                    userSelectGroup.style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option disabled>åŠ è½½ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
                document.getElementById('userSelectGroup').style.display = 'block';
            }
        }

        // ä¿®æ”¹éƒ¨é—¨é€‰æ‹©å¤„ç†å‡½æ•°
        function handleDepartmentSelection(event) {
            const selectedDeptId = event.target.value;
            console.log('Selected department:', selectedDeptId);
            
            if (selectedDeptId) {
                loadUsers(selectedDeptId);
            } else {
                const userSelectGroup = document.getElementById('userSelectGroup');
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '';
                userSelectGroup.style.display = 'none';
            }
        }

        // ä¿®æ”¹å‘é€æ¶ˆæ¯å‡½æ•°
        async function sendMessage(event) {
            event.preventDefault();
            
            const messageContent = document.getElementById('messageContent').value.trim();
            const selectedDeptId = document.getElementById('deptSelect').value;
            const userSelect = document.getElementById('userSelect');
            const selectedUsers = Array.from(userSelect.selectedOptions)
                .filter(option => !option.disabled)
                .map(option => option.value);
            const messageType = document.getElementById('messageType').value;

            if (!messageContent) {
                showCustomAlert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', null);
                return;
            }

            if (!selectedDeptId) {
                showCustomAlert('è¯·é€‰æ‹©æ¥æ”¶éƒ¨é—¨', null);
                return;
            }

            try {
                const sendButton = event.target.querySelector('button[type="submit"]');
                sendButton.disabled = true;
                sendButton.textContent = 'å‘é€ä¸­...';

                if (selectedUsers.length > 0) {
                    // å‘é€ç”¨æˆ·æ¶ˆæ¯
                    for (const userId of selectedUsers) {
                        await sendMessageToServer({
                            message: messageContent,
                            message_type: messageType,
                            sender_type: 'system',
                            receiver_type: 'user',
                            message_status: '1',
                            department_info: selectedDeptId,
                            user_id: userId
                        });
                    }
                } else {
                    // å‘é€éƒ¨é—¨æ¶ˆæ¯
                    console.log('sendMessageToServer.selectedDeptId',selectedDeptId);
                    console.log('sendMessageToServer.messageContent',messageContent);
                    await sendMessageToServer({
                        message: messageContent,
                        message_type: messageType,
                        sender_type: 'system',
                        receiver_type: 'department',
                        message_status: '1',
                        department_info: selectedDeptId
                    });
                }

                showCustomAlert('æ¶ˆæ¯å‘é€æˆåŠŸï¼', 'updateDashboard()');
                document.getElementById('messageContent').value = '';
                document.getElementById('deptSelect').value = '';
                userSelect.innerHTML = '';
                document.getElementById('userSelectGroup').style.display = 'none';
                updateDashboard();
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showCustomAlert(error.message || 'å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', null);
            } finally {
                const sendButton = event.target.querySelector('button[type="submit"]');
                sendButton.disabled = false;
                sendButton.textContent = 'å‘é€æ¶ˆæ¯';
            }
        }

        // æ·»åŠ å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨çš„å‡½æ•°
        async function sendMessageToServer(messageData) {
            try {
           
                const response = await fetch('/DeviceMessage/save_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        ...messageData
                    })
                });

                // æ£€æŸ¥å“åº”çš„Content-Type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ç«¯é…ç½®');
                }

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `æœåŠ¡å™¨è¿”å›é”™è¯¯çŠ¶æ€ç : ${response.status}`);
                }

                if (!result.success) {
                    throw new Error(result.message || 'å‘é€æ¶ˆæ¯å¤±è´¥');
                }

                return result;
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯è¯¦ç»†é”™è¯¯:', error);
                if (error.name === 'SyntaxError') {
                    throw new Error('æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨é…ç½®');
                }
                throw new Error(error.message || 'å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ç¡®ä¿åœ¨æ–‡æ¡£åŠ è½½å®Œæˆåæ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const deptSelect = document.getElementById('deptSelect');
            deptSelect.addEventListener('change', handleDepartmentSelection);
            
            // æ·»åŠ è¿‡æ»¤å™¨äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('messageTypeFilter').addEventListener('change', applyFilters);
            document.getElementById('messageStatusFilter').addEventListener('change', applyFilters);
            document.getElementById('departmentFilter').addEventListener('change', applyFilters);
            document.getElementById('resetFilter').addEventListener('click', resetFilters);
            
            // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
            loadDepartments();
            initDashboard();
            document.getElementById('sendMessageForm').addEventListener('submit', sendMessage);
        });

        // æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
        function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            const btnIcon = btn.querySelector('.btn-icon');
            const btnText = btn.querySelector('span:last-child');
            
            btnText.textContent = 'åˆ·æ–°ä¸­...';
            btnIcon.style.animation = 'spin 1s linear infinite';
            btn.disabled = true;
            
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ¶ˆæ¯æ•°æ®...');
            updateDashboard(true).then(() => {
                btnText.textContent = 'æ‰‹åŠ¨åˆ·æ–°';
                btnIcon.style.animation = '';
                btn.disabled = false;
                console.log('âœ… æ‰‹åŠ¨åˆ·æ–°å®Œæˆ');
            }).catch(error => {
                console.error('âŒ æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error);
                btnText.textContent = 'åˆ·æ–°å¤±è´¥';
                btnIcon.textContent = 'âŒ';
                setTimeout(() => {
                    btnText.textContent = 'æ‰‹åŠ¨åˆ·æ–°';
                    btnIcon.textContent = 'ğŸ”„';
                    btnIcon.style.animation = '';
                    btn.disabled = false;
                }, 2000);
            });
        }
        
        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        function toggleAutoRefresh() {
            const btn = document.getElementById('toggleAutoRefresh');
            const status = document.getElementById('refreshStatus');
            const statusDot = document.getElementById('statusDot');
            const btnIcon = document.getElementById('autoRefreshIcon');
            const btnText = document.getElementById('autoRefreshText');
            
            if (isAutoRefreshEnabled) {
                // å…³é—­è‡ªåŠ¨åˆ·æ–°
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                isAutoRefreshEnabled = false;
                btnIcon.textContent = 'â–¶ï¸';
                btnText.textContent = 'å¯åŠ¨ç›‘æ§';
                status.textContent = 'ç›‘æ§å·²æš‚åœ';
                statusDot.classList.add('paused');
                console.log('âŒ è‡ªåŠ¨åˆ·æ–°å·²å…³é—­');
            } else {
                // å¼€å¯è‡ªåŠ¨åˆ·æ–°
                startAutoRefresh();
                isAutoRefreshEnabled = true;
                btnIcon.textContent = 'â¸ï¸';
                btnText.textContent = 'æš‚åœè‡ªåŠ¨';
                status.textContent = 'å®æ—¶ç›‘æ§ä¸­';
                statusDot.classList.remove('paused');
                console.log('âœ… è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯');
            }
        }
        
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            autoRefreshTimer = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°æ¶ˆæ¯æ•°æ®...');
                    updateDashboard(true).catch(error => {
                        console.error('âŒ è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', error);
                    });
                }
            }, REFRESH_INTERVAL);
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }
        
        // å…¨å±€æš´éœ²åˆ·æ–°ç›¸å…³å‡½æ•°
        window.manualRefresh = manualRefresh;
        window.toggleAutoRefresh = toggleAutoRefresh;

        function showCustomAlert(msg, cb){
            const modal=document.createElement('div');
            modal.style.cssText='position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,21,41,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML=`
                <div style="background:rgba(10,24,48,0.98);border-radius:14px;box-shadow:0 0 24px #00e4ff44;padding:32px 38px;min-width:320px;max-width:420px;color:#fff;position:relative;display:flex;flex-direction:column;align-items:center;">
                    <div style="font-size:18px;font-weight:700;margin-bottom:18px;">${msg}</div>
                    <button style="margin-top:10px;padding:8px 32px;background:#1a3b5d;color:#00e4ff;border:none;border-radius:6px;font-size:16px;cursor:pointer;" onclick="this.parentNode.parentNode.remove();${cb?'('+cb+')':''}">ç¡®å®š</button>
                </div>`;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html> 