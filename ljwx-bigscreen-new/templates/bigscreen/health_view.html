<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>健康数据</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .container {
            display: grid;
            grid-template-columns: 400px 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .department-tree {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            height: 45vh;
        }

        .health-prediction {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            height: 45vh;
        }

        .main-content {
            grid-column: 2;
            grid-row: 1 / span 2;
        }

        .warning-item {
            background: rgba(0, 228, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .warning-high {
            border-left-color: #f44336;
        }

        .warning-medium {
            border-left-color: #ff9800;
        }

        .warning-low {
            border-left-color: #4caf50;
        }

        .warning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .warning-title {
            font-size: 16px;
            color: #00e4ff;
        }

        .warning-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .warning-content {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .prediction-chart {
            height: 200px;
            margin-bottom: 20px;
        }

        .panel-title {
            color: #00e4ff;
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.2);
        }

        /* 健康数据卡片网格 */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .health-card {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            transition: transform 0.3s ease;
        }

        .health-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 228, 255, 0.5);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.2);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 18px;
            color: #00e4ff;
            margin: 0;
        }

        .department {
            font-size: 14px;
            color: rgba(0, 228, 255, 0.7);
            margin-top: 5px;
        }

        .health-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric {
            padding: 10px;
            background: rgba(0, 228, 255, 0.1);
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 16px;
            color: #fff;
            font-weight: bold;
        }

        /* 图表网格 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            height: 300px;
        }

        /* 健康状态指示器 */
        .health-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-normal {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .status-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .status-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        /* 添加模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            width: 90%;
            height: 90%;
            margin: 2% auto;
            background: rgba(1, 19, 38, 0.95);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.2);
        }

        .modal-title {
            font-size: 20px;
            color: #00e4ff;
            margin: 0;
        }

        .close-modal {
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #00e4ff;
        }

        .modal-charts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            height: calc(100% - 60px);
        }

        .modal-chart-container {
            background: rgba(0, 228, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="department-tree">
                <h2 class="panel-title">部门健康评分</h2>
                <div id="departmentTreeChart" style="width: 100%; height: calc(100% - 60px);"></div>
            </div>
            <div class="health-prediction">
                <h2 class="panel-title">健康预警预测</h2>
                <div id="healthPredictionChart" class="prediction-chart"></div>
                <div class="warnings-list">
                    <div class="warning-item warning-high">
                        <div class="warning-header">
                            <span class="warning-title">高风险预警</span>
                            <span class="warning-time">10分钟前</span>
                        </div>
                        <div class="warning-content">安全管理部2组 张三 心率异常，建议及时检查</div>
                    </div>
                    <div class="warning-item warning-medium">
                        <div class="warning-header">
                            <span class="warning-title">中度预警</span>
                            <span class="warning-time">30分钟前</span>
                        </div>
                        <div class="warning-content">技术部1组 整体血压偏高，建议注意休息</div>
                    </div>
                    <div class="warning-item warning-low">
                        <div class="warning-header">
                            <span class="warning-title">健康提醒</span>
                            <span class="warning-time">1小时前</span>
                        </div>
                        <div class="warning-content">运营部 运动量不足，建议适当增加运动</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main-content">
            <!-- 健康数据卡片 -->
            <div class="cards-container" id="healthCards"></div>

            <!-- 统计图表 -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div id="departmentHealthChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="chart-container">
                    <div id="departmentDeviceChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="chart-container">
                    <div id="healthMetricsChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="chart-container">
                    <div id="healthTrendChart" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加模态框 -->
    <div id="healthDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">健康数据详细分析</h2>
                <span class="close-modal" onclick="closeHealthDetail()">&times;</span>
            </div>
            <div class="modal-charts">
                <div class="modal-chart-container">
                    <div id="healthScoreChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="modal-chart-container">
                    <div id="timeSeriesChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="modal-chart-container">
                    <div id="anomalyChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="modal-chart-container">
                    <div id="metricComparisonChart" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chartInstances = new Map();
        const modalChartInstances = new Map();

        async function fetchHealthInfo() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1'; // 如果没有参数，默认使用 '1'
                const deptId = urlParams.get('deptId') || ''; // 获取部门ID
                const userId = urlParams.get('userId') || ''; // 获取用户ID

                // 构建URL，使用 deptId 作为 orgId（如果存在），否则使用 customerId
                const orgId = deptId || customerId;
                let url = `/get_health_data_by_orgIdAndUserId?orgId=${orgId}`;
                if (userId && userId !== 'all') url += `&userId=${userId}`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    return result.data;
                }
                throw new Error('Failed to fetch health data');
            } catch (error) {
                console.error('Error fetching health data:', error);
                return null;
            }
        }

        function getHealthStatus(value, type) {
            switch(type) {
                case 'heartRate':
                    return value < 60 ? 'warning' : value > 100 ? 'danger' : 'normal';
                case 'temperature':
                    return value < 36 ? 'warning' : value > 37.5 ? 'danger' : 'normal';
                case 'bloodOxygen':
                    return value < 95 ? 'danger' : value < 97 ? 'warning' : 'normal';
                case 'calorie':
                    return value < 1800 ? 'warning' : value > 3000 ? 'warning' : 'normal';
                case 'step':
                    return value < 6000 ? 'warning' : value > 15000 ? 'warning' : 'normal';
                case 'distance':
                    return value < 3 ? 'warning' : value > 8 ? 'warning' : 'normal';
                default:
                    return 'normal';
            }
        }

        function displayHealthCards(healthData) {
            const container = document.getElementById('healthCards');
            if (!healthData || !healthData.healthData) {
                console.error('Invalid health data format:', healthData);
                return;
            }
            container.innerHTML = healthData.healthData.map(data => `
                <div class="health-card">
                    <div class="card-header">
                        <div class="user-info">
                            <h3 class="user-name">${data.userName}</h3>
                            <span class="department">${data.deptName}</span>
                        </div>
                        <a href="javascript:void(0)" class="device-link" onclick="showHealthDetail('${data.deviceSn}')">${data.deviceSn}</a>
                    </div>
                    <div class="health-metrics">
                        <div class="metric">
                            <div class="metric-label">心率</div>
                            <div class="metric-value">
                                <span class="health-status status-${getHealthStatus(data.heartRate, 'heartRate')}">
                                    ${data.heartRate} bpm
                                </span>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">体温</div>
                            <div class="metric-value">
                                <span class="health-status status-${getHealthStatus(data.temperature, 'temperature')}">
                                    ${data.temperature}°C
                                </span>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">血氧</div>
                            <div class="metric-value">
                                <span class="health-status status-${getHealthStatus(data.bloodOxygen, 'bloodOxygen')}">
                                    ${data.bloodOxygen}%
                                </span>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">步数</div>
                            <div class="metric-value">
                                <span class="health-status status-${getHealthStatus(data.step, 'step')}">
                                    ${data.step}
                                </span>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">距离</div>
                            <div class="metric-value">
                                <span class="health-status status-${getHealthStatus(data.distance, 'distance')}">
                                    ${data.distance}km
                                </span>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">卡路里</div>
                            <div class="metric-value">
                                <span class="health-status status-${getHealthStatus(parseFloat(data.calorie), 'calorie')}">
                                    ${(parseFloat(data.calorie) || 0).toFixed(2)}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateDepartmentHealthChart(departmentStats) {
            const chart = chartInstances.get('departmentHealthChart');
            const departments = Object.keys(departmentStats);
            
            chart.setOption({
                title: {
                    text: '部门健康指标平均值',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                legend: {
                    data: ['心率', '血氧', '体温', '步数', '距离', '卡路里'],
                    textStyle: { color: '#fff' },
                    top: 25
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: departments,
                    axisLabel: {
                        color: '#fff',
                        rotate: 45
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '心率/血氧/步数',
                        nameTextStyle: { color: '#fff' },
                        axisLabel: { color: '#fff' }
                    },
                    {
                        type: 'value',
                        name: '体温',
                        nameTextStyle: { color: '#fff' },
                        axisLabel: { color: '#fff' }
                    },
                    {
                        type: 'value',
                        name: '距离/卡路里',
                        nameTextStyle: { color: '#fff' },
                        axisLabel: { color: '#fff' }
                    }
                ],
                series: [
                    {
                        name: '心率',
                        type: 'bar',
                        data: departments.map(dept => departmentStats[dept].avgHeartRate),
                        itemStyle: {
                            color: '#ff9800'
                        }
                    },
                    {
                        name: '血氧',
                        type: 'bar',
                        data: departments.map(dept => departmentStats[dept].avgBloodOxygen),
                        itemStyle: {
                            color: '#2196f3'
                        }
                    },
                    {
                        name: '体温',
                        type: 'line',
                        yAxisIndex: 1,
                        data: departments.map(dept => departmentStats[dept].avgTemperature),
                        itemStyle: {
                            color: '#f44336'
                        }
                    },
                    {
                        name: '步数',
                        type: 'bar',
                        data: departments.map(dept => departmentStats[dept].avgStep),
                        itemStyle: {
                            color: '#4caf50'
                        }
                    },
                    {
                        name: '距离',
                        type: 'line',
                        yAxisIndex: 2,
                        data: departments.map(dept => departmentStats[dept].avgDistance),
                        itemStyle: {
                            color: '#9c27b0'
                        }
                    },
                    {
                        name: '卡路里',
                        type: 'line',
                        yAxisIndex: 2,
                        data: departments.map(dept => departmentStats[dept].avgCalorie),
                        itemStyle: {
                            color: '#ff5722'
                        }
                    }
                ]
            });
        }

        function updateDepartmentDeviceChart(departmentStats) {
            const chart = chartInstances.get('departmentDeviceChart');
            const deviceData = Object.entries(departmentStats).map(([dept, stats]) => ({
                name: dept,
                value: stats.deviceCount
            }));

            chart.setOption({
                title: {
                    text: '部门设备分布',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}台 ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        color: '#fff',
                        formatter: '{b}: {c}台'
                    },
                    data: deviceData
                }]
            });
        }

        async function updateDashboard() {
            const data = await fetchHealthInfo();
            if (data) {
                displayHealthCards(data);
                updateDepartmentHealthChart(data.departmentStats);
                updateDepartmentDeviceChart(data.departmentStats);
            }
        }

        function initCharts() {
            const chartIds = [
                'departmentHealthChart', 'departmentDeviceChart',
                'healthMetricsChart', 'healthTrendChart'
            ];
            
            chartIds.forEach(id => {
                chartInstances.set(id, echarts.init(document.getElementById(id)));
            });
        }

        function initModalCharts() {
            const chartIds = [
                'healthScoreChart', 'timeSeriesChart',
                'anomalyChart', 'metricComparisonChart'
            ];
            
            chartIds.forEach(id => {
                modalChartInstances.set(id, echarts.init(document.getElementById(id)));
            });
        }

        async function initDashboard() {
            console.log('Initializing dashboard...');
            initCharts();
            initModalCharts();
            await updateDashboard();
            setInterval(updateDashboard, 30000);

            window.addEventListener('resize', debounce(() => {
                chartInstances.forEach(chart => chart.resize());
                modalChartInstances.forEach(chart => chart.resize());
            }, 250));
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', initDashboard);

        function updateHealthScoreChart(data) {
            const chart = modalChartInstances.get('healthScoreChart');
            chart.setOption({
                title: {
                    text: '健康评分',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'gauge',
                    progress: {
                        show: true,
                        width: 18
                    },
                    axisLine: {
                        lineStyle: {
                            width: 18
                        }
                    },
                    axisTick: {
                        show: false
                    },
                    splitLine: {
                        length: 15,
                        lineStyle: {
                            width: 2,
                            color: '#999'
                        }
                    },
                    pointer: {
                        show: false
                    },
                    anchor: {
                        show: true,
                        showAbove: true,
                        size: 25,
                        itemStyle: {
                            borderWidth: 10
                        }
                    },
                    title: {
                        show: false
                    },
                    detail: {
                        valueAnimation: true,
                        fontSize: '30px',
                        offsetCenter: [0, '70%']
                    },
                    data: [{
                        value: data.healthScore,
                        name: '健康评分'
                    }]
                }]
            });
        }

        function updateTimeSeriesChart(data) {
            const chart = modalChartInstances.get('timeSeriesChart');
            chart.setOption({
                title: {
                    text: '时间序列趋势',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['心率', '血氧', '体温'],
                    textStyle: { color: '#fff' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.timeSeriesData.map(item => item.timestamp),
                    axisLabel: { color: '#fff' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' }
                },
                series: [
                    {
                        name: '心率',
                        type: 'line',
                        data: data.timeSeriesData.map(item => item.heartRate),
                        itemStyle: { color: '#ff9800' }
                    },
                    {
                        name: '血氧',
                        type: 'line',
                        data: data.timeSeriesData.map(item => item.bloodOxygen),
                        itemStyle: { color: '#2196f3' }
                    },
                    {
                        name: '体温',
                        type: 'line',
                        data: data.timeSeriesData.map(item => item.temperature),
                        itemStyle: { color: '#f44336' }
                    }
                ]
            });
        }

        function updateAnomalyChart(data) {
            const chart = modalChartInstances.get('anomalyChart');
            chart.setOption({
                title: {
                    text: '异常检测',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'item'
                },
                xAxis: {
                    type: 'category',
                    data: data.timeSeriesData.map(item => item.timestamp),
                    axisLabel: { color: '#fff' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' }
                },
                series: [{
                    type: 'scatter',
                    data: data.timeSeriesData
                        .filter(item => item.anomalies.length > 0)
                        .map(item => ({
                            value: [item.timestamp, item.heartRate],
                            itemStyle: { color: '#f44336' }
                        }))
                }]
            });
        }

        function updateMetricComparisonChart(data) {
            const chart = modalChartInstances.get('metricComparisonChart');
            chart.setOption({
                title: {
                    text: '指标对比',
                    textStyle: { color: '#fff' }
                },
                radar: {
                    indicator: [
                        { name: '心率', max: 100 },
                        { name: '血氧', max: 100 },
                        { name: '体温', max: 40 },
                        { name: '步数', max: 15000 },
                        { name: '距离', max: 10 },
                        { name: '卡路里', max: 3000 }
                    ],
                    axisLabel: { color: '#fff' }
                },
                series: [{
                    type: 'radar',
                    data: [{
                        value: [
                            data.healthScores.heartRate,
                            data.healthScores.bloodOxygen,
                            data.healthScores.temperature,
                            data.healthScores.step,
                            data.healthScores.distance,
                            data.healthScores.calorie
                        ],
                        name: '当前值'
                    }]
                }]
            });
        }

        async function showHealthDetail(deviceSn) {
            console.log('Showing health detail for device:', deviceSn);
            try {
                const response = await fetch(`./get_health_data_by_deviceSn?deviceSn=${deviceSn}`);
                console.log('Response received:', response);
                const result = await response.json();
                console.log('Data received:', result);
                
                if (result.success) {
                    const data = result.data;
                    console.log('Updating charts with data:', data);
                    
                    // 确保所有图表实例都已初始化
                    if (!modalChartInstances.size) {
                        initModalCharts();
                    }
                    
                    // 更新图表
                    updateHealthScoreChart(data);
                    updateTimeSeriesChart(data);
                    updateAnomalyChart(data);
                    updateMetricComparisonChart(data);
                    
                    // 显示模态框
                    const modal = document.getElementById('healthDetailModal');
                    modal.style.display = 'block';
                    console.log('Modal displayed');
                } else {
                    console.error('Failed to fetch health data:', result.message);
                }
            } catch (error) {
                console.error('Error in showHealthDetail:', error);
            }
        }

        function closeHealthDetail() {
            const modal = document.getElementById('healthDetailModal');
            modal.style.display = 'none';
            console.log('Modal closed');
        }

        // 添加点击模态框外部关闭功能
        window.onclick = function(event) {
            const modal = document.getElementById('healthDetailModal');
            if (event.target === modal) {
                closeHealthDetail();
            }
        }
    </script>
</body>
</html>