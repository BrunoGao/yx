<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å‘Šè­¦ä¸­å¿ƒ</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* å‘Šè­¦è¡¨æ ¼æ ·å¼ */
        .alert-table-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            overflow: hidden;
            position: relative;
        }

        /* è¡¨æ ¼æ ‡é¢˜æ ·å¼ */
        .alert-table-container h2 {
            color: #00e4ff;
            font-size: 20px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        /* æ·»åŠ å†…éƒ¨æ»šåŠ¨å®¹å™¨ */
        #alertTable {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 8px;
        }

        /* è¡¨æ ¼åŸºç¡€æ ·å¼ */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            font-size: 14px;
            position: relative;
        }

        /* è¡¨å¤´æ ·å¼ */
        th {
            background: linear-gradient(180deg, rgba(0, 228, 255, 0.15) 0%, rgba(0, 228, 255, 0.05) 100%);
            color: #00e4ff;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(0, 228, 255, 0.2);
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        th:first-child {
            border-top-left-radius: 8px;
        }

        th:last-child {
            border-top-right-radius: 8px;
        }

        /* è¡¨æ ¼å†…å®¹æ ·å¼ */
        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.1);
            transition: all 0.3s ease;
        }

        /* æ¡å¸¦æ•ˆæœ */
        tr:nth-child(even) {
            background: rgba(0, 228, 255, 0.03);
        }

        /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
        tr:hover td {
            background: rgba(0, 228, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 228, 255, 0.1);
        }

        /* å•å…ƒæ ¼å†…å®¹æ ·å¼ */
        td:first-child {
            font-weight: 600;
            color: #00e4ff;
        }

        /* çŠ¶æ€å’Œçº§åˆ«æ ‡ç­¾æ ·å¼ä¼˜åŒ– */
        .status-badge, .level-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .status-badge:hover, .level-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .status-pending {
            background: linear-gradient(45deg, rgba(255, 152, 0, 0.2) 0%, rgba(255, 152, 0, 0.4) 100%);
            color: #ff9800;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .status-responded {
            background: linear-gradient(45deg, rgba(76, 175, 80, 0.2) 0%, rgba(76, 175, 80, 0.4) 100%);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .level-critical {
            background: linear-gradient(45deg, rgba(244, 67, 54, 0.2) 0%, rgba(244, 67, 54, 0.4) 100%);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .level-medium {
            background: linear-gradient(45deg, rgba(255, 152, 0, 0.2) 0%, rgba(255, 152, 0, 0.4) 100%);
            color: #ff9800;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        #alertTable::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #alertTable::-webkit-scrollbar-track {
            background: rgba(0, 228, 255, 0.1);
            border-radius: 4px;
        }

        #alertTable::-webkit-scrollbar-thumb {
            background: rgba(0, 228, 255, 0.2);
            border-radius: 4px;
        }

        #alertTable::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 228, 255, 0.3);
        }

        /* ç§»é™¤åŸæ¥çš„æ»šåŠ¨æ¡æ ·å¼ */
        .alert-table-container::-webkit-scrollbar {
            display: none;
        }

        /* å›¾è¡¨ç½‘æ ¼å®¹å™¨ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            height: 300px;
        }

        /* æ·»åŠ æŒ‰é’®æ ·å¼ */
        .action-button {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            border: none;
            background: linear-gradient(45deg, rgba(0, 228, 255, 0.2) 0%, rgba(0, 228, 255, 0.4) 100%);
            color: #00e4ff;
            border: 1px solid rgba(0, 228, 255, 0.3);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, rgba(0, 228, 255, 0.3) 0%, rgba(0, 228, 255, 0.5) 100%);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* å¯æŠ˜å é¢æ¿æ ·å¼ */
        .collapsible-panel {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .panel-header {
            padding: 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 228, 255, 0.05);
            transition: background 0.3s ease;
        }

        .panel-header:hover {
            background: rgba(0, 228, 255, 0.1);
        }

        .panel-header h3 {
            color: #00e4ff;
            font-size: 20px;
            margin: 0;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        .panel-toggle {
            color: #00e4ff;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .panel-toggle.expanded {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .panel-content.expanded {
            max-height: 1000px;
            padding: 20px;
        }

        /* è¿‡æ»¤å™¨æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .form-group label {
            display: block;
            color: #00e4ff;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select {
            width: 100%;
            padding: 10px;
            background: rgba(1, 19, 38, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }

        .filter-select option {
            padding: 8px;
            background: rgba(1, 19, 38, 0.9);
            color: #fff;
        }

        .send-btn {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        /* å¤šé€‰å¤é€‰æ¡†æ ·å¼ */
        .alert-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #00e4ff;
            cursor: pointer;
        }

        /* æ‰¹å¤„ç†æŒ‰é’®æ ·å¼ */
        .batch-actions {
            display: none;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 228, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 228, 255, 0.3);
        }

        .batch-actions.show {
            display: block;
        }

        .batch-btn {
            background: linear-gradient(45deg, #f44336, #ff6b6b);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .batch-btn:hover {
            background: linear-gradient(45deg, #d32f2f, #f44336);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 228, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #52c41a;
            box-shadow: 0 0 6px rgba(82, 196, 26, 0.8);
            animation: pulse 2s infinite;
        }

        .status-dot.paused {
            background: #fa8c16;
            box-shadow: 0 0 6px rgba(250, 140, 22, 0.8);
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .status-text {
            color: #7ecfff;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .control-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
            min-width: 90px;
            justify-content: center;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
        }

        .control-btn.primary:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        .control-btn.secondary {
            background: linear-gradient(45deg, rgba(250, 140, 22, 0.8), rgba(255, 187, 0, 0.8));
            color: #fff;
        }

        .control-btn.secondary:hover {
            background: linear-gradient(45deg, rgba(255, 187, 0, 0.9), rgba(250, 140, 22, 0.9));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(250, 140, 22, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            font-size: 14px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¿‡æ»¤å™¨é¢æ¿ -->
        <div class="collapsible-panel">
            <div class="panel-header" onclick="togglePanel('alertFilterPanel')">
                <h3>ğŸ” å‘Šè­¦ç­›é€‰</h3>
                <span class="panel-toggle" id="alertFilterPanelToggle">â–¼</span>
            </div>
            <div class="panel-content" id="alertFilterPanelContent">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>å‘Šè­¦ç±»å‹ï¼š</label>
                        <select id="alertTypeFilter" class="filter-select">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>å‘Šè­¦çŠ¶æ€ï¼š</label>
                        <select id="alertStatusFilter" class="filter-select">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">å¾…å¤„ç†</option>
                            <option value="responded">å·²å“åº”</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>ä¸¥é‡çº§åˆ«ï¼š</label>
                        <select id="severityLevelFilter" class="filter-select">
                            <option value="">å…¨éƒ¨çº§åˆ«</option>
                            <option value="critical">ä¸¥é‡</option>
                            <option value="medium">ä¸­ç­‰</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 0; min-width: 120px; display: flex; align-items: end;">
                        <button id="resetAlertFilter" class="send-btn" style="width: 100%; margin: 0;">é‡ç½®ç­›é€‰</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="refreshStatus" class="status-text">å®æ—¶ç›‘æ§ä¸­</span>
            </div>
            <div class="button-group">
                <button id="refreshBtn" class="control-btn primary" onclick="manualRefresh()">
                    <span class="btn-icon">ğŸ”„</span>
                    <span>æ‰‹åŠ¨åˆ·æ–°</span>
                </button>
                <button id="toggleAutoRefresh" class="control-btn secondary" onclick="toggleAutoRefresh()">
                    <span class="btn-icon" id="autoRefreshIcon">â¸ï¸</span>
                    <span id="autoRefreshText">æš‚åœè‡ªåŠ¨</span>
                </button>
            </div>
        </div>

        <!-- å‘Šè­¦è¡¨æ ¼ -->
        <div class="alert-table-container">
            <h2>å‘Šè­¦åˆ—è¡¨ <span id="alertFilterStatus" style="font-size: 14px; color: #00e4ff; opacity: 0.8;"></span></h2>
            
            <!-- æ‰¹å¤„ç†æ“ä½œ -->
            <div class="batch-actions" id="batchActions">
                <span style="color: #00e4ff; margin-right: 15px;">å·²é€‰æ‹© <span id="selectedCount">0</span> æ¡å‘Šè­¦</span>
                <button id="batchProcessBtn" class="batch-btn">æ‰¹é‡å¤„ç†</button>
                <button id="selectAllBtn" class="send-btn" style="padding: 6px 12px; font-size: 12px;">å…¨é€‰</button>
                <button id="clearSelectionBtn" class="send-btn" style="padding: 6px 12px; font-size: 12px;">æ¸…ç©º</button>
            </div>
            
            <div id="alertTable"></div>
        </div>

        <!-- ç»Ÿè®¡å›¾è¡¨ -->
        <div class="charts-grid">
            <div class="chart-container">
                <div id="alertLevelChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="alertStatusChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="alertTypeChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="deviceAlertChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="departmentStatsChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container" style="grid-column: span 3;">
                <div id="alertTimeChart" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- å¤„ç†æ—¶é•¿åˆ†æå›¾ï¼ˆè·¨è¶Šæ‰€æœ‰åˆ—ï¼‰ -->
            <div class="chart-container" style="grid-column: span 3;">
                <div id="processingTimeChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <script>
        const chartInstances = new Map();
        
        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshTimer = null;
        let isAutoRefreshEnabled = true;
        const REFRESH_INTERVAL = 10000; // 10ç§’ï¼Œå‘Šè­¦æ›´ç´§æ€¥
        
        // å‘Šè­¦ç±»å‹ç¿»è¯‘æ˜ å°„
        const alertTypeMap = {
            'blood_oxygen': 'è¡€æ°§å¼‚å¸¸',
            'stress': 'å‹åŠ›å¼‚å¸¸', 
            'blood_pressure': 'è¡€å‹å¼‚å¸¸',
            'heart_rate': 'å¿ƒç‡å¼‚å¸¸',
            'temperature': 'æ¸©åº¦å¼‚å¸¸',
            'sleep': 'ç¡çœ å¼‚å¸¸',
            'SOS': 'SOSå‘Šè­¦',
            'one_key_alarm': 'ä¸€é”®å‘Šè­¦',
            'ONE_KEY_ALARM': 'ä¸€é”®å‘Šè­¦',
            'falldwn': 'è·Œå€’å‘Šè­¦',
            'fall_down': 'è·Œå€’å‘Šè­¦',
            'FALL_DOWN': 'è·Œå€’å‘Šè­¦'
        };

        // è·å–ç¿»è¯‘åçš„å‘Šè­¦ç±»å‹åç§°
        function getAlertTypeName(type) {
            return alertTypeMap[type] || type;
        }
        
        // å…¨å±€å˜é‡å­˜å‚¨åŸå§‹æ•°æ®å’Œè¿‡æ»¤çŠ¶æ€
        let originalAlertData = null;
        let currentFilteredData = null;
        let selectedAlerts = new Set();
        
        // ç¼“å­˜ä¼ é€’è¿‡æ¥çš„å‘Šè­¦æ•°æ®
        let cachedAlertInfo = null;
        
        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ•°æ®
        window.addEventListener('message', function(event) {
            if (event.data.type === 'alertInfo') {
                cachedAlertInfo = event.data.data;
                console.log('æ¥æ”¶åˆ°ä¼ é€’çš„å‘Šè­¦æ•°æ®:', cachedAlertInfo);
                // å¦‚æœå›¾è¡¨å·²åˆå§‹åŒ–ï¼Œç›´æ¥æ›´æ–°æ•°æ®
                if (chartInstances.size > 0) {
                    updateDashboardWithCachedData();
                }
            }
        });
        
        // ä½¿ç”¨ç¼“å­˜æ•°æ®æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboardWithCachedData() {
            if (!cachedAlertInfo) return;
            
            // å°†ç¼“å­˜çš„æ•°æ®è½¬æ¢ä¸ºå‘Šè­¦æ•°æ®æ ¼å¼
            const data = {
                alerts: cachedAlertInfo.alerts || [],
                alertLevelCount: cachedAlertInfo.alertLevelCount || {},
                alertStatusCount: cachedAlertInfo.alertStatusCount || {},
                alertTypeCount: cachedAlertInfo.alertTypeCount || {},
                deviceAlertCount: cachedAlertInfo.deviceAlertCount || {},
                departmentStats: cachedAlertInfo.departmentStats || {}
            };
            
            // ä¿å­˜åŸå§‹æ•°æ®
            originalAlertData = data;
            currentFilteredData = data;
            
            // åˆå§‹åŒ–å‘Šè­¦ç±»å‹è¿‡æ»¤å™¨
            initAlertTypeFilter(data.alerts);
            
            // åˆå§‹åŒ–è¿‡æ»¤çŠ¶æ€æ˜¾ç¤º
            updateAlertFilterStatus('', '', '', data.alerts.length, data.alerts.length);
            
            // æ˜¾ç¤ºæ•°æ®
            displayAlertTable(data.alerts);
            updateAlertLevelChart(data.alertLevelCount);
            updateAlertStatusChart(data.alertStatusCount);
            updateAlertTypeChart(data.alertTypeCount);
            updateDeviceAlertChart(data.deviceAlertCount);
            updateDepartmentStatsChart(data.departmentStats);
            updateAlertTimeChart(data.alerts);
            updateProcessingTimeChart(data.alerts);
            
            // æ¸…ç©ºé€‰æ‹©çŠ¶æ€
            selectedAlerts.clear();
            updateBatchActions();
        }

        // é¢æ¿åˆ‡æ¢åŠŸèƒ½
        function togglePanel(panelId) {
            const content = document.getElementById(panelId + 'Content');
            const toggle = document.getElementById(panelId + 'Toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = 'â–¼';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = 'â–²';
            }
        }

        // å…¨å±€æš´éœ²å‡½æ•°ä¾›HTMLè°ƒç”¨
        window.togglePanel = togglePanel;

        // è¿‡æ»¤å‡½æ•°
        function filterAlerts(alerts, typeFilter, statusFilter, levelFilter) {
            return alerts.filter(alert => {
                const typeMatch = !typeFilter || alert.alert_type === typeFilter;
                const statusMatch = !statusFilter || alert.alert_status === statusFilter;
                const levelMatch = !levelFilter || alert.severity_level === levelFilter;
                return typeMatch && statusMatch && levelMatch;
            });
        }

        // åº”ç”¨è¿‡æ»¤å™¨
        function applyAlertFilters() {
            if (!originalAlertData) return;

            const typeFilter = document.getElementById('alertTypeFilter').value;
            const statusFilter = document.getElementById('alertStatusFilter').value;
            const levelFilter = document.getElementById('severityLevelFilter').value;

            const filteredAlerts = filterAlerts(originalAlertData.alerts, typeFilter, statusFilter, levelFilter);
            
            // æ›´æ–°è¿‡æ»¤çŠ¶æ€æ˜¾ç¤º
            updateAlertFilterStatus(typeFilter, statusFilter, levelFilter, filteredAlerts.length, originalAlertData.alerts.length);
            
            // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
            const filteredData = {
                ...originalAlertData,
                alerts: filteredAlerts
            };

            // é‡æ–°è®¡ç®—å„ç§ç»Ÿè®¡
            const alertLevelCount = {};
            const alertStatusCount = {};
            const alertTypeCount = {};
            const deviceAlertCount = {};
            
            filteredAlerts.forEach(alert => {
                alertLevelCount[alert.severity_level] = (alertLevelCount[alert.severity_level] || 0) + 1;
                alertStatusCount[alert.alert_status] = (alertStatusCount[alert.alert_status] || 0) + 1;
                alertTypeCount[alert.alert_type] = (alertTypeCount[alert.alert_type] || 0) + 1;
                deviceAlertCount[alert.device_sn] = (deviceAlertCount[alert.device_sn] || 0) + 1;
            });

            filteredData.alertLevelCount = alertLevelCount;
            filteredData.alertStatusCount = alertStatusCount;
            filteredData.alertTypeCount = alertTypeCount;
            filteredData.deviceAlertCount = deviceAlertCount;

            currentFilteredData = filteredData;
            updateDisplayWithFilteredData(filteredData);
            
            // æ¸…ç©ºé€‰æ‹©çŠ¶æ€
            selectedAlerts.clear();
            updateBatchActions();
        }

        // æ›´æ–°è¿‡æ»¤çŠ¶æ€æ˜¾ç¤º
        function updateAlertFilterStatus(typeFilter, statusFilter, levelFilter, filteredCount, totalCount) {
            const statusElement = document.getElementById('alertFilterStatus');
            let statusText = '';
            
            if (typeFilter || statusFilter || levelFilter) {
                const filters = [];
                if (typeFilter) filters.push(`ç±»å‹:${getAlertTypeName(typeFilter)}`);
                if (statusFilter) filters.push(`çŠ¶æ€:${statusFilter === 'pending' ? 'å¾…å¤„ç†' : 'å·²å“åº”'}`);
                if (levelFilter) filters.push(`çº§åˆ«:${levelFilter === 'critical' ? 'ä¸¥é‡' : 'ä¸­ç­‰'}`);
                
                statusText = `(å·²ç­›é€‰: ${filters.join(', ')} | æ˜¾ç¤º ${filteredCount}/${totalCount} æ¡)`;
            } else {
                statusText = `(å…± ${totalCount} æ¡å‘Šè­¦)`;
            }
            
            statusElement.textContent = statusText;
        }

        // é‡ç½®è¿‡æ»¤å™¨
        function resetAlertFilters() {
            document.getElementById('alertTypeFilter').value = '';
            document.getElementById('alertStatusFilter').value = '';
            document.getElementById('severityLevelFilter').value = '';
            
            if (originalAlertData) {
                currentFilteredData = originalAlertData;
                updateAlertFilterStatus('', '', '', originalAlertData.alerts.length, originalAlertData.alerts.length);
                updateDisplayWithFilteredData(originalAlertData);
            }
            
            // æ¸…ç©ºé€‰æ‹©çŠ¶æ€
            selectedAlerts.clear();
            updateBatchActions();
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplayWithFilteredData(data) {
            displayAlertTable(data.alerts);
            updateAlertLevelChart(data.alertLevelCount);
            updateAlertStatusChart(data.alertStatusCount);
            updateAlertTypeChart(data.alertTypeCount);
            updateDeviceAlertChart(data.deviceAlertCount);
            updateDepartmentStatsChart(data.departmentStats);
            updateAlertTimeChart(data.alerts);
            updateProcessingTimeChart(data.alerts);
        }

        // åˆå§‹åŒ–å‘Šè­¦ç±»å‹è¿‡æ»¤å™¨é€‰é¡¹
        function initAlertTypeFilter(alerts) {
            const typeFilter = document.getElementById('alertTypeFilter');
            typeFilter.innerHTML = '<option value="">å…¨éƒ¨ç±»å‹</option>';
            
            const uniqueTypes = [...new Set(alerts.map(alert => alert.alert_type))];
            uniqueTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = getAlertTypeName(type);
                typeFilter.appendChild(option);
            });
        }

        async function fetchAlertInfo() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1'; // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨ '1'
                const deptId = urlParams.get('deptId') || ''; // è·å–éƒ¨é—¨ID
                const userId = urlParams.get('userId') || ''; // è·å–ç”¨æˆ·ID

                // æ„å»ºURLï¼Œä½¿ç”¨ deptId ä½œä¸º orgIdï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ customerId
                const orgId = deptId || customerId;
                let url = `/get_alerts_by_orgIdAndUserId?orgId=${orgId}`;
                if (userId && userId !== 'all') url += `&userId=${userId}`;
        
                // ä½¿ç”¨è·å–åˆ°çš„ customerId ä½œä¸º orgId
                const response = await fetch(url);
                
                const result = await response.json();
                if (result.success) {
                    return result.data;
                }
                throw new Error('Failed to fetch alert data');
            } catch (error) {
                console.error('Error fetching alert data:', error);
                return null;
            }
        }

        function displayAlertTable(alerts) {
            const container = document.getElementById('alertTable');
            
            // æŒ‰å‘Šè­¦æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°å‘Šè­¦åœ¨å‰ï¼‰
            const sortedAlerts = [...alerts].sort((a, b) => {
                const timeA = new Date(a.alert_timestamp || 0);
                const timeB = new Date(b.alert_timestamp || 0);
                return timeB - timeA; // å€’åºæ’åˆ—
            });
            
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" class="alert-checkbox" onchange="toggleAllSelection()">
                            </th>
                            <th>å‘Šè­¦ID</th>
                            <th>å‘Šè­¦ç±»å‹</th>
                            <th>å‘Šè­¦æè¿°</th>
                            <th>éƒ¨é—¨</th>
                            <th>ç”¨æˆ·</th>
                            <th>è®¾å¤‡å·</th>
                            <th>çŠ¶æ€</th>
                            <th>çº§åˆ«</th>
                            <th>æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedAlerts.map(alert => `
                            <tr>
                                <td>
                                    <input type="checkbox" class="alert-checkbox alert-item-checkbox" 
                                           value="${alert.alert_id}" onchange="toggleAlertSelection('${alert.alert_id}')">
                                </td>
                                <td>${alert.alert_id}</td>
                                <td>${getAlertTypeName(alert.alert_type)}</td>
                                <td>${alert.alert_desc}</td>
                                <td>${alert.org_name}</td>
                                <td>${alert.user_name}</td>
                                <td>${alert.device_sn}</td>
                                <td>
                                    <span class="status-badge status-${alert.alert_status}">
                                        ${alert.alert_status === 'pending' ? 'å¾…å¤„ç†' : 'å·²å“åº”'}
                                    </span>
                                </td>
                                <td>
                                    <span class="level-badge level-${alert.severity_level}">
                                        ${alert.severity_level === 'critical' ? 'ä¸¥é‡' : 'ä¸­ç­‰'}
                                    </span>
                                </td>
                                <td>${alert.alert_timestamp}</td>
                                <td>
                                    ${alert.alert_status === 'pending' ? 
                                        `<button class="action-button" onclick="handleAlert('${alert.alert_id}')">ä¸€é”®å¤„ç†</button>` :
                                        '<span style="color: #4caf50;">å·²å¤„ç†</span>'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHTML;
            
            // æ›´æ–°é€‰æ‹©çŠ¶æ€
            updateSelectionDisplay();
        }

        function handleAlert(alertId) {
            console.log('handleAlert',alertId);
            fetch(`./dealAlert?alertId=${alertId}`)
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  console.log('Alert processed:', data);
                  showCustomAlert(data.message,()=>{
                    location.reload();
                  });
                  //updateGeoJSONSources();
                  location.reload(); // Refresh the page
                } else {
                  console.error('ä¸€é”®å¤„ç†å¤±è´¥:', data.message);
                  showCustomAlert('ä¸€é”®å¤„ç†å¤±è´¥.è¯·é‡è¯•.',()=>{
                    location.reload();
                  });
                }
              })
              .catch(error => {
                console.error('ä¸€é”®å¤„ç†å¤±è´¥:', error);
                showCustomAlert('ä¸€é”®å¤„ç†å¤±è´¥.è¯·é‡è¯•.',()=>{
                  location.reload();
                });
              });
          }
          function showCustomAlert(msg, cb){
            const d=document.createElement('div'),b=document.createElement('button');
            d.style='position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;display:flex;align-items:center;justify-content:center;background:rgba(0,21,41,0.7)';
            d.innerHTML=`<div style="background:rgba(10,24,48,0.98);border-radius:12px;box-shadow:0 0 24px #00e4ff44;padding:32px 38px;min-width:320px;max-width:420px;color:#fff;display:flex;flex-direction:column;align-items:center;"><div style="font-size:22px;margin-bottom:28px;">${msg}</div></div>`;
            b.textContent='ç¡®å®š';b.style='margin:10px auto 0 auto;padding:8px 32px;font-size:18px;color:#00e4ff;background:rgba(0,0,0,0.2);border:1.5px solid #00e4ff;border-radius:6px;cursor:pointer;transition:.2s;';
            b.onclick=()=>{d.remove();cb&&cb();};
            d.querySelector('div').appendChild(b);
            document.body.appendChild(d);
          }
        

        function updateAlertLevelChart(data) {
            const chart = chartInstances.get('alertLevelChart');
            const levelMap = {
                'critical': 'ä¸¥é‡',
                'medium': 'ä¸­ç­‰'
            };
            
            chart.setOption({
                title: {
                    text: 'å‘Šè­¦çº§åˆ«åˆ†å¸ƒ',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}æ¡ ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {c}æ¡'
                    },
                    data: Object.entries(data).map(([key, value]) => ({
                        name: levelMap[key],
                        value: value,
                        itemStyle: {
                            color: key === 'critical' ? '#f44336' : '#ff9800'
                        }
                    }))
                }]
            });
        }

        function updateAlertStatusChart(data) {
            const chart = chartInstances.get('alertStatusChart');
            const statusMap = {
                'pending': 'å¾…å¤„ç†',
                'responded': 'å·²å“åº”'
            };

            chart.setOption({
                title: {
                    text: 'å‘Šè­¦çŠ¶æ€åˆ†å¸ƒ',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}æ¡ ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {c}æ¡'
                    },
                    data: Object.entries(data).map(([key, value]) => ({
                        name: statusMap[key],
                        value: value,
                        itemStyle: {
                            color: key === 'pending' ? '#ff9800' : '#4caf50'
                        }
                    }))
                }]
            });
        }

        function updateAlertTypeChart(data) {
            const chart = chartInstances.get('alertTypeChart');
            const types = Object.entries(data).sort((a, b) => b[1] - a[1]);

            chart.setOption({
                title: {
                    text: 'å‘Šè­¦ç±»å‹åˆ†å¸ƒ',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: types.map(t => getAlertTypeName(t[0])),
                    axisLabel: {
                        color: '#fff',
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' }
                },
                series: [{
                    type: 'bar',
                    data: types.map(t => ({
                        value: t[1],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#83bff6' },
                                { offset: 0.5, color: '#188df0' },
                                { offset: 1, color: '#188df0' }
                            ])
                        }
                    })),
                    label: {
                        show: true,
                        position: 'top',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateDeviceAlertChart(data) {
            const chart = chartInstances.get('deviceAlertChart');
            const devices = Object.entries(data);

            chart.setOption({
                title: {
                    text: 'è®¾å¤‡å‘Šè­¦æ•°é‡',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: devices.map(d => d[0]),
                    axisLabel: {
                        color: '#fff',
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' }
                },
                series: [{
                    type: 'bar',
                    data: devices.map(d => ({
                        value: d[1],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#ff9800' },
                                { offset: 1, color: '#f44336' }
                            ])
                        }
                    })),
                    label: {
                        show: true,
                        position: 'top',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateDepartmentStatsChart(data) {
            const chart = chartInstances.get('departmentStatsChart');
            const departments = Object.values(data);

            chart.setOption({
                title: {
                    text: 'éƒ¨é—¨å‘Šè­¦ç»Ÿè®¡',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                legend: {
                    data: ['æ€»å‘Šè­¦', 'ä¸¥é‡å‘Šè­¦', 'ä¸­ç­‰å‘Šè­¦', 'å¾…å¤„ç†', 'å·²å“åº”'],
                    textStyle: { color: '#fff' },
                    top: 25
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: departments.map(d => d.name),
                    axisLabel: { color: '#fff' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' }
                },
                series: [
                    {
                        name: 'æ€»å‘Šè­¦',
                        type: 'bar',
                        stack: 'total',
                        label: { show: true },
                        emphasis: { focus: 'series' },
                        data: departments.map(d => d.total_alerts)
                    },
                    {
                        name: 'ä¸¥é‡å‘Šè­¦',
                        type: 'bar',
                        stack: 'severity',
                        label: { show: true },
                        emphasis: { focus: 'series' },
                        data: departments.map(d => d.severity_stats.critical || 0)
                    },
                    {
                        name: 'ä¸­ç­‰å‘Šè­¦',
                        type: 'bar',
                        stack: 'severity',
                        label: { show: true },
                        emphasis: { focus: 'series' },
                        data: departments.map(d => d.severity_stats.medium || 0)
                    },
                    {
                        name: 'å¾…å¤„ç†',
                        type: 'bar',
                        stack: 'status',
                        label: { show: true },
                        emphasis: { focus: 'series' },
                        data: departments.map(d => d.status_stats.pending || 0)
                    },
                    {
                        name: 'å·²å“åº”',
                        type: 'bar',
                        stack: 'status',
                        label: { show: true },
                        emphasis: { focus: 'series' },
                        data: departments.map(d => d.status_stats.responded || 0)
                    }
                ],
                color: ['#91cc75', '#f44336', '#ff9800', '#fac858', '#73c0de']
            });
        }

        function updateAlertTimeChart(alerts) {
            const chart = chartInstances.get('alertTimeChart');
            
            // ç»Ÿè®¡å‘Šè­¦æ—¶é—´å’Œå“åº”æ—¶é—´åˆ†å¸ƒ
            const alertTimeData = {};
            const responseTimeData = {};
            const processingTimes = [];
            
            alerts.forEach(alert => {
                // ç»Ÿè®¡å‘Šè­¦æ—¶é—´åˆ†å¸ƒï¼ˆæ‰€æœ‰å‘Šè­¦ï¼‰
                const alertHour = new Date(alert.alert_timestamp).getHours();
                alertTimeData[alertHour] = (alertTimeData[alertHour] || 0) + 1;
                
                // ç»Ÿè®¡å“åº”æ—¶é—´åˆ†å¸ƒï¼ˆä»…å·²å¤„ç†çš„å‘Šè­¦ï¼‰
                if (alert.responded_time && 
                    alert.responded_time !== null && 
                    alert.responded_time !== 'null' && 
                    alert.responded_time !== '' &&
                    alert.responded_time !== undefined) {
                    
                    const responseHour = new Date(alert.responded_time).getHours();
                    responseTimeData[responseHour] = (responseTimeData[responseHour] || 0) + 1;
                    
                    // è®¡ç®—å¤„ç†æ—¶é•¿
                    const alertTime = new Date(alert.alert_timestamp);
                    const responseTime = new Date(alert.responded_time);
                    const processingHours = (responseTime - alertTime) / (1000 * 60 * 60);
                    
                    if (processingHours >= 0 && !isNaN(processingHours)) {
                        processingTimes.push({
                            alertId: alert.alert_id,
                            alertTime: alertTime,
                            responseTime: responseTime,
                            processingHours: processingHours.toFixed(2),
                            alertType: alert.alert_type
                        });
                    }
                }
            });

            const hours = Array.from({length: 24}, (_, i) => i);
            const alertData = hours.map(hour => alertTimeData[hour] || 0);
            const responseData = hours.map(hour => responseTimeData[hour] || 0);

            // è®¡ç®—å¹³å‡å¤„ç†æ—¶é•¿
            const avgProcessingTime = processingTimes.length > 0 
                ? (processingTimes.reduce((sum, item) => sum + parseFloat(item.processingHours), 0) / processingTimes.length).toFixed(2)
                : 0;

            // æ£€æŸ¥æ˜¯å¦æœ‰å“åº”æ•°æ®æ¥å†³å®šæ˜¾ç¤ºå†…å®¹
            const hasResponseData = processingTimes.length > 0;

            chart.setOption({
                title: {
                    text: 'å‘Šè­¦æ—¶é—´åˆ†å¸ƒä¸å¤„ç†åˆ†æ',
                    subtext: hasResponseData 
                        ? `å¹³å‡å¤„ç†æ—¶é•¿: ${avgProcessingTime}å°æ—¶ | å·²å¤„ç†: ${processingTimes.length}/${alerts.length}æ¡`
                        : `å…± ${alerts.length} æ¡å‘Šè­¦ | æš‚æ— å·²å¤„ç†å‘Šè­¦`,
                    textStyle: { color: '#fff' },
                    subtextStyle: { color: hasResponseData ? '#00e4ff' : '#ff9800', fontSize: 12 }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = `${params[0].name}<br/>`;
                        params.forEach(param => {
                            if (param.value > 0) { // åªæ˜¾ç¤ºæœ‰æ•°æ®çš„ç³»åˆ—
                                result += `${param.seriesName}: ${param.value}æ¡<br/>`;
                            }
                        });
                        
                        // æ˜¾ç¤ºè¯¥æ—¶é—´æ®µçš„å¤„ç†æ—¶é•¿ä¿¡æ¯
                        if (hasResponseData) {
                            const hour = parseInt(params[0].name.split(':')[0]);
                            const hourlyProcessing = processingTimes.filter(item => 
                                item.alertTime.getHours() === hour || item.responseTime.getHours() === hour
                            );
                            
                            if (hourlyProcessing.length > 0) {
                                const avgHourly = (hourlyProcessing.reduce((sum, item) => 
                                    sum + parseFloat(item.processingHours), 0) / hourlyProcessing.length).toFixed(2);
                                result += `è¯¥æ—¶æ®µå¹³å‡å¤„ç†æ—¶é•¿: ${avgHourly}å°æ—¶`;
                            }
                        }
                        
                        return result;
                    }
                },
                legend: {
                    data: hasResponseData ? ['å‘Šè­¦å‘ç”Ÿæ—¶é—´', 'å‘Šè­¦å“åº”æ—¶é—´'] : ['å‘Šè­¦å‘ç”Ÿæ—¶é—´'],
                    textStyle: { color: '#fff' },
                    top: 35
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours.map(h => `${h}:00`),
                    axisLabel: {
                        color: '#fff',
                        interval: 1,
                        rotate: 45
                    },
                    axisLine: {
                        lineStyle: { color: 'rgba(0, 228, 255, 0.3)' }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'å‘Šè­¦æ•°é‡',
                    nameTextStyle: { color: '#fff' },
                    axisLabel: { color: '#fff' },
                    splitLine: {
                        lineStyle: { color: 'rgba(0, 228, 255, 0.1)' }
                    }
                },
                series: hasResponseData ? [
                    {
                        name: 'å‘Šè­¦å‘ç”Ÿæ—¶é—´',
                    type: 'line',
                    smooth: true,
                        data: alertData,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(244, 67, 54, 0.3)' },
                                { offset: 1, color: 'rgba(244, 67, 54, 0.1)' }
                        ])
                    },
                    lineStyle: {
                            color: '#f44336',
                        width: 2
                    },
                    itemStyle: {
                            color: '#f44336',
                        borderWidth: 2
                        }
                    },
                    {
                        name: 'å‘Šè­¦å“åº”æ—¶é—´',
                        type: 'line',
                        smooth: true,
                        data: responseData,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(76, 175, 80, 0.3)' },
                                { offset: 1, color: 'rgba(76, 175, 80, 0.1)' }
                            ])
                        },
                        lineStyle: {
                            color: '#4caf50',
                            width: 2
                        },
                        itemStyle: {
                            color: '#4caf50',
                            borderWidth: 2
                        }
                    }
                ] : [
                    {
                        name: 'å‘Šè­¦å‘ç”Ÿæ—¶é—´',
                        type: 'line',
                        smooth: true,
                        data: alertData,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(244, 67, 54, 0.3)' },
                                { offset: 1, color: 'rgba(244, 67, 54, 0.1)' }
                            ])
                        },
                        lineStyle: {
                            color: '#f44336',
                            width: 2
                        },
                        itemStyle: {
                            color: '#f44336',
                            borderWidth: 2
                        }
                    }
                ]
            });
        }

        function updateProcessingTimeChart(alerts) {
            const chart = chartInstances.get('processingTimeChart');
            
            // è®¡ç®—å¤„ç†æ—¶é•¿æ•°æ®ï¼Œresponded_timeå­—æ®µå­˜åœ¨ä½†å¯èƒ½ä¸ºç©º
            const processingData = [];
            const typeProcessingStats = {};
            
            alerts.forEach(alert => {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å“åº”æ—¶é—´
                if (alert.responded_time && 
                    alert.responded_time !== null && 
                    alert.responded_time !== 'null' && 
                    alert.responded_time !== '' &&
                    alert.responded_time !== undefined) {
                    
                    const alertTime = new Date(alert.alert_timestamp);
                    const responseTime = new Date(alert.responded_time);
                    const processingHours = (responseTime - alertTime) / (1000 * 60 * 60);
                    
                    if (processingHours >= 0 && !isNaN(processingHours)) { // ç¡®ä¿æ—¶é—´è®¡ç®—æœ‰æ•ˆ
                        processingData.push({
                            alertId: alert.alert_id,
                            alertType: alert.alert_type,
                            severityLevel: alert.severity_level,
                            processingHours: processingHours,
                            alertTime: alertTime,
                            responseTime: responseTime
                        });
                        
                        // æŒ‰ç±»å‹ç»Ÿè®¡
                        if (!typeProcessingStats[alert.alert_type]) {
                            typeProcessingStats[alert.alert_type] = [];
                        }
                        typeProcessingStats[alert.alert_type].push(processingHours);
                    }
                }
            });
            
            // å¦‚æœæ²¡æœ‰å¤„ç†æ—¶é•¿æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (processingData.length === 0) {
                chart.setOption({
                    title: {
                        text: 'å‘Šè­¦å¤„ç†æ—¶é•¿åˆ†æ',
                        subtext: `æš‚æ— å·²å¤„ç†å‘Šè­¦æ•°æ® | å¾…å¤„ç†: ${alerts.length}æ¡`,
                        textStyle: { color: '#fff' },
                        subtextStyle: { color: '#ff9800', fontSize: 12 }
                    },
                    graphic: {
                        type: 'text',
                        left: 'center',
                        top: 'middle',
                        style: {
                            text: 'æš‚æ— å·²å¤„ç†çš„å‘Šè­¦æ•°æ®\nè¯·å¤„ç†å‘Šè­¦åæŸ¥çœ‹æ—¶é•¿åˆ†æ',
                            textAlign: 'center',
                            fill: '#fff',
                            fontSize: 16
                        }
                    },
                    xAxis: { show: false },
                    yAxis: { show: false },
                    series: []
                });
                return;
            }
            
            // æŒ‰å¤„ç†æ—¶é•¿æ’åºå¹¶å–å‰20æ¡ä½œä¸ºæ•£ç‚¹å›¾æ•°æ®
            const sortedData = processingData.sort((a, b) => b.processingHours - a.processingHours).slice(0, 20);
            
            // è®¡ç®—å„ç±»å‹å¹³å‡å¤„ç†æ—¶é•¿
            const avgByType = Object.entries(typeProcessingStats).map(([type, times]) => ({
                type: type,
                avgTime: (times.reduce((sum, time) => sum + time, 0) / times.length).toFixed(2),
                count: times.length,
                maxTime: Math.max(...times).toFixed(2),
                minTime: Math.min(...times).toFixed(2)
            })).sort((a, b) => parseFloat(b.avgTime) - parseFloat(a.avgTime));

            chart.setOption({
                title: {
                    text: 'å‘Šè­¦å¤„ç†æ—¶é•¿åˆ†æ',
                    subtext: `å·²å¤„ç†: ${processingData.length}æ¡ | å¾…å¤„ç†: ${alerts.length - processingData.length}æ¡`,
                    textStyle: { color: '#fff' },
                    subtextStyle: { color: '#00e4ff', fontSize: 12 }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.componentType === 'series') {
                            if (params.seriesName === 'å¤„ç†æ—¶é•¿åˆ†å¸ƒ') {
                                const data = sortedData[params.dataIndex];
                                return `å‘Šè­¦ID: ${data.alertId}<br/>` +
                                       `å‘Šè­¦ç±»å‹: ${getAlertTypeName(data.alertType)}<br/>` +
                                       `ä¸¥é‡çº§åˆ«: ${data.severityLevel === 'critical' ? 'ä¸¥é‡' : 'ä¸­ç­‰'}<br/>` +
                                       `å¤„ç†æ—¶é•¿: ${data.processingHours.toFixed(2)}å°æ—¶<br/>` +
                                       `å‘Šè­¦æ—¶é—´: ${data.alertTime.toLocaleString()}<br/>` +
                                       `å“åº”æ—¶é—´: ${data.responseTime.toLocaleString()}`;
                            } else {
                                const data = avgByType[params.dataIndex];
                                return `å‘Šè­¦ç±»å‹: ${getAlertTypeName(data.type)}<br/>` +
                                       `å¹³å‡å¤„ç†æ—¶é•¿: ${data.avgTime}å°æ—¶<br/>` +
                                       `å¤„ç†æ•°é‡: ${data.count}æ¡<br/>` +
                                       `æœ€é•¿æ—¶é•¿: ${data.maxTime}å°æ—¶<br/>` +
                                       `æœ€çŸ­æ—¶é•¿: ${data.minTime}å°æ—¶`;
                            }
                        }
                        return '';
                    }
                },
                legend: {
                    data: ['å¤„ç†æ—¶é•¿åˆ†å¸ƒ', 'ç±»å‹å¹³å‡æ—¶é•¿'],
                    textStyle: { color: '#fff' },
                    top: 30
                },
                grid: [
                    {
                        left: '8%',
                        right: '55%',
                        top: '18%',
                        bottom: '15%'
                    },
                    {
                        left: '60%',
                        right: '8%',
                        top: '18%',
                        bottom: '15%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: sortedData.map((_, index) => `${index + 1}`),
                        axisLabel: {
                            color: '#fff',
                            fontSize: 10,
                            interval: 0
                        },
                        name: 'å‘Šè­¦åºå·',
                        nameTextStyle: { color: '#fff', fontSize: 11 },
                        nameLocation: 'middle',
                        nameGap: 25,
                        gridIndex: 0
                    },
                    {
                        type: 'category',
                        data: avgByType.map(item => {
                            const translatedType = getAlertTypeName(item.type);
                            return translatedType.length > 6 ? translatedType.substring(0, 6) + '...' : translatedType;
                        }),
                        axisLabel: {
                            color: '#fff',
                            fontSize: 10,
                            rotate: 30,
                            interval: 0
                        },
                        name: 'å‘Šè­¦ç±»å‹',
                        nameTextStyle: { color: '#fff', fontSize: 11 },
                        nameLocation: 'middle',
                        nameGap: 35,
                        gridIndex: 1
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        name: 'å¤„ç†æ—¶é•¿(å°æ—¶)',
                        nameTextStyle: { color: '#fff', fontSize: 11 },
                        axisLabel: { 
                            color: '#fff',
                            fontSize: 10
                        },
                        splitLine: {
                            lineStyle: { color: 'rgba(0, 228, 255, 0.1)' }
                        },
                        gridIndex: 0
                    },
                    {
                        type: 'value',
                        name: 'å¹³å‡æ—¶é•¿(å°æ—¶)',
                        nameTextStyle: { color: '#fff', fontSize: 11 },
                        axisLabel: { 
                            color: '#fff',
                            fontSize: 10
                        },
                        splitLine: {
                            lineStyle: { color: 'rgba(0, 228, 255, 0.1)' }
                        },
                        gridIndex: 1
                    }
                ],
                series: [
                    {
                        name: 'å¤„ç†æ—¶é•¿åˆ†å¸ƒ',
                        type: 'scatter',
                        data: sortedData.map(item => ({
                            value: item.processingHours,
                            itemStyle: {
                                color: item.severityLevel === 'critical' ? '#f44336' : '#ff9800'
                            }
                        })),
                        symbolSize: function(value) {
                            return Math.max(8, Math.min(15, value + 5));
                        },
                        xAxisIndex: 0,
                        yAxisIndex: 0
                    },
                    {
                        name: 'ç±»å‹å¹³å‡æ—¶é•¿',
                        type: 'bar',
                        data: avgByType.map(item => ({
                            value: parseFloat(item.avgTime),
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: '#00e4ff' },
                                    { offset: 1, color: '#0066cc' }
                                ])
                            }
                        })),
                        label: {
                            show: true,
                            position: 'top',
                            color: '#fff',
                            fontSize: 10,
                            formatter: '{c}h'
                        },
                        barWidth: '60%',
                        xAxisIndex: 1,
                        yAxisIndex: 1
                    }
                ]
            });
        }

        async function updateDashboard(forceRefresh = false) {
            // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œè°ƒç”¨æ¥å£è·å–
            if (forceRefresh || !cachedAlertInfo) {
                console.log('ğŸ”„ è°ƒç”¨æ¥å£è·å–æœ€æ–°å‘Šè­¦æ•°æ®...');
                const data = await fetchAlertInfo();
                if (data) {
                    // ä¿å­˜åŸå§‹æ•°æ®
                    originalAlertData = data;
                    currentFilteredData = data;
                    
                    // åˆå§‹åŒ–å‘Šè­¦ç±»å‹è¿‡æ»¤å™¨
                    initAlertTypeFilter(data.alerts);
                    
                    // åˆå§‹åŒ–è¿‡æ»¤çŠ¶æ€æ˜¾ç¤º
                    updateAlertFilterStatus('', '', '', data.alerts.length, data.alerts.length);
                    
                    // æ˜¾ç¤ºæ•°æ®
                    displayAlertTable(data.alerts);
                    updateAlertLevelChart(data.alertLevelCount);
                    updateAlertStatusChart(data.alertStatusCount);
                    updateAlertTypeChart(data.alertTypeCount);
                    updateDeviceAlertChart(data.deviceAlertCount);
                    updateDepartmentStatsChart(data.departmentStats);
                    updateAlertTimeChart(data.alerts);
                    updateProcessingTimeChart(data.alerts);
                    
                    // æ¸…ç©ºé€‰æ‹©çŠ¶æ€
                    selectedAlerts.clear();
                    updateBatchActions();
                }
                return;
            }
            
            // åªæœ‰é¦–æ¬¡åŠ è½½ä¸”æœ‰ç¼“å­˜æ•°æ®æ—¶æ‰ä½¿ç”¨ç¼“å­˜
            console.log('âœ… ä½¿ç”¨ä¼ é€’çš„ç¼“å­˜æ•°æ®ï¼Œé¿å…é‡å¤æ¥å£è°ƒç”¨');
            updateDashboardWithCachedData();
        }

        function initCharts() {
            const chartIds = [
                'alertLevelChart', 'alertStatusChart', 'alertTypeChart',
                'deviceAlertChart', 'departmentStatsChart', 'alertTimeChart', 'processingTimeChart'
            ];
            
            chartIds.forEach(id => {
                chartInstances.set(id, echarts.init(document.getElementById(id)));
            });
        }

        async function initDashboard() {
            initCharts();
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œçœ‹æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®ä¼ é€’è¿‡æ¥
            setTimeout(async () => {
                if (cachedAlertInfo) {
                    console.log('âœ… ä½¿ç”¨ä¼ é€’çš„ç¼“å­˜æ•°æ®ï¼Œé¿å…é‡å¤æ¥å£è°ƒç”¨');
                } else {
                    console.log('âŒ æœªæ¥æ”¶åˆ°ç¼“å­˜æ•°æ®ï¼Œå°†è°ƒç”¨æ¥å£è·å–');
                }
                
                await updateDashboard();
                
                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                if (isAutoRefreshEnabled) {
                    startAutoRefresh();
                }
            }, 1000); // ç­‰å¾…1ç§’è®©postMessageæœ‰æ—¶é—´ä¼ é€’æ•°æ®

            window.addEventListener('resize', debounce(() => {
                chartInstances.forEach(chart => chart.resize());
            }, 250));
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
        function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            const btnIcon = btn.querySelector('.btn-icon');
            const btnText = btn.querySelector('span:last-child');
            
            btnText.textContent = 'åˆ·æ–°ä¸­...';
            btnIcon.style.animation = 'spin 1s linear infinite';
            btn.disabled = true;
            
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°å‘Šè­¦æ•°æ®...');
            updateDashboard(true).then(() => {
                btnText.textContent = 'æ‰‹åŠ¨åˆ·æ–°';
                btnIcon.style.animation = '';
                btn.disabled = false;
                console.log('âœ… æ‰‹åŠ¨åˆ·æ–°å®Œæˆ');
            }).catch(error => {
                console.error('âŒ æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error);
                btnText.textContent = 'åˆ·æ–°å¤±è´¥';
                btnIcon.textContent = 'âŒ';
                setTimeout(() => {
                    btnText.textContent = 'æ‰‹åŠ¨åˆ·æ–°';
                    btnIcon.textContent = 'ğŸ”„';
                    btnIcon.style.animation = '';
                    btn.disabled = false;
                }, 2000);
            });
        }
        
        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        function toggleAutoRefresh() {
            const btn = document.getElementById('toggleAutoRefresh');
            const status = document.getElementById('refreshStatus');
            const statusDot = document.getElementById('statusDot');
            const btnIcon = document.getElementById('autoRefreshIcon');
            const btnText = document.getElementById('autoRefreshText');
            
            if (isAutoRefreshEnabled) {
                // å…³é—­è‡ªåŠ¨åˆ·æ–°
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                isAutoRefreshEnabled = false;
                btnIcon.textContent = 'â–¶ï¸';
                btnText.textContent = 'å¯åŠ¨ç›‘æ§';
                status.textContent = 'ç›‘æ§å·²æš‚åœ';
                statusDot.classList.add('paused');
                console.log('âŒ è‡ªåŠ¨åˆ·æ–°å·²å…³é—­');
            } else {
                // å¼€å¯è‡ªåŠ¨åˆ·æ–°
                startAutoRefresh();
                isAutoRefreshEnabled = true;
                btnIcon.textContent = 'â¸ï¸';
                btnText.textContent = 'æš‚åœè‡ªåŠ¨';
                status.textContent = 'å®æ—¶ç›‘æ§ä¸­';
                statusDot.classList.remove('paused');
                console.log('âœ… è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯');
            }
        }
        
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            autoRefreshTimer = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°å‘Šè­¦æ•°æ®...');
                    updateDashboard(true).catch(error => {
                        console.error('âŒ è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', error);
                    });
                }
            }, REFRESH_INTERVAL);
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }
        
        // å…¨å±€æš´éœ²åˆ·æ–°ç›¸å…³å‡½æ•°
        window.manualRefresh = manualRefresh;
        window.toggleAutoRefresh = toggleAutoRefresh;

        document.addEventListener('DOMContentLoaded', initDashboard);

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ è¿‡æ»¤å™¨äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('alertTypeFilter').addEventListener('change', applyAlertFilters);
            document.getElementById('alertStatusFilter').addEventListener('change', applyAlertFilters);
            document.getElementById('severityLevelFilter').addEventListener('change', applyAlertFilters);
            document.getElementById('resetAlertFilter').addEventListener('click', resetAlertFilters);
            
            // æ·»åŠ æ‰¹å¤„ç†æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('batchProcessBtn').addEventListener('click', batchProcessAlerts);
            document.getElementById('selectAllBtn').addEventListener('click', selectAllAlerts);
            document.getElementById('clearSelectionBtn').addEventListener('click', clearSelection);
        });

        // å¤šé€‰åŠŸèƒ½ç›¸å…³å‡½æ•°
        function toggleAlertSelection(alertId) {
            if (selectedAlerts.has(alertId)) {
                selectedAlerts.delete(alertId);
            } else {
                selectedAlerts.add(alertId);
            }
            updateBatchActions();
            updateSelectionDisplay();
        }

        function toggleAllSelection() {
            const checkboxes = document.querySelectorAll('.alert-item-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    selectedAlerts.add(checkbox.value);
                    checkbox.checked = true;
                });
            } else {
                selectedAlerts.clear();
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            updateBatchActions();
        }

        function updateBatchActions() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');
            const batchProcessBtn = document.getElementById('batchProcessBtn');
            
            selectedCount.textContent = selectedAlerts.size;
            
            if (selectedAlerts.size > 0) {
                batchActions.classList.add('show');
                batchProcessBtn.disabled = false;
            } else {
                batchActions.classList.remove('show');
                batchProcessBtn.disabled = true;
            }
        }

        function updateSelectionDisplay() {
            const checkboxes = document.querySelectorAll('.alert-item-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectedAlerts.has(checkbox.value);
            });
            
            // æ›´æ–°å…¨é€‰çŠ¶æ€
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function selectAllAlerts() {
            const checkboxes = document.querySelectorAll('.alert-item-checkbox');
            checkboxes.forEach(checkbox => {
                selectedAlerts.add(checkbox.value);
                checkbox.checked = true;
            });
            updateBatchActions();
            updateSelectionDisplay();
        }

        function clearSelection() {
            selectedAlerts.clear();
            const checkboxes = document.querySelectorAll('.alert-item-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            updateBatchActions();
        }

        // æ‰¹é‡å¤„ç†å‘Šè­¦
        async function batchProcessAlerts() {
            if (selectedAlerts.size === 0) {
                showCustomAlert('è¯·å…ˆé€‰æ‹©è¦å¤„ç†çš„å‘Šè­¦', null);
                return;
            }

            const alertIds = Array.from(selectedAlerts);
            const batchProcessBtn = document.getElementById('batchProcessBtn');
            
            try {
                batchProcessBtn.disabled = true;
                batchProcessBtn.textContent = 'å¤„ç†ä¸­...';

                const response = await fetch('./batchDealAlert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        alertIds: alertIds
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showCustomAlert(`æˆåŠŸå¤„ç† ${alertIds.length} æ¡å‘Šè­¦ï¼`, () => {
                        location.reload();
                    });
                } else {
                    showCustomAlert(data.message || 'æ‰¹é‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', null);
                }
            } catch (error) {
                console.error('æ‰¹é‡å¤„ç†å¤±è´¥:', error);
                showCustomAlert('æ‰¹é‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', null);
            } finally {
                batchProcessBtn.disabled = false;
                batchProcessBtn.textContent = 'æ‰¹é‡å¤„ç†';
            }
        }

        // æš´éœ²å‡½æ•°ä¾›HTMLè°ƒç”¨
        window.toggleAlertSelection = toggleAlertSelection;
        window.toggleAllSelection = toggleAllSelection;
    </script>
</body>
</html> 