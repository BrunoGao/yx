<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>用户健康档案</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .profile-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 用户基本信息卡片 */
        .user-header {
            display: flex;
            gap: 20px;
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .avatar-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(0, 228, 255, 0.5);
        }

        .avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 24px;
            color: #00e4ff;
            margin: 0 0 10px 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .info-value {
            color: #fff;
            font-size: 14px;
        }

        /* 健康数据卡片 */
        .health-card {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .health-metrics {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .metric {
            padding: 15px;
            background: rgba(0, 228, 255, 0.1);
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 20px;
            color: #00e4ff;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .metric-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* 坐标显示特殊样式 */
        .metric.coordinates {
            grid-column: span 2;
        }

        .metric.coordinates .metric-value {
            font-size: 16px;
        }

        /* 图表网格 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            height: 300px;
        }

        /* 状态标签 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        /* 关闭按钮 */
        .close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .close-btn::before {
            content: '×';
        }

        /* 告警列表样式 */
        .alerts-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            margin-top: 20px;
        }

        .alerts-container h3 {
            color: #fff;
            margin: 0 0 15px 0;
        }

        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .alert-item {
            background: rgba(0, 228, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-info {
            flex: 1;
        }

        .alert-type {
            font-size: 14px;
            color: #fff;
            margin-bottom: 5px;
        }

        .alert-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .alert-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .alert-status.pending {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .alert-status.responded {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        /* 消息列表样式 */
        .messages-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            margin-top: 20px;
        }

        .messages-container h3 {
            color: #fff;
            margin: 0 0 15px 0;
        }

        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message-item {
            background: rgba(0, 228, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .message-type {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .message-content {
            font-size: 14px;
            color: #fff;
        }

        .message-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="closeProfile()" title="关闭"></button>
    <div class="profile-container" id="profileContainer">
        <!-- 用户基本信息 -->
        <div class="user-header">
            <div class="avatar-container">
                <img id="userAvatar" src="" alt="用户头像">
            </div>
            <div class="user-info">
                <h2 class="user-name" id="userName"></h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">部门</span>
                        <span class="info-value" id="deptName"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">设备号</span>
                        <span class="info-value" id="deviceSn"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">手机号</span>
                        <span class="info-value" id="phoneNumber"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">设备状态</span>
                        <span class="info-value" id="deviceStatus"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">佩戴状态</span>
                        <span class="info-value" id="wearableStatus"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">充电状态</span>
                        <span class="info-value" id="chargingStatus"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 健康数据概览 -->
        <div class="health-card">
            <div class="health-metrics" id="healthMetrics"></div>
        </div>

        <!-- 图表区域 -->
        <div class="charts-grid">
            <!-- 告警类型图表 -->
            <div class="chart-container">
                <div id="alertTypeChart" style="width: 100%; height: 100%;"></div>
            </div>
            <!-- 告警状态图表 -->
            <div class="chart-container">
                <div id="alertStatusChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>

        <!-- 告警列表 -->
        <div class="alerts-container">
            <h3>最近告警</h3>
            <div class="alerts-list" id="alertsList">
                <!-- 告警列表将通过JavaScript动态填充 -->
            </div>
        </div>

        <!-- 消息列表 -->
        <div class="messages-container">
            <h3>最近消息</h3>
            <div class="messages-list" id="messagesList">
                <!-- 消息列表将通过JavaScript动态填充 -->
            </div>
        </div>
    </div>

    <script>
        // 获取URL参数
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // 关闭窗口
        function closeProfile() {
            if (window.opener) {
                // 如果是通过window.open打开的窗口
                window.close();
            } else if (window.parent && window.parent !== window) {
                // 如果是在iframe中
                window.parent.postMessage({ type: 'closeProfile' }, '*');
            } else {
                // 如果是在当前窗口打开的
                window.history.back();
            }
        }

        // 监听父窗口消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'closeProfile') {
                window.close();
            }
        });

        // 初始化页面数据
        async function initializeProfile() {
            const deviceSn = getQueryParam('deviceSn');
            if (!deviceSn) {
                console.error('No device SN provided');
                return;
            }

            try {
                const response = await fetch(`/get_personal_info?deviceSn=${deviceSn}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const personalData = data.data;
                    
                    // 更新用户基本信息
                    if (personalData.user_info && personalData.user_info.data.users && personalData.user_info.data.users.length > 0) {
                        const user = personalData.user_info.data.users[0];
                        document.getElementById('userAvatar').src = user.avatar || '';
                        document.getElementById('userName').textContent = user.user_name || 'N/A';
                        document.getElementById('deptName').textContent = user.dept_name || 'N/A';
                        document.getElementById('deviceSn').textContent = user.device_sn || 'N/A';
                        document.getElementById('phoneNumber').textContent = user.phone_number || 'N/A';
                        document.getElementById('deviceStatus').textContent = translateStatus(user.device_status) || 'N/A';
                        document.getElementById('wearableStatus').textContent = translateWearableStatus(user.wearable_status) || 'N/A';
                        document.getElementById('chargingStatus').textContent = translateChargingStatus(user.charging_status) || 'N/A';
                    }

                    // 更新健康数据
                    if (personalData.health_data && personalData.health_data.data.healthData && personalData.health_data.data.healthData.length > 0) {
                        const health = personalData.health_data.data.healthData[0];
                        const healthMetrics = document.getElementById('healthMetrics');
                        healthMetrics.innerHTML = `
                            <div class="metric">
                                <div class="metric-value">${health.heartRate || 'N/A'}</div>
                                <div class="metric-label">心率 (bpm)</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${health.temperature || 'N/A'}</div>
                                <div class="metric-label">体温 (°C)</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${health.pressureHigh}/${health.pressureLow}</div>
                                <div class="metric-label">血压 (mmHg)</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${health.bloodOxygen || 'N/A'}</div>
                                <div class="metric-label">血氧 (%)</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${health.stress || 'N/A'}</div>
                                <div class="metric-label">压力指数</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${health.step || '0'}</div>
                                <div class="metric-label">步数</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${health.calorie ? health.calorie.toFixed(1) : '0'}</div>
                                <div class="metric-label">卡路里</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${health.distance ? (health.distance * 1000).toFixed(0) : '0'}</div>
                                <div class="metric-label">距离 (m)</div>
                            </div>
                            <div class="metric coordinates">
                                <div class="metric-value">${health.latitude ? `${health.latitude}, ${health.longitude}` : 'N/A'}</div>
                                <div class="metric-label">位置坐标</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${health.altitude ? health.altitude.toFixed(1) : '0'}</div>
                                <div class="metric-label">海拔 (m)</div>
                            </div>
                        `;
                    }

                    // 初始化告警类型图表
                    if (personalData.alert_info && personalData.alert_info.data) {
                        initAlertTypeChart(personalData.alert_info.data);
                        initAlertStatusChart(personalData.alert_info.data);
                        renderAlertsList(personalData.alert_info.data);
                    }

                    // 初始化消息列表
                    if (personalData.message_info && personalData.message_info.data) {
                        renderMessagesList(personalData.message_info.data);
                    }
                }
            } catch (error) {
                console.error('Error fetching profile data:', error);
            }
        }

        // 状态翻译函数
        function translateStatus(status) {
            const statusMap = {
                'ACTIVE': '活跃',
                'INACTIVE': '不活跃'
            };
            return statusMap[status] || status;
        }

        function translateWearableStatus(status) {
            const statusMap = {
                'WORN': '已佩戴',
                'NOT_WORN': '未佩戴'
            };
            return statusMap[status] || status;
        }

        function translateChargingStatus(status) {
            const statusMap = {
                'CHARGING': '充电中',
                'NOT_CHARGING': '未充电'
            };
            return statusMap[status] || status;
        }

        // 初始化告警类型图表
        function initAlertTypeChart(alertData) {
            const alertTypeChart = echarts.init(document.getElementById('alertTypeChart'));
            const typeCount = alertData.alertTypeCount;
            
            const option = {
                title: {
                    text: '告警类型分布',
                    textStyle: {
                        color: '#fff'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: Object.entries(typeCount).map(([name, value]) => ({
                        name,
                        value
                    })),
                    emphasis: {
                    itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            alertTypeChart.setOption(option);
        }

        // 初始化告警状态图表
        function initAlertStatusChart(alertData) {
            const alertStatusChart = echarts.init(document.getElementById('alertStatusChart'));
            const statusCount = alertData.alertStatusCount;

            const option = {
                title: {
                    text: '告警状态分布',
                    textStyle: {
                        color: '#fff'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: Object.entries(statusCount).map(([name, value]) => ({
                        name: name === 'pending' ? '待处理' : '已响应',
                        value
                    })),
                    emphasis: {
                    itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            alertStatusChart.setOption(option);
        }

        // 渲染告警列表
        function renderAlertsList(alertData) {
            const alertsList = document.getElementById('alertsList');
            const alerts = alertData.alerts;
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item">
                    <div class="alert-info">
                        <div class="alert-type">${alert.alert_type}</div>
                        <div class="alert-desc">${alert.alert_desc}</div>
                        <div class="alert-time">${alert.alert_timestamp}</div>
                    </div>
                    <div class="alert-status ${alert.alert_status}">
                        ${alert.alert_status === 'pending' ? '待处理' : '已响应'}
                    </div>
                </div>
            `).join('');
        }

        // 渲染消息列表
        function renderMessagesList(messageData) {
            const messagesList = document.getElementById('messagesList');
            const messages = messageData.messages;
            
            messagesList.innerHTML = messages.map(message => `
                <div class="message-item">
                    <div class="message-type">
                        ${message.message_type === 'announcement' ? '公告' : '工作'}
                    </div>
                    <div class="message-content">${message.message}</div>
                    <div class="message-time">${message.sent_time}</div>
                </div>
            `).join('');
            }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializeProfile);
    </script>
</body>
</html> 