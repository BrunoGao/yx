<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能手表设备分析系统</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            background: transparent; 
            color: #fff; 
            padding: 20px;
        }
        
        .container { 
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* 可折叠面板样式 */
        .collapsible-panel {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .panel-header {
            padding: 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 228, 255, 0.05);
            transition: background 0.3s ease;
        }

        .panel-header:hover {
            background: rgba(0, 228, 255, 0.1);
        }

        .panel-header h3 {
            color: #00e4ff;
            font-size: 20px;
            margin: 0;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        .panel-toggle {
            color: #00e4ff;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .panel-toggle.expanded {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .panel-content.expanded {
            max-height: 1000px;
            padding: 20px;
        }
        
        /* 过滤器样式 */
        .form-group {
            margin-bottom: 20px;
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            color: #00e4ff;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select {
            width: 100%;
            padding: 10px;
            background: rgba(1, 19, 38, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #00e4ff;
            box-shadow: 0 0 5px rgba(0, 228, 255, 0.5);
        }

        .filter-select option {
            background: rgba(1, 19, 38, 0.9);
            color: #fff;
            padding: 8px;
        }

        .send-btn {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }

        .send-btn:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        /* 设备表格容器样式 */
        .device-table-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            max-height: 500px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        /* 表格头部样式 */
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.1);
        }

        .table-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-title h2 {
            color: #00e4ff;
            font-size: 20px;
            margin: 0;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-count {
            background: linear-gradient(45deg, rgba(0, 228, 255, 0.2), rgba(0, 228, 255, 0.1));
            color: #00e4ff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(0, 228, 255, 0.3);
            letter-spacing: 0.5px;
        }

        /* 控制面板样式 */
        .control-panel {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 228, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #52c41a;
            box-shadow: 0 0 6px rgba(82, 196, 26, 0.8);
            animation: pulse 2s infinite;
        }

        .status-dot.paused {
            background: #fa8c16;
            box-shadow: 0 0 6px rgba(250, 140, 22, 0.8);
            animation: none;
        }

        .status-text {
            color: #7ecfff;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* 按钮组样式 */
        .button-group {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
            min-width: 90px;
            justify-content: center;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
        }

        .control-btn.primary:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        .control-btn.secondary {
            background: linear-gradient(45deg, rgba(250, 140, 22, 0.8), rgba(255, 187, 0, 0.8));
            color: #fff;
        }

        .control-btn.secondary:hover {
            background: linear-gradient(45deg, rgba(255, 187, 0, 0.9), rgba(250, 140, 22, 0.9));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(250, 140, 22, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            font-size: 14px;
        }

        #deviceTable {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 8px;
        }

        /* 表格基础样式 */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            position: relative;
        }

        th {
            background: linear-gradient(180deg, rgba(0, 228, 255, 0.15) 0%, rgba(0, 228, 255, 0.05) 100%);
            color: #00e4ff;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(0, 228, 255, 0.2);
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        th:first-child { border-top-left-radius: 8px; }
        th:last-child { border-top-right-radius: 8px; }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.1);
            transition: all 0.3s ease;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tr:nth-child(even) {
            background: rgba(0, 228, 255, 0.03);
        }

        tr:hover td {
            background: rgba(0, 228, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 228, 255, 0.1);
        }

        /* 状态标签样式 */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .status-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .status-active {
            background: linear-gradient(45deg, rgba(82, 196, 26, 0.2) 0%, rgba(82, 196, 26, 0.4) 100%);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.3);
        }

        .status-inactive {
            background: linear-gradient(45deg, rgba(245, 34, 45, 0.2) 0%, rgba(245, 34, 45, 0.4) 100%);
            color: #f5222d;
            border: 1px solid rgba(245, 34, 45, 0.3);
        }

        .status-charging {
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.2) 0%, rgba(33, 150, 243, 0.4) 100%);
            color: #2196f3;
            border: 1px solid rgba(33, 150, 243, 0.3);
            animation: pulse 1.5s infinite;
        }

        .status-not-charging {
            background: linear-gradient(45deg, rgba(250, 140, 22, 0.2) 0%, rgba(250, 140, 22, 0.4) 100%);
            color: #fa8c16;
            border: 1px solid rgba(250, 140, 22, 0.3);
        }

        .status-worn {
            background: linear-gradient(45deg, rgba(82, 196, 26, 0.2) 0%, rgba(82, 196, 26, 0.4) 100%);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.3);
        }

        .status-not-worn {
            background: linear-gradient(45deg, rgba(245, 34, 45, 0.2) 0%, rgba(245, 34, 45, 0.4) 100%);
            color: #f5222d;
            border: 1px solid rgba(245, 34, 45, 0.3);
        }

        /* 电池进度条 */
        .battery-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .battery-visual {
            position: relative;
            width: 60px;
            height: 12px;
            border: 1px solid #666;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .battery-bar {
            height: 100%;
            transition: width 0.3s ease-in-out;
        }

        .battery-low .battery-bar { background: linear-gradient(90deg, #f5222d, #ff4d4f); }
        .battery-medium .battery-bar { background: linear-gradient(90deg, #fa8c16, #ffc53d); }
        .battery-high .battery-bar { background: linear-gradient(90deg, #52c41a, #73d13d); }

        .battery-text {
            font-size: 12px;
            font-weight: 600;
            min-width: 35px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 图表网格容器 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            height: 350px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            border-color: rgba(0, 228, 255, 0.4);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }

        /* 电池分析图表跨两列 */
        .chart-container.full-width {
            grid-column: span 2;
            height: 400px;
        }

        /* 滚动条美化 */
        #deviceTable::-webkit-scrollbar {
            width: 8px;
        }

        #deviceTable::-webkit-scrollbar-track {
            background: rgba(0, 228, 255, 0.1);
            border-radius: 4px;
        }

        #deviceTable::-webkit-scrollbar-thumb {
            background: rgba(0, 228, 255, 0.2);
            border-radius: 4px;
        }

        #deviceTable::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 228, 255, 0.3);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container.full-width {
                grid-column: span 1;
            }
            
            .form-group {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 过滤器面板 -->
        <div class="collapsible-panel">
            <div class="panel-header" onclick="togglePanel('filterPanel')">
                <h3>🔍 设备筛选</h3>
                <span class="panel-toggle" id="filterPanelToggle">▼</span>
            </div>
            <div class="panel-content" id="filterPanelContent">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group">
                        <label>设备状态：</label>
                        <select id="filterStatus" class="filter-select" onchange="updateDashboard()">
                            <option value="">全部状态</option>
                            <option value="ACTIVE">在线</option>
                            <option value="INACTIVE">离线</option>
                </select>
            </div>
                    
                    <div class="form-group">
                        <label>充电状态：</label>
                        <select id="filterCharging" class="filter-select" onchange="updateDashboard()">
                            <option value="">全部状态</option>
                            <option value="CHARGING">充电中</option>
                            <option value="NOT_CHARGING">未充电</option>
                </select>
            </div>
                    
                    <div class="form-group">
                        <label>佩戴状态：</label>
                        <select id="filterWearable" class="filter-select" onchange="updateDashboard()">
                            <option value="">全部状态</option>
                            <option value="WORN">已佩戴</option>
                            <option value="NOT_WORN">未佩戴</option>
                        </select>
        </div>

                    <div class="form-group">
                        <label>电池电量：</label>
                        <select id="filterBattery" class="filter-select" onchange="updateDashboard()">
                            <option value="">全部范围</option>
                            <option value="low">低电量 (0-20%)</option>
                            <option value="medium">中等 (21-70%)</option>
                            <option value="high">高电量 (71-100%)</option>
                        </select>
            </div>
                    
                    <div class="form-group" style="flex: 0; min-width: 120px; display: flex; align-items: end;">
                        <button id="resetFilter" class="send-btn" onclick="resetFilters()">重置筛选</button>
            </div>
            </div>
            </div>
        </div>

        <!-- 设备表格 -->
        <div class="device-table-container">
            <div class="table-header">
                <div class="table-title">
                    <h2>📱 智能设备监控台</h2>
                    <span id="deviceCount" class="device-count"></span>
                </div>
                <div class="control-panel">
                    <div class="status-indicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="refreshStatus" class="status-text">实时监控中</span>
                    </div>
                    <div class="button-group">
                        <button id="refreshBtn" class="control-btn primary" onclick="manualRefresh()">
                            <span class="btn-icon">🔄</span>
                            <span>手动刷新</span>
                        </button>
                        <button id="toggleAutoRefresh" class="control-btn secondary" onclick="toggleAutoRefresh()">
                            <span class="btn-icon" id="autoRefreshIcon">⏸️</span>
                            <span id="autoRefreshText">暂停自动</span>
                        </button>
                    </div>
                </div>
            </div>
            <div id="deviceTable"></div>
        </div>

        <!-- 统计图表 -->
        <div class="charts-grid">
            <!-- 第一行：基础统计 -->
            <div class="chart-container">
                <div id="departmentChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="statusChart" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- 第二行：状态分析 -->
            <div class="chart-container">
                <div id="chargingChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="wearableChart" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- 第三行：电池和版本 -->
            <div class="chart-container">
                <div id="batteryChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="systemVersionChart" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- 第四行：历史趋势分析（跨越所有列） -->
            <div class="chart-container full-width">
                <div id="batteryTrendChart" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- 第五行：佩戴和充电趋势 -->
            <div class="chart-container">
                <div id="wearTrendChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="chargingTrendChart" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- 第六行：设备健康雷达图和预测分析 -->
            <div class="chart-container">
                <div id="deviceHealthRadar" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="batteryPredictionChart" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- 第七行：在线率趋势和版本分布时间线（跨越所有列） -->
            <div class="chart-container full-width">
                <div id="uptimeTrendChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <script>
        const chartInstances = new Map();
        let originalDeviceData = null;
        let currentFilteredData = null;
        
        // 缓存传递过来的设备数据
        let cachedDeviceInfo = null;
        
        // 自动刷新相关变量
        let autoRefreshTimer = null;
        let isAutoRefreshEnabled = true;
        const REFRESH_INTERVAL = 5000; // 5秒
        
        // 监听来自父窗口的数据 - 增强版本
        window.addEventListener('message', function(event) {
            console.log('📨 device_view收到message事件:', event);
            console.log('📨 事件数据:', event.data);
            console.log('📨 事件来源:', event.origin);
            
            if (event.data && event.data.type === 'deviceInfo') {
                cachedDeviceInfo = event.data.data;
                console.log('✅ 接收到传递的设备数据:', cachedDeviceInfo);
                
                // 发送确认消息给父窗口
                try {
                    event.source.postMessage({
                        type: 'dataReceived',
                        success: true,
                        timestamp: Date.now()
                    }, event.origin);
                    console.log('📤 已发送数据接收确认');
                } catch (e) {
                    console.error('❌ 发送确认消息失败:', e);
                }
                
                // 如果图表已初始化，直接更新数据
                if (chartInstances.size > 0) {
                    console.log('📊 图表已初始化，立即更新数据');
                    updateDashboardWithCachedData();
                } else {
                    console.log('⏳ 图表未初始化，等待initDashboard调用');
                }
            } else {
                console.log('⚠️ 收到的消息类型不匹配或数据格式错误:', event.data);
            }
        });
        
        // 使用缓存数据更新仪表板
        function updateDashboardWithCachedData() {
            if (!cachedDeviceInfo) return;
            
            console.log('📊 开始使用缓存数据更新图表:', cachedDeviceInfo);
            
            // 将缓存的数据转换为设备数据格式
            const data = {
                success: true,
                data: {
                    devices: cachedDeviceInfo.devices || [],
                    deviceStatusCount: cachedDeviceInfo.deviceStatusCount || {},
                    deviceChargingCount: cachedDeviceInfo.deviceChargingCount || {},
                    deviceWearableCount: cachedDeviceInfo.deviceWearableCount || {},
                    deviceSystemVersionCount: cachedDeviceInfo.deviceSystemVersionCount || {},
                    departmentDeviceCount: cachedDeviceInfo.departmentDeviceCount || {},
                    batteryAnalysis: cachedDeviceInfo.batteryAnalysis || {}
                }
            };
            
            originalDeviceData = data;
            const devices = data.data.devices;
            const filtered = filterDevices(devices);
            currentFilteredData = filtered;
            
            console.log('📋 显示设备表格，设备数量:', filtered.length);
            displayDeviceTable(filtered);
            
            const aggregated = aggregateData(filtered);
            // 修复电池分布数据格式转换
            if (cachedDeviceInfo.chartData && cachedDeviceInfo.chartData.battery_distribution) {
                aggregated.batteryDistribution = {
                    low: cachedDeviceInfo.chartData.battery_distribution['0-20'] || 0,
                    medium: (cachedDeviceInfo.chartData.battery_distribution['21-50'] || 0) + (cachedDeviceInfo.chartData.battery_distribution['51-80'] || 0),
                    high: cachedDeviceInfo.chartData.battery_distribution['81-100'] || 0
                };
            }
            aggregated.batteryAnalysis = data.data.batteryAnalysis || {};
            
            console.log('📈 更新图表数据:', aggregated);
            updateCharts(aggregated);
        }

        // 面板切换功能
        function togglePanel(panelId) {
            const content = document.getElementById(panelId + 'Content');
            const toggle = document.getElementById(panelId + 'Toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = '▼';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = '▲';
            }
        }

        // 全局暴露函数
        window.togglePanel = togglePanel;
        
        // 手动刷新功能
        function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            const btnIcon = btn.querySelector('.btn-icon');
            const btnText = btn.querySelector('span:last-child');
            
            btnText.textContent = '刷新中...';
            btnIcon.style.animation = 'spin 1s linear infinite';
            btn.disabled = true;
            
            console.log('🔄 手动刷新设备数据...');
            updateDashboard().then(() => {
                btnText.textContent = '手动刷新';
                btnIcon.style.animation = '';
                btn.disabled = false;
                console.log('✅ 手动刷新完成');
            }).catch(error => {
                console.error('❌ 手动刷新失败:', error);
                btnText.textContent = '刷新失败';
                btnIcon.textContent = '❌';
                setTimeout(() => {
                    btnText.textContent = '手动刷新';
                    btnIcon.textContent = '🔄';
                    btnIcon.style.animation = '';
                    btn.disabled = false;
                }, 2000);
            });
        }
        
        // 切换自动刷新状态
        function toggleAutoRefresh() {
            const btn = document.getElementById('toggleAutoRefresh');
            const status = document.getElementById('refreshStatus');
            const statusDot = document.getElementById('statusDot');
            const btnIcon = document.getElementById('autoRefreshIcon');
            const btnText = document.getElementById('autoRefreshText');
            
            if (isAutoRefreshEnabled) {
                // 关闭自动刷新
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                isAutoRefreshEnabled = false;
                btnIcon.textContent = '▶️';
                btnText.textContent = '启动监控';
                status.textContent = '监控已暂停';
                statusDot.classList.add('paused');
                console.log('❌ 自动刷新已关闭');
            } else {
                // 开启自动刷新
                startAutoRefresh();
                isAutoRefreshEnabled = true;
                btnIcon.textContent = '⏸️';
                btnText.textContent = '暂停自动';
                status.textContent = '实时监控中';
                statusDot.classList.remove('paused');
                console.log('✅ 自动刷新已开启');
            }
        }
        
        // 启动自动刷新
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            autoRefreshTimer = setInterval(() => {
                if (isAutoRefreshEnabled) {
                    console.log('🔄 自动刷新设备数据...');
                    updateDashboard().catch(error => {
                        console.error('❌ 自动刷新失败:', error);
                    });
                }
            }, REFRESH_INTERVAL);
        }
        
        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }
        
        // 全局暴露刷新相关函数
        window.manualRefresh = manualRefresh;
        window.toggleAutoRefresh = toggleAutoRefresh;

        async function fetchDeviceInfo() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                const deptId = urlParams.get('deptId') || '';
                const userId = urlParams.get('userId') || '';

                const orgId = deptId || customerId;
                let url = `/get_devices_by_orgIdAndUserId?orgId=${orgId}`;
                if (userId && userId !== 'all') url += `&userId=${userId}`;
                
                console.log('🔍 调用设备API:', url);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ API返回成功:', result);
                    return result;
                }
                throw new Error('Failed to fetch device data');
            } catch (error) {
                console.error('❌ Error fetching device data:', error);
                return null;
            }
        }

        function displayDeviceTable(devices) {
            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>设备编号</th>
                            <th>所属部门</th>
                            <th>使用人员</th>
                            <th>设备状态</th>
                            <th>电池电量</th>
                            <th>充电状态</th>
                            <th>佩戴状态</th>
                            <th>系统版本</th>
                            <th>更新时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${devices.map(device => {
                            const battery = parseInt(device.battery_level) || 0;
                            let batteryClass = 'battery-medium';
                            if (battery <= 20) batteryClass = 'battery-low';
                            else if (battery >= 71) batteryClass = 'battery-high';

                            return `
                                <tr>
                                    <td title="${device.serial_number}">${device.serial_number}</td>
                                    <td title="${device.department_name}">${device.department_name}</td>
                                    <td title="${device.user_name}">${device.user_name}</td>
                                    <td>
                                        <span class="status-badge ${device.status === 'ACTIVE' ? 'status-active' : 'status-inactive'}">
                                            ${device.status === 'ACTIVE' ? '在线' : '离线'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="battery-container">
                                            <div class="battery-visual ${batteryClass}">
                                                <div class="battery-bar" style="width: ${battery}%;"></div>
                                            </div>
                                            <span class="battery-text">${battery}%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge ${device.charging_status === 'CHARGING' ? 'status-charging' : 'status-not-charging'}">
                                            ${device.charging_status === 'CHARGING' ? '充电中' : '未充电'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge ${device.wearable_status === 'WORN' ? 'status-worn' : 'status-not-worn'}">
                                            ${device.wearable_status === 'WORN' ? '已佩戴' : '未佩戴'}
                                        </span>
                                    </td>
                                    <td title="${device.system_software_version}">${device.system_software_version}</td>
                                    <td title="${device.update_time}">${device.update_time}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('deviceTable').innerHTML = tableHtml;
            document.getElementById('deviceCount').textContent = `共 ${devices.length} 台设备`;
        }

        function updateCharts(data) {
            // 部门分布饼图
            updateDepartmentChart(data.departmentDeviceCount);
            // 设备状态柱状图
            updateStatusChart(data.deviceStatusCount);
            // 充电状态饼图
            updateChargingChart(data.deviceChargingCount);
            // 佩戴状态饼图
            updateWearableChart(data.deviceWearableCount);
            // 电池分布柱状图
            updateBatteryChart(data.batteryDistribution);
            // 系统版本分布
            updateSystemVersionChart(data.deviceSystemVersionCount);
            // 电池趋势分析
            updateBatteryTrendChart(data.batteryAnalysis);
        }

        function updateDepartmentChart(data) {
            const chart = chartInstances.get('departmentChart');
            if (!chart) {
                console.error('❌ 部门图表未初始化');
                return;
            }
            
            const chartData = Object.entries(data || {}).map(([name, value]) => ({ name, value }));
            console.log('📊 部门分布图表数据:', chartData);
            
            chart.setOption({
                title: { 
                    text: '部门设备分布', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}台 ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['60%', '50%'],
                    data: chartData,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    },
                    label: {
                        formatter: '{b}: {c}台'
                    }
                }]
            });
        }

        function updateStatusChart(data) {
            const chart = chartInstances.get('statusChart');
            if (!chart) {
                console.error('❌ 状态图表未初始化');
                return;
            }
            
            const activeCount = data.ACTIVE || 0;
            const inactiveCount = data.INACTIVE || 0;
            console.log('📊 设备状态图表数据:', { active: activeCount, inactive: inactiveCount });
            
            chart.setOption({
                title: { 
                    text: '设备状态分布', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'axis',
                    formatter: '{b}: {c}台'
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%',
                    top: '20%'
                },
                xAxis: { 
                    type: 'category', 
                    data: ['在线', '离线'],
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } },
                    splitLine: { lineStyle: { color: 'rgba(0, 228, 255, 0.2)' } }
                },
                series: [{
                    type: 'bar',
                    data: [
                        {
                            value: activeCount,
                            itemStyle: { 
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    {offset: 0, color: '#52c41a'},
                                    {offset: 1, color: '#73d13d'}
                                ])
                            }
                        },
                        {
                            value: inactiveCount,
                            itemStyle: { 
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    {offset: 0, color: '#f5222d'},
                                    {offset: 1, color: '#ff4d4f'}
                                ])
                            }
                        }
                    ],
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}台',
                        color: '#fff'
                    },
                    barWidth: '50%'
                }]
            });
        }

        function updateChargingChart(data) {
            const chart = chartInstances.get('chargingChart');
            if (!chart) {
                console.error('❌ 充电图表未初始化');
                return;
            }
            
            const chargingCount = data.CHARGING || 0;
            const notChargingCount = data.NOT_CHARGING || 0;
            console.log('📊 充电状态图表数据:', { charging: chargingCount, notCharging: notChargingCount });
            
            chart.setOption({
                title: { 
                    text: '充电状态分布', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}台 ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: [
                        {
                            name: '充电中',
                            value: chargingCount,
                            itemStyle: { color: '#2196f3' }
                        },
                        {
                            name: '未充电',
                            value: notChargingCount,
                            itemStyle: { color: '#fa8c16' }
                        }
                    ],
                    label: {
                        formatter: '{b}: {c}台\n({d}%)',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateWearableChart(data) {
            const chart = chartInstances.get('wearableChart');
            if (!chart) {
                console.error('❌ 佩戴图表未初始化');
                return;
            }
            
            const wornCount = data.WORN || 0;
            const notWornCount = data.NOT_WORN || 0;
            console.log('📊 佩戴状态图表数据:', { worn: wornCount, notWorn: notWornCount });
            
            chart.setOption({
                title: { 
                    text: '佩戴状态分布', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}台 ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        {
                            name: '已佩戴',
                            value: wornCount,
                            itemStyle: { color: '#52c41a' }
                        },
                        {
                            name: '未佩戴',
                            value: notWornCount,
                            itemStyle: { color: '#f5222d' }
                        }
                    ],
                    label: {
                        formatter: '{b}: {c}台\n({d}%)',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateBatteryChart(data) {
            const chart = chartInstances.get('batteryChart');
            if (!chart) {
                console.error('❌ 电池图表未初始化');
                return;
            }
            
            console.log('📊 电池分布图表数据:', data);
            
            chart.setOption({
                title: { 
                    text: '电池电量分布', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'axis',
                    formatter: '{b}: {c}台'
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%',
                    top: '20%'
                },
                xAxis: { 
                    type: 'category', 
                    data: ['0-20%', '21-70%', '71-100%'],
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } },
                    splitLine: { lineStyle: { color: 'rgba(0, 228, 255, 0.2)' } }
                },
                series: [{
                    type: 'bar',
                    data: [
                        {
                            value: data['low'] || 0,
                            itemStyle: { color: '#f5222d' }
                        },
                        {
                            value: data['medium'] || 0,
                            itemStyle: { color: '#fa8c16' }
                        },
                        {
                            value: data['high'] || 0,
                            itemStyle: { color: '#52c41a' }
                        }
                    ],
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}台',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateSystemVersionChart(data) {
            const chart = chartInstances.get('systemVersionChart');
            const versions = Object.entries(data).map(([version, count]) => ({
                name: version.substring(0, 20) + (version.length > 20 ? '...' : ''),
                fullVersion: version,
                value: count
            }));

            chart.setOption({
                title: { 
                    text: '系统版本分布', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = params[0];
                        return `${data.data.fullVersion}<br/>数量：${data.data.value}台`;
                    }
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '25%',
                    top: '20%'
                },
                xAxis: {
                    type: 'category',
                    data: versions.map(v => v.name),
                    axisLabel: {
                        color: '#fff',
                        rotate: 45,
                        interval: 0
                    },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } },
                    splitLine: { lineStyle: { color: 'rgba(0, 228, 255, 0.2)' } }
                },
                series: [{
                    type: 'bar',
                    data: versions.map((v, index) => ({
                        value: v.value,
                        fullVersion: v.fullVersion,
                        itemStyle: {
                            color: `hsl(${(index * 360 / versions.length)}, 70%, 60%)`
                        }
                    })),
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}台',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateBatteryTrendChart(batteryAnalysis) {
            const chart = chartInstances.get('batteryTrendChart');
            
            if (!batteryAnalysis || Object.keys(batteryAnalysis).length === 0) {
                chart.setOption({
                    title: { 
                        text: '电池趋势分析', 
                        textStyle: { color: '#00e4ff', fontSize: 18 },
                        left: 'center'
                    },
                    graphic: {
                        type: 'text',
                        left: 'center',
                        top: 'middle',
                        style: {
                            text: '暂无电池分析数据',
                            fontSize: 16,
                            fill: '#fff'
                        }
                    }
                });
                return;
            }

            const devices = Object.keys(batteryAnalysis);
            const consumptionRates = devices.map(sn => batteryAnalysis[sn].consumption_rate || 0);
            const remainingHours = devices.map(sn => batteryAnalysis[sn].hours_remaining || 0);

            chart.setOption({
                title: { 
                    text: '电池消耗率与剩余时间分析', 
                    textStyle: { color: '#00e4ff', fontSize: 18 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let html = `设备: ${devices[params[0].dataIndex]}<br/>`;
                        params.forEach(param => {
                            html += `${param.seriesName}: ${param.value}${param.seriesName.includes('消耗率') ? '%/h' : 'h'}<br/>`;
                        });
                        return html;
                    }
                },
                legend: {
                    data: ['电池消耗率(%/h)', '剩余时间(h)'],
                    textStyle: { color: '#fff' },
                    top: '8%'
                },
                grid: {
                    left: '8%',
                    right: '8%',
                    bottom: '15%',
                    top: '18%'
                },
                xAxis: {
                    type: 'category',
                    data: devices.map(sn => sn.substring(sn.length - 6)),
                    axisLabel: { 
                        color: '#fff',
                        rotate: 45
                    },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '消耗率(%/h)',
                        position: 'left',
                        axisLabel: { color: '#fff' },
                        axisLine: { lineStyle: { color: '#00e4ff' } },
                        splitLine: { lineStyle: { color: 'rgba(0, 228, 255, 0.2)' } }
                    },
                    {
                        type: 'value',
                        name: '时间(h)',
                        position: 'right',
                        axisLabel: { color: '#fff' },
                        axisLine: { lineStyle: { color: '#fa8c16' } }
                    }
                ],
                series: [
                    {
                        name: '电池消耗率(%/h)',
                        type: 'bar',
                        yAxisIndex: 0,
                        data: consumptionRates,
                        itemStyle: { color: '#00e4ff' }
                    },
                    {
                        name: '剩余时间(h)',
                    type: 'line',
                        yAxisIndex: 1,
                        data: remainingHours,
                        itemStyle: { color: '#fa8c16' }
                    }
                ]
            });
        }

        function filterDevices(devices) {
            const statusFilter = document.getElementById('filterStatus')?.value;
            const chargingFilter = document.getElementById('filterCharging')?.value;
            const wearableFilter = document.getElementById('filterWearable')?.value;
            const batteryFilter = document.getElementById('filterBattery')?.value;

            return devices.filter(device => {
                const matchStatus = !statusFilter || device.status === statusFilter;
                const matchCharging = !chargingFilter || device.charging_status === chargingFilter;
                const matchWearable = !wearableFilter || device.wearable_status === wearableFilter;
                
                let matchBattery = true;
                if (batteryFilter) {
                    const battery = parseInt(device.battery_level) || 0;
                    switch(batteryFilter) {
                        case 'low':
                            matchBattery = battery <= 20;
                            break;
                        case 'medium':
                            matchBattery = battery > 20 && battery <= 70;
                            break;
                        case 'high':
                            matchBattery = battery > 70;
                            break;
                    }
                }
                
                return matchStatus && matchCharging && matchWearable && matchBattery;
            });
        }

        function aggregateData(devices) {
            // 根据实际API返回的数据结构进行聚合
            const aggregated = {
                departmentDeviceCount: {},
                deviceStatusCount: {},
                deviceChargingCount: {},
                deviceWearableCount: {},
                deviceSystemVersionCount: {},
                batteryDistribution: { low: 0, medium: 0, high: 0 }
            };

            devices.forEach(device => {
                // 部门统计
                const dept = device.department_name || '未知部门';
                aggregated.departmentDeviceCount[dept] = (aggregated.departmentDeviceCount[dept] || 0) + 1;

                // 状态统计
                const status = device.status || 'UNKNOWN';
                aggregated.deviceStatusCount[status] = (aggregated.deviceStatusCount[status] || 0) + 1;
                
                const charging = device.charging_status || 'UNKNOWN';
                aggregated.deviceChargingCount[charging] = (aggregated.deviceChargingCount[charging] || 0) + 1;
                
                const wearable = device.wearable_status || 'UNKNOWN';
                aggregated.deviceWearableCount[wearable] = (aggregated.deviceWearableCount[wearable] || 0) + 1;

                // 系统版本统计
                const version = device.system_software_version || '未知版本';
                aggregated.deviceSystemVersionCount[version] = (aggregated.deviceSystemVersionCount[version] || 0) + 1;

                // 电池分布
                const battery = parseInt(device.battery_level) || 0;
                if (battery <= 20) aggregated.batteryDistribution.low++;
                else if (battery <= 70) aggregated.batteryDistribution.medium++;
                else aggregated.batteryDistribution.high++;
            });

            return aggregated;
        }

        function resetFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCharging').value = '';
            document.getElementById('filterWearable').value = '';
            document.getElementById('filterBattery').value = '';
            updateDashboard();
        }

        // 获取设备历史趋势数据
        async function fetchDeviceHistoryTrends(days = 7) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const orgId = urlParams.get('orgId') || '1';
                const userId = urlParams.get('userId') || '';
                
                const response = await fetch(`/api/device/history/trends?orgId=${orgId}&userId=${userId}&days=${days}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('获取设备历史趋势失败:', error);
                return { success: false, message: error.message };
            }
        }

        // 获取电池预测数据
        async function fetchBatteryPrediction(days = 30) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const orgId = urlParams.get('orgId') || '1';
                const userId = urlParams.get('userId') || '';
                
                const response = await fetch(`/api/device/battery/prediction?orgId=${orgId}&userId=${userId}&days=${days}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('获取电池预测失败:', error);
                return { success: false, message: error.message };
            }
        }

        // 获取综合设备分析数据
        async function fetchComprehensiveAnalysis(days = 7) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const orgId = urlParams.get('orgId') || '1';
                const userId = urlParams.get('userId') || '';
                
                const response = await fetch(`/api/device/analysis/comprehensive?orgId=${orgId}&userId=${userId}&days=${days}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('获取综合分析失败:', error);
                return { success: false, message: error.message };
            }
        }

        async function updateDashboard() {
            try {
                // 如果有缓存数据，优先使用缓存数据
                if (cachedDeviceInfo) {
                    console.log('✅ 使用传递的缓存数据，避免重复接口调用');
                    updateDashboardWithCachedData();
                    // 获取历史趋势数据
                    await updateHistoryTrends();
                    return Promise.resolve();
                }
                
                // 没有缓存数据时，调用接口获取
                console.log('❌ 未接收到缓存数据，将调用接口获取');
                const data = await fetchDeviceInfo();
                console.log('Fetched data:', data); // 调试信息
                
                if (data && data.success && data.data && data.data.devices) {
                    originalDeviceData = data;
                    const devices = data.data.devices;
                    const filtered = filterDevices(devices);
                    currentFilteredData = filtered;
                    
                    console.log('Filtered devices:', filtered.length); // 调试信息
                    
                    displayDeviceTable(filtered);
                    const aggregated = aggregateData(filtered);
                    
                    console.log('Aggregated data:', aggregated); // 调试信息
                    
                    // 使用API返回的电池分析数据
                    aggregated.batteryAnalysis = data.data.batteryAnalysis || {};
                    updateCharts(aggregated);
                    
                    // 获取历史趋势数据
                    await updateHistoryTrends();
                    return Promise.resolve();
                } else {
                    console.error('Invalid data structure:', data);
                    return Promise.reject(new Error('Invalid data structure'));
                }
            } catch (error) {
                console.error('❌ 更新仪表板失败:', error);
                return Promise.reject(error);
            }
        }

        // 更新历史趋势图表 - 使用真实数据
        async function updateHistoryTrends() {
            try {
                console.log('🔄 开始获取真实历史趋势数据...');
                
                const urlParams = new URLSearchParams(window.location.search);
                const orgId = urlParams.get('orgId') || urlParams.get('customerId') || '1';
                const userId = urlParams.get('userId') || '';
                
                // 获取真实的历史趋势数据
                const trendsResponse = await fetch(`/api/device/history/trends?orgId=${orgId}&userId=${userId}&days=7`);
                const trendsData = await trendsResponse.json();
                
                console.log('📊 真实趋势数据:', trendsData);
                
                if (trendsData.success && trendsData.data && trendsData.data.chart_data) {
                    const chartData = trendsData.data.chart_data;
                    const trendsAnalysis = trendsData.data.trends_analysis;
                    
                    console.log('📈 使用真实图表数据:', chartData);
                    
                    // 更新佩戴状态趋势图
                    updateWearTrendChart(chartData.wear_status_timeline);
                    
                    // 更新充电状态趋势图
                    updateChargingTrendChart(chartData.charging_pattern_chart);
                    
                    // 更新电池电量时序图
                    updateBatteryTrendChart(chartData.battery_trend_line);
                    
                    // 更新设备健康雷达图
                    updateDeviceHealthRadar(trendsAnalysis);
                    
                    // 更新在线率趋势图
                    updateUptimeTrendChart(chartData.status_uptime_chart);
                    
                    console.log('✅ 真实历史趋势图表更新完成');
                } else {
                    console.warn('⚠️ 未获取到有效的真实趋势数据，使用模拟数据');
                    const mockData = generateMockTrendData();
                    updateWearTrendChart(mockData.wearable_status);
                    updateChargingTrendChart(mockData.charging_status);
                    updateBatteryTrendChart(mockData.battery_trend);
                    updateDeviceHealthRadar(mockData.health_radar);
                    updateUptimeTrendChart(mockData.uptime_trend);
                }
                
                // 获取电池预测数据
                try {
                    const predictionResponse = await fetch(`/api/device/battery/prediction?orgId=${orgId}&userId=${userId}&days=30`);
                    const predictionData = await predictionResponse.json();
                    
                    if (predictionData.success && predictionData.data && predictionData.data.chart_data) {
                        console.log('🔋 使用真实电池预测数据');
                        updateBatteryPredictionChart(predictionData.data.chart_data);
                    } else {
                        console.warn('⚠️ 电池预测数据获取失败，使用模拟数据');
                        const mockData = generateMockTrendData();
                        updateBatteryPredictionChart(mockData.battery_prediction);
                    }
                } catch (error) {
                    console.error('❌ 电池预测数据获取失败:', error);
                    const mockData = generateMockTrendData();
                    updateBatteryPredictionChart(mockData.battery_prediction);
                }
                
            } catch (error) {
                console.error('❌ 更新历史趋势失败:', error);
                // 使用模拟数据作为后备
                const mockData = generateMockTrendData();
                updateWearTrendChart(mockData.wearable_status);
                updateChargingTrendChart(mockData.charging_status);
                updateBatteryTrendChart(mockData.battery_trend);
                updateDeviceHealthRadar(mockData.health_radar);
                updateBatteryPredictionChart(mockData.battery_prediction);
                updateUptimeTrendChart(mockData.uptime_trend);
            }
        }

        // 生成模拟趋势数据用于测试
        function generateMockTrendData() {
            const dates = [];
            const now = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }));
            }
            
            return {
                wearable_status: {
                    dates: dates,
                    worn_count: [3, 4, 2, 4, 3, 4, 4],
                    not_worn_count: [1, 0, 2, 0, 1, 0, 0]
                },
                charging_status: {
                    dates: dates,
                    charging_count: [1, 2, 1, 2, 1, 2, 2],
                    not_charging_count: [3, 2, 3, 2, 3, 2, 2]
                },
                battery_trend: {
                    dates: dates,
                    battery_levels: [85, 82, 78, 75, 72, 68, 65]
                },
                health_radar: {
                    battery_level: { avg_level: 75 },
                    uptime_rate: 0.85,
                    wearable_status: { wear_rate: 0.8 },
                    charging_status: { charge_rate: 0.3 },
                    system_version: { latest_rate: 0.9 }
                },
                battery_prediction: {
                    dates: ['12-20', '12-21', '12-22', '12-23', '12-24', '12-25', '12-26'],
                    historical: [85, 82, 78, 75, 72, 68, 65],
                    predicted: [62, 58, 54, 50, 46, 42, 38]
                },
                uptime_trend: {
                    dates: dates,
                    uptime_rates: [85, 90, 78, 92, 88, 95, 87]
                }
            };
        }

        function initCharts() {
            const chartIds = [
                'departmentChart', 'statusChart', 'chargingChart',
                'wearableChart', 'batteryChart', 'systemVersionChart', 'batteryTrendChart',
                'wearTrendChart', 'chargingTrendChart', 'deviceHealthRadar', 
                'batteryPredictionChart', 'uptimeTrendChart'
            ];
            
            console.log('📈 开始初始化图表...');
            chartIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const chart = echarts.init(element);
                    chartInstances.set(id, chart);
                    console.log(`✅ 图表 ${id} 初始化成功`);
                } else {
                    console.error(`❌ 图表容器 ${id} 不存在`);
                }
            });
            console.log(`📊 图表初始化完成，共 ${chartInstances.size} 个图表`);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function initDashboard() {
            console.log('🚀 开始初始化仪表板...');
            initCharts();
            
            // 等待一小段时间，看是否有缓存数据传递过来
            setTimeout(async () => {
                if (cachedDeviceInfo) {
                    console.log('✅ 使用传递的缓存数据，避免重复接口调用');
                    updateDashboardWithCachedData();
                } else {
                    console.log('❌ 未接收到缓存数据，将调用接口获取');
                    await updateDashboard();
                }
                
                // 启动自动刷新（5秒间隔）
                if (isAutoRefreshEnabled) {
                    startAutoRefresh();
                    console.log('🔄 自动刷新已启动，间隔:', REFRESH_INTERVAL/1000, '秒');
                }
            }, 1000); // 等待1秒让postMessage有时间传递数据

            // 窗口调整时重新渲染图表
            window.addEventListener('resize', debounce(() => {
                console.log('🔄 窗口大小变化，重新渲染图表');
                chartInstances.forEach(chart => chart.resize());
            }, 250));
            
            // 页面卸载时停止自动刷新
            window.addEventListener('beforeunload', () => {
                stopAutoRefresh();
                console.log('🛑 页面卸载，自动刷新已停止');
            });
            
            // 页面隐藏时暂停自动刷新，显示时恢复
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopAutoRefresh();
                    console.log('⏸️ 页面隐藏，自动刷新已暂停');
                } else if (isAutoRefreshEnabled) {
                    startAutoRefresh();
                    console.log('▶️ 页面显示，自动刷新已恢复');
                }
            });
            
            // 默认展开过滤器面板
            togglePanel('filterPanel');
            console.log('✅ 仪表板初始化完成');
        }

        // 更新佩戴状态趋势图 - 使用真实数据
        function updateWearTrendChart(data) {
            const chart = chartInstances.get('wearTrendChart');
            if (!chart || !data) return;
            
            console.log('👕 佩戴状态时序图原始数据:', data);
            
            // 处理按设备分组的数据格式
            const deviceSeries = [];
            const allTimestamps = new Set();
            
            // 收集所有时间戳
            Object.values(data).forEach(deviceData => {
                if (deviceData.timestamps) {
                    deviceData.timestamps.forEach(ts => allTimestamps.add(ts));
                }
            });
            
            // 转换为排序的时间数组
            const sortedTimes = Array.from(allTimestamps).sort();
            const dates = sortedTimes.map(ts => {
                const date = new Date(ts);
                return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            });
            
            // 为每个设备创建数据系列
            Object.entries(data).forEach(([deviceSn, deviceData], index) => {
                if (deviceData.values && deviceData.values.length > 0) {
                    const colors = ['#00e4ff', '#ff6b6b', '#ffbb00', '#a855f7'];
                    const color = colors[index % colors.length];
                    
                    deviceSeries.push({
                        name: `${deviceSn.slice(-4)}设备`,
                        type: 'line',
                        data: deviceData.values,
                        smooth: false,
                        step: 'end',
                        lineStyle: { color: color, width: 2 },
                        itemStyle: { color: color }
                    });
                }
            });
            
            console.log('👕 处理后的佩戴数据:', { dates: dates.slice(0, 10), deviceSeries });
            
            const option = {
                title: { text: '佩戴状态时序图', textStyle: { color: '#00e4ff', fontSize: 16 } },
                backgroundColor: 'transparent',
                grid: { left: '10%', right: '10%', top: '20%', bottom: '15%' },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,21,41,0.9)',
                    borderColor: 'rgba(0,228,255,0.5)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const time = params[0].axisValue;
                        let html = `${time}<br/>`;
                        params.forEach(param => {
                            html += `${param.seriesName}: ${param.value}台<br/>`;
                        });
                        return html;
                    }
                },
                legend: {
                    data: deviceSeries.map(s => s.name),
                    textStyle: { color: '#7ecfff' },
                    top: '5%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { color: '#7ecfff', fontSize: 10, rotate: 45 },
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } }
                },
                yAxis: {
                    type: 'value',
                    min: 0, max: 1,
                    axisLabel: { 
                        color: '#7ecfff',
                        formatter: function(value) {
                            return value === 1 ? '佩戴' : '未戴';
                        }
                    },
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } },
                    splitLine: { lineStyle: { color: 'rgba(0,228,255,0.1)' } }
                },
                series: deviceSeries
            };
            
            chart.setOption(option);
        }

        // 更新充电状态趋势图 - 使用真实数据
        function updateChargingTrendChart(data) {
            const chart = chartInstances.get('chargingTrendChart');
            if (!chart || !data) return;
            
            console.log('🔌 充电状态时序图原始数据:', data);
            
            // 处理按设备分组的数据格式
            const deviceSeries = [];
            const allTimestamps = new Set();
            
            // 收集所有时间戳
            Object.values(data).forEach(deviceData => {
                if (deviceData.timestamps) {
                    deviceData.timestamps.forEach(ts => allTimestamps.add(ts));
                }
            });
            
            // 转换为排序的时间数组
            const sortedTimes = Array.from(allTimestamps).sort();
            const dates = sortedTimes.map(ts => {
                const date = new Date(ts);
                return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            });
            
            // 为每个设备创建数据系列
            Object.entries(data).forEach(([deviceSn, deviceData], index) => {
                if (deviceData.values && deviceData.values.length > 0) {
                    const colors = ['#ffbb00', '#fa8c16', '#ff6b6b', '#a855f7'];
                    const color = colors[index % colors.length];
                    
                    deviceSeries.push({
                        name: `${deviceSn.slice(-4)}设备`,
                        type: 'line',
                        data: deviceData.values,
                        smooth: false,
                        step: 'end',
                        lineStyle: { color: color, width: 2 },
                        itemStyle: { color: color }
                    });
                }
            });
            
            console.log('🔌 处理后的充电数据:', { dates: dates.slice(0, 10), deviceSeries });
            
            const option = {
                title: { text: '充电状态时序图', textStyle: { color: '#ffbb00', fontSize: 16 } },
                backgroundColor: 'transparent',
                grid: { left: '10%', right: '10%', top: '20%', bottom: '15%' },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,21,41,0.9)',
                    borderColor: 'rgba(255,187,0,0.5)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const time = params[0].axisValue;
                        let html = `${time}<br/>`;
                        params.forEach(param => {
                            html += `${param.seriesName}: ${param.value}台<br/>`;
                        });
                        return html;
                    }
                },
                legend: {
                    data: deviceSeries.map(s => s.name),
                    textStyle: { color: '#7ecfff' },
                    top: '5%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { color: '#7ecfff', fontSize: 10, rotate: 45 },
                    axisLine: { lineStyle: { color: 'rgba(255,187,0,0.3)' } }
                },
                yAxis: {
                    type: 'value',
                    min: 0, max: 1,
                    axisLabel: { 
                        color: '#7ecfff',
                        formatter: function(value) {
                            return value === 1 ? '充电' : '待机';
                        }
                    },
                    axisLine: { lineStyle: { color: 'rgba(255,187,0,0.3)' } },
                    splitLine: { lineStyle: { color: 'rgba(255,187,0,0.1)' } }
                },
                series: deviceSeries
            };
            
            chart.setOption(option);
        }

        // 更新设备健康雷达图 - 使用真实数据
        function updateDeviceHealthRadar(trends) {
            const chart = chartInstances.get('deviceHealthRadar');
            if (!chart || !trends) return;
            
            console.log('🎯 设备健康雷达图数据:', trends);
            
            // 处理真实趋势分析数据
            let healthScore = { battery: 0, uptime: 0, wear: 0, charging: 0, version: 0 };
            
            if (trends.battery_trends) {
                // 计算所有设备的平均电池健康度
                const batteryValues = Object.values(trends.battery_trends);
                if (batteryValues.length > 0) {
                    const avgBattery = batteryValues.reduce((sum, item) => sum + (item.avg_battery || 0), 0) / batteryValues.length;
                    healthScore.battery = Math.round(avgBattery);
                }
            }
            
            if (trends.status_stability) {
                // 计算所有设备的平均在线率
                const uptimeValues = Object.values(trends.status_stability);
                if (uptimeValues.length > 0) {
                    const avgUptime = uptimeValues.reduce((sum, item) => sum + (item.uptime_rate || 0), 0) / uptimeValues.length;
                    healthScore.uptime = Math.round(avgUptime);
                }
            }
            
            if (trends.usage_patterns) {
                // 计算所有设备的平均佩戴率
                const wearValues = Object.values(trends.usage_patterns);
                if (wearValues.length > 0) {
                    const avgWear = wearValues.reduce((sum, item) => sum + (item.wear_rate || 0), 0) / wearValues.length;
                    healthScore.wear = Math.round(avgWear);
                }
            }
            
            if (trends.charging_patterns) {
                // 计算所有设备的平均充电效率
                const chargingValues = Object.values(trends.charging_patterns);
                if (chargingValues.length > 0) {
                    const avgCharging = chargingValues.reduce((sum, item) => sum + (item.charging_rate || 0), 0) / chargingValues.length;
                    healthScore.charging = Math.round(avgCharging);
                }
            }
            
            if (trends.version_distribution) {
                // 计算版本更新率（使用最新版本的设备比例）
                const versionValues = Object.values(trends.version_distribution);
                if (versionValues.length > 0) {
                    const latestVersionCount = versionValues.filter(item => item.version_changes === 0).length;
                    healthScore.version = Math.round((latestVersionCount / versionValues.length) * 100);
                }
            }
            
            console.log('📊 计算后的健康评分:', healthScore);
            
            const option = {
                title: { text: '设备健康雷达图', textStyle: { color: '#fff', fontSize: 16 } },
                backgroundColor: 'transparent',
                radar: {
                    indicator: [
                        { name: '电池健康', max: 100 },
                        { name: '在线率', max: 100 },
                        { name: '佩戴率', max: 100 },
                        { name: '充电效率', max: 100 },
                        { name: '版本更新率', max: 100 }
                    ],
                    axisName: { color: '#7ecfff', fontSize: 12 },
                    axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } },
                    splitLine: { lineStyle: { color: 'rgba(0,228,255,0.2)' } },
                    splitArea: { show: false }
                },
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,21,41,0.9)',
                    borderColor: 'rgba(0,228,255,0.5)',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'radar',
                    data: [{
                        value: [healthScore.battery, healthScore.uptime, healthScore.wear, healthScore.charging, healthScore.version],
                        name: '设备健康指标',
                        itemStyle: { color: '#00e4ff' },
                        lineStyle: { color: '#00e4ff', width: 2 },
                        areaStyle: { 
                            color: new echarts.graphic.RadialGradient(0.5, 0.5, 0.5, [
                                { offset: 0, color: 'rgba(0,228,255,0.3)' },
                                { offset: 1, color: 'rgba(0,228,255,0.1)' }
                            ])
                        }
                    }]
                }]
            };
            chart.setOption(option);
        }

        // 更新电池电量时序图 - 使用真实数据
        function updateBatteryTrendChart(data) {
            const chart = chartInstances.get('batteryTrendChart');
            if (!chart || !data) return;
            
            console.log('🔋 电池电量时序图原始数据:', data);
            
            // 处理按设备分组的数据格式
            const deviceSeries = [];
            const allTimestamps = new Set();
            
            // 收集所有时间戳
            Object.values(data).forEach(deviceData => {
                if (deviceData.timestamps) {
                    deviceData.timestamps.forEach(ts => allTimestamps.add(ts));
                }
            });
            
            // 转换为排序的时间数组，并格式化为小时显示
            const sortedTimes = Array.from(allTimestamps).sort();
            const dates = sortedTimes.map(ts => {
                const date = new Date(ts);
                return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            });
            
            // 为每个设备创建数据系列
            Object.entries(data).forEach(([deviceSn, deviceData], index) => {
                if (deviceData.values && deviceData.values.length > 0) {
                    const colors = ['#00ff88', '#00e4ff', '#ffbb00', '#ff6b6b'];
                    const color = colors[index % colors.length];
                    
                    deviceSeries.push({
                        name: `${deviceSn.slice(-4)}设备`,
                        type: 'line',
                        data: deviceData.values,
                        smooth: true,
                        lineStyle: { color: color, width: 2 },
                        itemStyle: { color: color }
                    });
                }
            });
            
            console.log('🔋 处理后的电池数据:', { dates: dates.slice(0, 10), deviceSeries });
            
            const option = {
                title: { text: '电池电量时序图', textStyle: { color: '#00ff88', fontSize: 16 } },
                backgroundColor: 'transparent',
                grid: { left: '10%', right: '10%', top: '20%', bottom: '15%' },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,21,41,0.9)',
                    borderColor: 'rgba(0,255,136,0.5)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const time = params[0].axisValue;
                        let html = `${time}<br/>`;
                        params.forEach(param => {
                            html += `${param.seriesName}: ${param.value}%<br/>`;
                        });
                        return html;
                    }
                },
                legend: {
                    data: deviceSeries.map(s => s.name),
                    textStyle: { color: '#7ecfff' },
                    top: '5%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { color: '#7ecfff', fontSize: 10, rotate: 45 },
                    axisLine: { lineStyle: { color: 'rgba(0,255,136,0.3)' } }
                },
                yAxis: {
                    type: 'value',
                    min: 0, max: 100,
                    axisLabel: { 
                        color: '#7ecfff',
                        formatter: '{value}%'
                    },
                    axisLine: { lineStyle: { color: 'rgba(0,255,136,0.3)' } },
                    splitLine: { lineStyle: { color: 'rgba(0,255,136,0.1)' } }
                },
                series: deviceSeries,
                markLine: {
                    data: [
                        { yAxis: 20, lineStyle: { color: '#ff6666', type: 'dashed' }, label: { formatter: '低电量警戒线' } },
                        { yAxis: 80, lineStyle: { color: '#00ff88', type: 'dashed' }, label: { formatter: '充电建议线' } }
                    ]
                }
            };
            
            chart.setOption(option);
        }

        // 更新电池预测图
        function updateBatteryPredictionChart(data) {
            const chart = chartInstances.get('batteryPredictionChart');
            if (!chart || !data) return;
            
            const option = {
                title: { text: '电池使用预测', textStyle: { color: '#00ff88', fontSize: 16 } },
                backgroundColor: 'transparent',
                grid: { left: '10%', right: '10%', top: '20%', bottom: '15%' },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,21,41,0.9)',
                    borderColor: 'rgba(0,255,136,0.5)',
                    textStyle: { color: '#fff' }
                },
                legend: { 
                    data: ['历史数据', '预测数据', '预警线'], 
                    textStyle: { color: '#7ecfff' },
                    top: '5%'
                },
                xAxis: { 
                    type: 'category', 
                    data: data.dates, 
                    axisLabel: { color: '#7ecfff', fontSize: 10, rotate: 45 },
                    axisLine: { lineStyle: { color: 'rgba(0,255,136,0.3)' } }
                },
                yAxis: { 
                    type: 'value', 
                    name: '电量(%)', 
                    min: 0, max: 100, 
                    axisLabel: { color: '#7ecfff', formatter: '{value}%' },
                    axisLine: { lineStyle: { color: 'rgba(0,255,136,0.3)' } },
                    splitLine: { lineStyle: { color: 'rgba(0,255,136,0.1)' } }
                },
                series: [
                    { 
                        name: '历史数据', 
                        type: 'line', 
                        data: data.historical, 
                        itemStyle: { color: '#00ff88' },
                        lineStyle: { width: 2 }
                    },
                    { 
                        name: '预测数据', 
                        type: 'line', 
                        data: data.predicted, 
                        itemStyle: { color: '#ffbb00' }, 
                        lineStyle: { type: 'dashed', width: 2 }
                    },
                    { 
                        name: '预警线', 
                        type: 'line', 
                        data: Array(data.dates.length).fill(20), 
                        itemStyle: { color: '#ff6666' }, 
                        lineStyle: { type: 'dotted', width: 2 }
                    }
                ]
            };
            chart.setOption(option);
        }

        // 更新在线率趋势图 - 使用真实数据
        function updateUptimeTrendChart(data) {
            const chart = chartInstances.get('uptimeTrendChart');
            if (!chart || !data) return;
            
            console.log('📶 在线率趋势图原始数据:', data);
            
            // 处理按设备分组的数据格式
            const deviceSeries = [];
            const allTimestamps = new Set();
            
            // 收集所有时间戳
            Object.values(data).forEach(deviceData => {
                if (deviceData.timestamps) {
                    deviceData.timestamps.forEach(ts => allTimestamps.add(ts));
                }
            });
            
            // 转换为排序的时间数组
            const sortedTimes = Array.from(allTimestamps).sort();
            const dates = sortedTimes.map(ts => {
                const date = new Date(ts);
                return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            });
            
            // 为每个设备创建数据系列
            Object.entries(data).forEach(([deviceSn, deviceData], index) => {
                if (deviceData.values && deviceData.values.length > 0) {
                    const colors = ['#9d4edd', '#c77dff', '#e0aaff', '#ffc8dd'];
                    const color = colors[index % colors.length];
                    
                    deviceSeries.push({
                        name: `${deviceSn.slice(-4)}设备`,
                        type: 'bar',
                        data: deviceData.values.map(v => v * 100), // 转换为百分比
                        itemStyle: { 
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: color },
                                { offset: 1, color: color + '80' }
                            ])
                        }
                    });
                }
            });
            
            console.log('📶 处理后的在线率数据:', { dates: dates.slice(0, 10), deviceSeries });
            
            const option = {
                title: { text: '设备在线率时序图', textStyle: { color: '#9d4edd', fontSize: 16 } },
                backgroundColor: 'transparent',
                grid: { left: '10%', right: '10%', top: '20%', bottom: '15%' },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,21,41,0.9)',
                    borderColor: 'rgba(157,78,221,0.5)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const time = params[0].axisValue;
                        const rate = params[0].value;
                        return `${time}<br/>在线率: ${rate}%`;
                    }
                },
                legend: {
                    data: deviceSeries.map(s => s.name),
                    textStyle: { color: '#7ecfff' },
                    top: '5%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { color: '#7ecfff', fontSize: 10, rotate: 45 },
                    axisLine: { lineStyle: { color: 'rgba(157,78,221,0.3)' } }
                },
                yAxis: {
                    type: 'value',
                    min: 0, max: 100,
                    axisLabel: { 
                        color: '#7ecfff',
                        formatter: '{value}%'
                    },
                    axisLine: { lineStyle: { color: 'rgba(157,78,221,0.3)' } },
                    splitLine: { lineStyle: { color: 'rgba(157,78,221,0.1)' } }
                },
                series: deviceSeries
            };
            
            chart.setOption(option);
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>