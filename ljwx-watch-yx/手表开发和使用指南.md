# 智能手表开发和使用指南

## 项目概述

本项目是一个基于HarmonyOS 3.0开发的智能健康手表应用，主要用于采集用户健康数据（心率、血氧、体温、步数等）并上传至后台服务。

## 目录结构

```
ljwx-watch/
├── entry/                          # 主应用模块
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/com/hg/watch/   # Java源码目录
│   │   │   └── resources/           # 资源文件
│   │   ├── ohosTest/                # 测试代码
│   │   └── test/                    # 单元测试
│   └── libs/                        # 第三方库
├── gradle/wrapper/                  # Gradle包装器
└── README.md
```

## 核心功能模块

### 1. 主界面 (MainAbility & MainAbilitySlice)
- **功能**: 应用主入口，显示健康数据概览
- **已删除文件**: 
  - `MainAbility.java` - 主Ability类
  - `slice/MainAbilitySlice.java` - 主界面切片
- **实现要点**:
  - 初始化应用UI组件
  - 启动各种服务（蓝牙、HTTP、数据管理）
  - 显示实时健康数据
  - 处理用户交互事件

### 2. 蓝牙服务 (BluetoothService)
- **功能**: 管理与健康传感器的蓝牙连接
- **已删除文件**: `BluetoothService.java`
- **核心功能**:
  - 蓝牙设备扫描和配对
  - 建立与健康传感器的连接
  - 接收实时健康数据
  - 处理连接异常和重连
- **关键API**:
  ```java
  // 蓝牙连接管理
  BluetoothAdapter.getDefaultAdapter()
  BluetoothDevice.connectGatt()
  BluetoothGattCallback.onCharacteristicChanged()
  ```

### 3. HTTP通信服务 (HttpService)
- **功能**: 与后台服务器进行数据通信
- **已删除文件**: `HttpService.java`
- **主要接口**:
  - `/upload_health_data` - 上传健康数据
  - `/upload_device_info` - 上传设备信息
  - `/common_event` - 上传通用事件
- **数据格式示例**:
  ```json
  {
    "deviceSn": "A5GTQ24B26000001",
    "userId": "user123",
    "heartRate": 72,
    "bloodOxygen": 98,
    "bodyTemperature": 36.5,
    "timestamp": 1699001234567
  }
  ```

### 4. 健康数据缓存 (HealthDataCache)
- **功能**: 本地数据缓存和管理
- **已删除文件**: `HealthDataCache.java`
- **缓存策略**:
  - 实时数据临时存储
  - 网络异常时的数据暂存
  - 批量上传优化
  - 数据去重和验证

### 5. 数据管理器 (DataManager)
- **功能**: 统一数据处理和协调
- **已删除文件**: `utils/DataManager.java`
- **核心职责**:
  - 数据收集调度
  - 数据格式标准化
  - 上传队列管理
  - 异常处理和重试

## 开发环境配置

### 前置要求
- **HarmonyOS SDK 3.0+**
- **DevEco Studio 3.0+**
- **Java JDK 11+**
- **HarmonyOS设备或模拟器**

### 配置步骤
1. **安装DevEco Studio**
   ```bash
   # 下载地址
   https://developer.harmonyos.com/cn/develop/deveco-studio
   ```

2. **配置SDK**
   ```bash
   # SDK路径配置
   File → Settings → HarmonyOS → SDK Manager
   # 安装API Level 3.0
   ```

3. **创建签名文件**
   ```bash
   # 生成签名
   Build → Generate Signed Bundle/APK
   ```

## 核心API使用

### 健康数据采集
```java
// 心率监测
public void startHeartRateMonitoring() {
    HealthSensorManager.startSensor(HEART_RATE_SENSOR);
}

// 血氧检测
public void measureBloodOxygen() {
    HealthSensorManager.measureOnce(BLOOD_OXYGEN_SENSOR);
}

// 体温测量
public void measureBodyTemperature() {
    TemperatureSensor.startMeasurement();
}
```

### 数据上传流程
```java
public class DataUploadFlow {
    // 1. 数据收集
    private HealthData collectHealthData() {
        return new HealthData.Builder()
            .setHeartRate(heartRateSensor.getCurrentValue())
            .setBloodOxygen(bloodOxygenSensor.getCurrentValue())
            .setBodyTemperature(temperatureSensor.getCurrentValue())
            .setTimestamp(System.currentTimeMillis())
            .build();
    }
    
    // 2. 数据缓存
    private void cacheData(HealthData data) {
        HealthDataCache.getInstance().put(data);
    }
    
    // 3. 批量上传
    private void uploadBatch() {
        List<HealthData> batch = HealthDataCache.getInstance().getBatch();
        HttpService.uploadHealthData(batch);
    }
}
```

## 常见问题和解决方案

### 1. 蓝牙连接问题

**问题**: 无法连接到健康传感器
```
错误: BluetoothGatt: Connection timeout
```

**解决方案**:
```java
// 增加重连机制
private void retryBluetoothConnection() {
    if (retryCount < MAX_RETRY_COUNT) {
        new Timer().schedule(new TimerTask() {
            @Override
            public void run() {
                connectToHealthSensor();
                retryCount++;
            }
        }, RETRY_DELAY);
    }
}
```

### 2. 数据上传失败

**问题**: 网络异常导致数据丢失
```
错误: java.net.ConnectException: Connection refused
```

**解决方案**:
```java
// 实现离线缓存
public void uploadWithOfflineSupport(HealthData data) {
    try {
        httpService.upload(data);
    } catch (NetworkException e) {
        // 保存到本地缓存
        localCache.save(data);
        // 设置重试任务
        scheduleRetryTask();
    }
}
```

### 3. 传感器读取异常

**问题**: 传感器数据不准确或读取失败
```
错误: Sensor reading failed: Invalid data
```

**解决方案**:
```java
// 数据验证和过滤
private boolean validateHealthData(HealthData data) {
    return data.getHeartRate() >= 40 && data.getHeartRate() <= 200 &&
           data.getBloodOxygen() >= 70 && data.getBloodOxygen() <= 100 &&
           data.getBodyTemperature() >= 35.0 && data.getBodyTemperature() <= 42.0;
}
```

### 4. 内存泄漏问题

**问题**: 长时间运行后应用响应变慢
```
错误: OutOfMemoryError: Java heap space
```

**解决方案**:
```java
// 及时释放资源
@Override
protected void onDestroy() {
    super.onDestroy();
    if (bluetoothService != null) {
        bluetoothService.disconnect();
        bluetoothService = null;
    }
    if (healthDataCache != null) {
        healthDataCache.clear();
    }
}
```

## 性能优化建议

### 1. 数据采集优化
- 设置合理的采集频率（心率1秒，血氧30秒）
- 使用传感器休眠机制节省电池
- 实现智能采集（运动时增加频率）

### 2. 网络请求优化
- 批量上传减少网络请求次数
- 使用数据压缩减少传输量
- 实现请求队列管理

### 3. 电池优化
```java
// 使用低功耗模式
public void enableLowPowerMode() {
    PowerManager pm = (PowerManager) getSystemService(POWER_SERVICE);
    pm.setSuspendOptimizationEnabled(false);
}
```

## 调试和日志

### 日志配置
```java
// 配置日志级别
private static final String TAG = "HealthWatch";
private static final boolean DEBUG = BuildConfig.DEBUG;

public static void log(String message) {
    if (DEBUG) {
        HiLog.info(LABEL_LOG, TAG + ": " + message);
    }
}
```

### 常用调试命令
```bash
# 查看应用日志
hdc hilog -T HEALTH_WATCH

# 性能监控
hdc shell dumpsys meminfo com.hg.watch

# 网络抓包
hdc shell tcpdump -i any -w /sdcard/capture.pcap
```

## 部署和发布

### 1. 构建APK
```bash
# Debug版本
./gradlew assembleDebug

# Release版本
./gradlew assembleRelease
```

### 2. 安装到设备
```bash
# 通过hdc安装
hdc install entry-debug.hap

# 通过DevEco Studio安装
Run → Run 'entry'
```

### 3. 发布到应用市场
- 完成应用签名
- 准备应用截图和描述
- 提交华为应用市场审核

## 维护和更新

### 版本管理
- 使用语义化版本号（如v1.2.3）
- 维护版本更新日志
- 实现增量更新机制

### 监控和告警
- 集成应用性能监控
- 设置崩溃率告警
- 监控关键指标（数据上传成功率、电池消耗等）

## 联系方式

**开发团队**: 智能科技有限公司  
**技术支持**: tech-support@company.com  
**项目地址**: https://github.com/company/ljwx-watch  

---
*最后更新: 2024年6月8日* 